# 支付开通引导文档

## 概述

本文档提供支付宝和微信支付的开通引导，帮助管理员快速配置支付功能。

## 支付宝支付开通指南

### 第一步：注册支付宝开放平台账号

1. 访问 [支付宝开放平台](https://open.alipay.com/)
2. 使用支付宝账号登录
3. 完成开发者认证（企业/个人）

### 第二步：创建应用

1. 进入【控制台】->【网页&移动应用】
2. 点击【创建应用】
3. 选择应用类型：**网页&移动应用**
4. 填写应用信息：
   - 应用名称
   - 应用图标
   - 应用描述
5. 提交审核（通常1-3个工作日）

### 第三步：获取应用信息

应用审核通过后，获取以下信息：

- **AppID**：应用的唯一标识（16位数字）
- **应用公钥**：需要上传到支付宝
- **支付宝公钥**：从开放平台获取（用于验签）

### 第四步：生成密钥对

1. 下载密钥生成工具：
   - 访问：https://opendocs.alipay.com/common/02kkv7
   - 下载支付宝密钥生成工具
2. 生成RSA2密钥对：
   - 打开密钥生成工具
   - 选择"RSA2(SHA256)密钥"
   - 点击"生成密钥"
   - 保存生成的私钥和公钥
3. 上传应用公钥：
   - 登录开放平台
   - 进入应用详情
   - 在"接口加签方式"中上传应用公钥
   - 获取支付宝公钥

### 第五步：配置支付参数

在管理系统中配置以下参数：

1. **AppID**：从开放平台获取
2. **商户私钥**：生成的RSA2私钥（完整内容，包括BEGIN和END）
3. **支付宝公钥**：从开放平台获取的公钥
4. **网关地址**：
   - 生产环境：`https://openapi.alipay.com/gateway.do`
   - 沙箱环境：`https://openapi.alipaydev.com/gateway.do`
5. **回调地址**：`https://your-domain.com/api/payment/callback/alipay`
6. **返回地址**：`https://your-domain.com/payment/return`

### 第六步：测试支付

1. 在管理系统中启用沙箱模式
2. 使用沙箱账号进行支付测试
3. 验证回调通知是否正常
4. 测试通过后，切换到生产环境

## 微信支付开通指南

### 第一步：注册微信支付商户号

1. 访问 [微信支付商户平台](https://pay.weixin.qq.com/)
2. 使用微信账号登录
3. 选择注册类型：
   - **企业**：需要营业执照
   - **个体工商户**：需要营业执照
   - **个人**：需要身份证
4. 填写相关信息并提交审核
5. 等待审核通过（通常1-3个工作日）

### 第二步：获取商户号信息

审核通过后，在商户平台获取以下信息：

- **商户号（MchId）**：10位数字
- **AppID**：关联的公众号或小程序AppID
- **API密钥（v2）**：用于v2接口签名（如果使用）
- **API v3密钥**：用于v3接口签名（32位字符串）

### 第三步：申请API证书

1. 登录商户平台
2. 进入【账户中心】->【API安全】
3. 点击【申请证书】
4. 下载证书工具
5. 使用证书工具生成证书请求串
6. 上传证书请求串，获取证书文件
7. 记录证书序列号

### 第四步：配置支付产品

1. 进入【产品中心】
2. 开通【Native支付】产品（PC端扫码支付）
3. 设置支付回调地址：`https://your-domain.com/api/payment/callback/wechat`

### 第五步：配置支付参数

在管理系统中配置以下参数：

1. **AppID**：关联的公众号或小程序AppID
2. **商户号（MchId）**：10位数字
3. **API v3密钥**：32位字符串
4. **商户私钥**：从证书文件中提取的私钥（PEM格式）
5. **证书序列号**：证书的序列号
6. **回调地址**：`https://your-domain.com/api/payment/callback/wechat`

### 第六步：测试支付

1. 在商户平台申请沙箱环境
2. 获取沙箱密钥和证书
3. 使用沙箱参数进行支付测试
4. 验证回调通知是否正常
5. 测试通过后，切换到生产环境

## API接口

### 获取支付开通引导

```
GET /api/payment/guide/alipay
GET /api/payment/guide/wechat
GET /api/payment/guide
```

## 注意事项

1. **安全性**：
   - 私钥和API密钥等敏感信息必须妥善保管
   - 建议对数据库进行加密存储
   - 不要在代码中硬编码密钥

2. **回调验证**：
   - 必须验证支付回调的签名
   - 确保回调来自支付宝/微信官方
   - 防止伪造回调攻击

3. **幂等性**：
   - 支付回调可能重复调用
   - 需要保证订单处理的幂等性
   - 避免重复激活会员

4. **订单过期**：
   - 订单有30分钟过期时间
   - 过期后需要重新创建订单
   - 建议前端定期查询订单状态

5. **沙箱环境**：
   - 测试时使用沙箱环境
   - 生产环境必须切换到正式网关
   - 沙箱和生产的配置参数不同

## 常见问题

### Q: 支付宝回调验证失败？
A: 检查支付宝公钥是否正确，确保使用正确的签名算法（RSA2）。

### Q: 微信支付回调无法解密？
A: 需要使用API v3密钥进行AES-256-GCM解密，确保密钥正确。

### Q: 支付订单创建失败？
A: 检查配置参数是否正确，特别是AppID、商户号、密钥等。

### Q: 如何切换沙箱/生产环境？
A: 在管理系统中修改`isSandbox`字段，并更新相应的网关地址。

## 技术支持

- 支付宝技术支持：https://open.alipay.com/support
- 微信支付技术支持：https://pay.weixin.qq.com/community
- 官方文档：
  - 支付宝：https://opendocs.alipay.com/
  - 微信支付：https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml

