package com.heartsphere.memory.repository;

import com.heartsphere.memory.model.MemoryType;
import com.heartsphere.memory.model.character.CharacterInteractionMemory;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.mongodb.repository.MongoRepository;
import org.springframework.data.mongodb.repository.Query;
import org.springframework.stereotype.Repository;

import java.time.Instant;
import java.util.List;

/**
 * 角色交互记忆Repository
 * 
 * @author HeartSphere
 * @date 2025-12-29
 */
@Repository
public interface CharacterInteractionMemoryRepository extends MongoRepository<CharacterInteractionMemory, String> {
    
    /**
     * 根据角色ID和用户ID查找
     */
    List<CharacterInteractionMemory> findByCharacterIdAndUserId(String characterId, String userId);
    
    /**
     * 根据角色ID、用户ID和场景ID查找
     */
    List<CharacterInteractionMemory> findByCharacterIdAndUserIdAndEraId(
        String characterId, String userId, String eraId);
    
    /**
     * 根据角色ID和用户ID，按交互时间倒序查找
     */
    List<CharacterInteractionMemory> findByCharacterIdAndUserIdOrderByInteractionTimeDesc(
        String characterId, String userId, Pageable pageable);
    
    /**
     * 根据角色ID、用户ID和场景ID，按交互时间倒序查找
     */
    List<CharacterInteractionMemory> findByCharacterIdAndUserIdAndEraIdOrderByInteractionTimeDesc(
        String characterId, String userId, String eraId, Pageable pageable);
    
    /**
     * 根据角色ID查找所有交互记忆
     */
    Page<CharacterInteractionMemory> findByCharacterId(String characterId, Pageable pageable);
    
    /**
     * 根据角色ID和类型查找
     */
    List<CharacterInteractionMemory> findByCharacterIdAndType(String characterId, MemoryType type);
    
    /**
     * 根据交互时间范围查找
     */
    List<CharacterInteractionMemory> findByCharacterIdAndUserIdAndInteractionTimeBetween(
        String characterId, String userId, Instant startTime, Instant endTime);
    
    /**
     * 文本搜索
     */
    @Query("{ 'characterId': ?0, 'userId': ?1, '$text': { '$search': ?2 } }")
    List<CharacterInteractionMemory> searchByCharacterIdAndUserIdAndText(
        String characterId, String userId, String query, Pageable pageable);
}



