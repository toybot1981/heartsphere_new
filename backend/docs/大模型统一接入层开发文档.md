# 大模型统一接入层开发文档

**文档版本**: V1.0  
**编写日期**: 2025-12-21  
**功能模块**: 大模型统一接入层 (AI Agent Service)  
**技术栈**: Spring Boot 3.2.0 + Spring AI Alibaba 1.1.0.0-RC1

---

## 一、项目结构

```
backend/src/main/java/com/heartsphere/aiagent/
├── adapter/                    # 模型适配器层
│   ├── ModelAdapter.java      # 适配器接口
│   ├── DashScopeAdapter.java  # 通义千问适配器（基于Spring AI Alibaba）
│   ├── GeminiAdapter.java     # Gemini适配器（待实现）
│   ├── OpenAIAdapter.java         # OpenAI适配器（待实现）
│   └── ModelAdapterManager.java  # 适配器管理器
├── config/                     # 配置类
│   ├── AIConfiguration.java   # AI配置类
│   └── ModelAdapterConfig.java # 适配器配置
├── controller/                 # API控制器
│   └── AIServiceController.java # 统一AI服务控制器
├── dto/                        # 数据传输对象
│   ├── request/               # 请求DTO
│   │   ├── TextGenerationRequest.java
│   │   ├── ImageGenerationRequest.java
│   │   ├── AudioRequest.java
│   │   └── VideoGenerationRequest.java
│   └── response/              # 响应DTO
│       ├── TextGenerationResponse.java
│       ├── ImageGenerationResponse.java
│       ├── AudioResponse.java
│       └── VideoGenerationResponse.java
├── entity/                     # 实体类
│   ├── UserAIConfig.java      # 用户AI配置实体
│   └── SystemAIConfig.java   # 系统AI配置实体
├── exception/                  # 异常类
│   ├── AIServiceException.java
│   └── UnsupportedModelException.java
├── repository/                 # 数据访问层
│   ├── UserAIConfigRepository.java
│   └── SystemAIConfigRepository.java
├── service/                    # 服务层
│   ├── AIService.java         # AI服务接口
│   ├── AIServiceImpl.java     # AI服务实现
│   ├── AIConfigService.java   # AI配置服务
│   └── AIUsageRecordService.java # 使用量记录服务（未来用于计费）
└── util/                       # 工具类
    ├── StreamResponseHandler.java # 流式响应处理器
    └── ResponseConverter.java    # 响应转换器
```

---

## 二、技术选型

### 2.1 核心依赖

```xml
<!-- Spring AI Alibaba DashScope Starter -->
<dependency>
    <groupId>com.alibaba.cloud.ai</groupId>
    <artifactId>spring-ai-alibaba-starter-dashscope</artifactId>
    <version>1.1.0.0-RC1</version>
</dependency>

<!-- Spring Boot WebFlux (用于流式响应) -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-webflux</artifactId>
</dependency>
```

### 2.2 设计模式

1. **适配器模式**: 统一不同AI提供商的接口
2. **策略模式**: 支持多种模型切换和降级
3. **工厂模式**: 管理适配器实例

---

## 三、核心功能实现

### 3.1 模型适配器接口

**位置**: `adapter/ModelAdapter.java`

```java
public interface ModelAdapter {
    String getProviderType();
    boolean supportsTextGeneration();
    boolean supportsImageGeneration();
    boolean supportsTextToSpeech();
    boolean supportsSpeechToText();
    boolean supportsVideoGeneration();
    
    TextGenerationResponse generateText(TextGenerationRequest request);
    void generateTextStream(TextGenerationRequest request, 
                           StreamResponseHandler<TextGenerationResponse> handler);
    ImageGenerationResponse generateImage(ImageGenerationRequest request);
    AudioResponse textToSpeech(AudioRequest request);
    AudioResponse speechToText(AudioRequest request);
    VideoGenerationResponse generateVideo(VideoGenerationRequest request);
    
    List<String> getSupportedModels(String capability);
}
```

### 3.2 DashScope适配器实现

**位置**: `adapter/DashScopeAdapter.java`

基于Spring AI Alibaba的DashScopeChatModel和DashScopeImageModel实现。

**关键实现点**:
- 使用`DashScopeChatModel`进行文本生成
- 使用`DashScopeImageModel`进行图片生成
- 参数转换：统一请求参数转换为DashScope API参数
- 响应转换：DashScope响应转换为统一响应格式

### 3.3 AI服务层

**位置**: `service/AIServiceImpl.java`

**核心逻辑**:
1. 获取用户配置（决定使用哪个provider和model）
2. 根据请求或配置选择适配器
3. 调用适配器生成内容
4. 记录使用量（为计费做准备）
5. 失败降级处理

### 3.4 API控制器

**位置**: `controller/AIServiceController.java`

**主要接口**:
- `POST /api/ai/text/generate` - 文本生成
- `POST /api/ai/text/generate/stream` - 流式文本生成（SSE）
- `POST /api/ai/image/generate` - 图片生成
- `POST /api/ai/audio/tts` - 文本转语音
- `POST /api/ai/audio/stt` - 语音转文本
- `POST /api/ai/video/generate` - 视频生成
- `GET /api/ai/config` - 获取用户配置
- `PUT /api/ai/config` - 更新用户配置

---

## 四、数据库设计

### 4.1 用户AI配置表

```sql
CREATE TABLE user_ai_config (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL COMMENT '用户ID',
  text_provider VARCHAR(50) COMMENT '文本生成提供商：dashscope, gemini, openai',
  text_model VARCHAR(100) COMMENT '文本生成模型名称',
  image_provider VARCHAR(50) COMMENT '图片生成提供商',
  image_model VARCHAR(100) COMMENT '图片生成模型名称',
  audio_provider VARCHAR(50) COMMENT '音频处理提供商',
  audio_model VARCHAR(100) COMMENT '音频处理模型名称',
  video_provider VARCHAR(50) COMMENT '视频生成提供商',
  video_model VARCHAR(100) COMMENT '视频生成模型名称',
  enable_fallback BOOLEAN DEFAULT TRUE COMMENT '是否启用降级',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id),
  UNIQUE KEY uk_user_id (user_id)
);
```

### 4.2 系统AI配置表

```sql
CREATE TABLE system_ai_config (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  config_key VARCHAR(100) NOT NULL COMMENT '配置键',
  config_value VARCHAR(500) NOT NULL COMMENT '配置值',
  description VARCHAR(500) COMMENT '描述',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_config_key (config_key)
);
```

### 4.3 AI使用量记录表（未来用于计费）

```sql
CREATE TABLE ai_usage_record (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL COMMENT '用户ID',
  provider VARCHAR(50) NOT NULL COMMENT '提供商',
  model VARCHAR(100) NOT NULL COMMENT '模型名称',
  capability VARCHAR(50) NOT NULL COMMENT '能力：text, image, audio, video',
  input_tokens INT COMMENT '输入Token数',
  output_tokens INT COMMENT '输出Token数',
  total_tokens INT COMMENT '总Token数',
  cost DECIMAL(10, 6) COMMENT '费用（元）',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id),
  INDEX idx_user_id (user_id),
  INDEX idx_created_at (created_at)
);
```

---

## 五、配置文件

### 5.1 application.yml配置

```yaml
spring:
  ai:
    dashscope:
      api-key: ${DASHSCOPE_API_KEY:}
      chat:
        options:
          model: qwen-max
          temperature: 0.7

ai:
  # 默认配置
  default:
    text-provider: dashscope
    text-model: qwen-max
    image-provider: dashscope
    image-model: wanx-v1
    enable-fallback: true
  
  # 各提供商配置
  dashscope:
    api-key: ${DASHSCOPE_API_KEY:}
    base-url: https://dashscope.aliyuncs.com/compatible-mode/v1
    default-text-model: qwen-max
    default-image-model: wanx-v1
```

---

## 六、API接口规范

### 6.1 文本生成

**请求**:
```json
POST /api/ai/text/generate
{
  "provider": "dashscope",
  "model": "qwen-max",
  "prompt": "你好",
  "systemInstruction": "你是一个助手",
  "messages": [
    {"role": "user", "content": "你好"}
  ],
  "temperature": 0.7,
  "maxTokens": 2048,
  "stream": false
}
```

**响应**:
```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "content": "你好！有什么可以帮助你的吗？",
    "provider": "dashscope",
    "model": "qwen-max",
    "usage": {
      "inputTokens": 10,
      "outputTokens": 20,
      "totalTokens": 30
    },
    "finishReason": "stop"
  }
}
```

### 6.2 流式文本生成

使用Server-Sent Events (SSE):

```
POST /api/ai/text/generate/stream
Content-Type: application/json

{
  "prompt": "你好",
  "stream": true
}
```

响应流:
```
data: {"content": "你好", "done": false}
data: {"content": "！", "done": false}
data: {"content": "有什么", "done": false}
data: {"content": "可以帮助你的吗？", "done": true, "usage": {...}}
```

---

## 七、错误处理

### 7.1 异常类

- `AIServiceException`: AI服务通用异常
- `UnsupportedModelException`: 不支持的模型异常
- `ModelAdapterException`: 适配器异常

### 7.2 错误响应格式

```json
{
  "code": 500,
  "message": "AI服务调用失败: 模型不可用",
  "data": null,
  "timestamp": "2025-12-21T10:30:00"
}
```

---

## 八、测试指南

### 8.1 单元测试

**测试文件位置**: `src/test/java/com/heartsphere/aiagent/`

**测试类**:
- `DashScopeAdapterTest.java` - 适配器测试
- `AIServiceTest.java` - 服务层测试
- `AIServiceControllerTest.java` - 控制器测试

### 8.2 集成测试

使用Postman或curl测试API接口：

```bash
# 文本生成测试
curl -X POST http://localhost:8081/api/ai/text/generate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "prompt": "你好",
    "provider": "dashscope",
    "model": "qwen-max"
  }'
```

### 8.3 测试用例

1. **基础功能测试**
   - 文本生成（同步）
   - 文本生成（流式）
   - 图片生成
   - 音频处理

2. **配置测试**
   - 用户配置获取和更新
   - 默认配置使用
   - 模型切换

3. **错误处理测试**
   - 无效provider
   - 无效model
   - API调用失败
   - 降级机制

4. **性能测试**
   - 并发请求
   - 响应时间
   - 流式响应延迟

---

## 九、开发进度

### 9.1 第一阶段：基础框架（当前阶段）

- [x] 项目结构创建
- [x] 依赖配置
- [ ] DashScope适配器实现
- [ ] AI服务层基础框架
- [ ] API控制器基础框架
- [ ] 配置管理

### 9.2 第二阶段：核心功能

- [ ] 文本生成（同步）
- [ ] 文本生成（流式）
- [ ] 图片生成
- [ ] 用户配置管理
- [ ] 错误处理

### 9.3 第三阶段：扩展功能

- [ ] 音频处理（TTS/STT）
- [ ] 视频生成
- [ ] 降级机制
- [ ] 使用量记录

### 9.4 第四阶段：优化和测试

- [ ] 性能优化
- [ ] 单元测试
- [ ] 集成测试
- [ ] 文档完善

---

## 十、注意事项

1. **模块化**: 每个文件不超过1000行，保持单一职责
2. **异常处理**: 所有AI调用都要有异常处理和降级机制
3. **日志记录**: 记录所有AI调用，便于监控和调试
4. **配置管理**: 支持环境变量和配置文件
5. **安全性**: API Key存储在配置中，不暴露给前端
6. **扩展性**: 易于添加新的模型适配器

---

## 十一、参考资源

- [Spring AI Alibaba文档](https://github.com/alibaba/spring-ai-alibaba)
- [DashScope API文档](https://help.aliyun.com/zh/model-studio/)
- [Spring AI文档](https://docs.spring.io/spring-ai/reference/)

---

**文档维护**: 本文档应随开发进展持续更新。


