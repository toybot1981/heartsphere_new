# 笔记同步模块说明

## 功能概述

笔记同步模块支持用户将外部笔记服务（如印象笔记）的笔记同步到心域系统中。目前已实现印象笔记（Evernote）的同步功能。

## 后端实现

### 1. 数据库实体

- **NoteSync**: 存储用户的笔记同步授权信息
  - 支持多个笔记服务提供商
  - 存储OAuth访问令牌和刷新令牌
  - 记录同步状态和最后同步时间

- **Note**: 存储同步的笔记数据
  - 关联用户和笔记服务提供商
  - 存储笔记标题、内容、标签等信息
  - 支持软删除

### 2. 服务层

- **EvernoteAuthService**: 印象笔记OAuth授权服务
  - 生成授权URL
  - 处理授权回调
  - 管理授权状态

- **NoteSyncService**: 笔记同步服务
  - 同步笔记数据
  - 管理同步配置
  - 获取笔记列表

### 3. API端点

- `GET /api/notes/evernote/authorize` - 获取印象笔记授权URL
- `GET /api/notes/evernote/callback` - 处理授权回调
- `GET /api/notes/syncs` - 获取用户的同步配置列表
- `GET /api/notes/syncs/{provider}/status` - 获取指定provider的同步状态
- `POST /api/notes/syncs/{provider}/sync` - 同步笔记
- `DELETE /api/notes/syncs/{provider}` - 撤销授权
- `GET /api/notes` - 获取笔记列表
- `GET /api/notes/{id}` - 获取单个笔记详情

## 配置说明

### 后端配置

在 `application.yml` 中添加印象笔记配置：

```yaml
evernote:
  consumer-key: your-consumer-key
  consumer-secret: your-consumer-secret
  sandbox: true  # 是否使用沙箱环境（开发时建议true）
```

### 获取印象笔记API密钥

1. 访问 [印象笔记开发者平台](https://dev.evernote.com/)
2. 注册开发者账户
3. 创建新应用
4. 获取 Consumer Key 和 Consumer Secret

## 前端实现

### NoteSyncModal 组件

提供完整的笔记同步管理界面：

- **同步配置标签页**:
  - 显示已连接的笔记服务
  - 授权/撤销授权按钮
  - 同步状态和最后同步时间
  - 立即同步功能

- **笔记列表标签页**:
  - 显示所有同步的笔记
  - 按服务提供商筛选
  - 显示笔记标题、内容预览、标签等
  - 支持跳转到原始笔记

### 使用方法

```tsx
import { NoteSyncModal } from './components/NoteSyncModal';

// 在需要的地方使用
<NoteSyncModal 
  token={userToken} 
  onClose={() => setShowModal(false)} 
/>
```

## 使用流程

1. **用户授权**:
   - 用户点击"授权连接"按钮
   - 系统生成授权URL并打开新窗口
   - 用户在印象笔记网站完成授权
   - 系统处理回调并保存授权信息

2. **同步笔记**:
   - 用户点击"立即同步"按钮
   - 系统调用印象笔记API获取笔记列表
   - 解析并保存笔记数据到数据库
   - 更新同步状态和时间

3. **查看笔记**:
   - 用户在"笔记列表"标签页查看所有同步的笔记
   - 可以按服务提供商筛选
   - 点击"查看原文"跳转到原始笔记

## 注意事项

1. **OAuth 1.0a协议**: 印象笔记使用OAuth 1.0a协议，实现相对复杂。当前实现为简化版本，实际生产环境需要完整实现OAuth 1.0a流程。

2. **API调用**: `syncEvernoteNotes` 方法中需要实现完整的印象笔记API调用逻辑，包括：
   - 使用OAuth签名发送请求
   - 解析EDAM格式的笔记数据
   - 处理分页和增量同步

3. **错误处理**: 需要完善错误处理机制，包括：
   - 令牌过期处理
   - 网络错误重试
   - 数据冲突解决

4. **性能优化**: 对于大量笔记，建议实现：
   - 增量同步
   - 后台任务处理
   - 分页加载

## 扩展支持其他笔记服务

模块设计支持扩展，可以轻松添加其他笔记服务：

1. 创建新的授权服务（如 `NotionAuthService`）
2. 在 `NoteSyncService` 中添加对应的同步方法
3. 在前端 `NoteSyncModal` 中添加新的服务卡片

## 后续改进

- [ ] 完善印象笔记OAuth 1.0a实现
- [ ] 实现完整的笔记同步逻辑
- [ ] 添加增量同步支持
- [ ] 支持Notion、Obsidian等其他笔记服务
- [ ] 添加同步计划任务
- [ ] 实现笔记搜索功能
- [ ] 支持笔记双向同步

