# 初始化流程测试用例文档

## 测试文件位置
`frontend/src/__tests__/initialization.test.ts`

## 测试目标

本测试用例旨在验证用户注册和初始化流程的正确性，确保：
1. 初始化完成后，登录用户无法看到体验场景（大学时代、赛博都市、心域心理治疗诊所）
2. 初始化后可以正常获取剧情数据
3. 初始化过程可以正确提取"我的大学"场景下的主线剧情

## 测试用例列表

### 测试用例1: 注册用户并执行初始化，验证体验场景不显示

**测试步骤：**
1. 注册新用户
2. 获取系统预置场景列表（初始化向导第一步）
3. 获取"我的大学"场景的主线剧情（初始化向导第三步）
4. 获取"我的大学"场景的剧本（初始化向导第四步）
5. 初始化完成后，获取用户的世界和场景列表
6. 构建用户场景列表（模拟 App.tsx 中的逻辑）
7. 验证体验场景不在用户场景列表中
8. 验证用户场景列表只包含用户创建的场景

**预期结果：**
- ✅ 用户成功注册并获取 token
- ✅ 系统预置场景列表加载成功
- ✅ "我的大学"场景的主线剧情加载成功
- ✅ 用户场景列表中不包含体验场景（university_era, cyberpunk_city, clinic）
- ✅ 用户场景列表只包含用户创建的场景（如"我的大学"）

**验证点：**
```typescript
// 体验场景的ID（来自 constants.ts）
const EXPERIENCE_SCENE_IDS = ['university_era', 'cyberpunk_city', 'clinic'];

// 验证体验场景不在用户场景列表中
const userSceneIds = userWorldScenes.map(s => s.id);
EXPERIENCE_SCENE_IDS.forEach(experienceSceneId => {
  expect(userSceneIds).not.toContain(experienceSceneId);
});
```

---

### 测试用例2: 验证初始化后可以正常获取剧情

**测试步骤：**
1. 设置用户 token
2. 获取世界列表
3. 获取场景列表
4. 获取角色列表
5. 获取剧本列表
6. 验证数据获取成功
7. 验证剧本与场景的关联

**预期结果：**
- ✅ 所有数据获取成功（世界、场景、角色、剧本）
- ✅ 剧本与场景正确关联（通过 eraId）
- ✅ 剧本数据完整（包含 title, content, sceneCount 等）

**验证点：**
```typescript
// 验证数据获取成功
expect(worlds.length).toBeGreaterThan(0);
expect(eras.length).toBeGreaterThan(0);
expect(Array.isArray(characters)).toBe(true);
expect(Array.isArray(scripts)).toBe(true);

// 验证剧本与场景的关联
const eraScripts = scripts.filter(s => s.eraId === mockUserEra.id);
expect(eraScripts.length).toBeGreaterThan(0);
expect(eraScripts[0].title).toBe('校园生活');
```

---

### 测试用例3: 验证初始化过程可以提取"我的大学"场景的主线剧情

**测试步骤：**
1. 获取系统预置场景列表
2. 找到"我的大学"场景
3. 获取"我的大学"场景的主线剧情
4. 验证主线剧情获取成功
5. 验证主线剧情的完整性
6. 验证主线剧情的 systemEraId 与场景ID匹配

**预期结果：**
- ✅ "我的大学"场景在预置场景列表中找到
- ✅ 主线剧情"青春校园的序曲"成功获取
- ✅ 主线剧情的 systemEraId 与场景ID匹配
- ✅ 主线剧情数据完整（包含 name, description, firstMessage, systemInstruction 等）

**验证点：**
```typescript
// 验证主线剧情获取成功
expect(mainStory).toBeDefined();
expect(mainStory).not.toBeNull();
expect(mainStory?.id).toBe(mockMyUniversityMainStory.id);
expect(mainStory?.name).toBe('青春校园的序曲');
expect(mainStory?.systemEraId).toBe(mockMyUniversityEra.id);

// 验证主线剧情的完整性
expect(mainStory?.description).toBeDefined();
expect(mainStory?.firstMessage).toBeDefined();
expect(mainStory?.systemInstruction).toBeDefined();
```

**边界情况测试：**
- ✅ 场景没有主线剧情的情况（404响应）应正确处理，返回 null 而不是抛出错误

---

### 测试用例4: 验证场景列表构建逻辑（不包含体验场景）

**测试场景1: 登录用户**
- 登录用户应该只看到 userWorldScenes，不包含 WORLD_SCENES

**测试场景2: 游客**
- 游客应该看到 WORLD_SCENES（体验场景）

**验证点：**
```typescript
// 登录用户的场景列表构建逻辑
const allScenes = userProfile && !userProfile.isGuest && userWorldScenes && userWorldScenes.length > 0
  ? [...userWorldScenes, ...customScenes]
  : [...WORLD_SCENES, ...customScenes];

// 验证登录用户不包含体验场景
const sceneIds = allScenes.map(s => s.id);
EXPERIENCE_SCENE_IDS.forEach(experienceSceneId => {
  expect(sceneIds).not.toContain(experienceSceneId);
});

// 验证游客包含体验场景
// （游客场景列表构建逻辑）
const allScenes = userProfile && !userProfile.isGuest && userWorldScenes && userWorldScenes.length > 0
  ? [...userWorldScenes, ...customScenes]
  : [...WORLD_SCENES, ...customScenes];

EXPERIENCE_SCENE_IDS.forEach(experienceSceneId => {
  expect(sceneIds).toContain(experienceSceneId);
});
```

---

## Mock 数据说明

### 系统预置场景（"我的大学"）
```typescript
const mockMyUniversityEra = {
  id: 1, // systemEraId
  name: '我的大学',
  description: '重返青涩的校园时光',
  imageUrl: 'https://example.com/university.jpg',
  startYear: 2020,
  endYear: 2024,
  isActive: true,
  sortOrder: 1,
};
```

### 主线剧情（"青春校园的序曲"）
```typescript
const mockMyUniversityMainStory = {
  id: 1,
  name: '青春校园的序曲',
  description: '一段关于青春、梦想与成长的校园故事',
  systemEraId: 1, // 对应"我的大学"场景
  eraName: '我的大学',
  firstMessage: '欢迎来到大学校园...',
  systemInstruction: '你是大学场景主线故事的叙事者...',
  // ... 其他字段
};
```

### 用户创建的场景
```typescript
const mockUserEra = {
  id: 10, // 用户场景ID（不同于systemEraId）
  name: '我的大学', // 用户自定义的名称
  description: '重返青涩的校园时光',
  systemEraId: 1, // 关联到系统预置场景
  worldId: 1,
  userId: 1,
  // ... 其他字段
};
```

---

## 运行测试

### 运行所有初始化测试
```bash
cd frontend
npm test -- initialization.test.ts
```

### 运行测试并查看覆盖率
```bash
cd frontend
npm test -- initialization.test.ts --coverage
```

### 运行测试并监听文件变化
```bash
cd frontend
npm test -- initialization.test.ts --watch
```

---

## 测试覆盖的功能点

1. ✅ **用户注册流程**
   - 用户注册 API 调用
   - Token 存储到 localStorage

2. ✅ **初始化向导流程**
   - 系统预置场景列表获取
   - 主线剧情获取（按场景ID）
   - 剧本获取（按场景ID）

3. ✅ **数据加载流程**
   - 世界列表获取
   - 场景列表获取
   - 角色列表获取
   - 剧本列表获取

4. ✅ **场景列表构建逻辑**
   - 登录用户场景列表（不包含体验场景）
   - 游客场景列表（包含体验场景）

5. ✅ **数据关联验证**
   - 剧本与场景的关联（通过 eraId）
   - 主线剧情与场景的关联（通过 systemEraId）

6. ✅ **错误处理**
   - 404 响应处理（场景没有主线剧情）
   - 数据验证（systemEraId 匹配）

---

## 注意事项

1. **Mock 数据一致性**
   - 确保 Mock 数据中的 `systemEraId` 与场景ID匹配
   - 确保用户场景的 `systemEraId` 指向正确的系统预置场景

2. **API 响应格式**
   - 确保 Mock 的 API 响应格式与真实 API 一致
   - 注意处理 ApiResponse 格式（包含 code, message, data）

3. **体验场景ID**
   - 体验场景的ID来自 `constants.ts` 中的 `WORLD_SCENES`
   - 当前体验场景ID：`university_era`, `cyberpunk_city`, `clinic`

4. **测试隔离**
   - 每个测试用例前都会清理 Mock 和 localStorage
   - 确保测试之间不会相互影响

---

## 相关文件

- 测试文件：`frontend/src/__tests__/initialization.test.ts`
- 测试配置：`frontend/jest.config.js`
- 测试设置：`frontend/src/__tests__/setup.ts`
- API 服务：`frontend/services/api.ts`
- 常量定义：`frontend/constants.ts`
- 主应用：`frontend/App.tsx`
- 初始化向导：`frontend/components/InitializationWizard.tsx`

---

## 更新日志

- **2025-12-18**: 创建初始化流程测试用例
  - 测试用例1: 注册用户并执行初始化，验证体验场景不显示
  - 测试用例2: 验证初始化后可以正常获取剧情
  - 测试用例3: 验证初始化过程可以提取"我的大学"场景的主线剧情
  - 测试用例4: 验证场景列表构建逻辑（不包含体验场景）




