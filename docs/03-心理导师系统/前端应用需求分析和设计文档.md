# MindScape AI Clinic - 前端应用需求分析与设计文档

## 📋 文档信息

- **项目名称**: MindScape AI Clinic（心灵绿洲智能诊所）
- **文档版本**: v1.0.0
- **创建日期**: 2025-12-27
- **技术栈**: React 19.2.3 + TypeScript + Vite 6.4.1
- **AI 模型**: Google GenAI SDK (Gemini)
- **UI 框架**: Tailwind CSS + Lucide React Icons

---

## 目录

1. [项目概述](#项目概述)
2. [核心功能分析](#核心功能分析)
3. [用户角色与场景](#用户角色与场景)
4. [信息架构](#信息架构)
5. [UI/UX 设计规范](#uiux-设计规范)
6. [技术架构](#技术架构)
7. [数据模型](#数据模型)
8. [核心组件设计](#核心组件设计)
9. [状态管理](#状态管理)
10. [API 集成](#api-集成)
11. [本地存储策略](#本地存储策略)
12. [无障碍设计](#无障碍设计)
13. [性能优化](#性能优化)
14. [安全性考虑](#安全性考虑)
15. [未来扩展方向](#未来扩展方向)

---

## 项目概述

### 1.1 产品定位

MindScape AI Clinic 是一款**智能心理健康咨询平台**，通过 AI 驱动的虚拟治疗师，为用户提供专业的心理治疗体验。产品模拟真实心理咨询流程，支持 5 种主流心理治疗流派，提供沉浸式的语音交互和深度学习资源。

### 1.2 核心价值主张

- **专业性**：基于真实心理学理论，5 种疗法流派各有特色
- **可及性**：随时随地获得心理支持，打破时空限制
- **沉浸感**：语音交互、环境氛围、学习路径营造真实咨询体验
- **隐私性**：本地存储，无需注册，保护用户隐私
- **成长性**：学习记录系统，追踪心理成长历程

### 1.3 目标用户

- **主要用户**: 18-45 岁城市青年，面临职场压力、情绪困扰、亲密关系问题
- **次要用户**: 心理学学习者、心理咨询从业者（作为学习工具）
- **潜在用户**: 对心理学感兴趣的普通大众

---

## 核心功能分析

### 2.1 功能总览图

```
MindScape AI Clinic
├── 🏠 首页 Landing (HeroSection)
│   ├── 品牌展示
│   ├── 开始咨询按钮
│   └── 浏览案例库
│
├── 🎭 疗法选择 Selection (MethodSelector)
│   ├── 5 种疗法卡片展示
│   └── 快速了解各疗法特色
│
├── 📚 案例库 CaseLibrary
│   ├── 17 个临床案例分类浏览
│   ├── 案例详情查看
│   └── 推荐疗法跳转
│
├── 🎯 疗法详情 Dashboard (MethodDashboard)
│   ├── 📖 学习路径 Roadmap
│   │   ├── 4 阶段课程大纲
│   │   └── 深度知识库生成（1000+ 字学术内容）
│   ├── 📝 学习记录 Records
│   │   ├── 历史会话列表
│   │   ├── 会话总结查看
│   │   └── 记录导出/删除
│   └── 📚 知识库 Library
│       ├── AI 生成的深度内容
│       ├── Markdown 渲染阅读
│       └── PDF 导出
│
├── 📋 诊前评估 Intake (ClinicalIntake)
│   ├── 情绪评分（1-10 分滑块）
│   ├── 主要困扰输入
│   ├── 目标设定（多选）
│   └── 自由对话 vs 实操练习选择
│
└── 💬 咨询会话 Session (ChatSession)
    ├── 🤖 AI 治疗师对话
    │   ├── 实时聊天界面
    │   ├── Markdown 富文本回复
    │   ├── 历史上下文加载
    │   └── 个性化系统指令
    ├── 🎙️ 语音交互
    │   ├── 语音输入（STT）
    │   ├── 语音输出（TTS）
    │   └── 5 种治疗师声音
    ├── 🌌 环境氛围
    │   ├── 日落 Sunset
    │   ├── 森林 Forest
    │   └── 午夜 Midnight
    ├── 🧘 呼吸练习
    │   └── 4-7-8 呼吸法动画引导
    └── 📊 会话管理
        ├── 实时总结生成
        ├── 记录保存到本地
        └── 退出确认
```

### 2.2 详细功能规格

#### 2.2.1 疗法系统（5 种流派）

| 疗法 ID | 名称 | 治疗师 | 专长领域 | 核心技术 | 声音 |
|---------|------|--------|----------|----------|------|
| `cbt` | 认知行为疗法 | Cognos 博士 🧠 | 焦虑、抑郁、恐惧 | 认知重构、行为激活、苏格拉底式提问 | Fenrir |
| `dbt` | 辩证行为疗法 | Sage Harmony ⚖️ | 情绪波动、成瘾 | 痛苦承受、情绪调节、正念、人际效能 | Kore |
| `psychodynamic` | 心理动力学 | Prof. Freudia 🛋️ | 原生家庭、创伤 | 移情分析、自由联想、防御机制识别 | Charon |
| `act` | 接纳承诺疗法 | Guide River 🌊 | 灾难化、空心病 | 认知解离、接纳、价值澄清 | Zephyr |
| `humanistic` | 人本主义 | Alex Beacon ❤️ | 自尊、亲密关系 | 共情反映、真诚一致、此时此刻 | Puck |

每个疗法包含：
- **4 阶段学习路径**（每阶段 1-3 周）
- **差异化系统提示词**（中英文混合，约 200 字）
- **专属颜色主题**（Tailwind CSS 类名）
- **治疗师人设**（姓名、头像 Emoji）

#### 2.2.2 临床案例库（17 个案例）

**分类分布**：
- 亲密关系（3 个）：夫妻沟通、回避型依恋、权力争夺
- 情绪障碍（3 个）：情绪淤堵、广泛性焦虑、躁郁边缘
- 职场与自我（2 个）：冒充者综合征、职业倦怠
- 焦虑障碍（2 个）：社交恐惧、广泛性焦虑
- 原生家庭（3 个）：讨好型人格、代际创伤、病理性哀悼
- 其他（4 个）：学业焦虑、数字成瘾、空心病、身材焦虑、失眠、毒性完美主义

每个案例结构：
```typescript
{
  id: string;              // case-1 ~ case-17
  category: string;        // 分类标签
  title: string;           // 案例标题
  manifestation: string;   // 典型表现
  rootCause: string;       // 心理溯源
  solution: string;        // 治疗处方
  recommendedMethodId: string; // 推荐疗法 ID
  tags: string[];          // 关键词标签
}
```

#### 2.2.3 咨询会话流程

**完整用户旅程**：

```
1. 首页
   ↓ 点击"开始咨询"
2. 疗法选择（5 选 1）
   ↓ 点击疗法卡片
3. 疗法详情 Dashboard
   ├→ 查看学习路径
   ├→ 浏览历史记录
   ├→ 进入知识库阅读
   ↓ 点击"进入诊疗室"
4. 诊前评估 Intake
   ├→ 情绪评分滑块
   ├→ 主要困扰文本框
   ├→ 目标设定（多选框）
   └→ 选择：自由对话 / 实操练习
   ↓ 点击"开始会话"
5. 咨询会话 Session
   ├→ AI 初始化（加载历史上下文）
   ├→ 实时对话
   ├→ 语音交互（可选）
   ├→ 环境氛围切换
   └→ 呼吸练习（可选）
   ↓ 点击"结束会话"
6. 会话总结
   ├→ AI 生成总结（100 字内）
   ├→ 保存到本地存储
   └→ 返回 Dashboard
```

#### 2.2.4 语音交互系统

**技术栈**：
- **STT (语音转文字)**: Web Speech API (`SpeechRecognition`)
- **TTS (文字转语音)**: Google GenAI Text-to-Speech API
- **音频播放**: Web Audio API (`AudioContext`)

**功能特性**：
1. **语音输入**
   - 支持中文识别 (`lang: 'zh-CN'`)
   - 实时转录反馈
   - 错误处理（无声音、权限拒绝、网络问题）
   - 自动追加到输入框

2. **语音输出**
   - 5 种差异化声音（对应 5 位治疗师）
   - 自动播放开关
   - 停止播放按钮
   - Markdown 文本清理（移除 `#*<>` 符号）
   - 限制 500 字（避免超时）

3. **语音状态管理**
   - `isListening`: 是否正在听
   - `isSpeaking`: 是否正在说
   - `autoPlayVoice`: 自动播放开关
   - `speechError`: 错误提示

#### 2.2.5 深度知识库生成

**功能描述**：
- 用户在学习路径中点击任意阶段，AI 生成 1000+ 字学术解析
- 内容结构：
  - 理论起源与哲学背景
  - 神经科学机制
  - 详细的临床操作流程
  - 深度案例分析
  - 常见误区与最新研究进展

**技术实现**：
```typescript
const prompt = `
  请作为一名拥有 20 年经验的临床心理学家，撰写一篇关于 CBT 核心知识点"${phaseTitle}"的深度学术解析文稿。

  要求：
  1. 篇幅要求：内容必须详实、深入，总字数不得少于 1000 字。
  2. 结构要求：
     - 理论起源与哲学背景。
     - 神经科学机制。
     - 详细的临床操作流程。
     - 深度案例分析。
     - 常见误区与最新研究进展。
  3. 语言风格：专业、严谨、具有人文关怀。
  4. 格式：使用标准的 Markdown 标题、列表、引用和加粗。

  当前主题简介：${phaseDescription}
`;
```

**缓存策略**：
- 生成后自动缓存到 `localStorage`
- 缓存 Key: `mindscape_dive_${methodId}_${phase}`
- 后续访问直接读取缓存

#### 2.2.6 学习记录系统

**数据结构**：
```typescript
interface LearningRecord {
  id: string;           // 唯一 ID（时间戳）
  date: string;         // 会话日期
  summary: string;      // AI 生成的总结（100 字内）
  topic: string;        // 讨论主题（来自 intake.primaryConcern）
  moodScore?: number;   // 情绪评分
  therapistName: string;// 治疗师姓名
}
```

**存储机制**：
- 存储 Key: `mindscape_history_list_${methodId}`
- 存储格式: JSON 数组
- 排序: 最新记录在前
- 用途:
  1. Dashboard 展示历史
  2. 下次会话时加载上下文（最近 3 次）

**功能**：
- 查看：列表展示，点击展开详情
- 删除：单条删除 + 清空全部
- 导出：触发浏览器打印（PDF）

#### 2.2.7 环境氛围系统

**三种氛围**：

1. **Sunset (日落)** 🌅
   - 渐变背景: `from-orange-100 to-rose-100`
   - 氛围: 温暖、舒适
   - 适用: 傍晚咨询

2. **Forest (森林)** 🌲
   - 渐变背景: `from-green-100 to-emerald-100`
   - 氛围: 平静、治愈
   - 适用: 焦虑缓解

3. **Midnight (午夜)** 🌙
   - 渐变背景: `from-slate-700 to-slate-900`
   - 氛围: 安静、专注
   - 适用: 深度思考

**实现方式**：
- 动态切换 CSS 类名
- 渐变背景应用在主容器
- 平滑过渡动画 (`transition-all duration-700`)

---

## 用户角色与场景

### 3.1 用户画像

#### 主要用户 1: 职场新人 - 小王（24 岁，程序员）

**痛点**：
- 工作压力大，经常加班
- 社交焦虑，不敢表达
- 睡眠质量差

**使用场景**：
1. 晚 10 点下班，打开网站
2. 选择 CBT 疗法（"认知重构"吸引他）
3. 进入诊疗室，情绪评分 3/10
4. 描述："最近项目压力大，总是担心做不好"
5. AI 治疗师引导识别灾难化思维
6. 语音交互 20 分钟
7. 结束后生成总结，保存记录
8. 一周后回来，AI 记得上次话题

#### 主要用户 2: 大学生 - 小李（21 岁，文科生）

**痛点**：
- 学业焦虑，绩点压力
- 自我认同困惑
- 亲密关系问题

**使用场景**：
1. 下午在宿舍，浏览案例库
2. 看到"学业焦虑"案例，产生共鸣
3. 点击推荐的人本主义疗法
4. 阅读学习路径"自我真实性探索"
5. 点击生成深度知识库（1000+ 字）
6. 打印成 PDF，作为学习资料
7. 尝试进入诊疗室，与治疗师对话

#### 次要用户: 心理学学习者 - 小张（28 岁，咨询师）

**需求**：
- 学习不同疗法的咨询技巧
- 参考系统提示词设计
- 案例库作为教学素材

**使用场景**：
1. 浏览 5 种疗法的学习路径
2. 观察系统提示词（Inspector 查看）
3. 分析 AI 回复模式
4. 作为教学演示工具

### 3.2 典型用户旅程

**场景: 焦虑管理的连续咨询**

```
Day 1: 首次访问
├─ 浏览案例库 → 发现"广泛性焦虑：灾难化思维"
├─ 点击推荐 ACT 疗法
├─ 查看 Dashboard → 阅读"认知解离练习"阶段
├─ 进入诊疗室 → 情绪评分 4/10
├─ 与 Guide River 对话 30 分钟
└─ 生成总结："识别出灾难化思维模式，学习观察者视角"

Day 7: 第二次访问
├─ 打开历史记录 → 看到上次总结
├─ 点击"继续咨询"
├─ 系统加载上下文："上次我们讨论了灾难化思维..."
├─ 情绪评分 6/10（有所改善）
├─ 汇报练习效果："这周尝试了认知解离，有一定帮助"
├─ AI 针对性反馈："很高兴看到进展，我们来深化练习..."
└─ 生成总结："认知解离练习初见成效，继续强化"

Day 14: 第三次访问
├─ 进入第 2 阶段："彻底接纳痛苦"
├─ 生成深度知识库 → 1000+ 字学术内容
├─ 打印学习资料
└─ 开始新阶段的对话
```

---

## 信息架构

### 4.1 导航结构

```
App (根组件)
│
├── AppView.LANDING (首页)
│   └── HeroSection
│       ├── 品牌标语
│       ├── CTA 按钮：开始咨询
│       └── 次要按钮：浏览案例库
│
├── AppView.SELECTION (疗法选择)
│   └── MethodSelector
│       ├── 网格布局：5 个疗法卡片
│       └── 每个卡片：头像、名称、描述
│
├── AppView.CASE_LIBRARY (案例库)
│   └── CaseLibrary
│       ├── 分类导航：9 个分类
│       ├── 案例网格：17 个案例
│       └── 详情模态框
│
├── AppView.METHOD_DETAILS (疗法详情)
│   └── MethodDashboard
│       ├── 顶部 Banner：疗法名称 + 治疗师头像
│       ├── Tab 导航：学习路径 / 历史记录 / 知识库
│       │
│       ├── Tab 1: 学习路径 Roadmap
│       │   ├── 4 个阶段卡片
│       │   └── 每个阶段：图标、标题、描述、时长、"深度学习"按钮
│       │
│       ├── Tab 2: 历史记录 Records
│       │   ├── 记录列表
│       │   └── 操作：查看、删除、清空、导出
│       │
│       ├── Tab 3: 知识库 Library
│       │   ├── AI 生成内容（Markdown）
│       │   └── 操作：打印 PDF
│       │
│       └── CTA 按钮：进入诊疗室 / 求助督导师
│
├── AppView.INTAKE (诊前评估)
│   └── ClinicalIntake
│       ├── 情绪评分滑块（1-10）
│       ├── 主要困扰文本框
│       ├── 目标设定（多选框）
│       └── 提交按钮：开始会话
│
└── AppView.SESSION (咨询会话)
    └── ChatSession
        ├── 顶部导航栏
        │   ├── 返回按钮
        │   ├── 治疗师头像 + 姓名
        │   ├── 氛围切换按钮
        │   ├── 语音控制按钮
        │   └── 退出按钮
        │
        ├── 消息列表区域
        │   ├── 系统欢迎消息
        │   ├── 用户消息气泡（右侧）
        │   ├── AI 消息气泡（左侧 + Markdown）
        │   └── 自动滚动到底部
        │
        ├── 呼吸练习按钮（可选）
        │
        └── 输入区域
            ├── 文本输入框
            ├── 语音输入按钮
            └── 发送按钮
```

### 4.2 状态流转图

```
LANDING
   ├─→ onStart() → SELECTION
   └─→ onExploreCases() → CASE_LIBRARY

SELECTION
   ├─→ onSelect(method) → METHOD_DETAILS
   └─→ onBack() → LANDING

CASE_LIBRARY
   ├─→ onSelectMethod(method) → METHOD_DETAILS
   └─→ onBack() → LANDING

METHOD_DETAILS
   ├─→ onEnterClinic(prompt, false) → INTAKE (治疗师)
   ├─→ onEnterClinic(prompt, true) → INTAKE (督导师)
   └─→ onBack() → SELECTION

INTAKE
   ├─→ onComplete(intake) → SESSION
   └─→ onCancel() → METHOD_DETAILS

SESSION
   └─→ onExit() → METHOD_DETAILS (保存记录)
```

---

## UI/UX 设计规范

### 5.1 色彩系统

#### 疗法主题色

| 疗法 | 背景色 | 文字色 | 边框色 | Tailwind 类名 |
|------|--------|--------|--------|---------------|
| CBT | 蓝色 | blue-800 | blue-200 | `bg-blue-100 text-blue-800 border-blue-200` |
| DBT | 青色 | teal-800 | teal-200 | `bg-teal-100 text-teal-800 border-teal-200` |
| Psychodynamic | 紫色 | purple-800 | purple-200 | `bg-purple-100 text-purple-800 border-purple-200` |
| ACT | 翠绿 | emerald-800 | emerald-200 | `bg-emerald-100 text-emerald-800 border-emerald-200` |
| Humanistic | 橙色 | orange-800 | orange-200 | `bg-orange-100 text-orange-800 border-orange-200` |

#### 通用色彩

- **主背景**: `from-slate-50 to-indigo-50/30`（渐变）
- **卡片背景**: `bg-white` + `shadow-md`
- **主按钮**: `bg-indigo-600 hover:bg-indigo-700`
- **次要按钮**: `bg-slate-100 hover:bg-slate-200`
- **文字主色**: `text-slate-900`
- **文字次要**: `text-slate-600`
- **边框**: `border-slate-200`

#### 氛围背景色

| 氛围 | 渐变类名 |
|------|----------|
| Sunset | `from-orange-100 to-rose-100` |
| Forest | `from-green-100 to-emerald-100` |
| Midnight | `from-slate-700 to-slate-900`（文字反白） |

### 5.2 字体系统

- **字体家族**: Inter (`font-family: 'Inter', sans-serif`)
- **标题字号**:
  - H1: `text-4xl md:text-5xl font-extrabold`
  - H2: `text-2xl font-bold`
  - H3: `text-xl font-semibold`
- **正文字号**: `text-base`
- **小字**: `text-sm text-slate-600`

### 5.3 间距系统

- **容器内边距**: `p-6` 或 `p-8`
- **卡片间距**: `gap-6`
- **元素间距**: `space-y-4`
- **外边距**: `mb-4`, `mt-8`

### 5.4 圆角与阴影

- **卡片圆角**: `rounded-xl`
- **按钮圆角**: `rounded-lg`
- **头像圆角**: `rounded-full`
- **阴影层级**:
  - 卡片: `shadow-md hover:shadow-lg transition-shadow`
  - 模态框: `shadow-2xl`
  - 按钮: `shadow-sm`

### 5.5 动画系统

```css
/* 淡入动画 */
@keyframes fade-in {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in { animation: fade-in 0.5s ease-out forwards; }

/* 淡入上升动画 */
@keyframes fade-in-up {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in-up { animation: fade-in-up 0.6s ease-out forwards; }

/* 缓慢弹跳 */
.animate-bounce-slow { animation: bounce 3s infinite; }
```

### 5.6 响应式断点

- **手机**: 默认样式（< 768px）
- **平板**: `md:` 断点（≥ 768px）
- **桌面**: `lg:` 断点（≥ 1024px）

**布局策略**:
- 疗法选择: 手机 1 列 → 平板 2 列 → 桌面 3 列
- 案例库: 手机 1 列 → 平板 2 列 → 桌面 3 列
- 学习路径: 始终垂直列表（移动优先）

### 5.7 交互设计模式

#### 按钮状态
- **默认**: 主色背景 + 白色文字
- **悬停**: 背景色加深 + `hover:scale-105`
- **禁用**: `opacity-50 cursor-not-allowed`
- **加载**: 显示 Loader 图标 + 禁用点击

#### 表单交互
- **滑块**: 实时显示数值
- **文本框**: `focus:ring-2 focus:ring-indigo-500`
- **多选框**: 选中后背景色变化

#### 消息气泡
- **用户**: 右对齐 + `bg-indigo-600 text-white`
- **AI**: 左对齐 + `bg-slate-100 text-slate-900` + Markdown 渲染

---

## 技术架构

### 6.1 技术栈选型

| 类别 | 技术 | 版本 | 用途 |
|------|------|------|------|
| **框架** | React | 19.2.3 | UI 组件库 |
| **语言** | TypeScript | 5.8.2 | 类型安全 |
| **构建工具** | Vite | 6.4.1 | 快速开发服务器 |
| **UI 库** | Tailwind CSS | CDN | 原子化 CSS |
| **图标** | Lucide React | 0.561.0 | 轻量图标库 |
| **Markdown** | react-markdown | 10.1.0 | 富文本渲染 |
| **AI SDK** | @google/genai | 1.34.0 | Gemini AI 集成 |
| **语音** | Web Speech API | - | 浏览器原生 STT |
| **音频** | Web Audio API | - | TTS 播放 |

### 6.2 项目结构

```
mindscape-ai-clinic/
├── index.html                 # HTML 入口（包含 importmap）
├── index.tsx                  # React 应用入口
├── App.tsx                    # 根组件（状态管理 + 路由）
├── types.ts                   # TypeScript 类型定义
├── constants.ts               # 常量（疗法、案例）
├── vite.config.ts             # Vite 配置
│
├── components/                # UI 组件
│   ├── HeroSection.tsx        # 首页英雄区
│   ├── MethodSelector.tsx     # 疗法选择器
│   ├── MethodDashboard.tsx    # 疗法详情 Dashboard
│   ├── ClinicalIntake.tsx     # 诊前评估表单
│   ├── ChatSession.tsx        # 咨询会话界面
│   └── CaseLibrary.tsx        # 案例库
│
├── services/                  # 业务逻辑服务
│   └── geminiService.ts       # Google GenAI 封装
│       ├── initializeChat()   # 初始化会话
│       ├── sendMessageToTherapist() # 发送消息
│       ├── generateSessionSummary() # 生成总结
│       ├── synthesizeSpeech() # TTS 语音合成
│       ├── generateDeepDive() # 深度知识生成
│       └── resetSession()     # 重置会话
│
└── package.json               # 依赖管理
```

### 6.3 组件层级树

```
App
├── HeroSection
│   ├── 标题
│   ├── 描述
│   ├── 开始按钮
│   └── 案例库按钮
│
├── MethodSelector
│   └── 疗法卡片 × 5
│       ├── 头像
│       ├── 名称
│       └── 描述
│
├── CaseLibrary
│   ├── 分类标签
│   └── 案例卡片网格
│       └── 案例卡片 × 17
│
├── MethodDashboard
│   ├── Banner
│   ├── Tab 导航
│   │   ├── 学习路径
│   │   │   └── 阶段卡片 × 4
│   │   ├── 历史记录
│   │   │   └── 记录列表
│   │   └── 知识库
│   │       └── Markdown 渲染
│   └── CTA 按钮组
│
├── ClinicalIntake
│   ├── 情绪评分滑块
│   ├── 主要困扰输入
│   ├── 目标设定
│   └── 提交按钮
│
└── ChatSession
    ├── 顶部导航栏
    ├── 消息列表
    │   ├── 消息气泡 × N
    │   └── Markdown 渲染
    ├── 呼吸练习按钮
    └── 输入区域
        ├── 文本框
        ├── 语音按钮
        └── 发送按钮
```

### 6.4 数据流架构

```
┌─────────────────────────────────────────────────────┐
│                    Browser                          │
│                                                       │
│  ┌──────────────┐      ┌──────────────┐            │
│  │   React UI   │ ←→  │   Local      │            │
│  │   (App.tsx)  │      │   Storage    │            │
│  └──────┬───────┘      └──────────────┘            │
│         │                                              │
│         │ 调用服务                                     │
│         ↓                                              │
│  ┌──────────────────────────────────────────────┐  │
│  │         geminiService.ts                      │  │
│  ├──────────────────────────────────────────────┤  │
│  │  • initializeChat()                           │  │
│  │  • sendMessageToTherapist()                  │  │
│  │  • generateSessionSummary()                  │  │
│  │  • synthesizeSpeech()                        │  │
│  │  • generateDeepDive()                        │  │
│  └──────────────────┬───────────────────────────┘  │
│                     │                                  │
│                     │ HTTP API                         │
│                     ↓                                  │
│  ┌──────────────────────────────────────────────┐  │
│  │       Google GenAI API (Gemini)              │  │
│  ├──────────────────────────────────────────────┤  │
│  │  • Chat API (gemini-3-flash-preview)         │  │
│  │  • TTS API (gemini-2.5-flash-preview-tts)    │  │
│  │  • Generate Content (gemini-3-pro-preview)   │  │
│  └──────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘

补充: 未来可扩展为连接后端 API (Spring Boot)
  ┌─────────────────────────────────────┐
  │  Backend REST API (localhost:8082)  │
  │  • POST /sessions/start             │
  │  • POST /sessions/{id}/message      │
  │  • POST /sessions/{id}/end          │
  │  • GET /methods                     │
  │  • GET /cases                       │
  └─────────────────────────────────────┘
```

### 6.5 性能优化策略

1. **代码分割**: 按路由懒加载组件（未来可引入 React Router）
2. **缓存策略**:
   - 深度知识库内容缓存到 `localStorage`
   - 学习记录持久化存储
3. **图片优化**: 使用 Emoji 替代图片（零加载时间）
4. **防抖/节流**: 语音输入、输入框 typing（未来可优化）
5. **懒加载**: Markdown 渲染按需加载

---

## 数据模型

### 7.1 核心类型定义

#### 7.1.1 疗法 (TherapyMethod)

```typescript
interface TherapyMethod {
  id: string;              // 疗法唯一标识 (cbt | dbt | psychodynamic | act | humanistic)
  name: string;            // 完整名称（中文）
  shortName: string;       // 简称（英文大写）
  description: string;     // 一句话介绍
  keyTechniques: string[]; // 核心技术数组（3 个）
  therapistName: string;   // 治疗师姓名
  therapistAvatar: string; // 治疗师头像（Emoji）
  color: string;           // Tailwind CSS 类名
  systemInstruction: string; // AI 系统提示词（英文）
  syllabus: SyllabusItem[]; // 4 阶段学习路径
  consultantName?: string; // 督导师姓名（可选）
  consultantAvatar?: string; // 督导师头像（可选）
  consultantInstruction?: string; // 督导师提示词（可选）
}
```

#### 7.1.2 学习路径节点 (SyllabusItem)

```typescript
interface SyllabusItem {
  phase: number;    // 阶段序号（1-4）
  title: string;    // 阶段标题（中文）
  desc: string;     // 阶段描述（中文）
  iconName: string; // 图标名称（Lucide 图标）
}
```

#### 7.1.3 临床案例 (CaseStudy)

```typescript
interface CaseStudy {
  id: string;                 // 案例唯一 ID (case-1 ~ case-17)
  category: string;           // 分类标签
  title: string;              // 案例标题
  manifestation: string;      // 典型表现
  rootCause: string;          // 心理溯源
  solution: string;           // 治疗处方
  recommendedMethodId: string; // 推荐疗法 ID
  tags: string[];             // 关键词标签
}
```

#### 7.1.4 诊前评估 (SessionIntake)

```typescript
interface SessionIntake {
  moodScore: number;        // 情绪评分（1-10）
  primaryConcern: string;   // 主要困扰
  goals: string[];          // 目标数组
}
```

#### 7.1.5 学习记录 (LearningRecord)

```typescript
interface LearningRecord {
  id: string;              // 唯一 ID（时间戳）
  date: string;            // 会话日期（ISO 字符串）
  summary: string;         // AI 生成的总结（100 字内）
  topic: string;           // 讨论主题（来自 intake.primaryConcern）
  moodScore?: number;      // 情绪评分
  therapistName: string;   // 治疗师姓名
}
```

#### 7.1.6 聊天消息 (Message)

```typescript
interface Message {
  id: string;        // 唯一 ID（时间戳）
  role: 'user' | 'model'; // 角色
  text: string;      // 消息内容
  timestamp: Date;   // 时间戳
}
```

#### 7.1.7 应用视图 (AppView)

```typescript
enum AppView {
  LANDING = 'LANDING',          // 首页
  SELECTION = 'SELECTION',      // 疗法选择
  METHOD_DETAILS = 'METHOD_DETAILS', // 疗法详情
  INTAKE = 'INTAKE',            // 诊前评估
  SESSION = 'SESSION',          // 咨询会话
  CASE_LIBRARY = 'CASE_LIBRARY' // 案例库
}
```

### 7.2 常量数据

#### 7.2.1 THERAPY_METHODS

存储在 `constants.ts`，包含 5 种疗法的完整配置。

#### 7.2.2 CASE_STUDIES

存储在 `constants.ts`，包含 17 个临床案例。

---

## 核心组件设计

### 8.1 App 组件（根组件）

**职责**:
- 应用级状态管理（当前视图、选中的疗法、会话信息）
- 路由导航逻辑
- 历史上下文加载

**关键 State**:
```typescript
const [view, setView] = useState<AppView>(AppView.LANDING);
const [selectedMethod, setSelectedMethod] = useState<TherapyMethod | null>(null);
const [sessionStartPrompt, setSessionStartPrompt] = useState<string | undefined>();
const [activeTherapistInfo, setActiveTherapistInfo] = useState<{
  name: string;
  avatar: string;
  isConsultant: boolean;
} | null>(null);
const [currentIntake, setCurrentIntake] = useState<SessionIntake | null>(null);
```

**关键方法**:
- `handleStartSession()`: 初始化会话，加载历史上下文
- `handleExitSession()`: 清理会话状态，返回 Dashboard

### 8.2 HeroSection 组件（首页）

**职责**:
- 品牌展示
- 引导用户开始咨询或浏览案例

**UI 元素**:
- 大标题: "MindScape AI Clinic"
- 副标题: "您的智能心理治疗师"
- 主按钮: "开始咨询" → 跳转到疗法选择
- 次按钮: "浏览案例库" → 跳转到案例库

### 8.3 MethodSelector 组件（疗法选择）

**职责**:
- 展示 5 种疗法
- 允许用户选择感兴趣的疗法

**布局**:
- 响应式网格（移动 1 列，平板 2 列，桌面 3 列）
- 每个卡片: 头像 Emoji + 名称 + 描述
- 点击卡片 → 跳转到疗法详情

### 8.4 MethodDashboard 组件（疗法详情）

**职责**:
- 展示疗法详细信息
- 管理 3 个 Tab（学习路径、历史记录、知识库）
- 提供进入诊疗室入口

**State**:
```typescript
const [history, setHistory] = useState<LearningRecord[]>([]);
const [activeTab, setActiveTab] = useState<'roadmap' | 'records' | 'library'>('roadmap');
const [deepDiveContent, setDeepDiveContent] = useState<string | null>(null);
const [isGenerating, setIsGenerating] = useState(false);
const [selectedPhaseForDive, setSelectedPhaseForDive] = useState<SyllabusItem | null>(null);
```

**关键功能**:
1. **学习路径 Tab**:
   - 展示 4 个阶段卡片
   - 每个阶段有"深度学习"按钮
   - 点击 → 调用 `generateDeepDive()` → 切换到知识库 Tab

2. **历史记录 Tab**:
   - 列表展示所有学习记录
   - 每条记录显示日期、主题、总结
   - 操作: 查看详情、删除单条、清空全部、导出 PDF

3. **知识库 Tab**:
   - Markdown 渲染 AI 生成的内容
   - 操作: 打印 PDF

### 8.5 ClinicalIntake 组件（诊前评估）

**职责**:
- 收集用户当前状态信息
- 作为 AI 会话的初始上下文

**表单字段**:
1. **情绪评分滑块**（1-10 分）
2. **主要困扰文本框**（必填）
3. **目标设定多选框**（预定义选项 + 自定义）

**验证规则**:
- 情绪评分: 默认 5
- 主要困扰: 非空验证
- 目标: 至少选择 1 个

### 8.6 ChatSession 组件（咨询会话）

**职责**:
- 实时聊天界面
- 语音交互
- 环境氛围切换
- 呼吸练习引导
- 会话总结生成

**核心 State**:
```typescript
const [messages, setMessages] = useState<Message[]>([]);
const [input, setInput] = useState('');
const [isLoading, setIsLoading] = useState(false);
const [isSummarizing, setIsSummarizing] = useState(false);
const [exitConfirm, setExitConfirm] = useState(false);
const [ambience, setAmbience] = useState<Ambience>('sunset');
const [showBreathing, setShowBreathing] = useState(false);

// 语音状态
const [isListening, setIsListening] = useState(false);
const [isSpeaking, setIsSpeaking] = useState(false);
const [autoPlayVoice, setAutoPlayVoice] = useState(true);
const [speechError, setSpeechError] = useState<string | null>(null);
```

**关键功能**:

1. **消息发送**:
   ```typescript
   const handleSend = async () => {
     // 1. 添加用户消息到列表
     // 2. 调用 sendMessageToTherapist()
     // 3. 添加 AI 回复到列表
     // 4. 如果自动播放开启，调用 synthesizeSpeech()
   };
   ```

2. **语音识别**:
   ```typescript
   const startSpeechRecognition = () => {
     const recognition = new SpeechRecognition();
     recognition.lang = 'zh-CN';
     recognition.onresult = (event) => {
       // 追加到输入框
     };
     recognition.start();
   };
   ```

3. **语音合成**:
   ```typescript
   const playAudio = (base64Audio: Uint8Array) => {
     const audioContext = new AudioContext();
     const audioBuffer = audioContext.decodeAudioData(base64Audio);
     const source = audioContext.createBufferSource();
     source.buffer = audioBuffer;
     source.connect(audioContext.destination);
     source.start();
   };
   ```

4. **会话总结**:
   ```typescript
   const handleExit = async () => {
     // 1. 调用 generateSessionSummary(messages)
     // 2. 保存到 localStorage
     // 3. 跳转回 Dashboard
   };
   ```

### 8.7 CaseLibrary 组件（案例库）

**职责**:
- 展示 17 个临床案例
- 支持按分类筛选
- 点击案例跳转到对应疗法

**State**:
```typescript
const [selectedCategory, setSelectedCategory] = useState<string>('all');
const [selectedCase, setSelectedCase] = useState<CaseStudy | null>(null);
```

**布局**:
- 顶部: 分类标签云（9 个分类 + 全部）
- 主体: 案例卡片网格（响应式）
- 模态框: 案例详情展示

---

## 状态管理

### 9.1 当前实现（组件级 State）

当前应用使用 React 内置的 `useState` 进行状态管理，所有状态保存在 `App.tsx` 根组件中。

**优点**:
- 简单直接，无需学习额外库
- 适合小型应用
- 数据流清晰

**缺点**:
- Props drilling（通过多层组件传递数据）
- 难以复用状态逻辑
- 缺乏时间旅行调试

### 9.2 未来优化建议

**选项 1: Context API + useReducer**
```typescript
// 创建全局 Context
const AppContext = createContext<AppState | null>(null);

// 使用 useReducer 管理复杂状态
const [state, dispatch] = useReducer(appReducer, initialState);
```

**选项 2: Zustand（轻量级状态管理）**
```typescript
import create from 'zustand';

const useAppStore = create((set) => ({
  view: AppView.LANDING,
  selectedMethod: null,
  setView: (view) => set({ view }),
  setSelectedMethod: (method) => set({ selectedMethod: method }),
}));
```

**选项 3: Redux Toolkit（中大型应用）**
- 适合复杂业务逻辑
- 支持时间旅行调试
- 丰富的中间件生态

### 9.3 状态持久化

**当前实现**:
- 使用 `localStorage` 存储学习记录
- 手动序列化/反序列化 JSON

**优化建议**:
```typescript
// 封装存储 Hook
const useLocalStorage = <T>(key: string, initialValue: T) => {
  const [storedValue, setStoredValue] = useState<T>(() => {
    try {
      const item = window.localStorage.getItem(key);
      return item ? JSON.parse(item) : initialValue;
    } catch (error) {
      return initialValue;
    }
  });

  const setValue = (value: T) => {
    try {
      setStoredValue(value);
      window.localStorage.setItem(key, JSON.stringify(value));
    } catch (error) {
      console.error(error);
    }
  };

  return [storedValue, setValue] as const;
};
```

---

## API 集成

### 10.1 当前 AI 集成（Google GenAI）

**服务文件**: `services/geminiService.ts`

**API 使用情况**:

| 功能 | 模型 | 用途 |
|------|------|------|
| 聊天对话 | `gemini-3-flash-preview` | 实时对话 |
| 语音合成 | `gemini-2.5-flash-preview-tts` | TTS |
| 深度生成 | `gemini-3-pro-preview` | 知识库生成 |

**配置方式**:
```typescript
const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
```

**环境变量**: `.env` 文件
```bash
GEMINI_API_KEY=your_api_key_here
```

### 10.2 未来后端集成（Spring Boot）

**目标**: 将 Google GenAI 替换为自建后端 API，实现：
- 上下文管理（短期 + 长期记忆）
- 事实提取（心理学画像）
- 会话迁移（跨会话知识继承）

**API 设计**: [心理导师API快速参考.md](./心理导师API快速参考.md)

**集成方式**:
```typescript
// 创建 psychologyService.ts
const API_BASE = 'http://localhost:8082/api/psychology';

export const startSession = async (intake: SessionIntake) => {
  const response = await fetch(`${API_BASE}/sessions/start`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(intake),
  });
  return response.json();
};

export const sendMessage = async (sessionId: string, message: string) => {
  const response = await fetch(`${API_BASE}/sessions/${sessionId}/message`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message }),
  });
  return response.json();
};
```

**优势**:
- 数据隐私（不依赖第三方）
- 成本可控（自托管模型）
- 功能扩展（长期记忆、事实提取）

---

## 本地存储策略

### 11.1 当前存储方案

| 数据类型 | Key 格式 | 数据结构 | 用途 |
|---------|----------|----------|------|
| 学习记录 | `mindscape_history_list_${methodId}` | `LearningRecord[]` | 历史会话列表 |
| 深度知识库 | `mindscape_dive_${methodId}_${phase}` | `string` | AI 生成的学术内容 |

**生命周期**:
- **永久存储**: 除非用户手动清除浏览器数据
- **容量限制**: 通常 5-10 MB（足够文本存储）
- **跨标签页同步**: 不支持（每个标签页独立）

### 11.2 存储操作示例

**保存学习记录**:
```typescript
const saveRecord = (methodId: string, record: LearningRecord) => {
  const key = `mindscape_history_list_${methodId}`;
  const existing = JSON.parse(localStorage.getItem(key) || '[]');
  const updated = [record, ...existing]; // 最新在前
  localStorage.setItem(key, JSON.stringify(updated));
};
```

**加载历史记录**:
```typescript
const loadHistory = (methodId: string): LearningRecord[] => {
  const key = `mindscape_history_list_${methodId}`;
  const data = localStorage.getItem(key);
  return data ? JSON.parse(data) : [];
};
```

**删除记录**:
```typescript
const deleteRecord = (methodId: string, recordId: string) => {
  const key = `mindscape_history_list_${methodId}`;
  const existing = loadHistory(methodId);
  const filtered = existing.filter(r => r.id !== recordId);
  localStorage.setItem(key, JSON.stringify(filtered));
};
```

### 11.3 存储优化建议

1. **数据压缩**: 使用 LZ-string 压缩长文本
   ```typescript
   import LZString from 'lz-string';
   const compressed = LZString.compress(longText);
   localStorage.setItem(key, compressed);
   ```

2. **过期清理**: 自动清理 6 个月前的记录
   ```typescript
   const cleanupOldRecords = () => {
     const sixMonthsAgo = Date.now() - 6 * 30 * 24 * 60 * 60 * 1000;
     const filtered = records.filter(r => new Date(r.date).getTime() > sixMonthsAgo);
     localStorage.setItem(key, JSON.stringify(filtered));
   };
   ```

3. **IndexedDB**: 对于大量数据（如语音录音），使用 IndexedDB

---

## 无障碍设计

### 12.1 当前无障碍支持

**已实现**:
- 语义化 HTML 标签
- 键盘导航（Tab 键切换焦点）
- 高对比度文字
- 响应式字体大小

**待改进**:
- ARIA 标签
- 屏幕阅读器支持
- 焦点可见性
- 颜色盲友好配色

### 12.2 改进建议

**添加 ARIA 标签**:
```tsx
<button
  aria-label="开始语音输入"
  aria-pressed={isListening}
  onClick={toggleListening}
>
  <Mic />
</button>
```

**键盘快捷键**:
```tsx
useEffect(() => {
  const handleKeyPress = (e: KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };
  window.addEventListener('keydown', handleKeyPress);
  return () => window.removeEventListener('keydown', handleKeyPress);
}, []);
```

---

## 性能优化

### 13.1 已实现优化

1. **缓存策略**: 深度知识库内容缓存到 `localStorage`
2. **懒加载**: 按需生成 AI 内容
3. **Emoji 图标**: 零网络请求

### 13.2 未来优化方向

1. **React.memo**: 减少不必要的重渲染
   ```tsx
   export const MethodCard = React.memo(({ method }) => {
     // ...
   });
   ```

2. **虚拟滚动**: 长消息列表优化
   ```tsx
   import { FixedSizeList } from 'react-window';
   ```

3. **代码分割**: 按路由懒加载
   ```tsx
   const ChatSession = lazy(() => import('./components/ChatSession'));
   ```

4. **Service Worker**: 离线支持
   ```tsx
   if ('serviceWorker' in navigator) {
     navigator.serviceWorker.register('/sw.js');
   }
   ```

---

## 安全性考虑

### 14.1 当前安全措施

1. **XSS 防护**: 使用 `react-markdown` 默认转义
2. **输入验证**: 诊前评估表单非空验证
3. **错误处理**: API 调用失败时显示友好提示

### 14.2 未来安全增强

1. **内容审核**: AI 回复敏感词过滤
2. **速率限制**: 防止 API 滥用
3. **数据加密**: `localStorage` 数据加密存储
4. **HTTPS**: 强制使用 HTTPS
5. **CSP**: 内容安全策略

---

## 未来扩展方向

### 15.1 功能扩展

1. **多语言支持**: i18n 国际化（英文、日语）
2. **主题切换**: 深色模式
3. **社交分享**: 分享学习成果（隐私保护）
4. **数据导出**: JSON/CSV 导出所有记录
5. **图表可视化**: 情绪趋势图
6. **提醒功能**: 定期练习提醒
7. **社群功能**: 匿名互助小组

### 15.2 技术升级

1. **PWA**: 渐进式 Web 应用（离线支持、桌面图标）
2. **移动端 App**: React Native 打包
3. **后端迁移**: 完全迁移到自建后端 API
4. **模型微调**: 基于真实对话数据微调模型
5. **多模态**: 图片、视频交互（情绪识别）

### 15.3 商业化考虑

1. **订阅制**: 高级功能付费
2. **企业版**: 员工心理援助计划（EAP）
3. **B2B2C**: 与心理咨询机构合作
4. **数据服务**: 匿名化数据分析报告

---

## 附录

### A. 图标映射表

| iconName | Lucide 图标 | 颜色 |
|----------|-------------|------|
| Activity | Activity | blue-600 |
| Search | Search | indigo-600 |
| ShieldCheck | ShieldCheck | teal-600 |
| Zap | Zap | amber-600 |
| Wind | Wind | emerald-600 |
| Thermometer | Thermometer | rose-600 |
| MessageCircle | MessageCircle | indigo-600 |
| History | History | purple-600 |
| Compass | Compass | orange-600 |
| RotateCcw | RotateCcw | slate-600 |
| Brain | Brain | pink-600 |
| Heart | Heart | rose-500 |
| ArrowRight | ArrowRight | indigo-600 |
| Sparkles | Sparkles | yellow-500 |

### B. 环境变量清单

```bash
# Google GenAI API Key
GEMINI_API_KEY=your_api_key_here

# 后端 API Base URL（未来）
REACT_APP_API_BASE_URL=http://localhost:8082/api/psychology
```

### C. 浏览器兼容性

- **推荐**: Chrome 90+, Edge 90+, Safari 14+
- **语音识别**: Chrome/Edge（完整支持），Safari（部分支持）
- **语音合成**: Chrome/Edge/Safari（完整支持）

---

## 结语

MindScape AI Clinic 是一款功能完整的心理健康咨询平台，通过专业的心理治疗理论和先进的 AI 技术，为用户提供便捷、私密的心理支持服务。

本文档详细分析了前端应用的各个方面，包括功能规格、技术架构、数据模型、UI/UX 设计等，可作为产品迭代、团队协作、技术交接的参考文档。

**文档维护**: 本文档应随产品迭代持续更新，保持与代码实现的一致性。

---

**最后更新**: 2025-12-27
**维护者**: Claude Code Agent
**版本**: v1.0.0
