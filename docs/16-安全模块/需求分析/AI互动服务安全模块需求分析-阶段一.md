# AI互动服务安全模块需求分析 - 阶段一：基础安全检测模块

**文档版本**: V1.0  
**编写日期**: 2025-12-29  
**功能模块**: AI互动服务安全模块 - 基础安全检测  
**参考依据**: 《人工智能拟人化互动服务管理暂行办法（征求意见稿）》  
**阶段目标**: 建立基础的内容安全检测和AI标识功能，确保服务基础安全合规

---

## 一、需求概述

### 1.1 背景

根据《人工智能拟人化互动服务管理暂行办法》，提供者需要：

1. **内容安全检测**（第七条）：禁止生成、传播违法违规内容
2. **AI身份标识**（第十六条）：显著提示用户正在与AI交互
3. **使用时长监控**（第十七条）：用户连续使用超过2小时需提醒
4. **退出机制**（第十八条）：提供便捷的退出途径
5. **安全日志**（第九条）：依法留存网络日志

### 1.2 核心功能

本阶段重点实现以下功能：

- ✅ **内容安全检测**：检测用户输入和AI生成内容是否包含违法违规信息
- ✅ **AI身份标识**：在界面显著位置标识AI身份，并动态提醒
- ✅ **使用时长监控**：监控用户使用时长，超过2小时自动提醒
- ✅ **退出机制**：提供便捷的退出功能
- ✅ **基础安全日志**：记录安全相关事件和操作

### 1.3 设计目标

1. **实时检测**：内容安全检测要实时进行，及时拦截风险内容
2. **准确识别**：减少误报，提高检测准确性
3. **用户友好**：AI标识和提醒要清晰但不打扰用户体验
4. **完整记录**：所有安全事件要有完整的日志记录
5. **可配置**：安全策略可以灵活配置

---

## 二、功能需求分析

### 2.1 内容安全检测模块

#### 2.1.1 功能描述

对用户输入的内容和AI生成的内容进行实时安全检测，识别违法违规、敏感、不当内容，及时拦截或标记。

#### 2.1.2 检测内容类别

根据管理办法第七条，需要检测以下内容：

**1. 国家安全相关**
- 危害国家安全的内容
- 损害国家荣誉和利益的内容
- 破坏民族团结的内容
- 非法宗教活动相关内容
- 散布谣言扰乱经济和社会秩序的内容

**2. 违法违规内容**
- 淫秽、色情内容
- 赌博相关内容
- 暴力内容
- 教唆犯罪的内容

**3. 侵权内容**
- 侮辱他人的内容
- 诽谤他人的内容
- 侵害他人合法权益的内容

**4. 误导性内容**
- 严重影响用户行为的虚假承诺
- 损害社会人际关系的服务内容

**5. 危害用户安全内容**
- 鼓励、美化、暗示自杀自残的内容
- 语言暴力、情感操控内容
- 算法操纵、信息误导、情感陷阱内容

**6. 敏感信息**
- 涉密信息
- 诱导套取敏感信息的内容

#### 2.1.3 检测方式

**1. 实时检测**
- 在用户发送消息前进行检测
- 在AI生成回复后进行检测
- 检测延迟要控制在合理范围内（建议<500ms）

**2. 检测策略**
- **关键词匹配**：使用敏感词库进行关键词匹配
- **语义分析**：使用AI模型进行语义层面的内容理解
- **规则引擎**：配置规则进行复杂场景检测
- **黑白名单**：维护黑白名单进行快速判断

**3. 处理方式**
- **拦截**：高风险内容直接拦截，不允许发送/显示
- **标记**：中风险内容标记后人工审核
- **警告**：低风险内容警告用户
- **记录**：所有检测结果都要记录日志

#### 2.1.4 检测流程

```
用户输入/AI生成内容
        ↓
  内容安全检测
        ↓
    ┌───┴───┐
    │ 风险评级 │
    └───┬───┘
        ↓
    ┌───┴───┐
  高风险  中/低风险
    ↓        ↓
  拦截    标记/警告
    ↓        ↓
  记录日志  记录日志
```

#### 2.1.5 性能要求

- **检测延迟**：单次检测延迟 < 500ms（P95）
- **并发能力**：支持至少1000 QPS的并发检测
- **准确率**：误报率 < 5%，漏报率 < 1%
- **可用性**：检测服务可用性 > 99.9%

---

### 2.2 AI身份标识模块

#### 2.2.1 功能描述

在用户界面显著位置标识AI身份，确保用户明确知道正在与AI而非自然人进行交互。

#### 2.2.2 标识要求

**1. 静态标识**

- **位置**：在对话界面显著位置（如对话窗口标题、消息气泡等）
- **内容**：明确显示"AI助手"、"AI陪伴"等标识
- **样式**：使用图标+文字的组合，视觉上清晰易识别
- **持久性**：在整个对话过程中持续显示

**2. 动态提醒**

根据管理办法第十六条，需要在以下场景动态提醒：

- **初次使用**：用户首次使用时弹出提示
- **重新登录**：用户重新登录时提示
- **依赖倾向**：系统识别出用户出现过度依赖、沉迷倾向时提醒
- **定期提醒**：可以设置定期提醒（如每天首次使用时）

**3. 提醒方式**

- **弹窗提醒**：使用模态弹窗进行重要提醒
- **横幅提醒**：使用顶部横幅进行一般提醒
- **消息内提示**：在对话消息中插入提示信息
- **音效提示**：可选，使用音效增强提醒效果

#### 2.2.3 提醒内容

提醒内容应该清晰、友好，包括但不限于：

- "您正在与AI助手对话，AI生成的内容仅供参考"
- "这是AI生成的内容，并非真实人物"
- "请注意AI的局限性，保持理性判断"

#### 2.2.4 用户体验考虑

- 提醒不能过于频繁，避免打扰用户体验
- 提醒文案要友好、易懂
- 用户可以关闭提醒（但静态标识需保留）
- 提供"不再提醒"选项（需谨慎使用）

---

### 2.3 使用时长监控模块

#### 2.3.1 功能描述

监控用户使用AI互动服务的时长，当用户连续使用超过2小时时，自动提醒用户暂停使用。

#### 2.3.2 监控规则

**1. 时长计算**

- **连续使用时长**：从用户开始使用服务到当前时间的连续使用时长
- **重置条件**：用户退出服务或超过一定时间未操作（如30分钟）后重置
- **计时精度**：精确到秒

**2. 提醒阈值**

- **主要阈值**：连续使用2小时（120分钟）
- **可配置阈值**：允许管理员配置不同的提醒阈值
- **多次提醒**：超过阈值后可以设置多次提醒（如每30分钟提醒一次）

**3. 提醒方式**

- **弹窗提醒**：使用模态弹窗提醒
- **横幅提醒**：使用顶部横幅提醒
- **消息提示**：在对话界面插入提示消息
- **视觉提示**：使用视觉效果（如闪烁、颜色变化）增强提醒

#### 2.3.3 提醒内容

提醒内容应该友好、关心用户，例如：

- "您已经连续使用2小时了，建议您休息一下，保护眼睛和身体健康"
- "长时间使用可能影响健康，建议您暂停使用，稍后再来"
- "为了您的健康，建议您适当休息"

#### 2.3.4 用户响应

- **继续使用**：用户可以点击"我知道了"继续使用
- **暂停使用**：用户可以点击"暂停使用"退出服务
- **提醒频率控制**：用户可以设置提醒频率或暂时关闭提醒

---

### 2.4 退出机制模块

#### 2.4.1 功能描述

提供便捷的退出途径，用户可以通过多种方式退出AI互动服务，系统不得阻拦用户主动退出。

#### 2.4.2 退出方式

**1. 按钮退出**

- **退出按钮**：在界面明显位置提供"退出"按钮
- **位置**：建议在界面右上角或底部导航栏
- **样式**：按钮样式清晰，易于识别

**2. 关键词退出**

- **触发词**：支持"退出"、"再见"、"结束"等关键词触发退出
- **确认机制**：可以通过关键词触发，然后弹窗确认退出
- **智能识别**：需要识别用户真实退出意图，避免误触发

**3. 手势退出**

- **移动端**：支持滑动退出、返回键退出等手势
- **Web端**：支持快捷键退出（如ESC键）

**4. 超时退出**

- **空闲超时**：用户超过一定时间未操作（如30分钟），可以提示是否退出
- **自动退出**：超时后可以自动退出（需用户同意开启此功能）

#### 2.4.3 退出流程

```
用户发起退出
    ↓
确认退出意图（可选，避免误操作）
    ↓
保存用户数据（如果有需要保存的数据）
    ↓
清理会话状态
    ↓
记录退出日志
    ↓
退出完成
```

#### 2.4.4 退出确认

- **可选确认**：可以设置是否需要退出确认（默认开启）
- **确认方式**：使用弹窗确认，询问"确定要退出吗？"
- **快速退出**：用户可以选择"不再询问"快速退出

---

### 2.5 基础安全日志模块

#### 2.5.1 功能描述

记录AI互动服务中的安全相关事件和操作，用于安全审计、问题追溯和合规管理。

#### 2.5.2 日志内容

**1. 内容安全检测日志**

- 检测时间
- 用户ID
- 内容类型（用户输入/AI生成）
- 检测内容（脱敏后）
- 检测结果（通过/拦截/标记/警告）
- 风险等级（高/中/低）
- 检测规则匹配情况

**2. AI标识提醒日志**

- 提醒时间
- 用户ID
- 提醒类型（初次使用/重新登录/依赖倾向/定期提醒）
- 提醒方式（弹窗/横幅/消息）
- 用户响应（已查看/已关闭/未响应）

**3. 使用时长监控日志**

- 使用开始时间
- 使用结束时间
- 使用时长
- 提醒时间（如果有）
- 用户响应（继续使用/暂停使用）

**4. 退出操作日志**

- 退出时间
- 用户ID
- 退出方式（按钮/关键词/手势/超时）
- 退出前使用时长
- 退出原因（如果有）

#### 2.5.3 日志存储

**1. 存储要求**

- **存储格式**：结构化存储，便于查询和分析
- **存储期限**：至少保存6个月（根据法规要求调整）
- **存储安全**：日志数据需要加密存储
- **备份机制**：定期备份日志数据

**2. 日志脱敏**

- **敏感信息脱敏**：用户输入内容需要进行脱敏处理
- **隐私保护**：不得记录用户完整的敏感对话内容
- **可追溯性**：脱敏后仍能通过日志ID关联到原始数据（需要权限）

#### 2.5.4 日志查询

- **查询接口**：提供日志查询API
- **查询条件**：支持按时间、用户ID、事件类型等条件查询
- **权限控制**：只有授权人员可以查询日志
- **导出功能**：支持日志导出（用于审计）

---

## 三、数据结构设计

### 3.1 内容安全检测记录表

**表名**: `content_security_checks`

**字段设计**:
- `id` (BIGINT, PRIMARY KEY): 记录ID
- `user_id` (BIGINT, NOT NULL): 用户ID
- `session_id` (VARCHAR, NOT NULL): 会话ID
- `content_type` (VARCHAR, NOT NULL): 内容类型（user_input/ai_output）
- `content_hash` (VARCHAR): 内容哈希值（用于去重，不存储原文）
- `content_preview` (TEXT): 内容预览（脱敏后，前100字符）
- `risk_level` (VARCHAR, NOT NULL): 风险等级（high/medium/low/safe）
- `check_result` (VARCHAR, NOT NULL): 检测结果（blocked/tagged/warning/passed）
- `matched_rules` (TEXT): 匹配的规则列表（JSON格式）
- `check_time` (DATETIME, NOT NULL): 检测时间
- `processed` (BOOLEAN, DEFAULT FALSE): 是否已处理
- `handler_id` (BIGINT): 处理人ID（如果是人工处理）

**索引**:
- `idx_user_time` (user_id, check_time)
- `idx_risk_level` (risk_level, check_time)
- `idx_session` (session_id)

---

### 3.2 AI标识提醒记录表

**表名**: `ai_identity_reminders`

**字段设计**:
- `id` (BIGINT, PRIMARY KEY): 记录ID
- `user_id` (BIGINT, NOT NULL): 用户ID
- `session_id` (VARCHAR): 会话ID
- `reminder_type` (VARCHAR, NOT NULL): 提醒类型（first_use/re_login/dependency/periodic）
- `reminder_method` (VARCHAR, NOT NULL): 提醒方式（popup/banner/message）
- `reminder_time` (DATETIME, NOT NULL): 提醒时间
- `user_response` (VARCHAR): 用户响应（viewed/closed/ignored）
- `response_time` (DATETIME): 用户响应时间
- `is_dismissed` (BOOLEAN, DEFAULT FALSE): 是否已关闭

**索引**:
- `idx_user_time` (user_id, reminder_time)
- `idx_type` (reminder_type)

---

### 3.3 使用时长记录表

**表名**: `usage_duration_records`

**字段设计**:
- `id` (BIGINT, PRIMARY KEY): 记录ID
- `user_id` (BIGINT, NOT NULL): 用户ID
- `session_id` (VARCHAR, NOT NULL): 会话ID
- `start_time` (DATETIME, NOT NULL): 开始使用时间
- `end_time` (DATETIME): 结束使用时间
- `duration_seconds` (INT): 使用时长（秒）
- `reminder_count` (INT, DEFAULT 0): 提醒次数
- `last_reminder_time` (DATETIME): 最后提醒时间
- `reminder_threshold` (INT, DEFAULT 7200): 提醒阈值（秒，默认2小时）

**索引**:
- `idx_user_time` (user_id, start_time)
- `idx_session` (session_id)

---

### 3.4 退出操作记录表

**表名**: `exit_operations`

**字段设计**:
- `id` (BIGINT, PRIMARY KEY): 记录ID
- `user_id` (BIGINT, NOT NULL): 用户ID
- `session_id` (VARCHAR, NOT NULL): 会话ID
- `exit_method` (VARCHAR, NOT NULL): 退出方式（button/keyword/gesture/timeout）
- `exit_time` (DATETIME, NOT NULL): 退出时间
- `duration_before_exit` (INT): 退出前使用时长（秒）
- `exit_reason` (VARCHAR): 退出原因（user_request/timeout/error）
- `is_confirmed` (BOOLEAN): 是否已确认退出

**索引**:
- `idx_user_time` (user_id, exit_time)
- `idx_session` (session_id)

---

### 3.5 安全配置表

**表名**: `security_configs`

**字段设计**:
- `id` (BIGINT, PRIMARY KEY): 配置ID
- `config_key` (VARCHAR, NOT NULL, UNIQUE): 配置键
- `config_value` (TEXT, NOT NULL): 配置值（JSON格式）
- `config_type` (VARCHAR, NOT NULL): 配置类型（content_check/ai_reminder/duration_monitor/exit）
- `description` (TEXT): 配置说明
- `is_enabled` (BOOLEAN, DEFAULT TRUE): 是否启用
- `updated_at` (DATETIME, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP): 更新时间
- `updated_by` (BIGINT): 更新人ID

**索引**:
- `idx_config_key` (config_key)
- `idx_type` (config_type)

---

## 四、API接口设计

### 4.1 内容安全检测接口

**接口**: `POST /api/security/content/check`

**功能**: 检测内容是否安全

**请求参数**:
- `content` (string, required): 待检测内容
- `contentType` (string, required): 内容类型（user_input/ai_output）
- `sessionId` (string, required): 会话ID

**响应数据**:
- `result` (string): 检测结果（passed/blocked/tagged/warning）
- `riskLevel` (string): 风险等级（safe/low/medium/high）
- `matchedRules` (array): 匹配的规则列表
- `suggestion` (string): 处理建议

---

### 4.2 AI标识提醒接口

**接口**: `POST /api/security/ai-reminder/check`

**功能**: 检查是否需要显示AI标识提醒

**请求参数**:
- `sessionId` (string, required): 会话ID
- `reminderType` (string): 提醒类型（first_use/re_login/dependency/periodic）

**响应数据**:
- `shouldShow` (boolean): 是否应该显示提醒
- `reminderType` (string): 提醒类型
- `reminderContent` (string): 提醒内容
- `reminderMethod` (string): 提醒方式（popup/banner/message）

**接口**: `POST /api/security/ai-reminder/record`

**功能**: 记录提醒显示和用户响应

**请求参数**:
- `reminderId` (string, required): 提醒ID
- `userResponse` (string): 用户响应（viewed/closed/ignored）

---

### 4.3 使用时长监控接口

**接口**: `GET /api/security/duration/current`

**功能**: 获取当前使用时长

**请求参数**:
- `sessionId` (string, required): 会话ID

**响应数据**:
- `durationSeconds` (integer): 当前使用时长（秒）
- `shouldRemind` (boolean): 是否应该提醒
- `reminderThreshold` (integer): 提醒阈值（秒）

**接口**: `POST /api/security/duration/remind`

**功能**: 记录使用时长提醒

**请求参数**:
- `sessionId` (string, required): 会话ID
- `reminderTime` (datetime, required): 提醒时间

---

### 4.4 退出操作接口

**接口**: `POST /api/security/exit`

**功能**: 处理用户退出操作

**请求参数**:
- `sessionId` (string, required): 会话ID
- `exitMethod` (string, required): 退出方式（button/keyword/gesture/timeout）
- `exitReason` (string): 退出原因

**响应数据**:
- `success` (boolean): 是否成功
- `message` (string): 响应消息

---

### 4.5 安全日志查询接口

**接口**: `GET /api/security/logs`

**功能**: 查询安全日志

**请求参数**:
- `logType` (string): 日志类型（content_check/ai_reminder/duration/exit）
- `userId` (bigint): 用户ID
- `startTime` (datetime): 开始时间
- `endTime` (datetime): 结束时间
- `page` (integer): 页码
- `size` (integer): 每页数量

**响应数据**:
- `logs` (array): 日志列表
- `total` (integer): 总记录数
- `page` (integer): 当前页码
- `size` (integer): 每页数量

---

## 五、业务流程设计

### 5.1 内容安全检测流程

```
用户输入消息/AI生成回复
        ↓
调用内容安全检测接口
        ↓
执行检测（关键词+语义+规则）
        ↓
    ┌───┴───┐
  高风险  其他
    ↓       ↓
  拦截    标记/警告/通过
    ↓       ↓
记录日志  记录日志
    ↓       ↓
返回结果  返回结果
```

### 5.2 AI标识提醒流程

```
用户进入对话/重新登录/检测到依赖
        ↓
检查提醒配置和用户状态
        ↓
判断是否需要提醒
        ↓
    ┌───┴───┐
  需要    不需要
    ↓       ↓
显示提醒  不显示
    ↓
记录提醒日志
    ↓
用户响应
    ↓
记录响应日志
```

### 5.3 使用时长监控流程

```
用户开始使用服务
        ↓
创建使用时长记录
        ↓
定期检查使用时长（如每分钟）
        ↓
    ┌───┴──────────┐
  超过阈值  未超过
    ↓          ↓
显示提醒    继续监控
    ↓
记录提醒日志
    ↓
用户响应（继续/暂停）
    ↓
更新记录
```

### 5.4 退出操作流程

```
用户发起退出
        ↓
确认退出意图（可选）
        ↓
保存使用数据（如使用时长）
        ↓
清理会话状态
        ↓
记录退出日志
        ↓
返回退出成功
```

---

## 六、技术实现要点

### 6.1 内容安全检测技术

**1. 关键词检测**
- 维护敏感词库
- 使用高效的字符串匹配算法（如AC自动机）
- 支持同音字、形近字、拼音检测

**2. 语义检测**
- 使用AI模型进行语义理解
- 识别隐晦表达和变体
- 评估内容意图和风险

**3. 规则引擎**
- 使用规则引擎配置复杂检测规则
- 支持正则表达式
- 支持多规则组合判断

**4. 性能优化**
- 使用缓存减少重复检测
- 异步处理非关键路径
- 批量检测优化

### 6.2 前端实现要点

**1. AI标识显示**
- 在对话界面显著位置显示标识
- 使用图标和文字组合
- 样式要清晰但不突兀

**2. 提醒实现**
- 使用Modal、Toast等组件实现提醒
- 支持多种提醒方式
- 优雅的动画效果

**3. 使用时长显示**
- 实时显示当前使用时长
- 使用友好的时间格式
- 提醒时的视觉效果

**4. 退出功能**
- 明显的退出按钮
- 支持多种退出方式
- 退出确认机制

### 6.3 后端实现要点

**1. 检测服务**
- 独立的检测服务，便于扩展
- 支持插件化检测器
- 异步检测不影响用户体验

**2. 日志记录**
- 异步记录日志，不影响性能
- 日志结构化存储
- 支持日志查询和分析

**3. 配置管理**
- 安全策略可配置
- 支持动态更新配置
- 配置变更审计

---

## 七、实施计划

### 7.1 第一阶段：内容安全检测（1周）

- [ ] 设计敏感词库结构
- [ ] 实现关键词检测功能
- [ ] 集成第三方内容安全检测服务（可选）
- [ ] 实现检测规则引擎
- [ ] 开发内容安全检测API
- [ ] 前端集成内容检测
- [ ] 单元测试和集成测试

### 7.2 第二阶段：AI标识和提醒（0.5周）

- [ ] 设计AI标识UI组件
- [ ] 实现静态标识显示
- [ ] 实现动态提醒功能
- [ ] 开发提醒记录API
- [ ] 前端集成提醒功能
- [ ] 测试提醒逻辑

### 7.3 第三阶段：使用时长监控（0.5周）

- [ ] 设计使用时长记录逻辑
- [ ] 实现时长监控服务
- [ ] 实现2小时提醒功能
- [ ] 开发时长监控API
- [ ] 前端集成时长显示和提醒
- [ ] 测试时长监控功能

### 7.4 第四阶段：退出机制（0.5周）

- [ ] 设计退出流程
- [ ] 实现退出API
- [ ] 前端实现退出功能
- [ ] 支持多种退出方式
- [ ] 测试退出功能

### 7.5 第五阶段：安全日志（0.5周）

- [ ] 设计日志数据结构
- [ ] 实现日志记录服务
- [ ] 实现日志查询API
- [ ] 前端开发日志查看界面（可选）
- [ ] 测试日志功能

### 7.6 第六阶段：测试和优化（1周）

- [ ] 功能测试
- [ ] 性能测试
- [ ] 安全测试
- [ ] 用户体验优化
- [ ] Bug修复
- [ ] 文档完善

---

## 八、验收标准

### 8.1 功能验收

- ✅ 内容安全检测能正确识别高风险内容并拦截
- ✅ AI身份标识在界面显著位置清晰显示
- ✅ 动态提醒在指定场景正确触发
- ✅ 使用时长超过2小时能正确提醒
- ✅ 用户可以通过多种方式便捷退出
- ✅ 所有安全事件都有完整的日志记录

### 8.2 性能验收

- ✅ 内容检测延迟 < 500ms（P95）
- ✅ 支持至少1000 QPS的并发检测
- ✅ 日志记录不影响主业务性能
- ✅ 系统整体可用性 > 99.9%

### 8.3 合规验收

- ✅ 符合管理办法第七条要求（内容安全）
- ✅ 符合管理办法第十六条要求（AI标识）
- ✅ 符合管理办法第十七条要求（使用时长提醒）
- ✅ 符合管理办法第十八条要求（退出机制）
- ✅ 符合管理办法第九条要求（安全日志）

---

## 九、风险和注意事项

### 9.1 技术风险

- **检测准确性**：内容检测可能存在误报和漏报，需要持续优化
- **性能影响**：检测可能影响用户体验，需要优化性能
- **可扩展性**：需要设计良好的架构，支持未来扩展

### 9.2 业务风险

- **用户体验**：过多的提醒可能影响用户体验，需要平衡
- **合规风险**：需要持续关注法规变化，及时调整
- **误拦截**：误拦截可能影响正常使用，需要快速响应和处理

### 9.3 注意事项

- 内容检测需要保护用户隐私，不要存储完整内容
- 提醒不能过于频繁，避免打扰用户
- 日志记录需要脱敏，保护用户隐私
- 配置管理需要权限控制，防止误配置

---

**文档状态**: 阶段一需求分析已完成，等待开发实施

