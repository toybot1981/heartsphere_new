# 记忆系统实施优先级与路线图

**文档版本**: V1.1  
**编写日期**: 2025-12-28  
**更新日期**: 2025-12-28

---

## 一、实施优先级

### 1.1 优先级原则

根据业务价值和实现复杂度，确定以下优先级：

1. **高优先级**：用户记忆 + 角色记忆
   - 核心业务价值：让AI角色能够记住用户，提供个性化体验
   - 实现复杂度：中等
   - 业务影响：直接影响用户体验

2. **中优先级**：高级记忆能力
   - 业务价值：提升记忆检索的准确性和效率
   - 实现复杂度：较高
   - 业务影响：优化体验，但不是必需

3. **低优先级**：参与者记忆
   - 业务价值：支持多用户协作场景
   - 实现复杂度：中等
   - 业务影响：特定场景需要，非核心功能

4. **持续优化**：系统优化
   - 业务价值：提升系统性能和稳定性
   - 实现复杂度：中等
   - 业务影响：长期优化

---

## 二、第一阶段：用户记忆系统（优先实施）

### 2.1 目标

建立完整的用户记忆系统，让系统能够：
- 记住用户的基本信息和偏好
- 在对话中自动提取和保存用户信息
- 跨会话检索用户记忆，提供个性化体验

### 2.2 核心功能

#### 2.2.1 短期记忆（Redis）

**功能**：
- ✅ 对话上下文管理（最近100条消息）
- ✅ 会话状态管理
- ✅ 工作记忆（临时数据）

**实现**：
- Redis List存储对话消息
- 自动过期（7天TTL）
- 容量限制（100条/会话）

#### 2.2.2 长期记忆（MongoDB）

**功能**：
- ✅ 用户事实存储（UserFact）
- ✅ 用户偏好存储（UserPreference）
- ✅ 用户记忆检索

**实现**：
- MongoDB集合：`user_facts`、`user_preferences`、`user_memories`
- 文本搜索索引
- 重要性评分和衰减机制

#### 2.2.3 记忆提取

**功能**：
- ✅ 从对话中自动提取用户信息
- ✅ LLM驱动的智能提取
- ✅ 规则提取（备用方案）

**实现**：
- LLMMemoryExtractor：使用大模型提取
- RuleBasedMemoryExtractor：规则提取备用
- 提取验证和去重

#### 2.2.4 记忆检索

**功能**：
- ✅ 关键词检索
- ✅ 上下文相关检索
- ✅ 混合检索（短期+长期）

**实现**：
- 基于MongoDB文本搜索
- 相关性评分和排序
- 缓存优化

### 2.3 交付清单

**代码**：
- [ ] ShortMemoryService（Redis实现）
- [ ] LongMemoryService（MongoDB实现）
- [ ] MemoryManager（记忆管理器）
- [ ] MemoryExtractor（记忆提取器）
- [ ] MemoryController（REST API）

**数据模型**：
- [ ] ChatMessage（对话消息）
- [ ] UserFact（用户事实）
- [ ] UserPreference（用户偏好）
- [ ] UserMemory（用户记忆）

**API接口**：
- [ ] 短期记忆API（消息管理、工作记忆）
- [ ] 长期记忆API（事实、偏好、检索）
- [ ] 记忆提取API

**文档**：
- [ ] API文档
- [ ] 数据库设计文档
- [ ] 使用指南

### 2.4 验收标准

- ✅ 短期记忆读写延迟 < 10ms
- ✅ 长期记忆检索延迟 < 100ms
- ✅ 记忆提取准确率 > 70%
- ✅ API接口覆盖核心功能
- ✅ 单元测试覆盖率 > 80%

---

## 三、第二阶段：角色记忆系统（优先实施）

### 3.1 目标

让每个E-SOUL角色拥有独立的记忆能力，能够：
- 记住角色自身的信息和背景
- 记住与用户的交互历史
- 在不同场景中保持独立的记忆
- 根据记忆调整对话风格

### 3.2 核心功能

#### 3.2.1 角色自身记忆

**功能**：
- ✅ 角色背景记忆（基本信息、性格、经历）
- ✅ 角色性格记忆（性格特点、行为模式）
- ✅ 角色经历记忆（重要经历和事件）

**实现**：
- MongoDB集合：`character_self_memories`
- 支持角色信息的CRUD操作

#### 3.2.2 角色与用户交互记忆

**功能**：
- ✅ 角色与用户的对话历史
- ✅ 用户偏好记忆（角色记住用户的偏好）
- ✅ 情感记忆（角色记住与用户的情感互动）
- ✅ 重要时刻记忆

**实现**：
- MongoDB集合：`character_interaction_memories`
- 按用户ID和场景ID索引
- 支持交互历史的检索和更新

#### 3.2.3 角色场景记忆

**功能**：
- ✅ 场景隔离（不同场景切片中的记忆相互隔离）
- ✅ 场景上下文（角色在特定场景中的表现）
- ✅ 场景切换记忆继承（可选）

**实现**：
- MongoDB集合：`character_scene_memories`
- 按角色ID和场景ID（eraId）索引
- 支持场景记忆的继承机制

#### 3.2.4 角色关系记忆

**功能**：
- ✅ 角色间关系（角色与其他角色的关系）
- ✅ 关系历史（关系变化历史）
- ✅ 关系强度（关系强度评估）

**实现**：
- MongoDB集合：`character_relationship_memories`
- 双向关系存储
- 关系强度动态更新

### 3.3 交付清单

**代码**：
- [ ] CharacterMemoryService（角色记忆服务）
- [ ] CharacterMemoryController（REST API）
- [ ] 角色记忆集成到对话系统

**数据模型**：
- [ ] CharacterSelfMemory（角色自身记忆）
- [ ] CharacterInteractionMemory（角色交互记忆）
- [ ] CharacterSceneMemory（角色场景记忆）
- [ ] CharacterRelationshipMemory（角色关系记忆）

**API接口**：
- [ ] 角色自身记忆API
- [ ] 角色交互记忆API
- [ ] 角色场景记忆API
- [ ] 角色关系记忆API
- [ ] 角色记忆检索API

**集成**：
- [ ] 对话系统集成（角色记忆自动提取和检索）
- [ ] 场景切换时的记忆处理

### 3.4 验收标准

- ✅ 每个角色拥有独立的记忆体系
- ✅ 角色能够记住与用户的交互历史
- ✅ 角色在不同场景中的记忆正确隔离
- ✅ 角色记忆检索延迟 < 150ms
- ✅ API接口覆盖角色记忆的所有功能

---

## 四、实施路线图

### 4.1 时间线

```
第1-6周：阶段一 - 用户记忆系统
  ├─ 第1-2周：短期记忆系统（Redis）
  ├─ 第3-4周：长期记忆系统（MongoDB）
  ├─ 第5周：记忆提取和检索
  └─ 第6周：API接口和测试

第7-12周：阶段二 - 角色记忆系统
  ├─ 第7-8周：角色记忆数据模型和服务
  ├─ 第9-10周：角色交互记忆和场景记忆
  ├─ 第11周：角色关系记忆
  └─ 第12周：集成到对话系统和测试

第13周+：后续阶段（根据业务需要）
  ├─ 阶段四：高级记忆能力（可选）
  ├─ 阶段五：系统优化（持续）
  └─ 阶段三：参与者记忆（暂缓）
```

### 4.2 里程碑

**里程碑1：用户记忆系统完成（第6周）**
- ✅ 短期记忆和长期记忆基础功能完成
- ✅ 记忆提取和检索功能完成
- ✅ API接口完成并测试通过
- ✅ 可以开始使用用户记忆功能

**里程碑2：角色记忆系统完成（第12周）**
- ✅ 角色记忆所有功能完成
- ✅ 角色记忆集成到对话系统
- ✅ 角色能够记住用户并个性化对话
- ✅ 可以开始使用角色记忆功能

**里程碑3：系统稳定运行（第16周）**
- ✅ 用户记忆和角色记忆稳定运行
- ✅ 性能优化完成
- ✅ 监控和诊断系统完成
- ✅ 可以开始考虑后续功能

---

## 五、暂缓功能说明

### 5.1 参与者记忆系统（阶段三）

**暂缓原因**：
- 当前业务重点在用户与AI角色的交互
- 多用户协作场景需求不紧急
- 先完成核心功能，再扩展社交功能

**后续计划**：
- 待用户记忆和角色记忆稳定运行后
- 根据业务需求决定是否实施
- 预计在系统运行3-6个月后评估

### 5.2 高级记忆能力（阶段四）

**暂缓原因**：
- 基础记忆检索已能满足当前需求
- 向量搜索和语义检索需要额外资源
- 可以先用关键词检索，后续优化

**后续计划**：
- 待基础功能稳定后
- 根据检索效果决定是否需要
- 预计在系统运行2-3个月后评估

---

## 六、风险与应对

### 6.1 技术风险

**风险1：记忆提取准确率不足**
- **应对**：使用LLM提取+规则提取双重保障
- **监控**：定期检查提取准确率，持续优化

**风险2：MongoDB查询性能**
- **应对**：合理设计索引，优化查询语句
- **监控**：监控查询延迟，及时优化

### 6.2 业务风险

**风险1：用户记忆隐私问题**
- **应对**：数据加密存储，访问权限控制
- **监控**：审计日志，异常检测

**风险2：角色记忆数据量大**
- **应对**：定期归档，数据压缩
- **监控**：监控存储使用量，及时清理

---

## 七、成功标准

### 7.1 功能标准

- ✅ 用户记忆系统完整可用
- ✅ 角色记忆系统完整可用
- ✅ 记忆提取准确率 > 70%
- ✅ 记忆检索响应时间 < 150ms
- ✅ API接口完整且稳定

### 7.2 性能标准

- ✅ 短期记忆读写延迟 < 10ms
- ✅ 长期记忆检索延迟 < 100ms
- ✅ 支持1000+并发用户
- ✅ 系统可用性 > 99.5%

### 7.3 质量标准

- ✅ 单元测试覆盖率 > 80%
- ✅ 集成测试通过率 100%
- ✅ 代码审查通过
- ✅ 文档完整

---

## 八、总结

### 8.1 当前重点

**优先实施**：
1. ✅ 用户记忆系统（阶段一）
2. ✅ 角色记忆系统（阶段二）

**暂缓实施**：
1. ⏸️ 参与者记忆系统（阶段三）
2. 🔄 高级记忆能力（阶段四）
3. 🔄 系统优化（阶段五）

### 8.2 实施原则

1. **聚焦核心**：优先实现用户和角色的记忆能力
2. **稳定优先**：确保核心功能稳定后再扩展
3. **迭代优化**：持续优化和优化现有功能
4. **按需扩展**：根据业务需求决定后续功能

通过聚焦用户记忆和角色记忆，可以快速实现核心价值，为后续扩展打下坚实基础。



