# 日记与记忆系统联动说明

## 概述

日记功能已与记忆系统集成，当用户创建或更新日记时，系统会自动从日记内容中提取记忆，并将这些记忆保存到**后端的Redis（短期记忆）和MongoDB（长期记忆）**中，用于后续的对话上下文和个性化服务。

## 存储架构

### 后端存储

- **短期记忆（Redis）**：存储对话上下文、会话状态等临时数据
- **长期记忆（MongoDB）**：存储用户事实、偏好、记忆等持久化数据

### 前端实现

- **RemoteMemoryStorage**：连接到后端API，将记忆保存到Redis/MongoDB
- **LocalMemoryStorage**：本地存储实现（可选，用于离线场景）

## 功能特性

### 1. 自动记忆提取

当用户创建或更新日记时，系统会自动：

- **提取日记内容中的记忆**：从标题、内容、洞察（insight）和标签中提取关键信息
- **保存到后端MongoDB**：通过 `/api/memory/v1/users/{userId}/facts` API保存
- **保存洞察为重要记忆**：如果日记包含AI生成的洞察，会将其作为重要反思记忆保存
- **提取标签为偏好记忆**：日记中的标签会被提取为用户偏好记忆

### 2. 记忆类型

从日记中提取的记忆类型包括：

- **个人信息** (`PERSONAL_INFO`)：姓名、年龄、生日等
- **偏好** (`PREFERENCE`)：兴趣爱好、标签偏好等
- **重要时刻** (`IMPORTANT_MOMENT`)：重要事件和经历
- **情感经历** (`EMOTIONAL_EXPERIENCE`)：情感相关的体验
- **习惯** (`HABIT`)：日常习惯和行为模式
- **反思** (`REFLECTION`)：AI生成的洞察和反思

### 3. 记忆来源

所有从日记中提取的记忆都会标记为 `MemorySource.JOURNAL`，并关联到对应的日记ID（`sourceId`），便于追溯和关联。

## 技术实现

### 核心组件

1. **JournalMemoryIntegration** (`frontend/services/journal-memory-integration/JournalMemoryIntegration.ts`)
   - 日记记忆集成服务类
   - 负责从日记中提取记忆
   - 使用 `RemoteMemoryStorage` 连接到后端

2. **RemoteMemoryStorage** (`frontend/services/memory-system/storage/RemoteMemoryStorage.ts`)
   - 远程记忆存储实现
   - 通过 `memoryApi` 连接到后端API
   - 将记忆保存到Redis/MongoDB

3. **memoryApi** (`frontend/services/api/memory/memory.ts`)
   - 记忆系统API客户端
   - 提供保存、搜索、更新、删除记忆的接口
   - 连接到 `/api/memory/v1` 端点

4. **useJournalHandlers** (`frontend/hooks/useJournalHandlers.ts`)
   - 日记操作Hook
   - 在创建/更新日记后自动调用记忆提取

### 集成流程

```
用户创建/更新日记
    ↓
调用 journalApi 保存到服务器
    ↓
从服务器重新获取所有日记
    ↓
更新本地状态
    ↓
异步调用 JournalMemoryIntegration.extractMemoriesFromJournal()
    ↓
从日记内容中提取记忆
    ↓
通过 RemoteMemoryStorage 保存到后端MongoDB
    ↓
记忆存储在服务器的MongoDB中（长期记忆）
```

### 配置选项

记忆提取可以通过 `JournalMemoryIntegrationConfig` 配置：

```typescript
{
  enabled: boolean;      // 是否启用记忆提取
  autoExtract: boolean;  // 是否自动提取
  aiEnhanced: boolean;  // 是否使用AI增强提取
  userId: number;        // 用户ID
}
```

**注意**：系统默认使用 `useRemoteStorage: true`，所有记忆都会保存到后端的Redis/MongoDB。

## 使用场景

### 1. 对话上下文增强

当用户与角色对话时，系统可以从MongoDB中检索相关记忆，提供更个性化的对话体验。

```typescript
// 获取与日记相关的记忆
const relevantMemories = await journalMemoryIntegration.getRelevantMemoriesForJournal(
  journalEntry,
  5 // 最多返回5条相关记忆
);
```

### 2. 个性化推荐

基于MongoDB中存储的偏好和习惯记忆，系统可以提供个性化的内容推荐。

### 3. 情感分析

从日记中提取的情感经历和模式，可以用于情感分析和支持。

## 查看记忆

### 在日记界面查看

1. 打开日记界面（RealWorldScreen）
2. 点击顶部的"🧠 我的记忆"按钮
3. 在记忆查看模态框中查看所有从日记中提取的记忆
4. 可以按类型、重要性、关键词筛选记忆

### 记忆存储位置

- **后端MongoDB**：`user_memories` 集合
- **后端Redis**：短期记忆（会话上下文）
- **前端localStorage**：仅用于离线缓存（如果启用）

## 注意事项

1. **网络连接**：记忆提取和保存需要网络连接，如果网络不可用，会记录错误日志
2. **异步处理**：记忆提取是异步进行的，不会阻塞日记的创建/更新流程
3. **错误处理**：如果记忆提取失败，不会影响日记的正常保存
4. **性能考虑**：记忆提取使用AI增强模式时，可能需要一些时间，但不会影响用户体验
5. **数据持久化**：所有记忆都存储在服务器的MongoDB中，不会因为清除浏览器缓存而丢失

## 未来扩展

1. **批量导入**：支持从历史日记中批量提取记忆
2. **记忆关联**：建立日记之间的记忆关联网络
3. **记忆可视化**：展示从日记中提取的记忆图谱
4. **智能提醒**：基于日记记忆提供智能提醒和建议
5. **向量搜索**：使用向量搜索实现更智能的记忆检索
