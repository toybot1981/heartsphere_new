# 记忆系统性能测试指南

**文档版本**: V1.0  
**编写日期**: 2025-12-28

---

## 📋 测试概述

本文档提供记忆系统的性能测试指南，包括测试目标、测试方法、测试工具和性能指标。

---

## 🎯 性能目标

### 短期记忆（Redis）

- **消息保存延迟**: < 10ms
- **消息检索延迟**: < 5ms
- **工作记忆读写延迟**: < 5ms
- **并发支持**: 1000+ 并发用户

### 长期记忆（MongoDB）

- **事实保存延迟**: < 50ms
- **事实检索延迟**: < 100ms
- **记忆检索延迟**: < 100ms
- **文本搜索延迟**: < 200ms
- **并发支持**: 500+ 并发用户

### 记忆提取

- **LLM提取响应时间**: < 5秒
- **规则提取响应时间**: < 100ms
- **批量提取吞吐量**: > 10条/秒

### API接口

- **API响应时间**: < 200ms（P95）
- **API吞吐量**: > 100请求/秒
- **错误率**: < 0.1%

---

## 🔧 测试工具

### 1. JMeter

**用途**: 压力测试和负载测试

**配置示例**:
```xml
<ThreadGroup>
  <stringProp name="ThreadGroup.on_sample_error">continue</stringProp>
  <elementProp name="ThreadGroup.main_controller" elementType="LoopController">
    <boolProp name="LoopController.continue_forever">false</boolProp>
    <stringProp name="LoopController.loops">100</stringProp>
  </elementProp>
  <stringProp name="ThreadGroup.num_threads">100</stringProp>
  <stringProp name="ThreadGroup.ramp_time">10</stringProp>
</ThreadGroup>
```

### 2. Gatling

**用途**: 高性能负载测试

**配置示例**:
```scala
val scn = scenario("Memory API Test")
  .exec(http("Save Message")
    .post("/api/memory/v1/sessions/test/messages")
    .body(StringBody("""{"role":"USER","content":"test"}""")))
  .pause(1)
  .exec(http("Get Messages")
    .get("/api/memory/v1/sessions/test/messages"))
```

### 3. 自定义性能测试

**用途**: 针对性的性能测试

---

## 📊 测试场景

### 场景1：短期记忆读写性能

**目标**: 测试Redis短期记忆的读写性能

**测试步骤**:
1. 创建1000个会话
2. 每个会话保存100条消息
3. 并发读取消息
4. 测量延迟和吞吐量

**预期结果**:
- 写入延迟 < 10ms
- 读取延迟 < 5ms
- 吞吐量 > 1000 ops/s

### 场景2：长期记忆检索性能

**目标**: 测试MongoDB长期记忆的检索性能

**测试步骤**:
1. 创建10000条用户事实
2. 执行各种检索操作
3. 测量延迟

**预期结果**:
- 简单查询 < 50ms
- 文本搜索 < 200ms
- 复杂查询 < 300ms

### 场景3：记忆提取性能

**目标**: 测试记忆提取的性能

**测试步骤**:
1. 准备100个会话，每个会话包含50条消息
2. 并发执行记忆提取
3. 测量响应时间和成功率

**预期结果**:
- LLM提取 < 5秒
- 规则提取 < 100ms
- 成功率 > 95%

### 场景4：API压力测试

**目标**: 测试API在高负载下的表现

**测试步骤**:
1. 模拟1000并发用户
2. 执行各种API操作
3. 测量响应时间、吞吐量、错误率

**预期结果**:
- P95响应时间 < 200ms
- 吞吐量 > 100 req/s
- 错误率 < 0.1%

### 场景5：混合负载测试

**目标**: 测试系统在混合负载下的表现

**测试步骤**:
1. 同时执行读写操作
2. 同时执行记忆提取
3. 测量整体性能

**预期结果**:
- 系统稳定运行
- 性能指标在可接受范围内
- 无内存泄漏

---

## 📈 性能指标监控

### 1. 应用指标

- **响应时间**: P50, P95, P99
- **吞吐量**: 请求/秒
- **错误率**: 错误请求/总请求
- **并发数**: 当前并发用户数

### 2. Redis指标

- **连接数**: 当前连接数
- **内存使用**: 内存占用
- **命令延迟**: 命令执行时间
- **命中率**: 缓存命中率

### 3. MongoDB指标

- **连接数**: 当前连接数
- **查询延迟**: 查询执行时间
- **索引使用**: 索引命中率
- **磁盘IO**: 磁盘读写

### 4. JVM指标

- **堆内存**: 堆内存使用
- **GC时间**: 垃圾回收时间
- **线程数**: 当前线程数
- **CPU使用**: CPU使用率

---

## 🔍 性能优化建议

### 1. Redis优化

- **连接池配置**: 合理配置连接池大小
- **批量操作**: 使用pipeline批量操作
- **数据压缩**: 启用数据压缩
- **持久化策略**: 合理配置持久化

### 2. MongoDB优化

- **索引优化**: 创建合适的索引
- **查询优化**: 优化查询语句
- **分片策略**: 考虑数据分片
- **读写分离**: 使用读写分离

### 3. 应用优化

- **异步处理**: 使用异步处理耗时操作
- **缓存策略**: 合理使用缓存
- **连接池**: 优化数据库连接池
- **线程池**: 优化线程池配置

---

## 📝 测试报告模板

### 测试环境

- **测试时间**: ___________
- **测试工具**: ___________
- **测试数据量**: ___________
- **并发用户数**: ___________

### 测试结果

#### 短期记忆性能

| 操作 | 平均延迟 | P95延迟 | P99延迟 | 吞吐量 |
|------|---------|---------|---------|--------|
| 保存消息 | ___ms | ___ms | ___ms | ___ops/s |
| 获取消息 | ___ms | ___ms | ___ms | ___ops/s |

#### 长期记忆性能

| 操作 | 平均延迟 | P95延迟 | P99延迟 | 吞吐量 |
|------|---------|---------|---------|--------|
| 保存事实 | ___ms | ___ms | ___ms | ___ops/s |
| 搜索事实 | ___ms | ___ms | ___ms | ___ops/s |
| 检索记忆 | ___ms | ___ms | ___ms | ___ops/s |

#### API性能

| 接口 | 平均延迟 | P95延迟 | P99延迟 | 吞吐量 | 错误率 |
|------|---------|---------|---------|--------|--------|
| POST /messages | ___ms | ___ms | ___ms | ___req/s | ___% |
| GET /messages | ___ms | ___ms | ___ms | ___req/s | ___% |

### 结论

- ✅ / ❌ 性能目标是否达成
- 主要瓶颈: ___________
- 优化建议: ___________

---

## 🚀 持续性能监控

### 1. 监控工具

- **Prometheus**: 指标收集
- **Grafana**: 可视化展示
- **ELK**: 日志分析

### 2. 告警规则

- **响应时间告警**: P95 > 200ms
- **错误率告警**: 错误率 > 1%
- **资源使用告警**: CPU > 80%, 内存 > 80%

### 3. 性能回归测试

- **定期执行**: 每周执行一次
- **版本对比**: 对比不同版本的性能
- **趋势分析**: 分析性能趋势

---

## 📚 参考文档

- [阶段一详细设计](./02-阶段一：基础记忆系统.md)
- [测试指南](./测试指南.md)
- [API文档](./07-API文档.md)

---

**开始性能测试！** 🚀

