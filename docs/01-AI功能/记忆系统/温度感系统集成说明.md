# è®°å¿†ç³»ç»Ÿä¸æ¸©åº¦æ„Ÿç³»ç»Ÿé›†æˆè¯´æ˜

**æ–‡æ¡£ç‰ˆæœ¬**: V1.0  
**ç¼–å†™æ—¥æœŸ**: 2025-12-28

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜è®°å¿†ç³»ç»Ÿå¦‚ä½•ä¸æ¸©åº¦æ„Ÿç³»ç»Ÿé›†æˆï¼Œå®ç°æƒ…æ„Ÿè®°å¿†çš„è‡ªåŠ¨æå–ã€å­˜å‚¨å’Œæ£€ç´¢ã€‚

---

## ğŸ”— é›†æˆæ¶æ„

### 1. æ ¸å¿ƒç»„ä»¶

```
æ¸©åº¦æ„Ÿç³»ç»Ÿ                   è®°å¿†ç³»ç»Ÿ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚EmotionServiceâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚Temperature  â”‚
â”‚             â”‚             â”‚MemoryServiceâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚MemoryManagerâ”‚
                            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼              â–¼              â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ShortMemoryâ”‚  â”‚LongMemoryâ”‚  â”‚Extractor â”‚
            â”‚  Service  â”‚  â”‚  Service â”‚  â”‚          â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ•°æ®æµ

1. **æƒ…ç»ªè®°å½•ä¿å­˜** â†’ `EmotionService.saveEmotionRecord()`
2. **è‡ªåŠ¨æå–è®°å¿†** â†’ `TemperatureMemoryService.extractMemoriesFromEmotion()`
3. **ä¿å­˜åˆ°é•¿æœŸè®°å¿†** â†’ `MongoLongMemoryService.saveMemory()`
4. **æ£€ç´¢ç›¸å…³è®°å¿†** â†’ `TemperatureMemoryService.retrieveMemoriesByEmotion()`

---

## ğŸ¯ æ”¯æŒçš„æƒ…æ„Ÿè®°å¿†ç±»å‹

### 1. æƒ…ç»ªæ¨¡å¼è®°å¿† (EMOTION_PATTERN)

**è§¦å‘æ¡ä»¶**ï¼š
- ç½®ä¿¡åº¦ > 0.7
- æƒ…ç»ªå¼ºåº¦ä¸º moderate æˆ– strong

**å­˜å‚¨å†…å®¹**ï¼š
- æƒ…ç»ªç±»å‹
- æƒ…ç»ªå¼ºåº¦
- ç½®ä¿¡åº¦
- æ—¶é—´æˆ³

**ç”¨é€”**ï¼š
- è¯†åˆ«ç”¨æˆ·çš„æƒ…ç»ªæ¨¡å¼
- é¢„æµ‹ç”¨æˆ·å¯èƒ½çš„æƒ…ç»ªçŠ¶æ€

### 2. æƒ…æ„Ÿç»å†è®°å¿† (EMOTIONAL_EXPERIENCE)

**è§¦å‘æ¡ä»¶**ï¼š
- æƒ…ç»ªå¼ºåº¦ä¸º strong
- ç½®ä¿¡åº¦ > 0.7

**å­˜å‚¨å†…å®¹**ï¼š
- æƒ…ç»ªç±»å‹
- è§¦å‘æ–‡æœ¬
- ä¸Šä¸‹æ–‡ä¿¡æ¯
- æ—¶é—´æˆ³

**ç”¨é€”**ï¼š
- è®°å½•ç”¨æˆ·çš„é‡è¦æƒ…æ„Ÿç»å†
- ç”¨äºä¸ªæ€§åŒ–å›åº”ç”Ÿæˆ

### 3. æƒ…ç»ªåå¥½è®°å¿† (EMOTIONAL_PREFERENCE)

**è§¦å‘æ¡ä»¶**ï¼š
- ç§¯ææƒ…ç»ªï¼ˆhappy, excited, contentç­‰ï¼‰
- å…³é”®çŸ­è¯­åŒ…å«åå¥½ç›¸å…³è¯æ±‡

**å­˜å‚¨å†…å®¹**ï¼š
- æƒ…ç»ªç±»å‹
- å…³é”®çŸ­è¯­
- åå¥½ä¿¡æ¯

**ç”¨é€”**ï¼š
- è¯†åˆ«ç”¨æˆ·çš„æƒ…æ„Ÿåå¥½
- ä¼˜åŒ–äº¤äº’ä½“éªŒ

---

## ğŸ’» ä½¿ç”¨æ–¹å¼

### 1. è‡ªåŠ¨æå–ï¼ˆå·²é›†æˆï¼‰

åœ¨ `EmotionService.saveEmotionRecord()` ä¸­è‡ªåŠ¨è°ƒç”¨ï¼š

```java
@Autowired
private TemperatureMemoryService temperatureMemoryService;

public EmotionRecord saveEmotionRecord(EmotionAnalysisResponse analysis, 
                                       EmotionAnalysisRequest request) {
    // ä¿å­˜æƒ…ç»ªè®°å½•
    EmotionRecord record = emotionRecordRepository.save(emotionRecord);
    
    // è‡ªåŠ¨æå–è®°å¿†
    try {
        temperatureMemoryService.extractMemoriesFromEmotion(
            String.valueOf(request.getUserId()), 
            record
        );
    } catch (Exception e) {
        log.error("æå–è®°å¿†å¤±è´¥", e);
        // ä¸å½±å“ä¸»æµç¨‹
    }
    
    return record;
}
```

### 2. æ‰‹åŠ¨æ£€ç´¢è®°å¿†

```java
@Autowired
private TemperatureMemoryService temperatureMemoryService;

// æ ¹æ®æƒ…ç»ªæ£€ç´¢ç›¸å…³è®°å¿†
List<UserMemory> memories = temperatureMemoryService.retrieveMemoriesByEmotion(
    userId, 
    "happy",  // æƒ…ç»ªç±»å‹
    10        // è¿”å›æ•°é‡
);

// è·å–æƒ…ç»ªæ¨¡å¼
List<UserMemory> patterns = temperatureMemoryService.getEmotionPatterns(userId);

// è·å–æƒ…æ„Ÿç»å†
List<UserMemory> experiences = temperatureMemoryService.getEmotionalExperiences(
    userId, 
    "sad",    // å¯é€‰çš„æƒ…ç»ªç±»å‹
    20        // è¿”å›æ•°é‡
);
```

### 3. åˆ†ææƒ…ç»ªè¶‹åŠ¿

```java
// åˆ†æå¹¶ä¿å­˜æƒ…ç»ªè¶‹åŠ¿
UserMemory trend = temperatureMemoryService.analyzeAndSaveEmotionTrend(
    userId, 
    "week"    // æ—¶é—´æ®µï¼šday/week/month
);
```

---

## ğŸ”§ é…ç½®è¯´æ˜

### 1. è®°å¿†æå–é˜ˆå€¼

åœ¨ `application.yml` ä¸­é…ç½®ï¼š

```yaml
heartsphere:
  memory:
    long-memory:
      extraction-importance-threshold: 0.7  # é‡è¦æ€§é˜ˆå€¼
      extraction-confidence-threshold: 0.6   # ç½®ä¿¡åº¦é˜ˆå€¼
```

### 2. MongoDBç´¢å¼•

å·²åˆ›å»ºä»¥ä¸‹ç´¢å¼•æ”¯æŒæƒ…æ„Ÿè®°å¿†æ£€ç´¢ï¼š

```javascript
// user_memoriesé›†åˆç´¢å¼•
db.user_memories.createIndex({ userId: 1, type: 1 });
db.user_memories.createIndex({ userId: 1, "metadata.emotionType": 1 });
db.user_memories.createIndex({ content: "text" });
```

---

## ğŸ“Š æ•°æ®ç»“æ„

### UserMemoryç»“æ„ï¼ˆæƒ…æ„Ÿè®°å¿†ï¼‰

```java
UserMemory {
    userId: String
    type: MemoryType (EMOTION_PATTERN | EMOTIONAL_EXPERIENCE | EMOTIONAL_PREFERENCE)
    importance: MemoryImportance (CORE | IMPORTANT | NORMAL | TEMPORARY)
    content: String
    structuredData: Map {
        emotionType: String
        intensity: String
        confidence: Double
        triggerText: String (å¯é€‰)
        keyPhrases: String (å¯é€‰)
    }
    metadata: Map {
        emotionType: String  // ç”¨äºæ£€ç´¢
        timestamp: String
        source: String
    }
    source: MemorySource (SYSTEM_DETECTED)
    confidence: Double
    tags: List<String>
}
```

---

## ğŸ¨ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šä¸ªæ€§åŒ–å›åº”ç”Ÿæˆ

```java
// 1. æ£€æµ‹åˆ°ç”¨æˆ·æƒ…ç»ª
EmotionAnalysisResponse emotion = emotionService.analyzeEmotion(request);

// 2. æ£€ç´¢ç›¸å…³è®°å¿†
List<UserMemory> memories = temperatureMemoryService.retrieveMemoriesByEmotion(
    userId, 
    emotion.getEmotionType(), 
    5
);

// 3. åŸºäºè®°å¿†ç”Ÿæˆä¸ªæ€§åŒ–å›åº”
String response = generatePersonalizedResponse(emotion, memories);
```

### åœºæ™¯2ï¼šæƒ…ç»ªæ¨¡å¼è¯†åˆ«

```java
// è·å–ç”¨æˆ·çš„æƒ…ç»ªæ¨¡å¼
List<UserMemory> patterns = temperatureMemoryService.getEmotionPatterns(userId);

// åˆ†ææ¨¡å¼
Map<String, Integer> emotionFrequency = new HashMap<>();
for (UserMemory pattern : patterns) {
    String emotionType = (String) pattern.getMetadata().get("emotionType");
    emotionFrequency.put(emotionType, 
        emotionFrequency.getOrDefault(emotionType, 0) + 1);
}

// è¯†åˆ«ä¸»è¦æƒ…ç»ªæ¨¡å¼
String dominantEmotion = emotionFrequency.entrySet().stream()
    .max(Map.Entry.comparingByValue())
    .map(Map.Entry::getKey)
    .orElse("calm");
```

### åœºæ™¯3ï¼šæƒ…ç»ªè¶‹åŠ¿åˆ†æ

```java
// åˆ†æå‘¨è¶‹åŠ¿
UserMemory weekTrend = temperatureMemoryService.analyzeAndSaveEmotionTrend(
    userId, 
    "week"
);

// è·å–è¶‹åŠ¿æ•°æ®
Map<String, Object> trendData = weekTrend.getStructuredData();
String dominantEmotion = (String) trendData.get("dominantEmotion");
Double avgConfidence = (Double) trendData.get("averageConfidence");
```

---

## ğŸ” æ£€ç´¢ç¤ºä¾‹

### 1. æ ¹æ®æƒ…ç»ªç±»å‹æ£€ç´¢

```java
// æ£€ç´¢ä¸"happy"ç›¸å…³çš„æ‰€æœ‰è®°å¿†
List<UserMemory> memories = mongoLongMemoryService.retrieveMemoriesByContext(
    userId,
    Map.of(
        "emotionType", "happy"
    ),
    10
);
```

### 2. æ£€ç´¢ç‰¹å®šç±»å‹çš„è®°å¿†

```java
// æ£€ç´¢æ‰€æœ‰æƒ…ç»ªæ¨¡å¼è®°å¿†
List<UserMemory> patterns = mongoLongMemoryService.retrieveMemoriesByContext(
    userId,
    Map.of(
        "type", "EMOTION_PATTERN"
    ),
    20
);
```

### 3. ç»„åˆæ£€ç´¢

```java
// æ£€ç´¢ç‰¹å®šæƒ…ç»ªç±»å‹çš„é‡è¦è®°å¿†
List<UserMemory> memories = mongoLongMemoryService.retrieveMemoriesByContext(
    userId,
    Map.of(
        "type", "EMOTIONAL_EXPERIENCE",
        "importance", "IMPORTANT",
        "emotionType", "sad"
    ),
    10
);
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å¼‚æ­¥å¤„ç†

è®°å¿†æå–æ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œä¸ä¼šé˜»å¡æƒ…ç»ªè®°å½•ä¿å­˜çš„ä¸»æµç¨‹ã€‚

### 2. é”™è¯¯å¤„ç†

å¦‚æœè®°å¿†æå–å¤±è´¥ï¼Œä¸ä¼šå½±å“æƒ…ç»ªè®°å½•çš„ä¿å­˜ï¼Œåªè®°å½•é”™è¯¯æ—¥å¿—ã€‚

### 3. æ€§èƒ½è€ƒè™‘

- è®°å¿†æå–ä½¿ç”¨å¼‚æ­¥å¤„ç†
- æ‰¹é‡ä¿å­˜è®°å¿†ä»¥æé«˜æ€§èƒ½
- ä½¿ç”¨MongoDBç´¢å¼•ä¼˜åŒ–æ£€ç´¢

### 4. æ•°æ®ä¸€è‡´æ€§

- æƒ…ç»ªè®°å½•å’Œè®°å¿†ä¹‹é—´é€šè¿‡sourceIdå…³è”
- æ”¯æŒé€šè¿‡sourceIdè¿½æº¯åŸå§‹æƒ…ç»ªè®°å½•

---

## ğŸ“ˆ æœªæ¥æ‰©å±•

### 1. è®°å¿†å…³è”

- å»ºç«‹è®°å¿†ä¹‹é—´çš„å…³è”å…³ç³»
- æ”¯æŒé€šè¿‡å…³è”æ£€ç´¢ç›¸å…³è®°å¿†

### 2. è®°å¿†è¡°å‡

- å®ç°è®°å¿†é‡è¦æ€§è¡°å‡æœºåˆ¶
- è‡ªåŠ¨æ¸…ç†ä½é‡è¦æ€§è®°å¿†

### 3. è®°å¿†å¯è§†åŒ–

- æä¾›è®°å¿†å¯è§†åŒ–æ¥å£
- å±•ç¤ºç”¨æˆ·çš„æƒ…ç»ªæ¨¡å¼å’Œè¶‹åŠ¿

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [é˜¶æ®µä¸€è¯¦ç»†è®¾è®¡](./02-é˜¶æ®µä¸€ï¼šåŸºç¡€è®°å¿†ç³»ç»Ÿ.md)
- [é•¿æœŸè®°å¿†ä¸çŸ­æœŸè®°å¿†è®¾è®¡è¯¦è§£](./é•¿æœŸè®°å¿†ä¸çŸ­æœŸè®°å¿†è®¾è®¡è¯¦è§£.md)
- [APIæ–‡æ¡£](./07-APIæ–‡æ¡£.md)

---

**é›†æˆå®Œæˆï¼** âœ…



