# è®°å¿†ç³»ç»Ÿæµ‹è¯•ç¯å¢ƒé…ç½®æŒ‡å—

**æ—¥æœŸ**: 2025-12-29  
**ç”¨é€”**: é…ç½®æµ‹è¯•ç¯å¢ƒä»¥è¿è¡Œè®°å¿†ç³»ç»Ÿæµ‹è¯•

---

## ğŸ“‹ å‰ç½®è¦æ±‚

### 1. å¿…éœ€æœåŠ¡

- **MongoDB**: ç‰ˆæœ¬ 4.4+
- **Redis**: ç‰ˆæœ¬ 6.0+
- **Java**: ç‰ˆæœ¬ 17+
- **Maven**: ç‰ˆæœ¬ 3.6+

---

## ğŸ”§ é…ç½®æ­¥éª¤

### æ­¥éª¤1ï¼šå¯åŠ¨MongoDB

```bash
# æ£€æŸ¥MongoDBæ˜¯å¦è¿è¡Œ
mongosh --eval "db.version()"

# å¦‚æœæœªè¿è¡Œï¼Œå¯åŠ¨MongoDB
# macOS (ä½¿ç”¨Homebrew)
brew services start mongodb-community

# Linux
sudo systemctl start mongod

# æˆ–ç›´æ¥è¿è¡Œ
mongod --dbpath /path/to/data
```

### æ­¥éª¤2ï¼šå¯åŠ¨Redis

```bash
# æ£€æŸ¥Redisæ˜¯å¦è¿è¡Œ
redis-cli ping

# å¦‚æœæœªè¿è¡Œï¼Œå¯åŠ¨Redis
# macOS (ä½¿ç”¨Homebrew)
brew services start redis

# Linux
sudo systemctl start redis

# æˆ–ç›´æ¥è¿è¡Œ
redis-server
```

### æ­¥éª¤3ï¼šåˆ›å»ºæµ‹è¯•æ•°æ®åº“

```bash
# è¿æ¥åˆ°MongoDB
mongosh

# åˆ›å»ºæµ‹è¯•æ•°æ®åº“ï¼ˆå¯é€‰ï¼ŒMongoDBä¼šè‡ªåŠ¨åˆ›å»ºï¼‰
use heartsphere_test

# é€€å‡º
exit
```

### æ­¥éª¤4ï¼šéªŒè¯é…ç½®

```bash
cd backend

# è¿è¡Œå•ä¸ªæµ‹è¯•éªŒè¯é…ç½®
mvn test -Dtest=RedisShortMemoryServiceTest#testSaveAndGetMessage

# å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œè¯´æ˜é…ç½®æ­£ç¡®
```

---

## ğŸ“ æµ‹è¯•é…ç½®æ–‡ä»¶

### æ–‡ä»¶ä½ç½®

`backend/src/test/resources/application-test.yml`

### é…ç½®å†…å®¹

```yaml
spring:
  # MongoDBé…ç½®ï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰
  data:
    mongodb:
      uri: mongodb://localhost:27017/heartsphere_test
      auto-index-creation: true

  # Redisé…ç½®ï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰
  redis:
    host: localhost
    port: 6379
    database: 1
    timeout: 2000ms
    lettuce:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0

# è®°å¿†ç³»ç»Ÿé…ç½®
heartsphere:
  memory:
    extraction:
      enable-llm-extraction: false  # æµ‹è¯•ç¯å¢ƒç¦ç”¨LLMæå–
      enable-rule-extraction: true    # å¯ç”¨è§„åˆ™æå–
      batch-size: 10
```

---

## ğŸ³ Dockeræ–¹å¼ï¼ˆæ¨èï¼‰

### ä½¿ç”¨Docker Compose

åˆ›å»º `docker-compose.test.yml`:

```yaml
version: '3.8'

services:
  mongodb-test:
    image: mongo:6.0
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: heartsphere_test
    volumes:
      - mongodb-test-data:/data/db

  redis-test:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-test-data:/data

volumes:
  mongodb-test-data:
  redis-test-data:
```

### å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨æµ‹è¯•æœåŠ¡
docker-compose -f docker-compose.test.yml up -d

# åœæ­¢æµ‹è¯•æœåŠ¡
docker-compose -f docker-compose.test.yml down

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.test.yml logs -f
```

---

## ğŸ” éªŒè¯æµ‹è¯•ç¯å¢ƒ

### 1. éªŒè¯MongoDBè¿æ¥

```bash
# ä½¿ç”¨mongosh
mongosh mongodb://localhost:27017/heartsphere_test

# æˆ–ä½¿ç”¨mongoå‘½ä»¤ï¼ˆæ—§ç‰ˆæœ¬ï¼‰
mongo mongodb://localhost:27017/heartsphere_test
```

### 2. éªŒè¯Redisè¿æ¥

```bash
# ä½¿ç”¨redis-cli
redis-cli -h localhost -p 6379 ping

# åº”è¯¥è¿”å›: PONG
```

### 3. è¿è¡Œæµ‹è¯•

```bash
cd backend

# è¿è¡Œæ‰€æœ‰è®°å¿†ç³»ç»Ÿæµ‹è¯•
mvn test -Dtest="*Memory*Test"

# è¿è¡Œå•ä¸ªæµ‹è¯•ç±»
mvn test -Dtest=RedisShortMemoryServiceTest

# è¿è¡Œå•ä¸ªæµ‹è¯•æ–¹æ³•
mvn test -Dtest=RedisShortMemoryServiceTest#testSaveAndGetMessage
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### é—®é¢˜1ï¼šMongoDBè¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**: `Connection refused`

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥MongoDBæ˜¯å¦è¿è¡Œ: `mongosh --eval "db.version()"`
2. æ£€æŸ¥ç«¯å£æ˜¯å¦æ­£ç¡®: é»˜è®¤27017
3. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

### é—®é¢˜2ï¼šRedisè¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**: `Connection refused`

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥Redisæ˜¯å¦è¿è¡Œ: `redis-cli ping`
2. æ£€æŸ¥ç«¯å£æ˜¯å¦æ­£ç¡®: é»˜è®¤6379
3. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

### é—®é¢˜3ï¼šæµ‹è¯•æ•°æ®åº“å†²çª

**é”™è¯¯ä¿¡æ¯**: `Database already exists`

**è§£å†³æ–¹æ¡ˆ**:
1. æµ‹è¯•æ•°æ®åº“ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œæ— éœ€æ‰‹åŠ¨åˆ›å»º
2. å¦‚æœé‡åˆ°å†²çªï¼Œå¯ä»¥åˆ é™¤æµ‹è¯•æ•°æ®åº“:
   ```bash
   mongosh
   use heartsphere_test
   db.dropDatabase()
   exit
   ```

### é—®é¢˜4ï¼šæµ‹è¯•æ•°æ®æ®‹ç•™

**è§£å†³æ–¹æ¡ˆ**:
1. æµ‹è¯•åº”è¯¥è‡ªåŠ¨æ¸…ç†æ•°æ®
2. å¦‚æœé‡åˆ°æ•°æ®æ®‹ç•™ï¼Œå¯ä»¥æ‰‹åŠ¨æ¸…ç†:
   ```bash
   # MongoDB
   mongosh
   use heartsphere_test
   db.dropDatabase()
   exit
   
   # Redis
   redis-cli -n 1 FLUSHDB
   ```

---

## ğŸ“Š æµ‹è¯•ç¯å¢ƒéš”ç¦»

### æ•°æ®åº“éš”ç¦»

- **æµ‹è¯•æ•°æ®åº“**: `heartsphere_test`
- **Redisæ•°æ®åº“**: `1` (database 1)
- **ç”Ÿäº§æ•°æ®åº“**: `heartsphere`
- **Redisæ•°æ®åº“**: `0` (database 0)

### é…ç½®éš”ç¦»

- **æµ‹è¯•é…ç½®**: `application-test.yml`
- **ç”Ÿäº§é…ç½®**: `application.yml`
- **ä½¿ç”¨profile**: `@ActiveProfiles("test")`

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. æµ‹è¯•æ•°æ®ç®¡ç†

- âœ… æ¯ä¸ªæµ‹è¯•å‰æ¸…ç†æ•°æ®
- âœ… ä½¿ç”¨å”¯ä¸€IDé¿å…å†²çª
- âœ… æµ‹è¯•åæ¸…ç†æ•°æ®

### 2. æµ‹è¯•éš”ç¦»

- âœ… æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹è¿è¡Œ
- âœ… ä¸ä¾èµ–å…¶ä»–æµ‹è¯•
- âœ… ä½¿ç”¨ç‹¬ç«‹çš„æµ‹è¯•æ•°æ®

### 3. æ€§èƒ½è€ƒè™‘

- âœ… ä½¿ç”¨å†…å­˜æ•°æ®åº“ï¼ˆå¦‚H2ï¼‰è¿›è¡Œå¿«é€Ÿæµ‹è¯•
- âœ… ä½¿ç”¨åµŒå…¥å¼MongoDB/Redisè¿›è¡Œé›†æˆæµ‹è¯•
- âœ… é¿å…é•¿æ—¶é—´è¿è¡Œçš„æµ‹è¯•

---

## ğŸ“ æ€»ç»“

**æµ‹è¯•ç¯å¢ƒé…ç½®è¦ç‚¹**:

1. âœ… MongoDBå’ŒRedisæœåŠ¡å¿…é¡»è¿è¡Œ
2. âœ… æµ‹è¯•é…ç½®å·²æ›´æ–°ï¼ˆ`application-test.yml`ï¼‰
3. âœ… ä½¿ç”¨ç‹¬ç«‹çš„æµ‹è¯•æ•°æ®åº“
4. âœ… æµ‹è¯•åæ¸…ç†æ•°æ®

**ä¸‹ä¸€æ­¥**: è¿è¡Œæµ‹è¯•ï¼ŒéªŒè¯é…ç½®æ˜¯å¦æ­£ç¡®

---

**æµ‹è¯•ç¯å¢ƒé…ç½®æŒ‡å—å®Œæˆï¼** âœ…

