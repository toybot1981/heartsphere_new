# 多层记忆架构分析与实现方案

**文档版本**: V1.0  
**编写日期**: 2025-12-31  
**目标**: 分析当前记忆系统与多层记忆架构的差异，提出实现方案

---

## 📊 当前记忆系统架构分析

### 当前实现

#### 1. 双层存储架构
- **短期记忆（Redis）**：对话上下文、会话状态
- **长期记忆（MongoDB）**：用户事实、偏好、记忆

#### 2. 记忆类型分类（MemoryType）
当前有20+种记忆类型，但**没有按层级组织**：
- 个人信息（PERSONAL_INFO）
- 偏好（PREFERENCE）
- 习惯（HABIT）
- 性格（PERSONALITY）
- 重要时刻（IMPORTANT_MOMENT）
- 情感经历（EMOTIONAL_EXPERIENCE）
- 情绪模式（EMOTION_PATTERN）
- 对话主题（CONVERSATION_TOPIC）
- 交互偏好（INTERACTION_PREFERENCE）
- 对话风格（CONVERSATION_STYLE）
- 等等...

#### 3. 记忆重要性分级（MemoryImportance）
- **核心（CORE）**：最重要的记忆
- **重要（IMPORTANT）**：重要的记忆
- **普通（NORMAL）**：一般的记忆
- **临时（TEMPORARY）**：临时记忆

### 与目标多层架构的差异

**目标架构**：
1. **状态层**：所有日常信息（对话、日志等）
2. **情景层**：重点关注的场景分析
3. **行为层**：个人行为模式（决策方式、行动模式等）
4. **认知层**：个人画像、偏好等
5. **核心层**：价值观等

**当前实现**：
- ❌ **没有明确的层级划分**
- ❌ **记忆类型是平面的，没有层级关系**
- ❌ **重要性分级（CORE/IMPORTANT/NORMAL/TEMPORARY）不完全对应层级**
- ✅ **有记忆类型分类，但需要重新组织到层级中**

---

## 🎯 多层记忆架构设计

### 架构层次定义

```
┌─────────────────────────────────────────┐
│           核心层 (Core Layer)           │
│  • 价值观                               │
│  • 人生信念                             │
│  • 核心原则                             │
│  • 根本动机                             │
└─────────────────────────────────────────┘
                    ↑
┌─────────────────────────────────────────┐
│         认知层 (Cognition Layer)        │
│  • 个人画像                             │
│  • 偏好体系                             │
│  • 认知模式                             │
│  • 思维习惯                             │
└─────────────────────────────────────────┘
                    ↑
┌─────────────────────────────────────────┐
│         行为层 (Behavior Layer)         │
│  • 行为模式                             │
│  • 决策方式（先决策后行动/先计划后决策）│
│  • 行动习惯                             │
│  • 反应模式                             │
└─────────────────────────────────────────┘
                    ↑
┌─────────────────────────────────────────┐
│         情景层 (Scenario Layer)          │
│  • 重点关注的场景                       │
│  • 场景偏好                             │
│  • 场景记忆                             │
│  • 场景关联                             │
└─────────────────────────────────────────┘
                    ↑
┌─────────────────────────────────────────┐
│         状态层 (State Layer)             │
│  • 对话记录                             │
│  • 日志内容                             │
│  • 日常信息                             │
│  • 临时状态                             │
└─────────────────────────────────────────┘
```

### 层级特点

#### 1. 状态层（State Layer）
- **特点**：最底层，包含所有原始信息
- **内容**：对话、日志、操作记录等
- **存储**：短期记忆（Redis）+ 长期记忆（MongoDB）
- **生命周期**：临时到长期，根据重要性决定
- **提取来源**：直接来自用户输入

#### 2. 情景层（Scenario Layer）
- **特点**：从状态层提取的场景信息
- **内容**：重点关注的场景、场景偏好、场景记忆
- **存储**：长期记忆（MongoDB）
- **生命周期**：中期到长期
- **提取方式**：AI分析状态层数据，识别场景模式

#### 3. 行为层（Behavior Layer）
- **特点**：从情景层和状态层分析出的行为模式
- **内容**：
  - 决策方式：先决策后行动、先计划后决策、直觉决策等
  - 行动模式：主动型、被动型、反应型等
  - 行为习惯：作息习惯、工作习惯等
- **存储**：长期记忆（MongoDB）
- **生命周期**：长期
- **提取方式**：AI分析多个场景和状态，识别行为模式

#### 4. 认知层（Cognition Layer）
- **特点**：从行为层和情景层抽象出的认知特征
- **内容**：
  - 个人画像：性格特征、思维模式
  - 偏好体系：兴趣偏好、价值偏好
  - 认知模式：学习方式、理解方式
- **存储**：长期记忆（MongoDB）
- **生命周期**：长期到永久
- **提取方式**：AI分析行为模式和场景，抽象认知特征

#### 5. 核心层（Core Layer）
- **特点**：最深层，最稳定的记忆
- **内容**：
  - 价值观：核心价值观念
  - 人生信念：根本信念
  - 核心原则：行为原则
  - 根本动机：深层动机
- **存储**：长期记忆（MongoDB）
- **生命周期**：永久
- **提取方式**：AI深度分析认知层和行为层，提取核心价值

---

## 🔧 实现方案

### 方案一：扩展记忆类型枚举（推荐）

在现有 `MemoryType` 基础上，添加层级信息：

```typescript
// 前端
export enum MemoryLayer {
  STATE = 'state',           // 状态层
  SCENARIO = 'scenario',     // 情景层
  BEHAVIOR = 'behavior',     // 行为层
  COGNITION = 'cognition',   // 认知层
  CORE = 'core'              // 核心层
}

export enum MemoryType {
  // ========== 状态层 (State Layer) ==========
  // 对话相关
  CONVERSATION = 'conversation',
  CONVERSATION_TOPIC = 'conversation_topic',
  
  // 日志相关
  JOURNAL_ENTRY = 'journal_entry',
  JOURNAL_CONTENT = 'journal_content',
  
  // 日常信息
  DAILY_ACTIVITY = 'daily_activity',
  TEMPORARY_STATE = 'temporary_state',
  
  // ========== 情景层 (Scenario Layer) ==========
  SCENARIO_FOCUS = 'scenario_focus',           // 重点关注的场景
  SCENARIO_PREFERENCE = 'scenario_preference', // 场景偏好
  SCENARIO_MEMORY = 'scenario_memory',         // 场景记忆
  SCENARIO_ASSOCIATION = 'scenario_association', // 场景关联
  
  // ========== 行为层 (Behavior Layer) ==========
  DECISION_PATTERN = 'decision_pattern',       // 决策模式
  ACTION_PATTERN = 'action_pattern',          // 行动模式
  REACTION_PATTERN = 'reaction_pattern',      // 反应模式
  BEHAVIOR_HABIT = 'behavior_habit',          // 行为习惯
  WORKFLOW_PATTERN = 'workflow_pattern',      // 工作流程模式
  
  // ========== 认知层 (Cognition Layer) ==========
  PERSONAL_PROFILE = 'personal_profile',      // 个人画像
  PREFERENCE_SYSTEM = 'preference_system',    // 偏好体系
  COGNITIVE_PATTERN = 'cognitive_pattern',    // 认知模式
  THINKING_HABIT = 'thinking_habit',          // 思维习惯
  LEARNING_STYLE = 'learning_style',          // 学习方式
  
  // ========== 核心层 (Core Layer) ==========
  CORE_VALUE = 'core_value',                  // 核心价值
  LIFE_BELIEF = 'life_belief',                // 人生信念
  CORE_PRINCIPLE = 'core_principle',          // 核心原则
  FUNDAMENTAL_MOTIVATION = 'fundamental_motivation', // 根本动机
  
  // ========== 保留原有类型（向后兼容）==========
  PERSONAL_INFO = 'personal_info',
  PREFERENCE = 'preference',
  HABIT = 'habit',
  PERSONALITY = 'personality',
  IMPORTANT_MOMENT = 'important_moment',
  EMOTIONAL_EXPERIENCE = 'emotional_experience',
  EMOTION_PATTERN = 'emotion_pattern',
  // ... 其他原有类型
}

// 记忆类型到层级的映射
export const MemoryTypeToLayer: Record<MemoryType, MemoryLayer> = {
  // 状态层
  [MemoryType.CONVERSATION]: MemoryLayer.STATE,
  [MemoryType.CONVERSATION_TOPIC]: MemoryLayer.STATE,
  [MemoryType.JOURNAL_ENTRY]: MemoryLayer.STATE,
  [MemoryType.JOURNAL_CONTENT]: MemoryLayer.STATE,
  [MemoryType.DAILY_ACTIVITY]: MemoryLayer.STATE,
  [MemoryType.TEMPORARY_STATE]: MemoryLayer.STATE,
  
  // 情景层
  [MemoryType.SCENARIO_FOCUS]: MemoryLayer.SCENARIO,
  [MemoryType.SCENARIO_PREFERENCE]: MemoryLayer.SCENARIO,
  [MemoryType.SCENARIO_MEMORY]: MemoryLayer.SCENARIO,
  [MemoryType.SCENARIO_ASSOCIATION]: MemoryLayer.SCENARIO,
  
  // 行为层
  [MemoryType.DECISION_PATTERN]: MemoryLayer.BEHAVIOR,
  [MemoryType.ACTION_PATTERN]: MemoryLayer.BEHAVIOR,
  [MemoryType.REACTION_PATTERN]: MemoryLayer.BEHAVIOR,
  [MemoryType.BEHAVIOR_HABIT]: MemoryLayer.BEHAVIOR,
  [MemoryType.WORKFLOW_PATTERN]: MemoryLayer.BEHAVIOR,
  
  // 认知层
  [MemoryType.PERSONAL_PROFILE]: MemoryLayer.COGNITION,
  [MemoryType.PREFERENCE_SYSTEM]: MemoryLayer.COGNITION,
  [MemoryType.COGNITIVE_PATTERN]: MemoryLayer.COGNITION,
  [MemoryType.THINKING_HABIT]: MemoryLayer.COGNITION,
  [MemoryType.LEARNING_STYLE]: MemoryLayer.COGNITION,
  
  // 核心层
  [MemoryType.CORE_VALUE]: MemoryLayer.CORE,
  [MemoryType.LIFE_BELIEF]: MemoryLayer.CORE,
  [MemoryType.CORE_PRINCIPLE]: MemoryLayer.CORE,
  [MemoryType.FUNDAMENTAL_MOTIVATION]: MemoryLayer.CORE,
  
  // 原有类型的映射（需要根据实际情况调整）
  [MemoryType.PERSONAL_INFO]: MemoryLayer.COGNITION,
  [MemoryType.PREFERENCE]: MemoryLayer.COGNITION,
  [MemoryType.HABIT]: MemoryLayer.BEHAVIOR,
  [MemoryType.PERSONALITY]: MemoryLayer.COGNITION,
  [MemoryType.IMPORTANT_MOMENT]: MemoryLayer.SCENARIO,
  [MemoryType.EMOTIONAL_EXPERIENCE]: MemoryLayer.STATE,
  [MemoryType.EMOTION_PATTERN]: MemoryLayer.BEHAVIOR,
  // ... 其他映射
};
```

### 方案二：在数据模型中添加层级字段

在 `UserMemory` 模型中添加 `layer` 字段：

```java
// 后端
public enum MemoryLayer {
    STATE,      // 状态层
    SCENARIO,   // 情景层
    BEHAVIOR,   // 行为层
    COGNITION,  // 认知层
    CORE        // 核心层
}

@Data
@Document(collection = "user_memories")
public class UserMemory {
    // ... 现有字段
    
    /**
     * 记忆层级
     */
    private MemoryLayer layer;
    
    /**
     * 层级权重（用于层级间的关联和检索）
     */
    private Double layerWeight;
    
    /**
     * 来源层级（如果是从其他层级提取的）
     */
    private MemoryLayer sourceLayer;
    
    /**
     * 来源记忆ID（如果是从其他记忆提取的）
     */
    private String sourceMemoryId;
}
```

### 方案三：层级提取服务

创建层级提取服务，自动从低层级提取高层级记忆：

```java
@Service
public class MemoryLayerExtractionService {
    
    /**
     * 从状态层提取情景层记忆
     */
    public List<UserMemory> extractScenarioMemories(String userId) {
        // 1. 获取状态层记忆（对话、日志等）
        List<UserMemory> stateMemories = getMemoriesByLayer(userId, MemoryLayer.STATE);
        
        // 2. AI分析，识别重点关注的场景
        // 3. 生成情景层记忆
        // 4. 保存到MongoDB
    }
    
    /**
     * 从情景层提取行为层记忆
     */
    public List<UserMemory> extractBehaviorMemories(String userId) {
        // 1. 获取情景层和状态层记忆
        // 2. AI分析，识别行为模式
        // 3. 生成行为层记忆（决策方式、行动模式等）
    }
    
    /**
     * 从行为层提取认知层记忆
     */
    public List<UserMemory> extractCognitionMemories(String userId) {
        // 1. 获取行为层记忆
        // 2. AI分析，抽象认知特征
        // 3. 生成认知层记忆（个人画像、偏好体系等）
    }
    
    /**
     * 从认知层提取核心层记忆
     */
    public List<UserMemory> extractCoreMemories(String userId) {
        // 1. 获取认知层和行为层记忆
        // 2. AI深度分析，提取核心价值
        // 3. 生成核心层记忆（价值观、信念等）
    }
}
```

---

## 📋 实施计划

### 阶段一：数据模型扩展（1-2周）

1. **添加层级枚举**
   - 前端：`MemoryLayer` 枚举
   - 后端：`MemoryLayer` 枚举

2. **扩展数据模型**
   - 在 `UserMemory` 中添加 `layer` 字段
   - 添加层级相关的元数据字段

3. **更新记忆类型**
   - 添加新的记忆类型（对应各层级）
   - 建立记忆类型到层级的映射关系

### 阶段二：层级提取服务（2-3周）

1. **实现层级提取服务**
   - `MemoryLayerExtractionService`
   - 各层级的提取逻辑

2. **AI分析能力**
   - 场景识别（从状态层到情景层）
   - 行为模式识别（从情景层到行为层）
   - 认知特征抽象（从行为层到认知层）
   - 价值观提取（从认知层到核心层）

3. **定时任务**
   - 定期执行层级提取
   - 增量更新高层级记忆

### 阶段三：层级检索和展示（1-2周）

1. **层级检索API**
   - 按层级检索记忆
   - 跨层级关联检索

2. **前端展示**
   - 按层级展示记忆
   - 层级间的关联可视化

---

## 🎯 当前状态总结

### ✅ 已实现
- 双层存储架构（短期/长期）
- 记忆类型分类（20+种类型）
- 记忆重要性分级
- 基础记忆提取和检索

### ❌ 未实现
- **明确的层级划分**（状态层、情景层、行为层、认知层、核心层）
- **层级间的提取机制**（从低层级自动提取高层级）
- **层级特定的记忆类型**（如决策模式、行为模式等）
- **层级关联和检索**

### 💡 建议
1. **短期**：在现有基础上添加层级字段，保持向后兼容
2. **中期**：实现层级提取服务，自动从低层级提取高层级记忆
3. **长期**：完善层级间的关联和检索机制

---

## 📝 下一步行动

1. **确认需求**：确认五层架构的具体定义和边界
2. **设计实现**：详细设计层级提取算法和AI提示词
3. **逐步实施**：按阶段实施，确保不影响现有功能

---

**最后更新**: 2025-12-31  
**文档维护**: HeartSphere 开发团队

