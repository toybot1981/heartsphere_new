# Memoryæ•°æ®åº“è¡¨åˆ›å»ºè¯´æ˜

**æ—¥æœŸ**: 2025-12-31  
**çŠ¶æ€**: âœ… å®ä½“ç±»å·²åˆ›å»º

---

## ğŸ“‹ æ•°æ®åº“è¡¨åˆ—è¡¨

### çŸ­æœŸè®°å¿†è¡¨

#### 1. `chat_messages` - å¯¹è¯æ¶ˆæ¯è¡¨
**å®ä½“ç±»**: `ChatMessageEntity`

**å­—æ®µ**:
- `id` (VARCHAR(64), PK) - æ¶ˆæ¯ID
- `session_id` (VARCHAR(64), NOT NULL) - ä¼šè¯ID
- `user_id` (VARCHAR(64), NOT NULL) - ç”¨æˆ·ID
- `role` (VARCHAR(20), NOT NULL) - æ¶ˆæ¯è§’è‰²ï¼ˆUSER/ASSISTANT/SYSTEMï¼‰
- `content` (TEXT, NOT NULL) - æ¶ˆæ¯å†…å®¹
- `metadata` (JSON) - å…ƒæ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰
- `timestamp` (BIGINT, NOT NULL) - æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
- `importance` (VARCHAR(20)) - é‡è¦æ€§
- `created_at` (DATETIME) - åˆ›å»ºæ—¶é—´
- `updated_at` (DATETIME) - æ›´æ–°æ—¶é—´
- `expires_at` (DATETIME) - è¿‡æœŸæ—¶é—´

**ç´¢å¼•**:
- `idx_session_id` - session_id
- `idx_user_id` - user_id
- `idx_timestamp` - timestamp
- `idx_session_timestamp` - (session_id, timestamp)

#### 2. `working_memories` - å·¥ä½œè®°å¿†è¡¨
**å®ä½“ç±»**: `WorkingMemoryEntity`

**å­—æ®µ**:
- `id` (BIGINT, PK, AUTO_INCREMENT) - ä¸»é”®
- `session_id` (VARCHAR(64), NOT NULL) - ä¼šè¯ID
- `memory_key` (VARCHAR(100), NOT NULL) - è®°å¿†é”®
- `memory_value` (TEXT) - è®°å¿†å€¼ï¼ˆJSONæ ¼å¼ï¼‰
- `created_at` (DATETIME) - åˆ›å»ºæ—¶é—´
- `updated_at` (DATETIME) - æ›´æ–°æ—¶é—´
- `expires_at` (DATETIME) - è¿‡æœŸæ—¶é—´

**ç´¢å¼•**:
- `idx_session_id` - session_id
- `idx_session_key` - (session_id, memory_key) UNIQUE
- `idx_expires_at` - expires_at

#### 3. `memory_sessions` - ä¼šè¯ç´¢å¼•è¡¨
**å®ä½“ç±»**: `SessionEntity`

**å­—æ®µ**:
- `id` (BIGINT, PK, AUTO_INCREMENT) - ä¸»é”®
- `session_id` (VARCHAR(64), NOT NULL, UNIQUE) - ä¼šè¯ID
- `user_id` (VARCHAR(64), NOT NULL) - ç”¨æˆ·ID
- `created_at` (DATETIME) - åˆ›å»ºæ—¶é—´
- `updated_at` (DATETIME) - æ›´æ–°æ—¶é—´
- `expires_at` (DATETIME) - è¿‡æœŸæ—¶é—´

**ç´¢å¼•**:
- `idx_user_id` - user_id
- `idx_session_id` - session_id (UNIQUE)
- `idx_updated_at` - updated_at

### é•¿æœŸè®°å¿†è¡¨

#### 4. `user_memories` - ç”¨æˆ·è®°å¿†è¡¨
**å®ä½“ç±»**: `UserMemoryEntity`

**å­—æ®µ**:
- `id` (VARCHAR(64), PK) - è®°å¿†ID
- `user_id` (VARCHAR(64), NOT NULL) - ç”¨æˆ·ID
- `type` (VARCHAR(50), NOT NULL) - è®°å¿†ç±»å‹ï¼ˆæšä¸¾ï¼‰
- `importance` (VARCHAR(20), NOT NULL) - é‡è¦æ€§ï¼ˆæšä¸¾ï¼‰
- `content` (TEXT, NOT NULL) - è®°å¿†å†…å®¹
- `structured_data` (JSON) - ç»“æ„åŒ–æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰
- `source` (VARCHAR(30), NOT NULL) - è®°å¿†æ¥æºï¼ˆæšä¸¾ï¼‰
- `source_id` (VARCHAR(64)) - æ¥æºID
- `created_at` (DATETIME) - åˆ›å»ºæ—¶é—´
- `last_accessed_at` (DATETIME) - æœ€åè®¿é—®æ—¶é—´
- `access_count` (INT, DEFAULT 0) - è®¿é—®æ¬¡æ•°
- `confidence` (DOUBLE) - æå–ç½®ä¿¡åº¦
- `tags` (JSON) - æ ‡ç­¾ï¼ˆJSONæ•°ç»„æ ¼å¼ï¼‰
- `metadata` (JSON) - æ‰©å±•å…ƒæ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰
- `updated_at` (DATETIME) - æ›´æ–°æ—¶é—´

**ç´¢å¼•**:
- `idx_user_id` - user_id
- `idx_type` - type
- `idx_importance` - importance
- `idx_source` - source
- `idx_source_id` - source_id
- `idx_created_at` - created_at
- `idx_user_type` - (user_id, type)
- `idx_user_importance` - (user_id, importance)

#### 5. `user_facts` - ç”¨æˆ·äº‹å®è¡¨
**å®ä½“ç±»**: `UserFactEntity`

**å­—æ®µ**:
- `id` (VARCHAR(64), PK) - äº‹å®ID
- `user_id` (VARCHAR(64), NOT NULL) - ç”¨æˆ·ID
- `fact` (TEXT, NOT NULL) - äº‹å®å†…å®¹
- `category` (VARCHAR(30), NOT NULL) - äº‹å®ç±»åˆ«ï¼ˆæšä¸¾ï¼‰
- `importance` (DOUBLE, DEFAULT 0.5) - é‡è¦æ€§ï¼ˆ0-1ï¼‰
- `confidence` (DOUBLE, DEFAULT 0.7) - ç½®ä¿¡åº¦ï¼ˆ0-1ï¼‰
- `source_session_id` (VARCHAR(64)) - æ¥æºä¼šè¯ID
- `created_at` (DATETIME) - åˆ›å»ºæ—¶é—´
- `last_accessed_at` (DATETIME) - æœ€åè®¿é—®æ—¶é—´
- `access_count` (INT, DEFAULT 0) - è®¿é—®æ¬¡æ•°
- `tags` (JSON) - æ ‡ç­¾ï¼ˆJSONæ•°ç»„æ ¼å¼ï¼‰
- `metadata` (JSON) - å…ƒæ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰
- `updated_at` (DATETIME) - æ›´æ–°æ—¶é—´

**ç´¢å¼•**:
- `idx_user_id` - user_id
- `idx_category` - category
- `idx_user_category` - (user_id, category)

#### 6. `user_preferences` - ç”¨æˆ·åå¥½è¡¨
**å®ä½“ç±»**: `UserPreferenceEntity`

**å­—æ®µ**:
- `id` (VARCHAR(64), PK) - åå¥½ID
- `user_id` (VARCHAR(64), NOT NULL) - ç”¨æˆ·ID
- `preference_key` (VARCHAR(100), NOT NULL) - åå¥½é”®
- `preference_value` (TEXT, NOT NULL) - åå¥½å€¼
- `preference_type` (VARCHAR(30)) - åå¥½ç±»å‹ï¼ˆæšä¸¾ï¼‰
- `created_at` (DATETIME) - åˆ›å»ºæ—¶é—´
- `updated_at` (DATETIME) - æ›´æ–°æ—¶é—´

**ç´¢å¼•**:
- `idx_user_id` - user_id
- `idx_key` - preference_key
- `idx_user_key` - (user_id, preference_key) UNIQUE

---

## ğŸ”§ è¡¨åˆ›å»ºæ–¹å¼

### æ–¹å¼ä¸€ï¼šè‡ªåŠ¨åˆ›å»ºï¼ˆæ¨èç”¨äºå¼€å‘ç¯å¢ƒï¼‰

å¦‚æœä½¿ç”¨ `application.properties` é…ç½®ï¼š
```properties
spring.jpa.hibernate.ddl-auto=update
```

**è¯´æ˜**ï¼š
- JPAä¼šåœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºè¡¨
- å¦‚æœè¡¨å·²å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨æ›´æ–°è¡¨ç»“æ„
- **é€‚ç”¨äºå¼€å‘ç¯å¢ƒ**

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨åˆ›å»ºï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰

å¦‚æœä½¿ç”¨ `application.yml` é…ç½®ï¼š
```yaml
spring:
  jpa:
    hibernate:
      ddl-auto: validate  # åªéªŒè¯ï¼Œä¸åˆ›å»º
```

**è¯´æ˜**ï¼š
- éœ€è¦æ‰‹åŠ¨æ‰§è¡ŒSQLè„šæœ¬åˆ›å»ºè¡¨
- **é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒ**

---

## ğŸ“ SQLåˆ›å»ºè„šæœ¬

å¦‚æœéœ€è¦æ‰‹åŠ¨åˆ›å»ºè¡¨ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹SQLè„šæœ¬ï¼š

```sql
-- 1. å¯¹è¯æ¶ˆæ¯è¡¨
CREATE TABLE IF NOT EXISTS `chat_messages` (
  `id` VARCHAR(64) NOT NULL PRIMARY KEY,
  `session_id` VARCHAR(64) NOT NULL,
  `user_id` VARCHAR(64) NOT NULL,
  `role` VARCHAR(20) NOT NULL,
  `content` TEXT NOT NULL,
  `metadata` JSON,
  `timestamp` BIGINT NOT NULL,
  `importance` VARCHAR(20),
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `expires_at` DATETIME,
  INDEX `idx_session_id` (`session_id`),
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_timestamp` (`timestamp`),
  INDEX `idx_session_timestamp` (`session_id`, `timestamp`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 2. å·¥ä½œè®°å¿†è¡¨
CREATE TABLE IF NOT EXISTS `working_memories` (
  `id` BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  `session_id` VARCHAR(64) NOT NULL,
  `memory_key` VARCHAR(100) NOT NULL,
  `memory_value` TEXT,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `expires_at` DATETIME,
  INDEX `idx_session_id` (`session_id`),
  UNIQUE KEY `idx_session_key` (`session_id`, `memory_key`),
  INDEX `idx_expires_at` (`expires_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 3. ä¼šè¯ç´¢å¼•è¡¨
CREATE TABLE IF NOT EXISTS `memory_sessions` (
  `id` BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  `session_id` VARCHAR(64) NOT NULL UNIQUE,
  `user_id` VARCHAR(64) NOT NULL,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `expires_at` DATETIME,
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_updated_at` (`updated_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 4. ç”¨æˆ·è®°å¿†è¡¨
CREATE TABLE IF NOT EXISTS `user_memories` (
  `id` VARCHAR(64) NOT NULL PRIMARY KEY,
  `user_id` VARCHAR(64) NOT NULL,
  `type` VARCHAR(50) NOT NULL,
  `importance` VARCHAR(20) NOT NULL,
  `content` TEXT NOT NULL,
  `structured_data` JSON,
  `source` VARCHAR(30) NOT NULL,
  `source_id` VARCHAR(64),
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `last_accessed_at` DATETIME,
  `access_count` INT DEFAULT 0,
  `confidence` DOUBLE,
  `tags` JSON,
  `metadata` JSON,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_type` (`type`),
  INDEX `idx_importance` (`importance`),
  INDEX `idx_source` (`source`),
  INDEX `idx_source_id` (`source_id`),
  INDEX `idx_created_at` (`created_at`),
  INDEX `idx_user_type` (`user_id`, `type`),
  INDEX `idx_user_importance` (`user_id`, `importance`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 5. ç”¨æˆ·äº‹å®è¡¨
CREATE TABLE IF NOT EXISTS `user_facts` (
  `id` VARCHAR(64) NOT NULL PRIMARY KEY,
  `user_id` VARCHAR(64) NOT NULL,
  `fact` TEXT NOT NULL,
  `category` VARCHAR(30) NOT NULL,
  `importance` DOUBLE DEFAULT 0.5,
  `confidence` DOUBLE DEFAULT 0.7,
  `source_session_id` VARCHAR(64),
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `last_accessed_at` DATETIME,
  `access_count` INT DEFAULT 0,
  `tags` JSON,
  `metadata` JSON,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_category` (`category`),
  INDEX `idx_user_category` (`user_id`, `category`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 6. ç”¨æˆ·åå¥½è¡¨
CREATE TABLE IF NOT EXISTS `user_preferences` (
  `id` VARCHAR(64) NOT NULL PRIMARY KEY,
  `user_id` VARCHAR(64) NOT NULL,
  `preference_key` VARCHAR(100) NOT NULL,
  `preference_value` TEXT NOT NULL,
  `preference_type` VARCHAR(30),
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_key` (`preference_key`),
  UNIQUE KEY `idx_user_key` (`user_id`, `preference_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## âœ… éªŒè¯è¡¨æ˜¯å¦å·²åˆ›å»º

### æ–¹æ³•ä¸€ï¼šæ£€æŸ¥æ•°æ®åº“

```sql
-- æŸ¥çœ‹æ‰€æœ‰memoryç›¸å…³çš„è¡¨
SHOW TABLES LIKE '%memory%';
SHOW TABLES LIKE '%chat%';

-- æˆ–è€…æŸ¥çœ‹æ‰€æœ‰è¡¨
SHOW TABLES;
```

### æ–¹æ³•äºŒï¼šæ£€æŸ¥åº”ç”¨æ—¥å¿—

å¯åŠ¨åº”ç”¨æ—¶ï¼Œå¦‚æœçœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼Œè¯´æ˜è¡¨å·²åˆ›å»ºï¼š
```
Hibernate: create table chat_messages ...
Hibernate: create table user_memories ...
...
```

### æ–¹æ³•ä¸‰ï¼šæ£€æŸ¥è¡¨ç»“æ„

```sql
-- æŸ¥çœ‹è¡¨ç»“æ„
DESCRIBE chat_messages;
DESCRIBE user_memories;
DESCRIBE user_facts;
DESCRIBE user_preferences;
DESCRIBE working_memories;
DESCRIBE memory_sessions;
```

---

## ğŸ” å½“å‰çŠ¶æ€

### âœ… å·²å®Œæˆ
- [x] 6ä¸ªå®ä½“ç±»å·²åˆ›å»º
- [x] æ‰€æœ‰å®ä½“ç±»éƒ½æœ‰ `@Table` æ³¨è§£æŒ‡å®šè¡¨å
- [x] æ‰€æœ‰å®ä½“ç±»éƒ½æœ‰å¿…è¦çš„ç´¢å¼•å®šä¹‰
- [x] JPAé…ç½®å·²è®¾ç½®ï¼ˆ`ddl-auto=update`ï¼‰

### â³ å¾…éªŒè¯
- [ ] æ•°æ®åº“è¡¨æ˜¯å¦å·²å®é™…åˆ›å»º
- [ ] è¡¨ç»“æ„æ˜¯å¦æ­£ç¡®
- [ ] ç´¢å¼•æ˜¯å¦å·²åˆ›å»º

---

## ğŸ’¡ å»ºè®®

1. **å¼€å‘ç¯å¢ƒ**ï¼šä½¿ç”¨ `ddl-auto=update`ï¼Œè®©JPAè‡ªåŠ¨åˆ›å»ºè¡¨
2. **ç”Ÿäº§ç¯å¢ƒ**ï¼šä½¿ç”¨ `ddl-auto=validate`ï¼Œæ‰‹åŠ¨æ‰§è¡ŒSQLè„šæœ¬åˆ›å»ºè¡¨
3. **éªŒè¯**ï¼šå¯åŠ¨åº”ç”¨åï¼Œæ£€æŸ¥æ•°æ®åº“ç¡®è®¤è¡¨å·²åˆ›å»º

---

**æœ€åæ›´æ–°**: 2025-12-31  
**æ–‡æ¡£ç»´æŠ¤**: HeartSphere å¼€å‘å›¢é˜Ÿ


