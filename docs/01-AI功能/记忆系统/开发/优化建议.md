# è®°å¿†ç³»ç»Ÿä¼˜åŒ–å»ºè®®

**æ–‡æ¡£ç‰ˆæœ¬**: V1.0  
**ç¼–å†™æ—¥æœŸ**: 2025-12-28

---

## ğŸ“‹ ä¼˜åŒ–æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›è®°å¿†ç³»ç»Ÿçš„ä¼˜åŒ–å»ºè®®ï¼ŒåŒ…æ‹¬æ€§èƒ½ä¼˜åŒ–ã€ä»£ç ä¼˜åŒ–ã€æ¶æ„ä¼˜åŒ–ç­‰æ–¹é¢ã€‚

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. Redisä¼˜åŒ–

#### 1.1 è¿æ¥æ± ä¼˜åŒ–

**å½“å‰çŠ¶æ€**: ä½¿ç”¨é»˜è®¤è¿æ¥æ± é…ç½®

**ä¼˜åŒ–å»ºè®®**:
```yaml
spring:
  data:
    redis:
      lettuce:
        pool:
          max-active: 20      # å¢åŠ æœ€å¤§è¿æ¥æ•°
          max-idle: 10        # å¢åŠ æœ€å¤§ç©ºé—²è¿æ¥æ•°
          min-idle: 5         # è®¾ç½®æœ€å°ç©ºé—²è¿æ¥æ•°
          max-wait: 2000ms    # è®¾ç½®æœ€å¤§ç­‰å¾…æ—¶é—´
```

**é¢„æœŸæ•ˆæœ**: æé«˜å¹¶å‘å¤„ç†èƒ½åŠ›ï¼Œå‡å°‘è¿æ¥åˆ›å»ºå¼€é”€

---

#### 1.2 æ‰¹é‡æ“ä½œä¼˜åŒ–

**å½“å‰çŠ¶æ€**: å•æ¡æ¶ˆæ¯ä¿å­˜

**ä¼˜åŒ–å»ºè®®**:
```java
// ä½¿ç”¨pipelineæ‰¹é‡ä¿å­˜æ¶ˆæ¯
List<Object> results = redisTemplate.executePipelined(
    (RedisCallback<Object>) connection -> {
        for (ChatMessage message : messages) {
            connection.rPush(key.getBytes(), serialize(message));
        }
        return null;
    }
);
```

**é¢„æœŸæ•ˆæœ**: å‡å°‘ç½‘ç»œå¾€è¿”ï¼Œæé«˜æ‰¹é‡æ“ä½œæ€§èƒ½

---

#### 1.3 æ•°æ®å‹ç¼©

**å½“å‰çŠ¶æ€**: æœªå¯ç”¨å‹ç¼©

**ä¼˜åŒ–å»ºè®®**:
```java
// ä½¿ç”¨å‹ç¼©åºåˆ—åŒ–å™¨
RedisSerializer<Object> serializer = new GenericJackson2JsonRedisSerializer();
// æˆ–ä½¿ç”¨è‡ªå®šä¹‰å‹ç¼©åºåˆ—åŒ–å™¨
```

**é¢„æœŸæ•ˆæœ**: å‡å°‘å†…å­˜ä½¿ç”¨ï¼Œæé«˜ç½‘ç»œä¼ è¾“æ•ˆç‡

---

### 2. MongoDBä¼˜åŒ–

#### 2.1 ç´¢å¼•ä¼˜åŒ–

**å½“å‰çŠ¶æ€**: åŸºç¡€ç´¢å¼•å·²åˆ›å»º

**ä¼˜åŒ–å»ºè®®**:
```javascript
// å¤åˆç´¢å¼•ä¼˜åŒ–
db.user_memories.createIndex({ 
    userId: 1, 
    type: 1, 
    lastAccessedAt: -1 
});

// éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•é‡è¦æ•°æ®ï¼‰
db.user_facts.createIndex(
    { userId: 1, importance: -1 },
    { partialFilterExpression: { importance: { $gte: 0.7 } } }
);
```

**é¢„æœŸæ•ˆæœ**: æé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œå‡å°‘ç´¢å¼•å¤§å°

---

#### 2.2 æŸ¥è¯¢ä¼˜åŒ–

**å½“å‰çŠ¶æ€**: éƒ¨åˆ†æŸ¥è¯¢å¯èƒ½æœªä¼˜åŒ–

**ä¼˜åŒ–å»ºè®®**:
```java
// ä½¿ç”¨æŠ•å½±å‡å°‘æ•°æ®ä¼ è¾“
Query query = new Query();
query.fields().include("content").include("type");
query.limit(limit);

// ä½¿ç”¨èšåˆç®¡é“ä¼˜åŒ–å¤æ‚æŸ¥è¯¢
Aggregation aggregation = Aggregation.newAggregation(
    Aggregation.match(Criteria.where("userId").is(userId)),
    Aggregation.sort(Sort.Direction.DESC, "importance"),
    Aggregation.limit(limit)
);
```

**é¢„æœŸæ•ˆæœ**: å‡å°‘æ•°æ®ä¼ è¾“é‡ï¼Œæé«˜æŸ¥è¯¢é€Ÿåº¦

---

#### 2.3 è¿æ¥æ± ä¼˜åŒ–

**å½“å‰çŠ¶æ€**: ä½¿ç”¨é»˜è®¤è¿æ¥æ± 

**ä¼˜åŒ–å»ºè®®**:
```yaml
spring:
  data:
    mongodb:
      options:
        max-pool-size: 100
        min-pool-size: 10
        max-idle-time-ms: 30000
        max-life-time-ms: 3600000
```

**é¢„æœŸæ•ˆæœ**: æé«˜å¹¶å‘å¤„ç†èƒ½åŠ›

---

### 3. åº”ç”¨å±‚ä¼˜åŒ–

#### 3.1 å¼‚æ­¥å¤„ç†ä¼˜åŒ–

**å½“å‰çŠ¶æ€**: è®°å¿†æå–å·²å¼‚æ­¥åŒ–

**ä¼˜åŒ–å»ºè®®**:
```java
// ä½¿ç”¨çº¿ç¨‹æ± ä¼˜åŒ–å¼‚æ­¥å¤„ç†
@Bean
public Executor memoryExtractionExecutor() {
    ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
    executor.setCorePoolSize(5);
    executor.setMaxPoolSize(10);
    executor.setQueueCapacity(100);
    executor.setThreadNamePrefix("memory-extraction-");
    executor.initialize();
    return executor;
}

// ä½¿ç”¨CompletableFutureä¼˜åŒ–
CompletableFuture<List<UserFact>> factsFuture = 
    CompletableFuture.supplyAsync(() -> 
        memoryExtractor.extractFacts(userId, messages), 
        memoryExtractionExecutor
    );
```

**é¢„æœŸæ•ˆæœ**: æé«˜å¼‚æ­¥å¤„ç†æ•ˆç‡ï¼Œé¿å…é˜»å¡

---

#### 3.2 ç¼“å­˜ä¼˜åŒ–

**å½“å‰çŠ¶æ€**: æœªä½¿ç”¨åº”ç”¨å±‚ç¼“å­˜

**ä¼˜åŒ–å»ºè®®**:
```java
// ä½¿ç”¨Spring Cacheç¼“å­˜ç”¨æˆ·ç”»åƒ
@Cacheable(value = "userProfiles", key = "#userId")
public UserProfile getUserProfile(String userId) {
    // ...
}

// ç¼“å­˜é…ç½®
@Configuration
@EnableCaching
public class CacheConfig {
    @Bean
    public CacheManager cacheManager() {
        RedisCacheManager.Builder builder = RedisCacheManager
            .RedisCacheManagerBuilder
            .fromConnectionFactory(redisConnectionFactory)
            .cacheDefaults(cacheConfiguration());
        return builder.build();
    }
}
```

**é¢„æœŸæ•ˆæœ**: å‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼Œæé«˜å“åº”é€Ÿåº¦

---

#### 3.3 æ‰¹é‡æ“ä½œä¼˜åŒ–

**å½“å‰çŠ¶æ€**: éƒ¨åˆ†æ“ä½œæœªæ‰¹é‡å¤„ç†

**ä¼˜åŒ–å»ºè®®**:
```java
// æ‰¹é‡ä¿å­˜äº‹å®
public void saveFactsBatch(List<UserFact> facts) {
    int batchSize = 100;
    for (int i = 0; i < facts.size(); i += batchSize) {
        List<UserFact> batch = facts.subList(
            i, Math.min(i + batchSize, facts.size())
        );
        mongoTemplate.insertAll(batch);
    }
}
```

**é¢„æœŸæ•ˆæœ**: æé«˜æ‰¹é‡æ“ä½œæ€§èƒ½

---

## ğŸ”§ ä»£ç ä¼˜åŒ–

### 1. å¼‚å¸¸å¤„ç†ä¼˜åŒ–

**å½“å‰çŠ¶æ€**: åŸºç¡€å¼‚å¸¸å¤„ç†

**ä¼˜åŒ–å»ºè®®**:
```java
// ä½¿ç”¨è‡ªå®šä¹‰å¼‚å¸¸
public class MemoryServiceException extends RuntimeException {
    private final ErrorCode errorCode;
    
    public MemoryServiceException(ErrorCode errorCode, String message) {
        super(message);
        this.errorCode = errorCode;
    }
}

// ç»Ÿä¸€å¼‚å¸¸å¤„ç†
@ControllerAdvice
public class MemoryExceptionHandler {
    @ExceptionHandler(MemoryServiceException.class)
    public ResponseEntity<ApiResponse<?>> handleMemoryException(
            MemoryServiceException e) {
        return ResponseEntity.status(e.getErrorCode().getHttpStatus())
            .body(ApiResponse.error(e.getErrorCode().getCode(), e.getMessage()));
    }
}
```

**é¢„æœŸæ•ˆæœ**: æ›´å¥½çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·ä½“éªŒ

---

### 2. æ—¥å¿—ä¼˜åŒ–

**å½“å‰çŠ¶æ€**: åŸºç¡€æ—¥å¿—è®°å½•

**ä¼˜åŒ–å»ºè®®**:
```java
// ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
log.info("ä¿å­˜ç”¨æˆ·äº‹å®: userId={}, factId={}, category={}", 
    userId, factId, category, 
    kv("userId", userId),
    kv("factId", factId),
    kv("category", category)
);

// ä½¿ç”¨MDCè®°å½•è¿½è¸ªä¿¡æ¯
MDC.put("userId", userId);
MDC.put("sessionId", sessionId);
try {
    // ä¸šåŠ¡é€»è¾‘
} finally {
    MDC.clear();
}
```

**é¢„æœŸæ•ˆæœ**: æ›´å¥½çš„æ—¥å¿—å¯è¯»æ€§å’Œè¿½è¸ªèƒ½åŠ›

---

### 3. ä»£ç å¤ç”¨ä¼˜åŒ–

**å½“å‰çŠ¶æ€**: éƒ¨åˆ†ä»£ç é‡å¤

**ä¼˜åŒ–å»ºè®®**:
```java
// æå–å…¬å…±æ–¹æ³•
private <T> List<T> validateAndClean(
    List<T> items, 
    Predicate<T> validator,
    Function<T, String> keyExtractor
) {
    return items.stream()
        .filter(validator)
        .collect(Collectors.toMap(
            keyExtractor,
            Function.identity(),
            (existing, replacement) -> existing
        ))
        .values()
        .stream()
        .collect(Collectors.toList());
}
```

**é¢„æœŸæ•ˆæœ**: å‡å°‘ä»£ç é‡å¤ï¼Œæé«˜å¯ç»´æŠ¤æ€§

---

## ğŸ—ï¸ æ¶æ„ä¼˜åŒ–

### 1. æœåŠ¡æ‹†åˆ†

**å½“å‰çŠ¶æ€**: æ‰€æœ‰æœåŠ¡åœ¨ä¸€ä¸ªæ¨¡å—

**ä¼˜åŒ–å»ºè®®**:
- è€ƒè™‘å°†è®°å¿†ç³»ç»Ÿæ‹†åˆ†ä¸ºç‹¬ç«‹æ¨¡å—
- ä½¿ç”¨å¾®æœåŠ¡æ¶æ„ï¼ˆå¦‚éœ€è¦ï¼‰
- æä¾›ç‹¬ç«‹çš„è®°å¿†æœåŠ¡API

---

### 2. æ•°æ®åˆ†ç‰‡

**å½“å‰çŠ¶æ€**: å•åº“å­˜å‚¨

**ä¼˜åŒ–å»ºè®®**:
```java
// æŒ‰ç”¨æˆ·IDåˆ†ç‰‡
String shardKey = userId.hashCode() % shardCount;
String databaseName = "heartsphere_shard_" + shardKey;
```

**é¢„æœŸæ•ˆæœ**: æé«˜æ•°æ®å­˜å‚¨å’ŒæŸ¥è¯¢æ€§èƒ½

---

### 3. è¯»å†™åˆ†ç¦»

**å½“å‰çŠ¶æ€**: è¯»å†™åŒä¸€æ•°æ®åº“

**ä¼˜åŒ–å»ºè®®**:
```yaml
spring:
  data:
    mongodb:
      uri: mongodb://read-write-host:27017/heartsphere
      replica-set: rs0
      read-preference: secondaryPreferred  # è¯»æ“ä½œä¼˜å…ˆä½¿ç”¨ä»åº“
```

**é¢„æœŸæ•ˆæœ**: æé«˜è¯»æ€§èƒ½ï¼Œå‡è½»ä¸»åº“å‹åŠ›

---

## ğŸ“Š ç›‘æ§å’Œå‘Šè­¦

### 1. æ€§èƒ½ç›‘æ§

**å»ºè®®æŒ‡æ ‡**:
- APIå“åº”æ—¶é—´ï¼ˆP50, P95, P99ï¼‰
- æ•°æ®åº“æŸ¥è¯¢å»¶è¿Ÿ
- ç¼“å­˜å‘½ä¸­ç‡
- é”™è¯¯ç‡
- ååé‡

**å·¥å…·**: Prometheus + Grafana

---

### 2. ä¸šåŠ¡ç›‘æ§

**å»ºè®®æŒ‡æ ‡**:
- è®°å¿†æå–æˆåŠŸç‡
- è®°å¿†æå–å‡†ç¡®ç‡
- ç”¨æˆ·æ´»è·ƒåº¦
- è®°å¿†ä½¿ç”¨é¢‘ç‡

---

### 3. å‘Šè­¦è§„åˆ™

**å»ºè®®è§„åˆ™**:
- å“åº”æ—¶é—´ > 200msï¼ˆP95ï¼‰
- é”™è¯¯ç‡ > 1%
- CPUä½¿ç”¨ç‡ > 80%
- å†…å­˜ä½¿ç”¨ç‡ > 80%
- æ•°æ®åº“è¿æ¥æ•° > 80%

---

## ğŸ”’ å®‰å…¨ä¼˜åŒ–

### 1. æ•°æ®åŠ å¯†

**å»ºè®®**: 
- æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- ä¼ è¾“æ•°æ®ä½¿ç”¨HTTPS
- æ•°æ®åº“è¿æ¥åŠ å¯†

---

### 2. è®¿é—®æ§åˆ¶

**å»ºè®®**:
- åŠ å¼ºç”¨æˆ·æƒé™éªŒè¯
- å®ç°ç»†ç²’åº¦æƒé™æ§åˆ¶
- è®°å½•æ“ä½œæ—¥å¿—

---

## ğŸ“ ä¼˜åŒ–ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§

1. âœ… **ç´¢å¼•ä¼˜åŒ–** - ç«‹å³æ‰§è¡Œ
2. âœ… **è¿æ¥æ± ä¼˜åŒ–** - ç«‹å³æ‰§è¡Œ
3. âœ… **å¼‚æ­¥å¤„ç†ä¼˜åŒ–** - ç«‹å³æ‰§è¡Œ

### ä¸­ä¼˜å…ˆçº§

1. â³ **ç¼“å­˜ä¼˜åŒ–** - 1å‘¨å†…
2. â³ **æ‰¹é‡æ“ä½œä¼˜åŒ–** - 1å‘¨å†…
3. â³ **æŸ¥è¯¢ä¼˜åŒ–** - 2å‘¨å†…

### ä½ä¼˜å…ˆçº§

1. ğŸ“‹ **æœåŠ¡æ‹†åˆ†** - æ ¹æ®éœ€æ±‚
2. ğŸ“‹ **æ•°æ®åˆ†ç‰‡** - æ ¹æ®æ•°æ®é‡
3. ğŸ“‹ **è¯»å†™åˆ†ç¦»** - æ ¹æ®è´Ÿè½½

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

### çŸ­æœŸç›®æ ‡ï¼ˆ1ä¸ªæœˆï¼‰

- âœ… å“åº”æ—¶é—´é™ä½30%
- âœ… ååé‡æé«˜50%
- âœ… é”™è¯¯ç‡é™ä½åˆ°0.1%ä»¥ä¸‹

### ä¸­æœŸç›®æ ‡ï¼ˆ3ä¸ªæœˆï¼‰

- âœ… å“åº”æ—¶é—´é™ä½50%
- âœ… ååé‡æé«˜100%
- âœ… æ”¯æŒ10000+å¹¶å‘ç”¨æˆ·

### é•¿æœŸç›®æ ‡ï¼ˆ6ä¸ªæœˆï¼‰

- âœ… å®ç°è‡ªåŠ¨æ‰©ç¼©å®¹
- âœ… å®ç°æ™ºèƒ½ç¼“å­˜
- âœ… å®ç°æ€§èƒ½è‡ªä¼˜åŒ–

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [æ€§èƒ½æµ‹è¯•æŒ‡å—](./æ€§èƒ½æµ‹è¯•æŒ‡å—.md)
- [æµ‹è¯•æŒ‡å—](./æµ‹è¯•æŒ‡å—.md)
- [é˜¶æ®µä¸€è¯¦ç»†è®¾è®¡](./02-é˜¶æ®µä¸€ï¼šåŸºç¡€è®°å¿†ç³»ç»Ÿ.md)

---

**å¼€å§‹ä¼˜åŒ–ï¼** ğŸš€

