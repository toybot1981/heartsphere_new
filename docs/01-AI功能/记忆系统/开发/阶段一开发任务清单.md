# 阶段一：基础记忆系统 - 开发任务清单

**文档版本**: V1.0  
**编写日期**: 2025-12-28  
**预计周期**: 4-6周

---

## 📋 任务总览

### 任务分组

1. **Week 1-2：短期记忆系统（Redis）**
2. **Week 3-4：长期记忆系统（MongoDB）**
3. **Week 5：记忆提取和检索**
4. **Week 6：API接口和测试**

---

## 一、Week 1-2：短期记忆系统（Redis）

### 任务1.1：创建包结构和数据模型 ✅

**优先级**：高  
**预计时间**：1天

**任务内容**：
- [ ] 创建包结构 `com.heartsphere.memory`
- [ ] 创建数据模型 `ChatMessage`
- [ ] 创建数据模型 `WorkingMemory`
- [ ] 创建枚举 `MessageRole`

**文件清单**：
```
backend/src/main/java/com/heartsphere/memory/
├── model/
│   ├── ChatMessage.java
│   ├── WorkingMemory.java
│   └── MessageRole.java
```

**验收标准**：
- ✅ 数据模型定义完整
- ✅ 包含必要的字段和注解
- ✅ 支持Builder模式

---

### 任务1.2：实现ShortMemoryService接口

**优先级**：高  
**预计时间**：1天

**任务内容**：
- [ ] 定义 `ShortMemoryService` 接口
- [ ] 定义所有必要的方法签名

**文件清单**：
```
backend/src/main/java/com/heartsphere/memory/
├── service/
│   └── ShortMemoryService.java
```

**接口方法**：
```java
public interface ShortMemoryService {
    // 消息管理
    void saveMessage(String sessionId, ChatMessage message);
    List<ChatMessage> getMessages(String sessionId, int limit);
    List<ChatMessage> getMessages(String sessionId, Instant startTime, Instant endTime);
    void deleteMessage(String sessionId, String messageId);
    void clearSession(String sessionId);
    
    // 工作记忆
    void saveWorkingMemory(String sessionId, String key, Object value);
    <T> T getWorkingMemory(String sessionId, String key, Class<T> type);
    void deleteWorkingMemory(String sessionId, String key);
    
    // 会话管理
    boolean sessionExists(String sessionId);
    void deleteSession(String sessionId);
    List<String> getAllSessionIds(String userId);
    
    // 统计
    int getMessageCount(String sessionId);
    int getSessionCount(String userId);
}
```

**验收标准**：
- ✅ 接口定义完整
- ✅ 方法签名清晰
- ✅ 包含必要的JavaDoc注释

---

### 任务1.3：实现RedisShortMemoryService

**优先级**：高  
**预计时间**：2-3天

**任务内容**：
- [ ] 实现 `RedisShortMemoryService`
- [ ] 配置Redis连接
- [ ] 实现消息存储和检索
- [ ] 实现工作记忆管理
- [ ] 实现会话管理
- [ ] 添加日志和异常处理

**文件清单**：
```
backend/src/main/java/com/heartsphere/memory/
├── service/
│   └── impl/
│       └── RedisShortMemoryService.java
```

**关键实现点**：
- Redis List存储消息（`short:msg:{sessionId}`）
- Redis String存储工作记忆（`short:work:{sessionId}:{key}`）
- Redis Set存储会话索引（`short:sessions:{userId}`）
- TTL设置（7天）
- 消息数量限制（100条/会话）

**验收标准**：
- ✅ 所有接口方法实现完整
- ✅ Redis操作正确
- ✅ 异常处理完善
- ✅ 日志记录完整
- ✅ 单元测试通过

---

### 任务1.4：编写单元测试

**优先级**：中  
**预计时间**：1天

**任务内容**：
- [ ] 编写 `RedisShortMemoryServiceTest`
- [ ] 测试消息存储和检索
- [ ] 测试工作记忆管理
- [ ] 测试会话管理
- [ ] 测试边界情况

**文件清单**：
```
backend/src/test/java/com/heartsphere/memory/
├── service/
│   └── impl/
│       └── RedisShortMemoryServiceTest.java
```

**验收标准**：
- ✅ 测试覆盖率 > 80%
- ✅ 所有测试用例通过
- ✅ 包含边界情况测试

---

## 二、Week 3-4：长期记忆系统（MongoDB）

### 任务2.1：创建长期记忆数据模型

**优先级**：高  
**预计时间**：1天

**任务内容**：
- [ ] 创建 `UserFact` 实体
- [ ] 创建 `UserPreference` 实体
- [ ] 创建 `UserMemory` 实体
- [ ] 创建相关枚举类

**文件清单**：
```
backend/src/main/java/com/heartsphere/memory/
├── model/
│   ├── UserFact.java
│   ├── UserPreference.java
│   ├── UserMemory.java
│   ├── FactCategory.java
│   ├── PreferenceType.java
│   ├── MemoryType.java
│   ├── MemoryImportance.java
│   └── MemorySource.java
```

**验收标准**：
- ✅ 实体类定义完整
- ✅ MongoDB注解正确
- ✅ 包含必要的字段和验证

---

### 任务2.2：创建MongoDB Repository

**优先级**：高  
**预计时间**：1天

**任务内容**：
- [ ] 创建 `UserFactRepository`
- [ ] 创建 `UserPreferenceRepository`
- [ ] 创建 `UserMemoryRepository`
- [ ] 定义自定义查询方法

**文件清单**：
```
backend/src/main/java/com/heartsphere/memory/
├── repository/
│   ├── UserFactRepository.java
│   ├── UserPreferenceRepository.java
│   └── UserMemoryRepository.java
```

**验收标准**：
- ✅ Repository接口定义完整
- ✅ 自定义查询方法正确
- ✅ 支持分页和排序

---

### 任务2.3：实现LongMemoryService接口

**优先级**：高  
**预计时间**：1天

**任务内容**：
- [ ] 定义 `LongMemoryService` 接口
- [ ] 定义所有必要的方法签名

**文件清单**：
```
backend/src/main/java/com/heartsphere/memory/
├── service/
│   └── LongMemoryService.java
```

**验收标准**：
- ✅ 接口定义完整
- ✅ 方法签名清晰
- ✅ 包含必要的JavaDoc注释

---

### 任务2.4：实现MongoLongMemoryService

**优先级**：高  
**预计时间**：2-3天

**任务内容**：
- [ ] 实现 `MongoLongMemoryService`
- [ ] 配置MongoDB连接
- [ ] 实现用户事实管理
- [ ] 实现用户偏好管理
- [ ] 实现记忆检索功能
- [ ] 添加日志和异常处理

**文件清单**：
```
backend/src/main/java/com/heartsphere/memory/
├── service/
│   └── impl/
│       └── MongoLongMemoryService.java
```

**关键实现点**：
- MongoDB集合操作
- 文本搜索索引
- 查询优化
- 相关性计算

**验收标准**：
- ✅ 所有接口方法实现完整
- ✅ MongoDB操作正确
- ✅ 查询性能满足要求
- ✅ 异常处理完善
- ✅ 单元测试通过

---

### 任务2.5：创建MongoDB索引

**优先级**：中  
**预计时间**：0.5天

**任务内容**：
- [ ] 创建索引初始化脚本
- [ ] 创建 `user_facts` 索引
- [ ] 创建 `user_preferences` 索引
- [ ] 创建 `user_memories` 索引

**文件清单**：
```
backend/src/main/resources/
├── db/
│   └── mongodb/
│       └── init-indexes.js
```

**索引定义**：
```javascript
// user_facts索引
db.user_facts.createIndex({ userId: 1, category: 1 });
db.user_facts.createIndex({ userId: 1, importance: -1 });
db.user_facts.createIndex({ fact: "text" });
db.user_facts.createIndex({ userId: 1, lastAccessedAt: -1 });

// user_preferences索引
db.user_preferences.createIndex({ userId: 1, key: 1 }, { unique: true });
db.user_preferences.createIndex({ userId: 1, updatedAt: -1 });
```

**验收标准**：
- ✅ 索引创建脚本完整
- ✅ 索引创建成功
- ✅ 查询性能提升明显

---

### 任务2.6：编写单元测试

**优先级**：中  
**预计时间**：1天

**任务内容**：
- [ ] 编写 `MongoLongMemoryServiceTest`
- [ ] 测试用户事实CRUD
- [ ] 测试用户偏好CRUD
- [ ] 测试记忆检索
- [ ] 测试边界情况

**验收标准**：
- ✅ 测试覆盖率 > 80%
- ✅ 所有测试用例通过
- ✅ 包含边界情况测试

---

## 三、Week 5：记忆提取和检索

### 任务3.1：实现MemoryExtractor接口

**优先级**：高  
**预计时间**：1天

**任务内容**：
- [ ] 定义 `MemoryExtractor` 接口
- [ ] 定义提取方法签名

**文件清单**：
```
backend/src/main/java/com/heartsphere/memory/
├── service/
│   └── MemoryExtractor.java
```

**验收标准**：
- ✅ 接口定义完整
- ✅ 方法签名清晰

---

### 任务3.2：实现LLMMemoryExtractor

**优先级**：高  
**预计时间**：2-3天

**任务内容**：
- [ ] 实现 `LLMMemoryExtractor`
- [ ] 集成大模型统一接入层
- [ ] 实现事实提取
- [ ] 实现偏好提取
- [ ] 实现提取结果解析
- [ ] 添加验证和清理逻辑

**文件清单**：
```
backend/src/main/java/com/heartsphere/memory/
├── service/
│   └── impl/
│       └── LLMMemoryExtractor.java
```

**关键实现点**：
- 构建提取提示词
- 调用大模型API
- 解析JSON响应
- 验证提取结果
- 去重处理

**验收标准**：
- ✅ 提取准确率 > 70%
- ✅ 异常处理完善
- ✅ 支持降级到规则提取

---

### 任务3.3：实现RuleBasedMemoryExtractor（备用）

**优先级**：中  
**预计时间**：1-2天

**任务内容**：
- [ ] 实现 `RuleBasedMemoryExtractor`
- [ ] 实现规则提取逻辑
- [ ] 实现姓名提取
- [ ] 实现偏好提取
- [ ] 实现其他信息提取

**文件清单**：
```
backend/src/main/java/com/heartsphere/memory/
├── service/
│   └── impl/
│       └── RuleBasedMemoryExtractor.java
```

**验收标准**：
- ✅ 规则提取逻辑正确
- ✅ 作为LLM提取的备用方案
- ✅ 单元测试通过

---

### 任务3.4：实现MemoryManager

**优先级**：高  
**预计时间**：2-3天

**任务内容**：
- [ ] 实现 `MemoryManager` 接口
- [ ] 协调短期和长期记忆
- [ ] 实现记忆提取和保存
- [ ] 实现记忆检索
- [ ] 实现用户画像构建

**文件清单**：
```
backend/src/main/java/com/heartsphere/memory/
├── service/
│   └── impl/
│       └── MemoryManagerImpl.java
```

**关键实现点**：
- 统一记忆访问接口
- 短期+长期记忆混合检索
- 异步记忆提取
- 用户画像构建

**验收标准**：
- ✅ 所有接口方法实现完整
- ✅ 记忆检索性能满足要求
- ✅ 异常处理完善
- ✅ 单元测试通过

---

## 四、Week 6：API接口和测试

### 任务4.1：实现REST API Controller

**优先级**：高  
**预计时间**：2-3天

**任务内容**：
- [ ] 创建 `MemoryController`
- [ ] 实现短期记忆API
- [ ] 实现长期记忆API
- [ ] 实现记忆提取API
- [ ] 添加参数验证
- [ ] 添加异常处理
- [ ] 添加API文档注解

**文件清单**：
```
backend/src/main/java/com/heartsphere/memory/
├── controller/
│   └── MemoryController.java
```

**API端点**：
- `POST /api/memory/v1/sessions/{sessionId}/messages` - 保存消息
- `GET /api/memory/v1/sessions/{sessionId}/messages` - 获取消息
- `POST /api/memory/v1/users/{userId}/facts` - 保存事实
- `GET /api/memory/v1/users/{userId}/facts/search` - 搜索事实
- `POST /api/memory/v1/users/{userId}/preferences` - 保存偏好
- `GET /api/memory/v1/users/{userId}/preferences/{key}` - 获取偏好
- `POST /api/memory/v1/users/{userId}/sessions/{sessionId}/extract` - 提取记忆

**验收标准**：
- ✅ 所有API端点实现完整
- ✅ 参数验证正确
- ✅ 异常处理完善
- ✅ API文档完整
- ✅ 集成测试通过

---

### 任务4.2：配置Spring Boot

**优先级**：高  
**预计时间**：0.5天

**任务内容**：
- [ ] 配置Redis连接
- [ ] 配置MongoDB连接
- [ ] 配置大模型接入层
- [ ] 添加配置属性类

**文件清单**：
```
backend/src/main/resources/
├── application.yml
└── application-dev.yml

backend/src/main/java/com/heartsphere/memory/
├── config/
│   ├── RedisConfig.java
│   ├── MongoConfig.java
│   └── MemoryProperties.java
```

**验收标准**：
- ✅ 配置正确
- ✅ 连接测试通过
- ✅ 支持多环境配置

---

### 任务4.3：编写集成测试

**优先级**：中  
**预计时间**：1-2天

**任务内容**：
- [ ] 编写API集成测试
- [ ] 测试完整流程
- [ ] 测试异常情况
- [ ] 性能测试

**文件清单**：
```
backend/src/test/java/com/heartsphere/memory/
├── controller/
│   └── MemoryControllerTest.java
└── integration/
    └── MemorySystemIntegrationTest.java
```

**验收标准**：
- ✅ 集成测试通过
- ✅ 覆盖主要流程
- ✅ 性能满足要求

---

### 任务4.4：编写文档

**优先级**：中  
**预计时间**：1天

**任务内容**：
- [ ] 更新API文档
- [ ] 编写使用示例
- [ ] 编写部署文档
- [ ] 编写故障排查文档

**验收标准**：
- ✅ 文档完整
- ✅ 示例清晰
- ✅ 易于理解

---

## 五、开发规范

### 5.1 代码规范

- 遵循Java编码规范
- 使用Lombok简化代码
- 添加必要的JavaDoc注释
- 使用统一的异常处理

### 5.2 测试规范

- 单元测试覆盖率 > 80%
- 集成测试覆盖主要流程
- 使用Mockito进行Mock
- 使用TestContainers进行集成测试（可选）

### 5.3 提交规范

- 每个任务完成后提交
- 提交信息清晰
- 包含必要的测试

---

## 六、验收标准

### 6.1 功能验收

- ✅ 短期记忆读写功能正常
- ✅ 长期记忆CRUD功能正常
- ✅ 记忆提取功能正常
- ✅ 记忆检索功能正常
- ✅ API接口完整可用

### 6.2 性能验收

- ✅ 短期记忆读写延迟 < 10ms
- ✅ 长期记忆检索延迟 < 100ms
- ✅ 记忆提取准确率 > 70%
- ✅ 支持1000+并发用户

### 6.3 质量验收

- ✅ 单元测试覆盖率 > 80%
- ✅ 集成测试通过
- ✅ 代码审查通过
- ✅ 文档完整

---

## 七、风险与应对

### 7.1 技术风险

**风险1：Redis连接问题**
- **应对**：使用连接池，添加重试机制
- **监控**：监控连接状态

**风险2：MongoDB查询性能**
- **应对**：合理设计索引，优化查询
- **监控**：监控查询延迟

**风险3：记忆提取准确率不足**
- **应对**：使用LLM+规则双重保障
- **监控**：定期检查提取准确率

### 7.2 进度风险

**风险1：开发进度延迟**
- **应对**：每日站会，及时调整
- **监控**：跟踪任务完成情况

---

## 八、每日站会要点

### 每日检查

1. 昨天完成了什么？
2. 今天计划做什么？
3. 遇到了什么阻碍？

### 每周总结

1. 本周完成的任务
2. 遇到的问题和解决方案
3. 下周计划

---

## 九、参考资源

- [阶段一详细设计文档](./02-阶段一：基础记忆系统.md)
- [长期记忆与短期记忆设计详解](./长期记忆与短期记忆设计详解.md)
- [API文档](./07-API文档.md)
- [使用指南](./08-使用指南.md)

---

**开始开发！** 🚀

