# é˜¶æ®µå››å’Œé˜¶æ®µäº”ç¬¬ä¸€é˜¶æ®µå®ŒæˆæŠ¥å‘Š

**å®Œæˆæ—¥æœŸ**: 2025-12-29  
**é˜¶æ®µ**: ç¬¬ä¸€é˜¶æ®µï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## âœ… å®Œæˆå†…å®¹

### 1. Embedding æ¨¡å‹é›†æˆ

#### 1.1 DashScopeEmbeddingService

**æ–‡ä»¶**: `backend/src/main/java/com/heartsphere/memory/service/DashScopeEmbeddingService.java`

**åŠŸèƒ½**:
- âœ… é›†æˆ DashScope Embedding APIï¼ˆtext-embedding-v2ï¼‰
- âœ… æ”¯æŒå•ä¸ªå’Œæ‰¹é‡æ–‡æœ¬å‘é‡ç”Ÿæˆ
- âœ… å‘é‡ç»´åº¦ï¼š1536
- âœ… æ‰¹é‡å¤„ç†ï¼ˆæ¯æ‰¹æœ€å¤š25ä¸ªæ–‡æœ¬ï¼‰
- âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

**å…³é”®æ–¹æ³•**:
- `generateEmbedding(String text)` - ç”Ÿæˆå•ä¸ªæ–‡æœ¬å‘é‡
- `generateEmbeddings(List<String> texts)` - æ‰¹é‡ç”Ÿæˆå‘é‡
- `isAvailable()` - æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯ç”¨

#### 1.2 SimpleVectorSearchService æ›´æ–°

**æ–‡ä»¶**: `backend/src/main/java/com/heartsphere/memory/service/impl/SimpleVectorSearchService.java`

**æ›´æ–°å†…å®¹**:
- âœ… æ³¨å…¥ `DashScopeEmbeddingService`
- âœ… `generateEmbedding()` æ–¹æ³•ä¼˜å…ˆä½¿ç”¨çœŸå® Embedding
- âœ… å®ç°é™çº§ç­–ç•¥ï¼ˆå¤±è´¥æ—¶ä½¿ç”¨å“ˆå¸Œå‘é‡ï¼‰
- âœ… è‡ªåŠ¨æ›´æ–°å‘é‡ç»´åº¦

**é™çº§ç­–ç•¥**:
```
1. å°è¯•ä½¿ç”¨ DashScope Embedding API
2. å¦‚æœå¤±è´¥æˆ–ä¸å¯ç”¨ï¼Œé™çº§åˆ°å“ˆå¸Œå‘é‡ï¼ˆ384ç»´ï¼‰
3. è®°å½•æ—¥å¿—ä¾¿äºæ’æŸ¥
```

### 2. REST API Controllers

#### 2.1 AdvancedMemoryController (v4)

**æ–‡ä»¶**: `backend/src/main/java/com/heartsphere/memory/controller/AdvancedMemoryController.java`

**è·¯å¾„**: `/api/memory/v4`

**APIç«¯ç‚¹**ï¼ˆ7ä¸ªï¼‰:

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|------|
| POST | `/vector/embed` | ç”Ÿæˆå‘é‡åµŒå…¥ | âœ… |
| POST | `/vector/search` | å‘é‡è¯­ä¹‰æœç´¢ | âœ… |
| GET | `/associations/{memoryId}` | è·å–è®°å¿†å…³è” | âœ… |
| POST | `/associations/discover` | å‘ç°è®°å¿†å…³è” | âœ… |
| POST | `/intelligent/search` | æ™ºèƒ½æ£€ç´¢ | âœ… |
| POST | `/intelligent/hybrid-search` | æ··åˆæ£€ç´¢ | âœ… |
| POST | `/consolidation/execute` | æ‰§è¡Œè®°å¿†å·©å›º | âœ… |
| GET | `/consolidation/stats` | å·©å›ºç»Ÿè®¡ | âœ…ï¼ˆç®€åŒ–ï¼‰ |

#### 2.2 MemoryOptimizationController (v5)

**æ–‡ä»¶**: `backend/src/main/java/com/heartsphere/memory/controller/MemoryOptimizationController.java`

**è·¯å¾„**: `/api/memory/v5`

**APIç«¯ç‚¹**ï¼ˆ12ä¸ªï¼‰:

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|------|
| POST | `/decay/update` | æ›´æ–°è®°å¿†è¡°å‡ | âœ… |
| GET | `/decay/stats` | è¡°å‡ç»Ÿè®¡ | âœ…ï¼ˆç®€åŒ–ï¼‰ |
| POST | `/cache/warmup` | ç¼“å­˜é¢„çƒ­ | âš ï¸ å¾…å®ç° |
| DELETE | `/cache/clear` | æ¸…ç†ç¼“å­˜ | âš ï¸ å¾…å®ç° |
| GET | `/cache/stats` | ç¼“å­˜ç»Ÿè®¡ | âš ï¸ å¾…å®ç° |
| POST | `/compression/compress` | å‹ç¼©è®°å¿† | âš ï¸ å¾…å®ç° |
| POST | `/archiving/archive` | å½’æ¡£è®°å¿† | âš ï¸ å¾…å®ç° |
| GET | `/archiving/list` | å½’æ¡£åˆ—è¡¨ | âš ï¸ å¾…å®ç° |
| POST | `/archiving/restore` | æ¢å¤å½’æ¡£ | âš ï¸ å¾…å®ç° |
| GET | `/monitoring/metrics` | æ€§èƒ½æŒ‡æ ‡ | âš ï¸ å¾…å®ç° |
| GET | `/monitoring/health` | å¥åº·æ£€æŸ¥ | âœ…ï¼ˆç®€åŒ–ï¼‰ |
| GET | `/monitoring/diagnostics` | è¯Šæ–­ä¿¡æ¯ | âš ï¸ å¾…å®ç° |

**æ³¨æ„**: v5 ä¸­çš„éƒ¨åˆ†åŠŸèƒ½æ ‡è®°ä¸º"å¾…å®ç°"ï¼Œå°†åœ¨ç¬¬äºŒé˜¶æ®µå®Œæˆã€‚

### 3. DTO ç±»

#### 3.1 VectorSearchRequest

**æ–‡ä»¶**: `backend/src/main/java/com/heartsphere/memory/dto/VectorSearchRequest.java`

**å­—æ®µ**:
- `query` - æŸ¥è¯¢æ–‡æœ¬
- `userId` - ç”¨æˆ·IDï¼ˆå¯é€‰ï¼‰
- `characterId` - è§’è‰²IDï¼ˆå¯é€‰ï¼‰
- `participantId` - å‚ä¸è€…IDï¼ˆå¯é€‰ï¼‰
- `limit` - è¿”å›æ•°é‡é™åˆ¶ï¼ˆé»˜è®¤10ï¼‰
- `threshold` - ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆé»˜è®¤0.6ï¼‰

#### 3.2 IntelligentSearchRequest

**æ–‡ä»¶**: `backend/src/main/java/com/heartsphere/memory/dto/IntelligentSearchRequest.java`

**å­—æ®µ**:
- `query` - æŸ¥è¯¢æ–‡æœ¬
- `userId` - ç”¨æˆ·ID
- `characterId` - è§’è‰²IDï¼ˆå¯é€‰ï¼‰
- `participantId` - å‚ä¸è€…IDï¼ˆå¯é€‰ï¼‰
- `context` - ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
- `limit` - è¿”å›æ•°é‡é™åˆ¶ï¼ˆé»˜è®¤10ï¼‰
- `semanticWeight` - è¯­ä¹‰æƒé‡ï¼ˆé»˜è®¤0.4ï¼‰
- `keywordWeight` - å…³é”®è¯æƒé‡ï¼ˆé»˜è®¤0.4ï¼‰
- `associationWeight` - å…³è”æƒé‡ï¼ˆé»˜è®¤0.2ï¼‰

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

- **æ–°å¢æ–‡ä»¶**: 5ä¸ª
- **ä¿®æ”¹æ–‡ä»¶**: 1ä¸ª
- **APIç«¯ç‚¹**: 19ä¸ªï¼ˆv4: 8ä¸ªï¼Œv5: 12ä¸ªï¼‰
- **ä»£ç è¡Œæ•°**: çº¦1500è¡Œ

---

## âœ… æŠ€æœ¯è¦ç‚¹

### Embedding é›†æˆ

1. **APIè°ƒç”¨**:
   - URL: `https://dashscope.aliyuncs.com/api/v1/services/embeddings/text-embedding/text-embedding`
   - æ¨¡å‹: `text-embedding-v2`
   - å‘é‡ç»´åº¦: 1536

2. **æ‰¹é‡å¤„ç†**:
   - å•æ¬¡æœ€å¤š25ä¸ªæ–‡æœ¬
   - è‡ªåŠ¨åˆ†æ‰¹å¤„ç†
   - é”™è¯¯å®¹é”™ï¼ˆç»§ç»­å¤„ç†ä¸‹ä¸€æ‰¹ï¼‰

3. **é™çº§ç­–ç•¥**:
   - APIè°ƒç”¨å¤±è´¥æ—¶ä½¿ç”¨å“ˆå¸Œå‘é‡
   - è®°å½•æ—¥å¿—ä¾¿äºæ’æŸ¥
   - ä¿è¯æœåŠ¡å¯ç”¨æ€§

### REST API è®¾è®¡

1. **ç‰ˆæœ¬æ§åˆ¶**:
   - v4: é«˜çº§è®°å¿†èƒ½åŠ›
   - v5: è®°å¿†ç³»ç»Ÿä¼˜åŒ–

2. **ç»Ÿä¸€å“åº”æ ¼å¼**:
   - ä½¿ç”¨ `ApiResponse<T>` ç»Ÿä¸€å°è£…
   - åŒ…å« `code`, `message`, `data`, `timestamp`

3. **è®¤è¯å’Œæˆæƒ**:
   - ä½¿ç”¨ `@AuthenticationPrincipal UserDetails`
   - æ”¯æŒä»è®¤è¯ä¿¡æ¯è·å–ç”¨æˆ·ID

---

## âš ï¸ å·²çŸ¥é—®é¢˜

1. **éƒ¨åˆ†åŠŸèƒ½å¾…å®ç°**:
   - v5 Controller ä¸­çš„ç¼“å­˜ã€å‹ç¼©å½’æ¡£ã€ç›‘æ§è¯Šæ–­åŠŸèƒ½æ ‡è®°ä¸º"å¾…å®ç°"
   - å°†åœ¨ç¬¬äºŒé˜¶æ®µå®Œæˆ

2. **URLæ„å»ºé€»è¾‘**:
   - DashScope Embedding API çš„ URL æ„å»ºå¯èƒ½éœ€è¦æ ¹æ®å®é™… API æ–‡æ¡£è°ƒæ•´
   - å½“å‰å®ç°åŸºäºæŠ€æœ¯æ–¹æ¡ˆï¼Œéœ€è¦éªŒè¯

---

## ğŸ¯ ä¸‹ä¸€æ­¥

### é€‰é¡¹1ï¼šç»§ç»­ç¬¬äºŒé˜¶æ®µ
- å®ç°ç¼“å­˜ä¼˜åŒ–æœåŠ¡
- å®ç°å‹ç¼©å½’æ¡£æœåŠ¡
- å®ç°ç›‘æ§è¯Šæ–­ç³»ç»Ÿ

### é€‰é¡¹2ï¼šæµ‹è¯•ç¬¬ä¸€é˜¶æ®µ
- åˆ›å»ºå•å…ƒæµ‹è¯•
- åˆ›å»ºé›†æˆæµ‹è¯•
- éªŒè¯ Embedding é›†æˆ
- æµ‹è¯• REST API

---

**ç¬¬ä¸€é˜¶æ®µæ ¸å¿ƒåŠŸèƒ½å®Œæˆï¼** âœ…



