# 记忆系统下一步开发计划

**文档版本**: V1.0  
**编写日期**: 2025-12-28

---

## 📋 当前状态

### ✅ 已完成

1. **基础架构** ✅
   - 数据模型（13个文件）
   - 服务接口（4个文件）
   - 配置类（3个文件）

2. **短期记忆系统** ✅
   - RedisShortMemoryService实现
   - 消息存储和检索
   - 工作记忆管理

3. **长期记忆系统** ✅
   - MongoDB Repository（3个）
   - MongoLongMemoryService实现
   - 记忆CRUD操作

4. **记忆管理器** ✅
   - MemoryManagerImpl实现
   - 统一记忆访问接口

5. **温度感系统集成** ✅
   - TemperatureMemoryService集成
   - 情感记忆提取和检索

---

## 🎯 下一步开发任务

### 优先级1：MemoryExtractor实现（Week 5）

#### 任务1.1：实现LLMMemoryExtractor

**文件**: `backend/src/main/java/com/heartsphere/memory/service/impl/LLMMemoryExtractor.java`

**功能**：
- 使用大模型提取用户事实
- 使用大模型提取用户偏好
- 使用大模型提取用户记忆
- 解析JSON响应
- 验证和清理提取结果

**关键实现**：
```java
@Service
@RequiredArgsConstructor
public class LLMMemoryExtractor implements MemoryExtractor {
    private final AIService aiService;
    
    @Override
    public List<UserFact> extractFacts(String userId, List<ChatMessage> messages) {
        // 构建提取提示词
        String prompt = buildFactExtractionPrompt(messages);
        
        // 调用AI服务
        TextGenerationResponse response = aiService.generateText(userId, request);
        
        // 解析JSON响应
        return parseFactsFromResponse(response);
    }
}
```

**预计时间**: 2-3天

---

#### 任务1.2：实现RuleBasedMemoryExtractor

**文件**: `backend/src/main/java/com/heartsphere/memory/service/impl/RuleBasedMemoryExtractor.java`

**功能**：
- 基于规则的记忆提取（备用方案）
- 姓名提取
- 偏好提取
- 其他信息提取

**预计时间**: 1-2天

---

### 优先级2：REST API实现（Week 6）

#### 任务2.1：实现MemoryController

**文件**: `backend/src/main/java/com/heartsphere/memory/controller/MemoryController.java`

**API端点**：
- `POST /api/memory/v1/sessions/{sessionId}/messages` - 保存消息
- `GET /api/memory/v1/sessions/{sessionId}/messages` - 获取消息
- `POST /api/memory/v1/users/{userId}/facts` - 保存事实
- `GET /api/memory/v1/users/{userId}/facts/search` - 搜索事实
- `POST /api/memory/v1/users/{userId}/preferences` - 保存偏好
- `GET /api/memory/v1/users/{userId}/preferences/{key}` - 获取偏好
- `POST /api/memory/v1/users/{userId}/sessions/{sessionId}/extract` - 提取记忆
- `GET /api/memory/v1/users/{userId}/memories/search` - 搜索记忆
- `GET /api/memory/v1/users/{userId}/profile` - 获取用户画像

**预计时间**: 2-3天

---

### 优先级3：测试完善（Week 6-7）

#### 任务3.1：完善单元测试

**文件**：
- `RedisShortMemoryServiceTest.java` ✅（已创建）
- `MongoLongMemoryServiceTest.java`
- `MemoryManagerImplTest.java`
- `TemperatureMemoryServiceTest.java` ✅（已创建）
- `LLMMemoryExtractorTest.java`
- `RuleBasedMemoryExtractorTest.java`

**目标**：测试覆盖率 > 80%

**预计时间**: 2-3天

---

#### 任务3.2：编写集成测试

**文件**：
- `MemorySystemIntegrationTest.java`
- `TemperatureMemoryIntegrationTest.java`

**预计时间**: 1-2天

---

### 优先级4：性能优化（Week 7-8）

#### 任务4.1：性能测试

- 短期记忆读写性能测试
- 长期记忆检索性能测试
- 并发性能测试
- 压力测试

**预计时间**: 2-3天

---

#### 任务4.2：优化实现

- Redis连接池优化
- MongoDB查询优化
- 索引优化
- 缓存策略优化

**预计时间**: 2-3天

---

## 📅 开发时间表

### Week 5（记忆提取）

- **Day 1-2**: 实现LLMMemoryExtractor
- **Day 3**: 实现RuleBasedMemoryExtractor
- **Day 4-5**: 测试和优化

### Week 6（API和测试）

- **Day 1-2**: 实现MemoryController
- **Day 3-4**: 完善单元测试
- **Day 5**: 编写集成测试

### Week 7-8（优化）

- **Week 7**: 性能测试和优化
- **Week 8**: 文档完善和发布准备

---

## 🎯 里程碑

### 里程碑1：记忆提取完成（Week 5结束）

**验收标准**：
- ✅ LLMMemoryExtractor实现完成
- ✅ RuleBasedMemoryExtractor实现完成
- ✅ 单元测试通过
- ✅ 提取准确率 > 70%

### 里程碑2：API完成（Week 6结束）

**验收标准**：
- ✅ MemoryController实现完成
- ✅ 所有API端点可用
- ✅ API文档完整
- ✅ 集成测试通过

### 里程碑3：系统优化完成（Week 8结束）

**验收标准**：
- ✅ 性能测试通过
- ✅ 性能指标达标
- ✅ 文档完善
- ✅ 系统稳定

---

## 📝 开发规范

### 代码规范

- 遵循Java编码规范
- 使用Lombok简化代码
- 添加必要的JavaDoc注释
- 使用统一的异常处理

### 测试规范

- 单元测试覆盖率 > 80%
- 集成测试覆盖主要流程
- 使用Mockito进行Mock
- 使用TestContainers进行集成测试（可选）

### 提交规范

- 每个任务完成后提交
- 提交信息清晰
- 包含必要的测试

---

## 🔗 相关文档

- [阶段一详细设计](./02-阶段一：基础记忆系统.md)
- [测试指南](./测试指南.md)
- [快速验证指南](./快速验证指南.md)
- [温度感系统集成说明](./温度感系统集成说明.md)

---

**开始下一步开发！** 🚀

