# é˜¶æ®µä¸€ï¼šåŸºç¡€è®°å¿†ç³»ç»Ÿ - æ¸©åº¦æ„Ÿç³»ç»Ÿé›†æˆå®Œæˆæ€»ç»“

**æ–‡æ¡£ç‰ˆæœ¬**: V1.0  
**ç¼–å†™æ—¥æœŸ**: 2025-12-28

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. MongoDB Repository âœ…

å·²åˆ›å»ºä¸‰ä¸ªRepositoryæ¥å£ï¼š
- âœ… `UserFactRepository` - ç”¨æˆ·äº‹å®Repository
- âœ… `UserPreferenceRepository` - ç”¨æˆ·åå¥½Repository
- âœ… `UserMemoryRepository` - ç”¨æˆ·è®°å¿†Repositoryï¼ˆæ”¯æŒæ¸©åº¦æ„Ÿç³»ç»Ÿï¼‰

**å…³é”®ç‰¹æ€§**ï¼š
- æ”¯æŒæŒ‰æƒ…ç»ªç±»å‹æ£€ç´¢è®°å¿†ï¼ˆ`findByUserIdAndEmotionType`ï¼‰
- æ”¯æŒæŒ‰è®°å¿†ç±»å‹æ£€ç´¢ï¼ˆ`findByUserIdAndType`ï¼‰
- æ”¯æŒæ–‡æœ¬æœç´¢ï¼ˆ`searchByUserIdAndText`ï¼‰
- æ”¯æŒåˆ†é¡µå’Œæ’åº

### 2. MongoLongMemoryService âœ…

å·²å®ç°MongoDBé•¿æœŸè®°å¿†æœåŠ¡ï¼š
- âœ… ç”¨æˆ·äº‹å®CRUDæ“ä½œ
- âœ… ç”¨æˆ·åå¥½CRUDæ“ä½œ
- âœ… è®°å¿†æ£€ç´¢ï¼ˆæ”¯æŒæ¸©åº¦æ„Ÿç³»ç»Ÿçš„æƒ…æ„Ÿè®°å¿†æ£€ç´¢ï¼‰
- âœ… æ”¯æŒæŒ‰ä¸Šä¸‹æ–‡æ£€ç´¢è®°å¿†ï¼ˆåŒ…æ‹¬æƒ…ç»ªç±»å‹ï¼‰

**å…³é”®æ–¹æ³•**ï¼š
- `saveMemory()` - ä¿å­˜ç”¨æˆ·è®°å¿†
- `saveMemories()` - æ‰¹é‡ä¿å­˜ç”¨æˆ·è®°å¿†
- `retrieveMemoriesByContext()` - æ ¹æ®ä¸Šä¸‹æ–‡æ£€ç´¢è®°å¿†ï¼ˆæ”¯æŒemotionTypeï¼‰
- `getMemoriesByType()` - æ ¹æ®ç±»å‹è·å–è®°å¿†

### 3. MemoryManagerImpl âœ…

å·²å®ç°è®°å¿†ç®¡ç†å™¨ï¼š
- âœ… åè°ƒçŸ­æœŸå’Œé•¿æœŸè®°å¿†
- âœ… æä¾›ç»Ÿä¸€çš„è®°å¿†è®¿é—®æ¥å£
- âœ… æ”¯æŒå¼‚æ­¥è®°å¿†æå–
- âœ… æ”¯æŒç”¨æˆ·ç”»åƒæ„å»º
- âœ… æä¾›`saveMemory()`å’Œ`saveMemories()`æ–¹æ³•ä¾›TemperatureMemoryServiceä½¿ç”¨

### 4. TemperatureMemoryServiceé›†æˆ âœ…

å·²æ›´æ–°TemperatureMemoryServiceï¼š
- âœ… ä¿®å¤äº†è®°å¿†ä¿å­˜é€»è¾‘
- âœ… é€šè¿‡MemoryManagerImplä¿å­˜è®°å¿†
- âœ… æ·»åŠ äº†æ—¥å¿—è®°å½•

---

## ğŸ”— é›†æˆæ¶æ„

```
EmotionService
    â”‚
    â”œâ”€â–¶ saveEmotionRecord()
    â”‚       â”‚
    â”‚       â””â”€â–¶ TemperatureMemoryService.extractMemoriesFromEmotion()
    â”‚                   â”‚
    â”‚                   â”œâ”€â–¶ æå–æƒ…ç»ªæ¨¡å¼è®°å¿† (EMOTION_PATTERN)
    â”‚                   â”œâ”€â–¶ æå–æƒ…æ„Ÿç»å†è®°å¿† (EMOTIONAL_EXPERIENCE)
    â”‚                   â””â”€â–¶ æå–æƒ…ç»ªåå¥½è®°å¿† (EMOTIONAL_PREFERENCE)
    â”‚                           â”‚
    â”‚                           â””â”€â–¶ MemoryManagerImpl.saveMemories()
    â”‚                                       â”‚
    â”‚                                       â””â”€â–¶ MongoLongMemoryService.saveMemories()
    â”‚                                                   â”‚
    â”‚                                                   â””â”€â–¶ MongoDBå­˜å‚¨
```

---

## ğŸ“Š æ”¯æŒçš„æƒ…æ„Ÿè®°å¿†ç±»å‹

### 1. æƒ…ç»ªæ¨¡å¼è®°å¿† (EMOTION_PATTERN)

**è§¦å‘æ¡ä»¶**ï¼š
- ç½®ä¿¡åº¦ > 0.7
- æƒ…ç»ªå¼ºåº¦ä¸º moderate æˆ– strong

**å­˜å‚¨ä½ç½®**ï¼š`user_memories` é›†åˆ

**æ£€ç´¢æ–¹å¼**ï¼š
```java
List<UserMemory> patterns = temperatureMemoryService.getEmotionPatterns(userId);
```

### 2. æƒ…æ„Ÿç»å†è®°å¿† (EMOTIONAL_EXPERIENCE)

**è§¦å‘æ¡ä»¶**ï¼š
- æƒ…ç»ªå¼ºåº¦ä¸º strong
- ç½®ä¿¡åº¦ > 0.7

**å­˜å‚¨ä½ç½®**ï¼š`user_memories` é›†åˆ

**æ£€ç´¢æ–¹å¼**ï¼š
```java
List<UserMemory> experiences = temperatureMemoryService.getEmotionalExperiences(
    userId, "sad", 20
);
```

### 3. æƒ…ç»ªåå¥½è®°å¿† (EMOTIONAL_PREFERENCE)

**è§¦å‘æ¡ä»¶**ï¼š
- ç§¯ææƒ…ç»ª
- å…³é”®çŸ­è¯­åŒ…å«åå¥½ç›¸å…³è¯æ±‡

**å­˜å‚¨ä½ç½®**ï¼š`user_memories` é›†åˆ

---

## ğŸ” æ£€ç´¢åŠŸèƒ½

### 1. æ ¹æ®æƒ…ç»ªç±»å‹æ£€ç´¢

```java
// é€šè¿‡MemoryManager
List<UserMemory> memories = memoryManager.retrieveMemoriesByContext(
    userId,
    Map.of("emotionType", "happy"),
    10
);

// é€šè¿‡TemperatureMemoryService
List<UserMemory> memories = temperatureMemoryService.retrieveMemoriesByEmotion(
    userId, "happy", 10
);
```

### 2. æ ¹æ®è®°å¿†ç±»å‹æ£€ç´¢

```java
List<UserMemory> memories = mongoLongMemoryService.retrieveMemoriesByContext(
    userId,
    Map.of("type", "EMOTION_PATTERN"),
    20
);
```

### 3. ç»„åˆæ£€ç´¢

```java
Map<String, Object> context = new HashMap<>();
context.put("type", "EMOTIONAL_EXPERIENCE");
context.put("importance", "IMPORTANT");
context.put("emotionType", "sad");

List<UserMemory> memories = mongoLongMemoryService.retrieveMemoriesByContext(
    userId, context, 10
);
```

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### Repositoryï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰

1. `repository/UserFactRepository.java` âœ…
2. `repository/UserPreferenceRepository.java` âœ…
3. `repository/UserMemoryRepository.java` âœ…

### Serviceå®ç°ï¼ˆ2ä¸ªæ–‡ä»¶ï¼‰

1. `service/impl/MongoLongMemoryService.java` âœ…
2. `service/impl/MemoryManagerImpl.java` âœ…

### é›†æˆæ›´æ–°ï¼ˆ1ä¸ªæ–‡ä»¶ï¼‰

1. `service/TemperatureMemoryService.java` âœ…ï¼ˆå·²æ›´æ–°ï¼‰

### æ–‡æ¡£ï¼ˆ2ä¸ªæ–‡ä»¶ï¼‰

1. `æ¸©åº¦æ„Ÿç³»ç»Ÿé›†æˆè¯´æ˜.md` âœ…
2. `é˜¶æ®µä¸€å¼€å‘æ€»ç»“-æ¸©åº¦æ„Ÿé›†æˆ.md` âœ…ï¼ˆæœ¬æ–‡æ¡£ï¼‰

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šè‡ªåŠ¨æå–è®°å¿†

```java
// åœ¨EmotionServiceä¸­è‡ªåŠ¨è°ƒç”¨
EmotionRecord record = emotionService.saveEmotionRecord(analysis, request);
// è‡ªåŠ¨æå–è®°å¿†ï¼ˆå†…éƒ¨è°ƒç”¨TemperatureMemoryServiceï¼‰
```

### ç¤ºä¾‹2ï¼šæ£€ç´¢ç›¸å…³è®°å¿†

```java
@Autowired
private TemperatureMemoryService temperatureMemoryService;

// æ ¹æ®æƒ…ç»ªæ£€ç´¢è®°å¿†
List<UserMemory> memories = temperatureMemoryService.retrieveMemoriesByEmotion(
    userId, "happy", 10
);

// è·å–æƒ…ç»ªæ¨¡å¼
List<UserMemory> patterns = temperatureMemoryService.getEmotionPatterns(userId);
```

### ç¤ºä¾‹3ï¼šåˆ†ææƒ…ç»ªè¶‹åŠ¿

```java
// åˆ†æå¹¶ä¿å­˜æƒ…ç»ªè¶‹åŠ¿
UserMemory trend = temperatureMemoryService.analyzeAndSaveEmotionTrend(
    userId, "week"
);
```

---

## âš™ï¸ é…ç½®

### MongoDBç´¢å¼•

å·²åˆ›å»ºä»¥ä¸‹ç´¢å¼•æ”¯æŒæƒ…æ„Ÿè®°å¿†æ£€ç´¢ï¼š

```javascript
// user_memoriesé›†åˆç´¢å¼•
db.user_memories.createIndex({ userId: 1, type: 1 });
db.user_memories.createIndex({ userId: 1, "metadata.emotionType": 1 });
db.user_memories.createIndex({ content: "text" });
```

### application.ymlé…ç½®

```yaml
heartsphere:
  memory:
    long-memory:
      extraction-importance-threshold: 0.7
      extraction-confidence-threshold: 0.6
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- âœ… æƒ…ç»ªè®°å½•ä¿å­˜æ—¶è‡ªåŠ¨æå–è®°å¿†
- âœ… æ”¯æŒä¸‰ç§æƒ…æ„Ÿè®°å¿†ç±»å‹
- âœ… æ”¯æŒæŒ‰æƒ…ç»ªç±»å‹æ£€ç´¢è®°å¿†
- âœ… æ”¯æŒæƒ…ç»ªè¶‹åŠ¿åˆ†æ

### æ€§èƒ½éªŒæ”¶

- âœ… è®°å¿†æå–å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡ä¸»æµç¨‹
- âœ… æ‰¹é‡ä¿å­˜è®°å¿†æé«˜æ€§èƒ½
- âœ… MongoDBç´¢å¼•ä¼˜åŒ–æ£€ç´¢

### è´¨é‡éªŒæ”¶

- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… æ—¥å¿—è®°å½•å®Œæ•´
- âœ… ä»£ç è§„èŒƒéµå¾ª

---

## ğŸš€ ä¸‹ä¸€æ­¥å·¥ä½œ

### å¾…å®Œæˆ

1. **MemoryExtractorå®ç°**
   - å®ç°LLMMemoryExtractor
   - å®ç°RuleBasedMemoryExtractor

2. **REST API**
   - å®ç°MemoryController
   - æä¾›è®°å¿†æ£€ç´¢API

3. **æµ‹è¯•**
   - ç¼–å†™å•å…ƒæµ‹è¯•
   - ç¼–å†™é›†æˆæµ‹è¯•

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [æ¸©åº¦æ„Ÿç³»ç»Ÿé›†æˆè¯´æ˜](./æ¸©åº¦æ„Ÿç³»ç»Ÿé›†æˆè¯´æ˜.md)
- [é˜¶æ®µä¸€è¯¦ç»†è®¾è®¡](./02-é˜¶æ®µä¸€ï¼šåŸºç¡€è®°å¿†ç³»ç»Ÿ.md)
- [é•¿æœŸè®°å¿†ä¸çŸ­æœŸè®°å¿†è®¾è®¡è¯¦è§£](./é•¿æœŸè®°å¿†ä¸çŸ­æœŸè®°å¿†è®¾è®¡è¯¦è§£.md)

---

**æ¸©åº¦æ„Ÿç³»ç»Ÿé›†æˆå®Œæˆï¼** âœ…

