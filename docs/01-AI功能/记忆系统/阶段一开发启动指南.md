# é˜¶æ®µä¸€ï¼šåŸºç¡€è®°å¿†ç³»ç»Ÿ - å¼€å‘å¯åŠ¨æŒ‡å—

**æ–‡æ¡£ç‰ˆæœ¬**: V1.0  
**ç¼–å†™æ—¥æœŸ**: 2025-12-28

---

## ä¸€ã€ç¯å¢ƒå‡†å¤‡

### 1.1 æ£€æŸ¥ä¾èµ–

ç¡®ä¿ `pom.xml` ä¸­åŒ…å«ä»¥ä¸‹ä¾èµ–ï¼š

```xml
<!-- Redis -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>

<!-- MongoDB -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-mongodb</artifactId>
</dependency>

<!-- Lombok -->
<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
    <optional>true</optional>
</dependency>
```

### 1.2 é…ç½®æ•°æ®åº“

åœ¨ `application.yml` ä¸­æ·»åŠ é…ç½®ï¼š

```yaml
spring:
  # Redisé…ç½®
  data:
    redis:
      host: localhost
      port: 6379
      database: 0
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
  
  # MongoDBé…ç½®
    mongodb:
      uri: mongodb://localhost:27017/heartsphere
      # æˆ–åˆ†åˆ«é…ç½®
      # host: localhost
      # port: 27017
      # database: heartsphere

# è®°å¿†ç³»ç»Ÿé…ç½®
heartsphere:
  memory:
    short-memory:
      message-ttl: 604800  # 7å¤©ï¼ˆç§’ï¼‰
      max-messages-per-session: 100
      working-memory-ttl: 86400  # 24å°æ—¶ï¼ˆç§’ï¼‰
    long-memory:
      extraction-importance-threshold: 0.7
      extraction-confidence-threshold: 0.6
    extraction:
      enable-llm-extraction: true
      enable-rule-extraction: true
      batch-size: 10
```

### 1.3 åˆå§‹åŒ–MongoDBç´¢å¼•

```bash
# æ‰§è¡Œç´¢å¼•åˆå§‹åŒ–è„šæœ¬
mongosh heartsphere < backend/src/main/resources/db/mongodb/init-indexes.js
```

---

## äºŒã€å·²åˆ›å»ºçš„åŸºç¡€ç»“æ„

### 2.1 åŒ…ç»“æ„

```
backend/src/main/java/com/heartsphere/memory/
â”œâ”€â”€ model/              # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ ChatMessage.java
â”‚   â”œâ”€â”€ UserFact.java
â”‚   â”œâ”€â”€ UserPreference.java
â”‚   â”œâ”€â”€ UserMemory.java
â”‚   â”œâ”€â”€ ConversationContext.java
â”‚   â”œâ”€â”€ UserProfile.java
â”‚   â””â”€â”€ æšä¸¾ç±»...
â”œâ”€â”€ service/            # æœåŠ¡æ¥å£
â”‚   â”œâ”€â”€ ShortMemoryService.java
â”‚   â”œâ”€â”€ LongMemoryService.java
â”‚   â”œâ”€â”€ MemoryExtractor.java
â”‚   â””â”€â”€ MemoryManager.java
â”œâ”€â”€ service/impl/       # æœåŠ¡å®ç°ï¼ˆå¾…å®ç°ï¼‰
â”œâ”€â”€ repository/         # Repositoryï¼ˆå¾…å®ç°ï¼‰
â”œâ”€â”€ controller/         # REST APIï¼ˆå¾…å®ç°ï¼‰
â””â”€â”€ config/            # é…ç½®ç±»
    â”œâ”€â”€ RedisConfig.java
    â”œâ”€â”€ MongoConfig.java
    â””â”€â”€ MemoryProperties.java
```

### 2.2 å·²åˆ›å»ºçš„æ–‡ä»¶

âœ… **æ•°æ®æ¨¡å‹**ï¼š
- `MessageRole.java` - æ¶ˆæ¯è§’è‰²æšä¸¾
- `ChatMessage.java` - å¯¹è¯æ¶ˆæ¯æ¨¡å‹
- `FactCategory.java` - äº‹å®ç±»åˆ«æšä¸¾
- `UserFact.java` - ç”¨æˆ·äº‹å®æ¨¡å‹
- `PreferenceType.java` - åå¥½ç±»å‹æšä¸¾
- `UserPreference.java` - ç”¨æˆ·åå¥½æ¨¡å‹
- `MemoryType.java` - è®°å¿†ç±»å‹æšä¸¾
- `MemoryImportance.java` - è®°å¿†é‡è¦æ€§æšä¸¾
- `MemorySource.java` - è®°å¿†æ¥æºæšä¸¾
- `UserMemory.java` - ç”¨æˆ·è®°å¿†æ¨¡å‹
- `ConversationContext.java` - å¯¹è¯ä¸Šä¸‹æ–‡
- `UserProfile.java` - ç”¨æˆ·ç”»åƒ

âœ… **æœåŠ¡æ¥å£**ï¼š
- `ShortMemoryService.java` - çŸ­æœŸè®°å¿†æœåŠ¡æ¥å£
- `LongMemoryService.java` - é•¿æœŸè®°å¿†æœåŠ¡æ¥å£
- `MemoryExtractor.java` - è®°å¿†æå–å™¨æ¥å£
- `MemoryManager.java` - è®°å¿†ç®¡ç†å™¨æ¥å£

âœ… **é…ç½®ç±»**ï¼š
- `RedisConfig.java` - Redisé…ç½®
- `MongoConfig.java` - MongoDBé…ç½®
- `MemoryProperties.java` - è®°å¿†ç³»ç»Ÿé…ç½®å±æ€§

---

## ä¸‰ã€å¼€å‘é¡ºåº

### ç¬¬ä¸€æ­¥ï¼šå®ç°RedisShortMemoryServiceï¼ˆWeek 1-2ï¼‰

**æ–‡ä»¶**ï¼š`backend/src/main/java/com/heartsphere/memory/service/impl/RedisShortMemoryService.java`

**å…³é”®ç‚¹**ï¼š
1. æ³¨å…¥ `RedisTemplate<String, Object>`
2. å®ç°æ¶ˆæ¯å­˜å‚¨ï¼ˆä½¿ç”¨Listï¼‰
3. å®ç°æ¶ˆæ¯æ•°é‡é™åˆ¶ï¼ˆ100æ¡ï¼‰
4. å®ç°TTLè®¾ç½®ï¼ˆ7å¤©ï¼‰
5. å®ç°å·¥ä½œè®°å¿†ç®¡ç†

**å‚è€ƒå®ç°**ï¼šè§ `02-é˜¶æ®µä¸€ï¼šåŸºç¡€è®°å¿†ç³»ç»Ÿ.md` ç¬¬4.1.2èŠ‚

---

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºMongoDB Repositoryï¼ˆWeek 3ï¼‰

**æ–‡ä»¶**ï¼š
- `backend/src/main/java/com/heartsphere/memory/repository/UserFactRepository.java`
- `backend/src/main/java/com/heartsphere/memory/repository/UserPreferenceRepository.java`
- `backend/src/main/java/com/heartsphere/memory/repository/UserMemoryRepository.java`

**ç¤ºä¾‹**ï¼š
```java
@Repository
public interface UserFactRepository extends MongoRepository<UserFact, String> {
    List<UserFact> findByUserId(String userId);
    List<UserFact> findByUserIdAndCategory(String userId, FactCategory category);
    List<UserFact> findByUserIdOrderByImportanceDesc(String userId);
}
```

---

### ç¬¬ä¸‰æ­¥ï¼šå®ç°MongoLongMemoryServiceï¼ˆWeek 3-4ï¼‰

**æ–‡ä»¶**ï¼š`backend/src/main/java/com/heartsphere/memory/service/impl/MongoLongMemoryService.java`

**å…³é”®ç‚¹**ï¼š
1. æ³¨å…¥ `MongoTemplate` å’Œ Repository
2. å®ç°ç”¨æˆ·äº‹å®CRUD
3. å®ç°ç”¨æˆ·åå¥½CRUD
4. å®ç°è®°å¿†æ£€ç´¢ï¼ˆæ–‡æœ¬æœç´¢ï¼‰
5. å®ç°ç›¸å…³æ€§è®¡ç®—

---

### ç¬¬å››æ­¥ï¼šå®ç°MemoryExtractorï¼ˆWeek 5ï¼‰

**æ–‡ä»¶**ï¼š
- `backend/src/main/java/com/heartsphere/memory/service/impl/LLMMemoryExtractor.java`
- `backend/src/main/java/com/heartsphere/memory/service/impl/RuleBasedMemoryExtractor.java`

**å…³é”®ç‚¹**ï¼š
1. é›†æˆå¤§æ¨¡å‹ç»Ÿä¸€æ¥å…¥å±‚
2. æ„å»ºæå–æç¤ºè¯
3. è§£æJSONå“åº”
4. éªŒè¯å’Œæ¸…ç†æå–ç»“æœ

---

### ç¬¬äº”æ­¥ï¼šå®ç°MemoryManagerï¼ˆWeek 5ï¼‰

**æ–‡ä»¶**ï¼š`backend/src/main/java/com/heartsphere/memory/service/impl/MemoryManagerImpl.java`

**å…³é”®ç‚¹**ï¼š
1. åè°ƒçŸ­æœŸå’Œé•¿æœŸè®°å¿†
2. å®ç°æ··åˆæ£€ç´¢
3. å®ç°å¼‚æ­¥è®°å¿†æå–
4. æ„å»ºç”¨æˆ·ç”»åƒ

---

### ç¬¬å…­æ­¥ï¼šå®ç°REST APIï¼ˆWeek 6ï¼‰

**æ–‡ä»¶**ï¼š`backend/src/main/java/com/heartsphere/memory/controller/MemoryController.java`

**å…³é”®ç‚¹**ï¼š
1. å®ç°æ‰€æœ‰APIç«¯ç‚¹
2. æ·»åŠ å‚æ•°éªŒè¯
3. æ·»åŠ å¼‚å¸¸å¤„ç†
4. æ·»åŠ APIæ–‡æ¡£æ³¨è§£

---

## å››ã€å¼€å‘æ£€æŸ¥æ¸…å•

### 4.1 ä»£ç è´¨é‡

- [ ] éµå¾ªJavaç¼–ç è§„èŒƒ
- [ ] ä½¿ç”¨Lombokç®€åŒ–ä»£ç 
- [ ] æ·»åŠ å¿…è¦çš„JavaDocæ³¨é‡Š
- [ ] ä½¿ç”¨ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†
- [ ] æ·»åŠ æ—¥å¿—è®°å½•

### 4.2 æµ‹è¯•

- [ ] ç¼–å†™å•å…ƒæµ‹è¯•ï¼ˆè¦†ç›–ç‡ > 80%ï¼‰
- [ ] ç¼–å†™é›†æˆæµ‹è¯•
- [ ] æµ‹è¯•è¾¹ç•Œæƒ…å†µ
- [ ] æ€§èƒ½æµ‹è¯•

### 4.3 æ–‡æ¡£

- [ ] æ›´æ–°APIæ–‡æ¡£
- [ ] ç¼–å†™ä½¿ç”¨ç¤ºä¾‹
- [ ] æ›´æ–°README

---

## äº”ã€å¿«é€Ÿæµ‹è¯•

### 5.1 æµ‹è¯•Redisè¿æ¥

```java
@SpringBootTest
class RedisConnectionTest {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Test
    void testRedisConnection() {
        redisTemplate.opsForValue().set("test", "hello");
        String value = (String) redisTemplate.opsForValue().get("test");
        assertEquals("hello", value);
    }
}
```

### 5.2 æµ‹è¯•MongoDBè¿æ¥

```java
@SpringBootTest
class MongoConnectionTest {
    @Autowired
    private MongoTemplate mongoTemplate;
    
    @Test
    void testMongoConnection() {
        String dbName = mongoTemplate.getDb().getName();
        assertEquals("heartsphere", dbName);
    }
}
```

---

## å…­ã€å¸¸è§é—®é¢˜

### Q1: Redisè¿æ¥å¤±è´¥ï¼Ÿ

**A**: æ£€æŸ¥ï¼š
1. Redisæ˜¯å¦è¿è¡Œï¼š`redis-cli ping`
2. é…ç½®æ˜¯å¦æ­£ç¡®ï¼š`application.yml`
3. ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼š`lsof -i :6379`

### Q2: MongoDBè¿æ¥å¤±è´¥ï¼Ÿ

**A**: æ£€æŸ¥ï¼š
1. MongoDBæ˜¯å¦è¿è¡Œï¼š`mongosh --eval "db.version()"`
2. é…ç½®æ˜¯å¦æ­£ç¡®ï¼š`application.yml`
3. æ•°æ®åº“æ˜¯å¦å­˜åœ¨ï¼š`mongosh heartsphere`

### Q3: ä¾èµ–å†²çªï¼Ÿ

**A**: æ£€æŸ¥ï¼š
1. Spring Bootç‰ˆæœ¬æ˜¯å¦å…¼å®¹
2. Rediså’ŒMongoDBä¾èµ–ç‰ˆæœ¬
3. ä½¿ç”¨ `mvn dependency:tree` æ£€æŸ¥ä¾èµ–æ ‘

---

## ä¸ƒã€ä¸‹ä¸€æ­¥

1. âœ… **å®Œæˆç¯å¢ƒå‡†å¤‡**ï¼šé…ç½®Rediså’ŒMongoDB
2. âœ… **å¼€å§‹å®ç°**ï¼šæŒ‰ç…§å¼€å‘é¡ºåºé€æ­¥å®ç°
3. âœ… **æŒç»­æµ‹è¯•**ï¼šæ¯ä¸ªåŠŸèƒ½å®Œæˆåç«‹å³æµ‹è¯•
4. âœ… **æ–‡æ¡£æ›´æ–°**ï¼šåŠæ—¶æ›´æ–°APIæ–‡æ¡£

**å¼€å§‹å¼€å‘ï¼** ğŸš€

