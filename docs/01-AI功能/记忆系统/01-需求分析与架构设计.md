# 记忆系统 - 需求分析与架构设计

**文档版本**: V1.0  
**编写日期**: 2025-12-28  
**系统名称**: Memory System - AI Agent 记忆系统  
**目标**: 设计一个完整的AI Agent记忆系统，支持用户、角色、参与者多主体记忆

---

## 一、需求概述

### 1.1 背景

随着心域系统的发展，我们需要一个完整的记忆系统来支持：

1. **用户记忆**：记录用户的信息、偏好、历史交互等
2. **角色记忆**：让每个E-SOUL角色拥有独立的记忆，能够记住与用户的交互历史
3. **参与者记忆**：支持多用户场景，记录参与者之间的关系和交互历史
4. **关系记忆**：记录用户与角色、参与者之间的关系网络

当前上下文引擎主要关注对话上下文的短期管理，而记忆系统需要：
- 更长期的记忆存储和管理
- 多主体记忆支持
- 更智能的记忆检索和关联
- 记忆的巩固和衰减机制

### 1.2 核心需求

#### 1.2.1 多主体记忆需求

**用户记忆**：
- 基本信息（姓名、年龄、偏好等）
- 交互历史（对话、操作等）
- 偏好和习惯
- 情感状态和模式

**角色记忆（E-SOUL）**：
- 角色自身的记忆（每个角色独立的记忆体系）
- 角色与用户之间的交互记忆
- 角色在不同场景切片中的记忆
- 角色与其他角色的关系记忆

**参与者记忆**：
- 参与者的身份和角色
- 参与者之间的交互历史
- 参与者关系网络
- 参与者的偏好和行为模式

#### 1.2.2 记忆能力需求

**记忆存储**：
- 短期记忆（当前对话上下文）
- 长期记忆（持久化的重要信息）
- 工作记忆（临时处理的数据）

**记忆检索**：
- 关键词检索
- 语义检索（向量搜索）
- 上下文相关检索
- 关联检索

**记忆管理**：
- 记忆提取（从对话中自动提取）
- 记忆巩固（从短期到长期）
- 记忆衰减（基于时间的重要性衰减）
- 记忆关联（建立记忆之间的关系）

### 1.3 设计目标

- ✅ **双层记忆架构**：清晰区分短期记忆和长期记忆
- ✅ **多主体支持**：用户、角色、参与者多主体记忆
- ✅ **智能检索**：支持多种检索方式，高效查找相关记忆
- ✅ **记忆生命周期**：从短期到长期的自然过渡
- ✅ **关系网络**：构建用户-角色-参与者关系网络
- ✅ **可扩展性**：支持未来扩展更多记忆类型和主体
- ✅ **高性能**：保证记忆检索和存储的高性能
- ✅ **隐私保护**：确保记忆数据的隐私和安全

---

## 二、理论基础

### 2.1 认知科学记忆理论

参考人类记忆系统的认知科学研究：

#### 2.1.1 短期记忆（Short-term Memory）

- **容量限制**：7±2个信息块（Miller's Law）
- **保持时间**：几秒到几分钟
- **易遗忘**：如果不进行复述，会快速遗忘
- **工作记忆**：需要工作记忆参与处理和操作

**在系统中的映射**：
- Redis存储对话上下文（最近N条消息）
- 会话状态和临时数据
- 工作记忆用于临时处理

#### 2.1.2 长期记忆（Long-term Memory）

- **容量**：几乎无限
- **保持时间**：从几天到终身
- **巩固过程**：需要从短期记忆经过巩固过程转为长期记忆
- **检索机制**：通过关联、上下文、线索进行检索

**在系统中的映射**：
- MongoDB存储用户事实、偏好、历史等
- 角色记忆、参与者记忆
- 关系网络数据

#### 2.1.3 记忆巩固（Memory Consolidation）

- 重要信息从短期记忆转移到长期记忆
- 需要重复、强化、关联
- 睡眠和休息有助于巩固

**在系统中的映射**：
- 自动从对话中提取重要信息
- 基于重要性评分决定是否转为长期记忆
- 定期巩固机制

#### 2.1.4 记忆检索（Memory Retrieval）

- 通过线索（cue）触发
- 上下文相关检索（context-dependent retrieval）
- 关联检索（associative retrieval）

**在系统中的映射**：
- 基于用户查询的关键词检索
- 基于上下文的语义检索
- 基于关联关系的关联检索

### 2.2 多主体记忆理论

#### 2.2.1 角色记忆（Character Memory）

每个AI角色应该拥有：
- **独立的人格记忆**：角色的背景、性格、经历等
- **交互记忆**：与不同用户的交互历史
- **场景记忆**：在不同场景中的表现和记忆
- **关系记忆**：与其他角色的关系

#### 2.2.2 参与者记忆（Participant Memory）

在多用户场景中：
- **身份记忆**：参与者在系统中的身份和角色
- **交互记忆**：参与者之间的交互历史
- **关系网络**：参与者之间的关系图谱
- **协作记忆**：参与者之间的协作历史

---

## 三、架构设计

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    记忆系统 (Memory System)                   │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │           记忆主体管理器                             │    │
│  │     (Memory Subject Manager)                        │    │
│  ├─────────────────────────────────────────────────────┤    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐         │    │
│  │  │用户记忆  │  │角色记忆  │  │参与者记忆│         │    │
│  │  │User      │  │Character │  │Participant│        │    │
│  │  │Memory    │  │Memory    │  │Memory    │         │    │
│  │  └──────────┘  └──────────┘  └──────────┘         │    │
│  │       │              │              │               │    │
│  │       └──────────────┴──────────────┘               │    │
│  │                      │                               │    │
│  │              ┌───────▼───────┐                      │    │
│  │              │   关系记忆    │                      │    │
│  │              │ Relationship  │                      │    │
│  │              │    Memory     │                      │    │
│  │              └───────────────┘                      │    │
│  └─────────────────────────────────────────────────────┘    │
│                      │                                       │
│  ┌───────────────────▼───────────────────┐                  │
│  │           记忆管理器                  │                  │
│  │     (Memory Manager)                  │                  │
│  ├───────────────────────────────────────┤                  │
│  │ • 记忆存储 (Storage)                  │                  │
│  │ • 记忆检索 (Retrieval)                │                  │
│  │ • 记忆巩固 (Consolidation)            │                  │
│  │ • 记忆关联 (Association)              │                  │
│  │ • 记忆衰减 (Decay)                    │                  │
│  └───────────────────────────────────────┘                  │
│                      │                                       │
│  ┌───────────────────▼───────────────────┐                  │
│  │        记忆层级 (Memory Layers)       │                  │
│  ├───────────────────────────────────────┤                  │
│  │  ┌─────────────┐   ┌─────────────┐   │                  │
│  │  │ 短期记忆    │   │ 长期记忆    │   │                  │
│  │  │ Short Memory│   │ Long Memory │   │                  │
│  │  │ (Redis)     │   │ (MongoDB)   │   │                  │
│  │  └─────────────┘   └─────────────┘   │                  │
│  └───────────────────────────────────────┘                  │
│                      │                                       │
│  ┌───────────────────▼───────────────────┐                  │
│  │      扩展服务 (Extended Services)     │                  │
│  ├───────────────────────────────────────┤                  │
│  │ • 向量搜索服务 (Vector Search)        │                  │
│  │ • 记忆提取服务 (Memory Extraction)    │                  │
│  │ • 记忆分析服务 (Memory Analysis)      │                  │
│  └───────────────────────────────────────┘                  │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 核心组件

#### 3.2.1 记忆主体管理器（Memory Subject Manager）

**职责**：
- 管理不同类型的记忆主体（用户、角色、参与者）
- 提供统一的记忆访问接口
- 协调不同主体之间的记忆交互

**组件**：
- `UserMemoryService`：用户记忆服务
- `CharacterMemoryService`：角色记忆服务
- `ParticipantMemoryService`：参与者记忆服务
- `RelationshipMemoryService`：关系记忆服务

#### 3.2.2 记忆管理器（Memory Manager）

**职责**：
- 记忆的存储和检索
- 记忆的巩固和衰减
- 记忆的关联和索引
- 记忆的生命周期管理

**组件**：
- `ShortMemoryService`：短期记忆服务
- `LongMemoryService`：长期记忆服务
- `MemoryConsolidationService`：记忆巩固服务
- `MemoryRetrievalService`：记忆检索服务

#### 3.2.3 记忆存储层（Storage Layer）

**短期记忆存储（Redis）**：
- 对话上下文（最近N条消息）
- 会话状态
- 工作记忆（临时数据）

**长期记忆存储（MongoDB）**：
- 用户事实和偏好
- 角色记忆
- 参与者记忆
- 关系记忆

**向量存储（可选）**：
- 记忆的向量嵌入
- 支持语义搜索

### 3.3 数据模型

#### 3.3.1 用户记忆模型

```java
/**
 * 用户记忆
 */
@Data
@Document(collection = "user_memories")
public class UserMemory {
    @Id
    private String id;
    
    private String userId;
    private MemoryType type; // 记忆类型
    private MemoryImportance importance; // 重要性
    private String content; // 记忆内容
    
    // 结构化数据
    private Map<String, Object> structuredData;
    
    // 元数据
    private MemorySource source; // 记忆来源
    private String sourceId; // 来源ID
    private Instant createdAt;
    private Instant lastAccessedAt;
    private Integer accessCount;
    private Double confidence; // 提取置信度
    
    // 关联信息
    private List<String> relatedMemoryIds; // 关联的记忆ID
    private List<String> tags; // 标签
    private Map<String, Object> metadata; // 扩展元数据
}
```

#### 3.3.2 角色记忆模型

```java
/**
 * 角色记忆
 */
@Data
@Document(collection = "character_memories")
public class CharacterMemory {
    @Id
    private String id;
    
    private String characterId; // 角色ID
    private String eraId; // 场景切片ID（可选）
    private MemoryType type; // 记忆类型
    private MemoryImportance importance;
    private String content;
    
    // 角色相关信息
    private String relatedUserId; // 关联的用户ID
    private String relatedCharacterId; // 关联的其他角色ID
    private String interactionSessionId; // 交互会话ID
    
    // 时间信息
    private Instant createdAt;
    private Instant lastAccessedAt;
    private Integer accessCount;
    
    // 结构化数据
    private Map<String, Object> structuredData;
    private List<String> tags;
    private Map<String, Object> metadata;
}
```

#### 3.3.3 参与者记忆模型

```java
/**
 * 参与者记忆
 */
@Data
@Document(collection = "participant_memories")
public class ParticipantMemory {
    @Id
    private String id;
    
    private String participantId; // 参与者ID
    private String sceneId; // 场景ID
    private MemoryType type;
    private MemoryImportance importance;
    private String content;
    
    // 参与者关系
    private List<String> relatedParticipantIds; // 关联的参与者ID列表
    private Map<String, ParticipantRelationship> relationships; // 关系详情
    
    // 时间信息
    private Instant createdAt;
    private Instant lastAccessedAt;
    private Integer accessCount;
    
    // 结构化数据
    private Map<String, Object> structuredData;
    private List<String> tags;
    private Map<String, Object> metadata;
}
```

#### 3.3.4 关系记忆模型

```java
/**
 * 关系记忆
 */
@Data
@Document(collection = "relationship_memories")
public class RelationshipMemory {
    @Id
    private String id;
    
    private String subjectId; // 主体ID
    private MemorySubjectType subjectType; // 主体类型（USER, CHARACTER, PARTICIPANT）
    private String objectId; // 客体ID
    private MemorySubjectType objectType; // 客体类型
    
    private RelationshipType relationshipType; // 关系类型
    private Double strength; // 关系强度 (0.0-1.0)
    private String description; // 关系描述
    
    // 交互历史
    private List<InteractionRecord> interactions; // 交互记录
    private Integer interactionCount; // 交互次数
    private Instant firstMetAt; // 首次交互时间
    private Instant lastInteractedAt; // 最后交互时间
    
    // 时间信息
    private Instant createdAt;
    private Instant updatedAt;
    
    // 元数据
    private Map<String, Object> metadata;
}

enum RelationshipType {
    FRIEND,           // 朋友
    COLLEAGUE,        // 同事
    FAMILY,           // 家人
    LOVER,            // 恋人
    MENTOR,           // 导师
    STUDENT,          // 学生
    ENEMY,            // 敌人
    ACQUAINTANCE,     // 熟人
    UNKNOWN           // 未知
}
```

### 3.4 记忆类型定义

```java
enum MemoryType {
    // 个人信息
    PERSONAL_INFO,        // 个人信息
    PREFERENCE,           // 偏好
    HABIT,                // 习惯
    PERSONALITY,          // 性格
    
    // 情感记忆
    IMPORTANT_MOMENT,     // 重要时刻
    EMOTIONAL_EXPERIENCE, // 情感经历
    EMOTION_PATTERN,      // 情绪模式
    EMOTIONAL_PREFERENCE, // 情感偏好
    
    // 交互记忆
    INTERACTION_HISTORY,  // 交互历史
    CONVERSATION_TOPIC,   // 对话主题
    INTERACTION_PREFERENCE, // 交互偏好
    CONVERSATION_STYLE,   // 对话风格
    
    // 关系记忆
    RELATIONSHIP_INFO,    // 关系信息
    RELATIONSHIP_EVENT,   // 关系事件
    RELATIONSHIP_STATUS,  // 关系状态
    
    // 内容记忆
    CREATED_CONTENT,      // 创作内容
    FOCUSED_CONTENT,      // 关注内容
    FAVORITED_CONTENT,    // 收藏内容
    
    // 成长记忆
    GROWTH_TRAJECTORY,    // 成长轨迹
    MILESTONE,            // 里程碑
    ACHIEVEMENT,          // 成就
    REFLECTION            // 反思
}

enum MemoryImportance {
    CORE,       // 核心记忆（永久保留）
    IMPORTANT,  // 重要记忆（长期保留）
    NORMAL,     // 普通记忆（定期衰减）
    TEMPORARY   // 临时记忆（短期保留）
}

enum MemorySource {
    CONVERSATION,     // 对话
    USER_INPUT,       // 用户输入
    SYSTEM_DETECTED,  // 系统检测
    MANUAL_CREATE,    // 手动创建
    EXTERNAL_SYNC     // 外部同步
}
```

---

## 四、关键技术设计

### 4.1 记忆提取

从对话中自动提取重要信息：

1. **LLM驱动提取**：使用大模型从对话中提取结构化事实
2. **规则提取**：基于规则的快速提取（备用方案）
3. **混合提取**：结合LLM和规则，提高准确性和效率

### 4.2 记忆检索

多种检索方式：

1. **关键词检索**：基于文本的关键词匹配
2. **语义检索**：基于向量嵌入的语义相似度搜索
3. **关联检索**：基于记忆关联关系的检索
4. **上下文检索**：基于当前上下文的检索

### 4.3 记忆巩固

从短期记忆到长期记忆的转换：

1. **重要性评估**：基于重要性评分决定是否巩固
2. **批量巩固**：定期批量处理，提高效率
3. **关联巩固**：关联相关的记忆一起巩固
4. **去重合并**：合并重复或相似的记忆

### 4.4 记忆衰减

基于时间的记忆重要性衰减：

1. **时间衰减**：基于最后访问时间的衰减
2. **访问频率**：访问频率影响衰减速度
3. **重要性保护**：核心记忆不受衰减影响
4. **定期清理**：定期清理过期的临时记忆

---

## 五、技术栈

- **后端框架**：Spring Boot 3.x
- **短期存储**：Redis 7.x
- **长期存储**：MongoDB 6.x
- **向量数据库**：Milvus / FAISS（可选）
- **AI模型**：大模型统一接入层
- **嵌入模型**：text-embedding-ada-002 或开源模型（如bge-large-zh）

---

## 六、性能指标

### 6.1 响应时间

- 短期记忆读取：< 10ms
- 长期记忆检索：< 100ms
- 语义搜索：< 200ms
- 记忆提取：< 1s（异步）

### 6.2 吞吐量

- 记忆写入：> 1000 ops/s
- 记忆读取：> 5000 ops/s
- 记忆检索：> 500 ops/s

### 6.3 存储容量

- 短期记忆：单用户最多100MB
- 长期记忆：单用户最多10GB
- 总存储：支持百万级用户

---

## 七、安全性设计

### 7.1 数据隐私

- 记忆数据加密存储
- 访问权限控制
- 用户数据隔离
- 敏感信息脱敏

### 7.2 数据安全

- 数据备份和恢复
- 审计日志
- 异常检测
- 数据完整性校验

---

## 八、总结

本架构设计提供了一个完整的记忆系统方案，支持：

1. ✅ **多主体记忆**：用户、角色、参与者多主体支持
2. ✅ **双层架构**：短期记忆和长期记忆清晰分离
3. ✅ **智能检索**：多种检索方式，高效查找相关记忆
4. ✅ **记忆生命周期**：从提取到巩固到衰减的完整生命周期
5. ✅ **关系网络**：构建用户-角色-参与者关系网络
6. ✅ **可扩展性**：支持未来扩展更多记忆类型和主体
7. ✅ **高性能**：优化的存储和检索性能
8. ✅ **安全性**：完善的隐私和安全保护

接下来的文档将详细描述各个阶段的实施计划和技术细节。

