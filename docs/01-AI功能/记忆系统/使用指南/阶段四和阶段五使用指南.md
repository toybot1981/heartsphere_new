# é˜¶æ®µå››å’Œé˜¶æ®µäº”ä½¿ç”¨æŒ‡å—

**ç‰ˆæœ¬**: v1.0  
**æ—¥æœŸ**: 2025-12-29

---

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [åŠŸèƒ½ä½¿ç”¨](#åŠŸèƒ½ä½¿ç”¨)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æ¦‚è¿°

é˜¶æ®µå››å’Œé˜¶æ®µäº”ä¸ºè®°å¿†ç³»ç»Ÿæä¾›äº†é«˜çº§åŠŸèƒ½å’Œä¼˜åŒ–èƒ½åŠ›ï¼š

### é˜¶æ®µå››ï¼šé«˜çº§è®°å¿†èƒ½åŠ›

- **å‘é‡æœç´¢**: åŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦çš„è®°å¿†æ£€ç´¢
- **è®°å¿†å…³è”**: è‡ªåŠ¨å‘ç°å’Œç®¡ç†è®°å¿†ä¹‹é—´çš„å…³è”å…³ç³»
- **æ™ºèƒ½æ£€ç´¢**: å¤šç»´åº¦ã€æ™ºèƒ½æ’åºçš„è®°å¿†æ£€ç´¢
- **è®°å¿†å·©å›º**: å°†çŸ­æœŸè®°å¿†è½¬æ¢ä¸ºé•¿æœŸè®°å¿†

### é˜¶æ®µäº”ï¼šè®°å¿†ç³»ç»Ÿä¼˜åŒ–

- **ç¼“å­˜ä¼˜åŒ–**: å¤šçº§ç¼“å­˜æå‡æ€§èƒ½
- **å‹ç¼©å½’æ¡£**: èŠ‚çœå­˜å‚¨ç©ºé—´
- **ç›‘æ§è¯Šæ–­**: ç³»ç»Ÿå¥åº·ç›‘æ§å’Œæ€§èƒ½åˆ†æ

---

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

#### ä¾èµ–é…ç½®

ç¡®ä¿ `pom.xml` ä¸­åŒ…å«ä»¥ä¸‹ä¾èµ–ï¼š

```xml
<!-- Caffeine Cache -->
<dependency>
    <groupId>com.github.ben-manes.caffeine</groupId>
    <artifactId>caffeine</artifactId>
</dependency>
```

#### é…ç½®æ–‡ä»¶

åœ¨ `application.yml` ä¸­é…ç½®ï¼š

```yaml
spring:
  ai:
    dashscope:
      api-key: your-api-key
      base-url: https://dashscope.aliyuncs.com/compatible-mode/v1
  data:
    redis:
      host: localhost
      port: 6379
    mongodb:
      uri: mongodb://localhost:27017/heartsphere
```

### 2. åŸºæœ¬ä½¿ç”¨

#### ç”Ÿæˆå‘é‡åµŒå…¥

```java
@Autowired
private DashScopeEmbeddingService embeddingService;

// ç”Ÿæˆå•ä¸ªæ–‡æœ¬çš„å‘é‡
float[] embedding = embeddingService.generateEmbedding("æµ‹è¯•æ–‡æœ¬");

// æ‰¹é‡ç”Ÿæˆå‘é‡
List<String> texts = Arrays.asList("æ–‡æœ¬1", "æ–‡æœ¬2", "æ–‡æœ¬3");
List<float[]> embeddings = embeddingService.generateEmbeddings(texts);
```

#### å‘é‡æœç´¢

```java
@Autowired
private VectorSearchService vectorSearchService;

// è¯­ä¹‰æœç´¢
List<VectorSearchService.SimilarMemory> results = 
    vectorSearchService.searchSimilarMemories(
        "æŸ¥è¯¢æ–‡æœ¬",
        "user-1",
        null,
        null,
        10,
        0.6
    );
```

#### ä½¿ç”¨ç¼“å­˜

```java
@Autowired
private MemoryCacheService cacheService;

// å†™å…¥ç¼“å­˜
cacheService.put("memory:1", memoryObject, Duration.ofHours(1));

// è¯»å–ç¼“å­˜
Optional<Memory> memory = cacheService.get("memory:1", Memory.class);

// åˆ é™¤ç¼“å­˜
cacheService.evict("memory:1");
```

---

## åŠŸèƒ½ä½¿ç”¨

### 1. å‘é‡æœç´¢

#### ä½¿ç”¨åœºæ™¯

- è¯­ä¹‰ç›¸ä¼¼åº¦æœç´¢
- ç›¸å…³è®°å¿†æ¨è
- ä¸Šä¸‹æ–‡è®°å¿†æ£€ç´¢

#### ç¤ºä¾‹ä»£ç 

```java
// 1. ç”ŸæˆæŸ¥è¯¢å‘é‡
float[] queryVector = vectorSearchService.generateEmbedding("ç”¨æˆ·å–œæ¬¢ä»€ä¹ˆ");

// 2. æœç´¢ç›¸ä¼¼è®°å¿†
List<VectorSearchService.SimilarMemory> similarMemories = 
    vectorSearchService.searchSimilarMemories(
        "ç”¨æˆ·å–œæ¬¢ä»€ä¹ˆ",
        userId,
        null,
        null,
        10,
        0.6  // ç›¸ä¼¼åº¦é˜ˆå€¼
    );

// 3. å¤„ç†ç»“æœ
for (VectorSearchService.SimilarMemory memory : similarMemories) {
    System.out.println("è®°å¿†ID: " + memory.getMemoryId());
    System.out.println("ç›¸ä¼¼åº¦: " + memory.getSimilarity());
    System.out.println("å†…å®¹: " + memory.getContent());
}
```

### 2. è®°å¿†å…³è”

#### ä½¿ç”¨åœºæ™¯

- å‘ç°ç›¸å…³è®°å¿†
- æ„å»ºè®°å¿†ç½‘ç»œ
- å…³è”å…³ç³»åˆ†æ

#### ç¤ºä¾‹ä»£ç 

```java
@Autowired
private MemoryAssociationService associationService;

// 1. å‘ç°è®°å¿†å…³è”
List<MemoryAssociationService.MemoryAssociation> associations = 
    associationService.discoverAssociations("memory-1", 10);

// 2. è·å–è®°å¿†çš„æ‰€æœ‰å…³è”
List<MemoryAssociationService.MemoryAssociation> allAssociations = 
    associationService.getAssociations("memory-1");

// 3. åŸºäºå…³è”æ£€ç´¢è®°å¿†
List<MemoryAssociationService.MemoryAssociation> relatedMemories = 
    associationService.retrieveByAssociation("memory-1", 10);
```

### 3. æ™ºèƒ½æ£€ç´¢

#### ä½¿ç”¨åœºæ™¯

- å¤šç»´åº¦è®°å¿†æ£€ç´¢
- æ™ºèƒ½æ’åºå’Œæ¨è
- ä¸Šä¸‹æ–‡ç›¸å…³æ£€ç´¢

#### ç¤ºä¾‹ä»£ç 

```java
@Autowired
private IntelligentRetrievalService retrievalService;

// 1. å¤šç»´åº¦æ£€ç´¢
List<IntelligentRetrievalService.RetrievedMemory> results = 
    retrievalService.multiDimensionSearch(
        "æŸ¥è¯¢æ–‡æœ¬",
        userId,
        characterId,
        participantId,
        context,
        10
    );

// 2. æ··åˆæ£€ç´¢ï¼ˆå¯é…ç½®æƒé‡ï¼‰
List<IntelligentRetrievalService.RetrievedMemory> hybridResults = 
    retrievalService.hybridSearch(
        "æŸ¥è¯¢æ–‡æœ¬",
        userId,
        0.4,  // è¯­ä¹‰æƒé‡
        0.4,  // å…³é”®è¯æƒé‡
        0.2,  // å…³è”æƒé‡
        10
    );
```

### 4. ç¼“å­˜ä¼˜åŒ–

#### ä½¿ç”¨åœºæ™¯

- æå‡è¯»å–æ€§èƒ½
- å‡å°‘æ•°æ®åº“å‹åŠ›
- ç¼“å­˜çƒ­ç‚¹æ•°æ®

#### ç¤ºä¾‹ä»£ç 

```java
@Autowired
private MemoryCacheService cacheService;

// 1. ç¼“å­˜é¢„çƒ­
List<String> hotMemoryIds = Arrays.asList("memory-1", "memory-2", "memory-3");
cacheService.warmup(hotMemoryIds);

// 2. è·å–ç¼“å­˜ç»Ÿè®¡
MemoryCacheService.CacheStats stats = cacheService.getStats();
System.out.println("L1å‘½ä¸­ç‡: " + stats.getL1HitRate());
System.out.println("L2å‘½ä¸­ç‡: " + stats.getL2HitRate());
System.out.println("æ€»å‘½ä¸­ç‡: " + stats.getTotalHitRate());

// 3. æ¸…ç†ç¼“å­˜
cacheService.clear("memory");  // æ¸…ç†æŒ‡å®šç±»å‹
cacheService.clear(null);      // æ¸…ç†æ‰€æœ‰ç¼“å­˜
```

### 5. å‹ç¼©å½’æ¡£

#### ä½¿ç”¨åœºæ™¯

- èŠ‚çœå­˜å‚¨ç©ºé—´
- å½’æ¡£é•¿æœŸæœªä½¿ç”¨çš„è®°å¿†
- ç®¡ç†è®°å¿†ç”Ÿå‘½å‘¨æœŸ

#### ç¤ºä¾‹ä»£ç 

```java
@Autowired
private MemoryCompressionService compressionService;
@Autowired
private MemoryArchivingService archivingService;

// 1. å‹ç¼©è®°å¿†
List<String> memoryIds = Arrays.asList("memory-1", "memory-2");
List<MemoryCompressionService.CompressionResult> results = 
    compressionService.compressBatch(memoryIds);

// 2. å½’æ¡£è®°å¿†
List<MemoryArchivingService.ArchiveResult> archiveResults = 
    archivingService.archiveBatch(memoryIds, "é•¿æœŸæœªä½¿ç”¨");

// 3. æŸ¥è¯¢å½’æ¡£åˆ—è¡¨
Pageable pageable = PageRequest.of(0, 20);
Page<ArchivedMemory> archivedPage = 
    archivingService.listArchived(userId, pageable);

// 4. æ¢å¤å½’æ¡£è®°å¿†
archivingService.restore("archived-1");
```

### 6. ç›‘æ§è¯Šæ–­

#### ä½¿ç”¨åœºæ™¯

- ç³»ç»Ÿå¥åº·ç›‘æ§
- æ€§èƒ½åˆ†æ
- é—®é¢˜è¯Šæ–­

#### ç¤ºä¾‹ä»£ç 

```java
@Autowired
private MemoryMonitoringService monitoringService;

// 1. å¥åº·æ£€æŸ¥
MemoryMonitoringService.HealthStatus health = monitoringService.healthCheck();
System.out.println("ç³»ç»ŸçŠ¶æ€: " + health.getStatus());
for (Map.Entry<String, ComponentHealth> entry : health.getComponents().entrySet()) {
    System.out.println(entry.getKey() + ": " + entry.getValue().getStatus());
}

// 2. è·å–æ€§èƒ½æŒ‡æ ‡
Instant startTime = Instant.now().minusSeconds(3600);
Instant endTime = Instant.now();
MemoryMonitoringService.PerformanceMetrics metrics = 
    monitoringService.getPerformanceMetrics(startTime, endTime);
System.out.println("P95å“åº”æ—¶é—´: " + metrics.getP95ResponseTime() + "ms");
System.out.println("QPS: " + metrics.getQps());
System.out.println("ç¼“å­˜å‘½ä¸­ç‡: " + metrics.getCacheHitRate());

// 3. è·å–è¯Šæ–­ä¿¡æ¯
MemoryMonitoringService.DiagnosticsInfo diagnostics = 
    monitoringService.diagnose();
System.out.println("å¥åº·çŠ¶æ€: " + diagnostics.getHealth().getStatus());
for (String recommendation : diagnostics.getRecommendations()) {
    System.out.println("å»ºè®®: " + recommendation);
}
```

---

## æœ€ä½³å®è·µ

### 1. Embedding ä½¿ç”¨

**å»ºè®®**:
- æ‰¹é‡å¤„ç†æ—¶ä½¿ç”¨ `generateEmbeddings()` è€Œä¸æ˜¯å¤šæ¬¡è°ƒç”¨ `generateEmbedding()`
- å¯¹äºå¤§é‡æ–‡æœ¬ï¼Œè€ƒè™‘å¼‚æ­¥å¤„ç†
- å®ç°æœ¬åœ°ç¼“å­˜é¿å…é‡å¤è°ƒç”¨

**ç¤ºä¾‹**:
```java
// å¥½çš„åšæ³•ï¼šæ‰¹é‡å¤„ç†
List<String> texts = getTexts();
List<float[]> embeddings = embeddingService.generateEmbeddings(texts);

// é¿å…ï¼šå¾ªç¯è°ƒç”¨
for (String text : texts) {
    float[] embedding = embeddingService.generateEmbedding(text);  // ä¸æ¨è
}
```

### 2. ç¼“å­˜ä½¿ç”¨

**å»ºè®®**:
- åˆç†è®¾ç½®TTLï¼Œå¹³è¡¡æ€§èƒ½å’Œä¸€è‡´æ€§
- ä½¿ç”¨ç¼“å­˜é¢„çƒ­æå‡æ€§èƒ½
- å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜

**ç¤ºä¾‹**:
```java
// è®¾ç½®åˆç†çš„TTL
cacheService.put(key, value, Duration.ofHours(1));  // çƒ­ç‚¹æ•°æ®
cacheService.put(key, value, Duration.ofMinutes(5)); // ä¸´æ—¶æ•°æ®

// ç¼“å­˜é¢„çƒ­
List<String> hotKeys = getHotMemoryIds();
cacheService.warmup(hotKeys);
```

### 3. å‹ç¼©å½’æ¡£

**å»ºè®®**:
- åªå‹ç¼©ä½é¢‘è®¿é—®çš„è®°å¿†
- å®šæœŸå½’æ¡£é•¿æœŸæœªä½¿ç”¨çš„è®°å¿†
- ä¿ç•™é‡è¦è®°å¿†ä¸å‹ç¼©

**ç¤ºä¾‹**:
```java
// è¯†åˆ«ä½é¢‘è®¿é—®çš„è®°å¿†
List<String> lowFrequencyMemories = findLowFrequencyMemories(userId);

// å‹ç¼©
compressionService.compressBatch(lowFrequencyMemories);

// å½’æ¡£é•¿æœŸæœªä½¿ç”¨çš„è®°å¿†
List<String> oldMemories = findOldMemories(userId, 90); // 90å¤©å‰
archivingService.archiveBatch(oldMemories, "é•¿æœŸæœªä½¿ç”¨");
```

### 4. ç›‘æ§è¯Šæ–­

**å»ºè®®**:
- å®šæœŸæ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€
- ç›‘æ§å…³é”®æ€§èƒ½æŒ‡æ ‡
- æ ¹æ®è¯Šæ–­å»ºè®®ä¼˜åŒ–ç³»ç»Ÿ

**ç¤ºä¾‹**:
```java
// å®šæ—¶å¥åº·æ£€æŸ¥
@Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿ
public void healthCheck() {
    HealthStatus health = monitoringService.healthCheck();
    if (!"HEALTHY".equals(health.getStatus())) {
        log.warn("ç³»ç»Ÿå¥åº·çŠ¶æ€å¼‚å¸¸: {}", health.getStatus());
        // å‘é€å‘Šè­¦
    }
}
```

---

## å¸¸è§é—®é¢˜

### Q1: Embedding API è°ƒç”¨å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A**: ç³»ç»Ÿå®ç°äº†é™çº§ç­–ç•¥ï¼ŒAPIå¤±è´¥æ—¶ä¼šè‡ªåŠ¨ä½¿ç”¨å“ˆå¸Œå‘é‡ã€‚æ£€æŸ¥ï¼š
1. API Keyæ˜¯å¦æ­£ç¡®é…ç½®
2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
3. APIè°ƒç”¨æ˜¯å¦è¶…é™

### Q2: ç¼“å­˜å‘½ä¸­ç‡ä½æ€ä¹ˆåŠï¼Ÿ

**A**: å¯ä»¥å°è¯•ï¼š
1. å¢åŠ ç¼“å­˜é¢„çƒ­
2. è°ƒæ•´ç¼“å­˜TTL
3. æ£€æŸ¥ç¼“å­˜é”®è®¾è®¡æ˜¯å¦åˆç†

### Q3: å‹ç¼©ç‡ä¸ç†æƒ³æ€ä¹ˆåŠï¼Ÿ

**A**: è€ƒè™‘ï¼š
1. æ£€æŸ¥å†…å®¹æ˜¯å¦é€‚åˆå‹ç¼©ï¼ˆæ–‡æœ¬å‹ç¼©æ•ˆæœå¥½ï¼‰
2. è°ƒæ•´å‹ç¼©é˜ˆå€¼
3. åªå‹ç¼©ä½é¢‘è®¿é—®çš„è®°å¿†

### Q4: å¦‚ä½•ç›‘æ§ç³»ç»Ÿæ€§èƒ½ï¼Ÿ

**A**: ä½¿ç”¨ç›‘æ§APIï¼š
1. å®šæœŸè°ƒç”¨ `/api/memory/v5/monitoring/metrics` è·å–æ€§èƒ½æŒ‡æ ‡
2. è°ƒç”¨ `/api/memory/v5/monitoring/health` æ£€æŸ¥å¥åº·çŠ¶æ€
3. è°ƒç”¨ `/api/memory/v5/monitoring/diagnostics` è·å–è¯Šæ–­ä¿¡æ¯

### Q5: å½’æ¡£çš„è®°å¿†å¦‚ä½•æ¢å¤ï¼Ÿ

**A**: ä½¿ç”¨æ¢å¤APIï¼š
```bash
POST /api/memory/v5/archiving/restore?archivedMemoryId=archived-1
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [APIæ–‡æ¡£](./é˜¶æ®µå››å’Œé˜¶æ®µäº”APIæ–‡æ¡£.md)
- [æŠ€æœ¯æ–¹æ¡ˆ](../å¼€å‘/é˜¶æ®µå››å’Œé˜¶æ®µäº”æŠ€æœ¯æ–¹æ¡ˆ.md)
- [å®ŒæˆæŠ¥å‘Š](../å¼€å‘/é˜¶æ®µå››å’Œé˜¶æ®µäº”å®ŒæˆæŠ¥å‘Š.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-12-29



