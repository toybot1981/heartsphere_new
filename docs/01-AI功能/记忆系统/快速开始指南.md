# è®°å¿†ç³»ç»Ÿå¿«é€Ÿå¼€å§‹æŒ‡å—

**æ–‡æ¡£ç‰ˆæœ¬**: V1.0  
**ç¼–å†™æ—¥æœŸ**: 2025-12-28

---

## ä¸€ã€å½“å‰å®æ–½é‡ç‚¹ â­

### ä¼˜å…ˆå®æ–½çš„åŠŸèƒ½

1. **ç”¨æˆ·è®°å¿†ç³»ç»Ÿ**ï¼ˆé˜¶æ®µä¸€ï¼‰
   - çŸ­æœŸè®°å¿†ï¼ˆRedisï¼‰ï¼šå¯¹è¯ä¸Šä¸‹æ–‡ç®¡ç†
   - é•¿æœŸè®°å¿†ï¼ˆMongoDBï¼‰ï¼šç”¨æˆ·äº‹å®å’Œåå¥½
   - è®°å¿†æå–ï¼šä»å¯¹è¯ä¸­è‡ªåŠ¨æå–ç”¨æˆ·ä¿¡æ¯
   - è®°å¿†æ£€ç´¢ï¼šè·¨ä¼šè¯æ£€ç´¢ç”¨æˆ·è®°å¿†

2. **è§’è‰²è®°å¿†ç³»ç»Ÿ**ï¼ˆé˜¶æ®µäºŒï¼‰
   - è§’è‰²è‡ªèº«è®°å¿†ï¼šè§’è‰²èƒŒæ™¯ã€æ€§æ ¼ã€ç»å†
   - è§’è‰²ä¸ç”¨æˆ·äº¤äº’è®°å¿†ï¼šè®°ä½ä¸ç”¨æˆ·çš„äº¤äº’å†å²
   - è§’è‰²åœºæ™¯è®°å¿†ï¼šä¸åŒåœºæ™¯ä¸­çš„è®°å¿†éš”ç¦»
   - è§’è‰²å…³ç³»è®°å¿†ï¼šè§’è‰²ä¹‹é—´çš„å…³ç³»

### æš‚ç¼“å®æ–½çš„åŠŸèƒ½

- â¸ï¸ **å‚ä¸è€…è®°å¿†ç³»ç»Ÿ**ï¼ˆé˜¶æ®µä¸‰ï¼‰ï¼šå¾…ç”¨æˆ·è®°å¿†å’Œè§’è‰²è®°å¿†ç¨³å®šåå†è€ƒè™‘
- ğŸ”„ **é«˜çº§è®°å¿†èƒ½åŠ›**ï¼ˆé˜¶æ®µå››ï¼‰ï¼šåŸºç¡€åŠŸèƒ½ç¨³å®šåå†ä¼˜åŒ–
- ğŸ”„ **ç³»ç»Ÿä¼˜åŒ–**ï¼ˆé˜¶æ®µäº”ï¼‰ï¼šæŒç»­ä¼˜åŒ–

---

## äºŒã€å¼€å‘é¡ºåº

### ç¬¬ä¸€æ­¥ï¼šç”¨æˆ·è®°å¿†ç³»ç»Ÿï¼ˆ4-6å‘¨ï¼‰

**Week 1-2ï¼šçŸ­æœŸè®°å¿†ç³»ç»Ÿ**
```java
// 1. å®ç°ShortMemoryService
@Service
public class RedisShortMemoryService implements ShortMemoryService {
    // ä¿å­˜å¯¹è¯æ¶ˆæ¯åˆ°Redis
    // ç®¡ç†å·¥ä½œè®°å¿†
    // ä¼šè¯ç®¡ç†
}

// 2. å®ç°æ•°æ®æ¨¡å‹
@Data
public class ChatMessage {
    private String id;
    private String sessionId;
    private String userId;
    private MessageRole role;
    private String content;
    // ...
}
```

**Week 3-4ï¼šé•¿æœŸè®°å¿†ç³»ç»Ÿ**
```java
// 1. å®ç°LongMemoryService
@Service
public class MongoLongMemoryService implements LongMemoryService {
    // ä¿å­˜ç”¨æˆ·äº‹å®
    // ä¿å­˜ç”¨æˆ·åå¥½
    // è®°å¿†æ£€ç´¢
}

// 2. å®ç°æ•°æ®æ¨¡å‹
@Document(collection = "user_facts")
public class UserFact {
    private String userId;
    private String fact;
    private FactCategory category;
    // ...
}
```

**Week 5ï¼šè®°å¿†æå–å’Œæ£€ç´¢**
```java
// 1. å®ç°MemoryExtractor
@Service
public class LLMMemoryExtractor implements MemoryExtractor {
    // ä»å¯¹è¯ä¸­æå–ç”¨æˆ·ä¿¡æ¯
    // ä½¿ç”¨LLMè¿›è¡Œæ™ºèƒ½æå–
}

// 2. å®ç°MemoryManager
@Service
public class MemoryManager {
    // åè°ƒçŸ­æœŸå’Œé•¿æœŸè®°å¿†
    // æä¾›ç»Ÿä¸€çš„è®°å¿†è®¿é—®æ¥å£
}
```

**Week 6ï¼šAPIæ¥å£å’Œæµ‹è¯•**
```java
// 1. å®ç°REST API
@RestController
@RequestMapping("/api/memory/v1")
public class MemoryController {
    // çŸ­æœŸè®°å¿†API
    // é•¿æœŸè®°å¿†API
    // è®°å¿†æå–API
}

// 2. ç¼–å†™æµ‹è¯•
// å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•
```

### ç¬¬äºŒæ­¥ï¼šè§’è‰²è®°å¿†ç³»ç»Ÿï¼ˆ4-6å‘¨ï¼‰

**Week 7-8ï¼šè§’è‰²è®°å¿†æ•°æ®æ¨¡å‹å’ŒæœåŠ¡**
```java
// 1. å®ç°CharacterMemoryService
@Service
public class CharacterMemoryService {
    // è§’è‰²è‡ªèº«è®°å¿†
    // è§’è‰²äº¤äº’è®°å¿†
    // è§’è‰²åœºæ™¯è®°å¿†
    // è§’è‰²å…³ç³»è®°å¿†
}

// 2. å®ç°æ•°æ®æ¨¡å‹
@Document(collection = "character_memories")
public class CharacterMemory {
    private String characterId;
    private String userId;
    private String eraId;
    // ...
}
```

**Week 9-10ï¼šè§’è‰²äº¤äº’è®°å¿†å’Œåœºæ™¯è®°å¿†**
```java
// 1. å®ç°è§’è‰²ä¸ç”¨æˆ·çš„äº¤äº’è®°å¿†
// 2. å®ç°è§’è‰²åœ¨ä¸åŒåœºæ™¯ä¸­çš„è®°å¿†éš”ç¦»
// 3. å®ç°åœºæ™¯åˆ‡æ¢æ—¶çš„è®°å¿†å¤„ç†
```

**Week 11ï¼šè§’è‰²å…³ç³»è®°å¿†**
```java
// 1. å®ç°è§’è‰²ä¹‹é—´çš„å…³ç³»è®°å¿†
// 2. å®ç°å…³ç³»å¼ºåº¦è®¡ç®—
// 3. å®ç°å…³ç³»ç½‘ç»œæ„å»º
```

**Week 12ï¼šé›†æˆåˆ°å¯¹è¯ç³»ç»Ÿ**
```java
// 1. åœ¨å¯¹è¯ç³»ç»Ÿä¸­é›†æˆè§’è‰²è®°å¿†
// 2. è§’è‰²è®°å¿†çš„è‡ªåŠ¨æå–å’Œæ£€ç´¢
// 3. æµ‹è¯•å’Œä¼˜åŒ–
```

---

## ä¸‰ã€æ ¸å¿ƒæ¥å£ç¤ºä¾‹

### 3.1 ç”¨æˆ·è®°å¿†æ¥å£

```java
// ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
POST /api/memory/v1/sessions/{sessionId}/messages
{
  "role": "USER",
  "content": "ä½ å¥½ï¼Œæˆ‘å«å¼ ä¸‰"
}

// è·å–å¯¹è¯ä¸Šä¸‹æ–‡
GET /api/memory/v1/sessions/{sessionId}/messages?limit=20

// ä¿å­˜ç”¨æˆ·äº‹å®
POST /api/memory/v1/users/{userId}/facts
{
  "fact": "åå­—: å¼ ä¸‰",
  "category": "PERSONAL",
  "importance": 0.9
}

// æ£€ç´¢ç”¨æˆ·è®°å¿†
GET /api/memory/v1/users/{userId}/memories/search?query=å¼ ä¸‰
```

### 3.2 è§’è‰²è®°å¿†æ¥å£

```java
// ä¿å­˜è§’è‰²äº¤äº’è®°å¿†
POST /api/memory/v2/characters/{characterId}/interaction-memories
{
  "userId": "user-456",
  "eraId": "era-001",
  "content": "ç”¨æˆ·å–œæ¬¢è°ˆè®ºæ—…è¡Œè¯é¢˜"
}

// è·å–è§’è‰²ä¸ç”¨æˆ·çš„äº¤äº’è®°å¿†
GET /api/memory/v2/characters/{characterId}/interaction-memories?userId={userId}

// ä¿å­˜è§’è‰²åœºæ™¯è®°å¿†
POST /api/memory/v2/characters/{characterId}/scene-memories
{
  "eraId": "era-001",
  "content": "åœ¨å¤§å­¦åœºæ™¯ä¸­ï¼Œè§’è‰²æ˜¯å­¦ç”Ÿ"
}
```

---

## å››ã€å…³é”®å®ç°è¦ç‚¹

### 4.1 è®°å¿†æå–

```java
// åœ¨å¯¹è¯ç»“æŸæ—¶è‡ªåŠ¨æå–è®°å¿†
@PostMapping("/conversation/end")
public void endConversation(@RequestBody EndConversationRequest request) {
    // å¼‚æ­¥æå–è®°å¿†ï¼Œä¸é˜»å¡ä¸»æµç¨‹
    CompletableFuture.runAsync(() -> {
        memoryManager.extractAndSaveMemories(
            request.getUserId(), 
            request.getSessionId()
        );
    });
}
```

### 4.2 è®°å¿†æ£€ç´¢

```java
// åœ¨å¯¹è¯å¼€å§‹æ—¶æ£€ç´¢ç›¸å…³è®°å¿†
public ConversationContext getConversationContext(
        String userId, String sessionId, String characterId, String eraId) {
    
    // 1. è·å–çŸ­æœŸè®°å¿†ï¼ˆæœ€è¿‘20æ¡æ¶ˆæ¯ï¼‰
    List<ChatMessage> messages = shortMemoryService.getMessages(sessionId, 20);
    
    // 2. è·å–ç”¨æˆ·è®°å¿†
    List<UserMemory> userMemories = longMemoryService.retrieveRelevantMemories(
        userId, buildQuery(messages), 10);
    
    // 3. è·å–è§’è‰²è®°å¿†ï¼ˆå¦‚æœæœ‰è§’è‰²ï¼‰
    List<CharacterInteractionMemory> characterMemories = null;
    if (characterId != null) {
        characterMemories = characterMemoryService.getInteractionMemories(
            characterId, userId, eraId);
    }
    
    // 4. æ„å»ºå®Œæ•´ä¸Šä¸‹æ–‡
    return ConversationContext.builder()
        .messages(messages)
        .userMemories(userMemories)
        .characterMemories(characterMemories)
        .build();
}
```

### 4.3 è§’è‰²è®°å¿†é›†æˆ

```java
// åœ¨è§’è‰²å¯¹è¯æ—¶è‡ªåŠ¨ä¿å­˜è§’è‰²è®°å¿†
@PostMapping("/chat/character")
public ChatResponse chatWithCharacter(@RequestBody CharacterChatRequest request) {
    // 1. ç”ŸæˆAIå›å¤
    String response = generateResponse(request);
    
    // 2. ä¿å­˜è§’è‰²äº¤äº’è®°å¿†
    CharacterInteractionMemory memory = new CharacterInteractionMemory();
    memory.setCharacterId(request.getCharacterId());
    memory.setUserId(request.getUserId());
    memory.setEraId(request.getEraId());
    memory.setContent("ç”¨æˆ·è¯¢é—®ï¼š" + request.getMessage());
    characterMemoryService.saveInteractionMemory(memory);
    
    return ChatResponse.builder().message(response).build();
}
```

---

## äº”ã€æ•°æ®åº“é…ç½®

### 5.1 Redisé…ç½®

```yaml
spring:
  data:
    redis:
      host: localhost
      port: 6379
      database: 0
      timeout: 2000ms
```

### 5.2 MongoDBé…ç½®

```yaml
spring:
  data:
    mongodb:
      uri: mongodb://localhost:27017/heartsphere
```

### 5.3 æ•°æ®åº“åˆå§‹åŒ–

```bash
# å¯åŠ¨Rediså’ŒMongoDB
./scripts/start-databases.sh

# åˆ›å»ºMongoDBç´¢å¼•
mongosh heartsphere --eval "
  db.user_facts.createIndex({ userId: 1, category: 1 });
  db.user_facts.createIndex({ userId: 1, importance: -1 });
  db.user_facts.createIndex({ fact: 'text' });
  
  db.user_preferences.createIndex({ userId: 1, key: 1 }, { unique: true });
  
  db.character_memories.createIndex({ characterId: 1, userId: 1, eraId: 1 });
"
```

---

## å…­ã€æµ‹è¯•è¦ç‚¹

### 6.1 å•å…ƒæµ‹è¯•

```java
@Test
public void testSaveAndRetrieveUserFact() {
    // ä¿å­˜ç”¨æˆ·äº‹å®
    UserFact fact = UserFact.builder()
        .userId("user-123")
        .fact("åå­—: å¼ ä¸‰")
        .category(FactCategory.PERSONAL)
        .build();
    longMemoryService.saveFact(fact);
    
    // æ£€ç´¢ç”¨æˆ·äº‹å®
    List<UserFact> facts = longMemoryService.getAllFacts("user-123");
    assertEquals(1, facts.size());
    assertEquals("åå­—: å¼ ä¸‰", facts.get(0).getFact());
}
```

### 6.2 é›†æˆæµ‹è¯•

```java
@Test
public void testMemoryExtraction() {
    // åˆ›å»ºå¯¹è¯æ¶ˆæ¯
    List<ChatMessage> messages = Arrays.asList(
        ChatMessage.builder()
            .content("æˆ‘å«å¼ ä¸‰ï¼Œå–œæ¬¢å–å’–å•¡")
            .role(MessageRole.USER)
            .build()
    );
    
    // æå–è®°å¿†
    List<UserFact> facts = memoryExtractor.extractFacts("user-123", messages);
    
    // éªŒè¯æå–ç»“æœ
    assertTrue(facts.size() > 0);
    assertTrue(facts.stream().anyMatch(f -> f.getFact().contains("å¼ ä¸‰")));
}
```

---

## ä¸ƒã€å¸¸è§é—®é¢˜

### Q1: è®°å¿†æå–ä»€ä¹ˆæ—¶å€™è§¦å‘ï¼Ÿ

**A**: å»ºè®®åœ¨ä»¥ä¸‹æ—¶æœºè§¦å‘ï¼š
- å¯¹è¯ç»“æŸæ—¶ï¼ˆå¼‚æ­¥ï¼‰
- æ£€æµ‹åˆ°é‡è¦ä¿¡æ¯æ—¶ï¼ˆç«‹å³ï¼‰
- å®šæœŸæ‰¹é‡å¤„ç†ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰

### Q2: å¦‚ä½•é¿å…é‡å¤è®°å¿†ï¼Ÿ

**A**: åœ¨ä¿å­˜å‰è¿›è¡Œå»é‡æ£€æŸ¥ï¼š
```java
List<UserFact> existingFacts = longMemoryService.getAllFacts(userId);
List<UserFact> newFacts = facts.stream()
    .filter(newFact -> !isDuplicate(newFact, existingFacts))
    .collect(Collectors.toList());
```

### Q3: è§’è‰²è®°å¿†å¦‚ä½•ä¸ç”¨æˆ·è®°å¿†åŒºåˆ†ï¼Ÿ

**A**: 
- ç”¨æˆ·è®°å¿†ï¼šå­˜å‚¨åœ¨`user_facts`ã€`user_preferences`é›†åˆï¼Œåªå…³è”userId
- è§’è‰²è®°å¿†ï¼šå­˜å‚¨åœ¨`character_memories`é›†åˆï¼Œå…³è”characterIdå’ŒuserId

---

## å…«ã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… **é˜…è¯»æ–‡æ¡£**ï¼šä»”ç»†é˜…è¯»é˜¶æ®µä¸€å’Œé˜¶æ®µäºŒçš„è¯¦ç»†è®¾è®¡æ–‡æ¡£
2. âœ… **ç¯å¢ƒå‡†å¤‡**ï¼šå®‰è£…å’Œé…ç½®Redisã€MongoDB
3. âœ… **å¼€å§‹ç¼–ç **ï¼šæŒ‰ç…§å¼€å‘é¡ºåºé€æ­¥å®ç°
4. âœ… **æŒç»­æµ‹è¯•**ï¼šæ¯ä¸ªåŠŸèƒ½å®Œæˆåç«‹å³æµ‹è¯•
5. âœ… **æ–‡æ¡£æ›´æ–°**ï¼šåŠæ—¶æ›´æ–°APIæ–‡æ¡£å’Œä½¿ç”¨æŒ‡å—

---

## ä¹ã€å‚è€ƒæ–‡æ¡£

- [å®æ–½ä¼˜å…ˆçº§ä¸è·¯çº¿å›¾](./å®æ–½ä¼˜å…ˆçº§ä¸è·¯çº¿å›¾.md) - è¯¦ç»†çš„å®æ–½è®¡åˆ’
- [é˜¶æ®µä¸€ï¼šåŸºç¡€è®°å¿†ç³»ç»Ÿ](./02-é˜¶æ®µä¸€ï¼šåŸºç¡€è®°å¿†ç³»ç»Ÿ.md) - ç”¨æˆ·è®°å¿†ç³»ç»Ÿè¯¦ç»†è®¾è®¡
- [é˜¶æ®µäºŒï¼šè§’è‰²è®°å¿†ç³»ç»Ÿ](./03-é˜¶æ®µäºŒï¼šè§’è‰²è®°å¿†ç³»ç»Ÿ.md) - è§’è‰²è®°å¿†ç³»ç»Ÿè¯¦ç»†è®¾è®¡
- [é•¿æœŸè®°å¿†ä¸çŸ­æœŸè®°å¿†è®¾è®¡è¯¦è§£](./é•¿æœŸè®°å¿†ä¸çŸ­æœŸè®°å¿†è®¾è®¡è¯¦è§£.md) - æŠ€æœ¯ç»†èŠ‚
- [APIæ–‡æ¡£](./07-APIæ–‡æ¡£.md) - APIæ¥å£è¯´æ˜
- [ä½¿ç”¨æŒ‡å—](./08-ä½¿ç”¨æŒ‡å—.md) - ä½¿ç”¨ç¤ºä¾‹å’Œæœ€ä½³å®è·µ

---

**è®°ä½**ï¼šèšç„¦æ ¸å¿ƒåŠŸèƒ½ï¼Œå…ˆå®ç°ç”¨æˆ·è®°å¿†å’Œè§’è‰²è®°å¿†ï¼Œç¡®ä¿ç¨³å®šåå†æ‰©å±•å…¶ä»–åŠŸèƒ½ï¼

