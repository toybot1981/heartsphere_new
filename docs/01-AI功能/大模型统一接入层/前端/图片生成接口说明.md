# 图片生成接口说明

**文档版本**: v1.0  
**创建日期**: 2025-01-22  
**状态**: ✅ 所有Provider已实现

---

## 一、接口概述

图片生成接口支持多种AI模型提供商，每个provider有不同的实现方式和特点。

### 支持的Provider

| Provider | 状态 | 特点 |
|----------|------|------|
| Gemini | ✅ | 使用 generateContent API，返回 base64 数据 |
| OpenAI | ✅ | 使用 DALL-E API，支持多种尺寸 |
| 通义千问 | ✅ | 异步任务模式，需要轮询结果 |
| 豆包 | ✅ | 注意CORS限制，建议使用后端代理 |

---

## 二、接口使用

### 2.1 基本使用

```typescript
import { aiService, AIConfigManager } from '@/services/ai';

// 配置（本地配置模式）
AIConfigManager.setApiKey('gemini', 'your-api-key');
AIConfigManager.saveUserConfig({
  mode: 'local',
  imageProvider: 'gemini',
  imageModel: 'gemini-2.0-flash-exp',
});

// 生成图片
const response = await aiService.generateImage({
  prompt: '一只可爱的小猫在花园里',
  width: 1024,
  height: 1024,
  numberOfImages: 1,
});

// 使用生成的图片
const imageUrl = response.images[0].base64; // Gemini返回base64
// 或
const imageUrl = response.images[0].url; // 其他provider可能返回URL
```

### 2.2 指定Provider和Model

```typescript
// 使用OpenAI DALL-E
const response = await aiService.generateImage({
  provider: 'openai',
  model: 'dall-e-3',
  prompt: '未来城市的夜景',
  width: 1024,
  height: 1024,
});

// 使用通义千问
const response = await aiService.generateImage({
  provider: 'qwen',
  model: 'wanx-v1',
  prompt: '中国古典山水画',
  aspectRatio: '16:9',
});
```

### 2.3 生成多张图片

```typescript
// 生成3张图片
const response = await aiService.generateImage({
  prompt: '不同风格的抽象艺术',
  numberOfImages: 3,
  width: 1024,
  height: 1024,
});

response.images.forEach((img, index) => {
  console.log(`图片 ${index + 1}:`, img.url || img.base64);
});
```

---

## 三、各Provider实现细节

### 3.1 Gemini

**API**: `generateContent`  
**特点**:
- 使用 `generateContent` API，不是专门的图片生成API
- 返回 base64 编码的图片数据
- 支持宽高比配置
- 一次调用生成一张图片，多张需要多次调用

**示例**:
```typescript
const response = await aiService.generateImage({
  provider: 'gemini',
  model: 'gemini-2.0-flash-exp',
  prompt: '一只小猫',
  width: 1024,
  height: 1024,
});

// 返回 base64 数据URL
const imageDataUrl = response.images[0].base64;
// 格式: data:image/png;base64,...
```

**注意事项**:
- 模型名称可能需要使用支持图片生成的模型
- 宽高比会自动计算

### 3.2 OpenAI

**API**: `/images/generations`  
**特点**:
- 使用 DALL-E API
- 支持多种尺寸
- 返回图片URL或base64
- 支持质量设置

**示例**:
```typescript
const response = await aiService.generateImage({
  provider: 'openai',
  model: 'dall-e-3',
  prompt: '未来城市的夜景',
  width: 1024,
  height: 1024,
  numberOfImages: 1,
});

// 可能返回URL或base64
const imageUrl = response.images[0].url || response.images[0].base64;
```

**支持的尺寸**:
- 1024x1024 (1:1)
- 1024x1792 (9:16)
- 1792x1024 (16:9)

### 3.3 通义千问

**API**: 异步任务模式  
**特点**:
- 使用异步任务模式
- 先提交任务，然后轮询结果
- 支持自定义尺寸
- 可能需要较长时间（轮询最多60秒）

**示例**:
```typescript
const response = await aiService.generateImage({
  provider: 'qwen',
  model: 'wanx-v1',
  prompt: '中国古典山水画',
  width: 1024,
  height: 1024,
  aspectRatio: '16:9', // 可选：16:9, 9:16, 3:4, 4:3, 1:1
});

// 返回图片URL
const imageUrl = response.images[0].url;
```

**注意事项**:
- 异步任务，需要等待
- 轮询间隔2秒，最多30次（约60秒）
- 如果超时，会抛出异常

### 3.4 豆包

**API**: `/images/generations`  
**特点**:
- 使用标准图片生成API
- 注意CORS限制
- 建议使用后端代理或统一接入模式

**示例**:
```typescript
const response = await aiService.generateImage({
  provider: 'doubao',
  model: 'doubao-image',
  prompt: '现代艺术风格',
  width: 1024,
  height: 1024,
});
```

**注意事项**:
- 可能存在CORS问题
- 如果遇到CORS错误，建议：
  1. 使用统一接入模式（等待后端实现）
  2. 配置后端代理
  3. 使用浏览器扩展绕过CORS（仅测试环境）

---

## 四、错误处理

```typescript
import { AIServiceException } from '@/services/ai';

try {
  const response = await aiService.generateImage({
    prompt: '测试图片',
  });
} catch (error) {
  if (error instanceof AIServiceException) {
    console.error('AI服务错误:', error.message);
    console.error('Provider:', error.provider);
    
    // 根据错误类型处理
    if (error.errorCode === 'API_KEY_NOT_CONFIGURED') {
      // 引导用户配置API Key
    } else if (error.message.includes('CORS')) {
      // 提示使用后端代理
    } else if (error.message.includes('timeout')) {
      // 提示任务超时
    }
  } else {
    console.error('未知错误:', error);
  }
}
```

---

## 五、降级机制

如果启用了降级（`enableFallback: true`），当指定的provider失败时，会自动尝试其他可用的provider：

```typescript
AIConfigManager.saveUserConfig({
  mode: 'local',
  imageProvider: 'gemini',
  enableFallback: true,
});

// 如果gemini失败，会自动尝试openai、qwen、doubao
try {
  const response = await aiService.generateImage({
    prompt: '测试',
  });
} catch (error) {
  // 如果所有provider都失败，才会抛出异常
  console.error('所有provider都失败了');
}
```

---

## 六、最佳实践

### 6.1 选择合适的Provider

- **Gemini**: 适合快速生成，返回base64，无需额外下载
- **OpenAI**: 质量高，支持多种尺寸，但成本较高
- **通义千问**: 适合中文场景，但需要等待异步任务
- **豆包**: 注意CORS限制

### 6.2 处理不同返回格式

```typescript
const response = await aiService.generateImage({
  prompt: '测试',
});

const image = response.images[0];

// 处理base64数据
if (image.base64) {
  const img = document.createElement('img');
  img.src = image.base64;
  document.body.appendChild(img);
}

// 处理URL
if (image.url) {
  const img = document.createElement('img');
  img.src = image.url;
  document.body.appendChild(img);
}
```

### 6.3 优化用户体验

```typescript
// 显示加载状态
setLoading(true);

try {
  const response = await aiService.generateImage({
    prompt: userPrompt,
    width: 1024,
    height: 1024,
  });
  
  // 显示生成的图片
  setImages(response.images);
} catch (error) {
  // 显示错误提示
  showError('图片生成失败，请重试');
} finally {
  setLoading(false);
}
```

---

## 七、已知限制

1. **Gemini**: 一次只能生成一张图片，多张需要多次调用
2. **通义千问**: 异步任务，需要等待，可能有超时风险
3. **豆包**: CORS限制，建议使用后端代理
4. **所有Provider**: 流式生成不支持降级

---

## 八、后续优化

1. ⚠️ 实现图片生成缓存
2. ⚠️ 添加图片生成进度提示（特别是异步任务）
3. ⚠️ 优化多张图片生成的并发控制
4. ⚠️ 添加图片质量设置选项
5. ⚠️ 支持图片编辑和变体生成

---

**最后更新**: 2025-01-22


