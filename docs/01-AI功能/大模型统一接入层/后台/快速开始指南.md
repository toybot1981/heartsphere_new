# 大模型统一接入层 - 快速开始指南

**文档版本**: V1.0  
**编写日期**: 2025-12-21

---

## 一、项目概述

大模型统一接入层是基于Spring AI Alibaba实现的AI服务统一接入系统，支持：
- ✅ 文本生成（同步和流式）
- ✅ 图片生成
- 🔄 音频处理（TTS/STT）- 开发中
- 🔄 视频生成 - 开发中
- ✅ 多模型适配器支持
- ✅ 配置管理

---

## 二、项目结构

```
backend/src/main/java/com/heartsphere/aiagent/
├── adapter/              # 模型适配器层
│   ├── ModelAdapter.java
│   ├── DashScopeAdapter.java
│   └── ModelAdapterManager.java
├── config/               # 配置类
├── controller/           # API控制器
├── dto/                  # 数据传输对象
│   ├── request/         # 请求DTO
│   └── response/        # 响应DTO
├── entity/              # 实体类
├── exception/           # 异常类
├── repository/          # 数据访问层
├── service/            # 服务层
└── util/               # 工具类
```

---

## 三、快速开始

### 3.1 环境要求

- JDK 17+
- Maven 3.6+
- MySQL 8.0+（或H2用于测试）
- DashScope API Key

### 3.2 配置步骤

1. **添加依赖**（已完成）
   - Spring AI Alibaba已在 `pom.xml` 中配置

2. **配置API Key**

   在 `application.yml` 中添加：
   ```yaml
   spring:
     ai:
       dashscope:
         api-key: ${DASHSCOPE_API_KEY:your-api-key-here}
   ```

   或使用环境变量：
   ```bash
   export DASHSCOPE_API_KEY=your-api-key-here
   ```

3. **数据库配置**

   创建数据库迁移脚本（待完成）：
   - `user_ai_config` 表
   - `system_ai_config` 表
   - `ai_usage_record` 表（可选，用于计费）

### 3.3 启动服务

```bash
cd backend
mvn spring-boot:run
```

服务将在 `http://localhost:8081` 启动。

---

## 四、核心组件说明

### 4.1 适配器层

**ModelAdapter接口**: 定义统一的模型调用接口

**DashScopeAdapter**: 基于Spring AI Alibaba实现
- 使用 `DashScopeChatModel` 进行文本生成
- 使用 `DashScopeImageModel` 进行图片生成
- 支持流式响应

**ModelAdapterManager**: 管理所有适配器实例

### 4.2 服务层

**AIService接口**: 定义AI服务接口

**AIServiceImpl**: 实现AI服务逻辑（待实现）
- 获取用户配置
- 选择适配器
- 调用适配器
- 记录使用量
- 错误处理和降级

### 4.3 控制器层

**AIServiceController**: 提供REST API接口（待实现）
- `POST /api/ai/text/generate` - 文本生成
- `POST /api/ai/text/generate/stream` - 流式文本生成
- `POST /api/ai/image/generate` - 图片生成
- `POST /api/ai/audio/tts` - 文本转语音
- `POST /api/ai/audio/stt` - 语音转文本
- `POST /api/ai/video/generate` - 视频生成
- `GET /api/ai/config` - 获取配置
- `PUT /api/ai/config` - 更新配置

---

## 五、使用示例

### 5.1 文本生成（同步）

```java
@Autowired
private AIService aiService;

TextGenerationRequest request = new TextGenerationRequest();
request.setPrompt("你好，请介绍一下你自己");
request.setProvider("dashscope");
request.setModel("qwen-max");

TextGenerationResponse response = aiService.generateText(userId, request);
System.out.println(response.getContent());
```

### 5.2 文本生成（流式）

```java
aiService.generateTextStream(userId, request, (response, done) -> {
    System.out.print(response.getContent());
    if (done) {
        System.out.println("\n完成");
    }
});
```

### 5.3 图片生成

```java
ImageGenerationRequest request = new ImageGenerationRequest();
request.setPrompt("一只可爱的小猫");
request.setProvider("dashscope");
request.setModel("wanx-v1");

ImageGenerationResponse response = aiService.generateImage(userId, request);
response.getImages().forEach(image -> {
    System.out.println("图片URL: " + image.getUrl());
});
```

---

## 六、开发任务清单

### 高优先级（立即完成）
- [ ] 实现 `AIServiceImpl.java`
- [ ] 实现 `AIServiceController.java`
- [ ] 创建数据库迁移脚本
- [ ] 实现 `AIConfigService.java`

### 中优先级（1-2天）
- [ ] 完善DashScopeAdapter的音频和视频功能
- [ ] 实现降级机制
- [ ] 编写单元测试

### 低优先级（1周内）
- [ ] 实现使用量记录
- [ ] 性能优化
- [ ] 完善文档

---

## 七、测试

### 7.1 单元测试

```bash
mvn test
```

### 7.2 API测试

参考 `API测试文档.md` 进行API测试。

---

## 八、常见问题

### Q1: 如何添加新的模型适配器？

A: 实现 `ModelAdapter` 接口，添加 `@Component` 注解，Spring会自动注册。

### Q2: 如何切换不同的模型？

A: 在请求中指定 `provider` 和 `model` 参数，或在用户配置中设置默认值。

### Q3: 如何实现降级机制？

A: 在 `AIServiceImpl` 中实现，当主模型失败时，自动切换到备用模型。

---

## 九、参考文档

- [开发文档](./大模型统一接入层开发文档.md)
- [API测试文档](./API测试文档.md)
- [开发进度总结](./开发进度总结.md)
- [Spring AI Alibaba文档](https://github.com/alibaba/spring-ai-alibaba)

---

## 十、下一步

1. 查看 `开发进度总结.md` 了解当前进度
2. 查看 `API测试文档.md` 了解API使用
3. 开始实现 `AIServiceImpl` 和 `AIServiceController`

---

**文档维护**: 本文档应随开发进展持续更新。

