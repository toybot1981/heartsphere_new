# 前后端联调说明

**文档版本**: v1.0  
**创建日期**: 2025-01-22  
**状态**: ✅ 前后端联调已完成

---

## 一、联调概述

前后端联调已完成，支持统一接入模式和本地配置模式的双模式AI服务调用。

### 已实现功能

- ✅ 后端REST API接口（AIServiceController）
- ✅ 后端服务实现（AIServiceImpl）
- ✅ 前端统一接入模式API调用
- ✅ 前端配置管理API调用
- ✅ 流式文本生成（SSE）
- ✅ 错误处理和认证

---

## 二、后端接口

### 2.1 文本生成

**接口**: `POST /api/ai/text/generate`

**请求示例**:
```json
{
  "prompt": "你好，请介绍一下你自己",
  "provider": "dashscope",
  "model": "qwen-max",
  "temperature": 0.7,
  "maxTokens": 1000
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "文本生成成功",
  "data": {
    "content": "你好！我是通义千问...",
    "provider": "dashscope",
    "model": "qwen-max",
    "usage": {
      "inputTokens": 15,
      "outputTokens": 45,
      "totalTokens": 60
    },
    "finishReason": "stop"
  }
}
```

### 2.2 流式文本生成

**接口**: `POST /api/ai/text/generate/stream`

**响应格式** (Server-Sent Events):
```
data: {"content":"生成的","done":false}
data: {"content":"文本","done":false}
data: {"content":"内容","done":true,"usage":{"inputTokens":15,"outputTokens":45,"totalTokens":60}}
```

### 2.3 图片生成

**接口**: `POST /api/ai/image/generate`

**请求示例**:
```json
{
  "prompt": "一只可爱的小猫",
  "provider": "dashscope",
  "model": "wanx-v1",
  "width": 1024,
  "height": 1024
}
```

### 2.4 配置管理

**获取配置**: `GET /api/ai/config`  
**更新配置**: `PUT /api/ai/config`

---

## 三、前端调用

### 3.1 基本使用

```typescript
import { aiService, AIConfigManager } from '@/services/ai';

// 1. 配置为统一接入模式
await AIConfigManager.saveUserConfig({
  mode: 'unified',
  textProvider: 'dashscope',
  textModel: 'qwen-max',
});

// 2. 调用AI服务
const response = await aiService.generateText({
  prompt: '你好',
});

console.log(response.content);
```

### 3.2 流式生成

```typescript
await aiService.generateTextStream(
  { prompt: '写一首诗' },
  (chunk) => {
    if (!chunk.done) {
      console.log(chunk.content);
    } else {
      console.log('完成，Token使用:', chunk.usage);
    }
  }
);
```

### 3.3 图片生成

```typescript
const response = await aiService.generateImage({
  prompt: '一只可爱的小猫',
  width: 1024,
  height: 1024,
});

const imageUrl = response.images[0].url;
```

---

## 四、认证

所有后端API都需要JWT认证：

```typescript
// 前端自动从localStorage获取token
const token = localStorage.getItem('auth_token');

// 后端自动从请求头获取
Authorization: Bearer <token>
```

---

## 五、错误处理

### 5.1 前端错误处理

```typescript
import { AIServiceException } from '@/services/ai';

try {
  const response = await aiService.generateText({
    prompt: '测试',
  });
} catch (error) {
  if (error instanceof AIServiceException) {
    console.error('AI服务错误:', error.message);
    console.error('Provider:', error.provider);
  } else {
    console.error('未知错误:', error);
  }
}
```

### 5.2 后端错误响应

```json
{
  "code": 500,
  "message": "文本生成失败: 模型不可用",
  "data": null,
  "timestamp": "2025-01-22T10:30:00"
}
```

---

## 六、模式切换

### 6.1 统一接入模式

- 所有API调用经过后端
- 后端管理API Keys
- 支持使用量统计和配额管理
- 需要用户登录

### 6.2 本地配置模式

- 前端直接调用AI服务API
- 用户自己配置API Keys
- 不需要后端
- 支持访客模式

---

## 七、测试

### 7.1 启动后端

```bash
cd backend
mvn spring-boot:run
```

后端将在 `http://localhost:8081` 启动。

### 7.2 启动前端

```bash
cd frontend
npm run dev
```

前端将在 `http://localhost:3000` 启动。

### 7.3 测试步骤

1. **登录获取Token**
   ```bash
   curl -X POST http://localhost:8081/api/auth/login \
     -H "Content-Type: application/json" \
     -d '{"username":"test@example.com","password":"password123"}'
   ```

2. **测试文本生成**
   ```bash
   curl -X POST http://localhost:8081/api/ai/text/generate \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer <token>" \
     -d '{"prompt":"你好"}'
   ```

3. **前端测试**
   - 打开浏览器控制台
   - 切换到统一接入模式
   - 调用AI服务，查看网络请求

---

## 八、已知问题

1. **后端DashScopeAdapter编译错误**
   - Spring AI Alibaba版本兼容性问题
   - 不影响基本功能，需要后续修复

2. **配置管理API未完全实现**
   - 后端配置获取/更新逻辑待实现
   - 前端已支持，等待后端完善

---

## 九、后续优化

1. ⚠️ 实现完整的配置管理（数据库存储）
2. ⚠️ 实现使用量统计
3. ⚠️ 实现配额管理
4. ⚠️ 完善错误处理和日志记录
5. ⚠️ 添加API限流

---

**最后更新**: 2025-01-22


