# 大模型统一接入层测试指南

**文档版本**: v1.0  
**创建日期**: 2025-01-22

---

## 一、客户端入口位置

### 1.1 前端入口文件

**主要入口**:
- **HTML入口**: `frontend/index.html` - 浏览器加载的HTML文件
- **React入口**: `frontend/index.tsx` - React应用的入口点
- **主应用组件**: `frontend/App.tsx` - 主应用组件，包含所有业务逻辑

**入口文件结构**:
```
frontend/
├── index.html          # HTML入口（浏览器加载）
├── index.tsx           # React入口（渲染App组件）
└── App.tsx             # 主应用组件（包含所有功能）
```

### 1.2 启动方式

```bash
# 进入前端目录
cd frontend

# 启动开发服务器（端口3000）
npm run dev
```

访问地址: `http://localhost:3000`

---

## 二、后端入口位置

### 2.1 后端入口

**Spring Boot应用入口**:
- 通常在 `backend/src/main/java/com/heartsphere/Application.java` 或类似文件

**AI服务相关**:
- **Controller**: `backend/src/main/java/com/heartsphere/aiagent/controller/AIServiceController.java`
- **Service**: `backend/src/main/java/com/heartsphere/aiagent/service/AIServiceImpl.java`

### 2.2 启动方式

```bash
# 进入后端目录
cd backend

# 启动Spring Boot应用（端口8081）
mvn spring-boot:run
```

访问地址: `http://localhost:8081`

---

## 三、测试步骤

### 3.1 环境准备

1. **启动后端服务**
   ```bash
   cd backend
   mvn spring-boot:run
   ```
   
   确保后端在 `http://localhost:8081` 正常运行。

2. **启动前端服务**
   ```bash
   cd frontend
   npm run dev
   ```
   
   确保前端在 `http://localhost:3000` 正常运行。

3. **配置环境变量**（可选）
   
   如果需要使用本地配置模式，可以在 `frontend/.env` 中配置API Keys：
   ```env
   VITE_GEMINI_API_KEY=your-api-key
   VITE_OPENAI_API_KEY=your-api-key
   VITE_QWEN_API_KEY=your-api-key
   ```

### 3.2 测试统一接入模式

#### 步骤1: 登录获取Token

1. 打开浏览器访问 `http://localhost:3000`
2. 点击登录按钮
3. 输入用户名和密码登录
4. 登录成功后，Token会自动保存到 `localStorage` 的 `auth_token` 中

#### 步骤2: 切换到统一接入模式

1. 打开浏览器控制台（F12）
2. 执行以下代码切换到统一接入模式：
   ```javascript
   import { AIConfigManager } from './services/ai';
   
   await AIConfigManager.saveUserConfig({
     mode: 'unified',
     textProvider: 'dashscope',
     textModel: 'qwen-max',
     enableFallback: true,
   });
   ```

   或者在前端代码中添加一个设置界面来切换模式。

#### 步骤3: 测试文本生成

在浏览器控制台执行：
```javascript
import { aiService } from './services/ai';

try {
  const response = await aiService.generateText({
    prompt: '你好，请介绍一下你自己',
    provider: 'dashscope',
    model: 'qwen-max',
  });
  console.log('生成结果:', response);
} catch (error) {
  console.error('生成失败:', error);
}
```

#### 步骤4: 测试流式文本生成

```javascript
import { aiService } from './services/ai';

await aiService.generateTextStream(
  {
    prompt: '请写一首关于春天的诗',
    provider: 'dashscope',
  },
  (chunk) => {
    if (!chunk.done) {
      console.log('收到数据块:', chunk.content);
    } else {
      console.log('完成，Token使用:', chunk.usage);
    }
  }
);
```

#### 步骤5: 测试图片生成

```javascript
import { aiService } from './services/ai';

try {
  const response = await aiService.generateImage({
    prompt: '一只可爱的小猫坐在窗台上',
    provider: 'dashscope',
    model: 'wanx-v1',
    width: 1024,
    height: 1024,
  });
  console.log('生成的图片:', response.images);
} catch (error) {
  console.error('图片生成失败:', error);
}
```

### 3.3 测试本地配置模式

#### 步骤1: 切换到本地配置模式

```javascript
import { AIConfigManager } from './services/ai';

await AIConfigManager.saveUserConfig({
  mode: 'local',
  textProvider: 'gemini',
  textModel: 'gemini-2.0-flash-exp',
  enableFallback: true,
});

// 设置API Key
AIConfigManager.setApiKey('gemini', 'your-gemini-api-key');
```

#### 步骤2: 测试文本生成

```javascript
import { aiService } from './services/ai';

try {
  const response = await aiService.generateText({
    prompt: '你好',
  });
  console.log('生成结果:', response);
} catch (error) {
  console.error('生成失败:', error);
}
```

---

## 四、测试检查清单

### 4.1 统一接入模式测试

- [ ] 后端服务正常启动（端口8081）
- [ ] 前端服务正常启动（端口3000）
- [ ] 用户登录成功，Token已保存
- [ ] 切换到统一接入模式成功
- [ ] 文本生成接口调用成功
- [ ] 流式文本生成接口调用成功
- [ ] 图片生成接口调用成功
- [ ] 错误处理正常（如未登录、API失败等）

### 4.2 本地配置模式测试

- [ ] 切换到本地配置模式成功
- [ ] API Key配置成功
- [ ] 文本生成接口调用成功
- [ ] 流式文本生成接口调用成功
- [ ] 图片生成接口调用成功
- [ ] 降级机制正常工作

### 4.3 配置管理测试

- [ ] 获取用户配置成功
- [ ] 更新用户配置成功
- [ ] 配置持久化正常（localStorage）
- [ ] 统一接入模式下配置同步到后端

---

## 五、常见问题排查

### 5.1 后端连接失败

**问题**: 前端无法连接到后端API

**排查步骤**:
1. 检查后端是否正常运行：`curl http://localhost:8081/api/auth/login`
2. 检查前端API_BASE_URL配置：`frontend/services/ai/AIService.ts` 中的 `API_BASE_URL`
3. 检查浏览器控制台的网络请求，查看是否有CORS错误

### 5.2 认证失败

**问题**: 统一接入模式返回401未授权

**排查步骤**:
1. 检查Token是否存在：`localStorage.getItem('auth_token')`
2. 检查Token是否有效（未过期）
3. 检查后端JWT配置是否正确

### 5.3 API调用失败

**问题**: AI服务调用返回错误

**排查步骤**:
1. 检查后端日志，查看具体错误信息
2. 检查API Key配置（统一接入模式由后端管理，本地模式需要用户配置）
3. 检查网络请求的请求体和响应体

---

## 六、调试技巧

### 6.1 浏览器控制台调试

```javascript
// 查看当前配置
import { AIConfigManager } from './services/ai';
const config = await AIConfigManager.getUserConfig();
console.log('当前配置:', config);

// 查看API Keys（本地模式）
const apiKeys = AIConfigManager.getLocalApiKeys();
console.log('API Keys:', apiKeys);

// 测试AI服务
import { aiService } from './services/ai';
const response = await aiService.generateText({ prompt: '测试' });
console.log('响应:', response);
```

### 6.2 网络请求调试

1. 打开浏览器开发者工具（F12）
2. 切换到"Network"标签
3. 过滤请求：输入 `ai` 或 `api/ai`
4. 查看请求详情：
   - 请求URL
   - 请求头（特别是Authorization）
   - 请求体
   - 响应状态码
   - 响应体

### 6.3 后端日志调试

查看后端控制台输出，关注：
- AI服务调用日志
- 错误堆栈信息
- 请求参数和响应结果

---

## 七、测试报告模板

### 测试环境
- 前端版本: 
- 后端版本: 
- 测试日期: 
- 测试人员: 

### 测试结果

| 测试项 | 统一接入模式 | 本地配置模式 | 备注 |
|--------|------------|------------|------|
| 文本生成 | ✅/❌ | ✅/❌ | |
| 流式文本生成 | ✅/❌ | ✅/❌ | |
| 图片生成 | ✅/❌ | ✅/❌ | |
| 配置管理 | ✅/❌ | ✅/❌ | |
| 错误处理 | ✅/❌ | ✅/❌ | |

### 发现的问题

1. 
2. 
3. 

---

**最后更新**: 2025-01-22


