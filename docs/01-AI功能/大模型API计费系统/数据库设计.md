# 大模型API计费系统 - 数据库设计

## 数据库表结构

数据库表结构定义在：`backend/src/main/resources/db/migration/create_billing_tables.sql`

## 表说明

### 1. ai_providers - AI模型提供商表

存储AI模型提供商信息。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| name | VARCHAR(100) | 提供商名称：dashscope, openai, gemini, doubao |
| display_name | VARCHAR(200) | 显示名称：阿里云通义千问 |
| enabled | BOOLEAN | 是否启用 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### 2. ai_models - AI模型表

存储AI模型信息。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| provider_id | BIGINT | 提供商ID |
| model_code | VARCHAR(100) | 模型代码：qwen-max, gpt-4 |
| model_name | VARCHAR(200) | 模型名称：通义千问-Max |
| model_type | VARCHAR(50) | 模型类型：text, image, audio, video |
| enabled | BOOLEAN | 是否启用 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### 3. ai_model_pricing - 模型资费配置表

存储模型资费配置信息。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| model_id | BIGINT | 模型ID |
| pricing_type | VARCHAR(50) | 计费类型：input_token, output_token, image, audio_minute, video_second |
| unit_price | DECIMAL(12,6) | 单价 |
| unit | VARCHAR(50) | 单位：per_1k_tokens, per_image, per_minute, per_second |
| min_charge_unit | DECIMAL(12,6) | 最低计费单位 |
| effective_date | DATETIME | 生效日期 |
| expiry_date | DATETIME | 失效日期（NULL表示永久有效） |
| is_active | BOOLEAN | 是否生效 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### 4. user_token_quota - 用户Token配额表

存储用户的各种配额信息。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户ID（唯一） |
| text_token_total | BIGINT | 文本Token总配额 |
| text_token_used | BIGINT | 文本Token已使用 |
| text_token_monthly_quota | BIGINT | 月度文本Token配额 |
| text_token_monthly_used | BIGINT | 月度文本Token已使用 |
| image_quota_total | INT | 图片生成总配额 |
| image_quota_used | INT | 图片生成已使用 |
| image_quota_monthly | INT | 月度图片配额 |
| image_quota_monthly_used | INT | 月度图片已使用 |
| audio_quota_total | INT | 语音处理总配额（分钟） |
| audio_quota_used | INT | 语音处理已使用（分钟） |
| audio_quota_monthly | INT | 月度语音配额（分钟） |
| audio_quota_monthly_used | INT | 月度语音已使用（分钟） |
| video_quota_total | INT | 视频生成总配额（秒） |
| video_quota_used | INT | 视频生成已使用（秒） |
| video_quota_monthly | INT | 月度视频配额（秒） |
| video_quota_monthly_used | INT | 月度视频已使用（秒） |
| last_reset_date | DATE | 上次重置日期 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### 5. token_quota_transaction - Token配额变动记录表

记录所有配额变动操作，用于审计和追溯。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户ID |
| transaction_type | VARCHAR(50) | 变动类型：grant, consume, purchase, refund |
| quota_type | VARCHAR(50) | 配额类型：text_token, image, audio, video |
| amount | BIGINT | 变动数量 |
| balance_after | BIGINT | 变动后余额 |
| source | VARCHAR(100) | 来源：membership, purchase, admin_grant, usage |
| reference_id | BIGINT | 关联ID（订单ID、会员ID等） |
| description | VARCHAR(500) | 描述 |
| created_at | DATETIME | 创建时间 |

### 6. ai_usage_records - AI使用记录表

记录每次AI API调用的详细信息。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户ID |
| provider_id | BIGINT | 提供商ID |
| model_id | BIGINT | 模型ID |
| usage_type | VARCHAR(50) | 使用类型：text_generation, image_generation, audio_tts, audio_stt, video_generation |
| input_tokens | INT | 输入Token数 |
| output_tokens | INT | 输出Token数 |
| total_tokens | INT | 总Token数 |
| image_count | INT | 图片数量 |
| audio_duration | INT | 音频时长（秒） |
| video_duration | INT | 视频时长（秒） |
| cost_amount | DECIMAL(12,6) | 费用（元） |
| token_consumed | BIGINT | 消耗的Token配额 |
| status | VARCHAR(20) | 状态：success, failed, timeout |
| request_id | VARCHAR(100) | 请求ID（用于追踪） |
| error_message | TEXT | 错误信息 |
| created_at | DATETIME | 创建时间 |

### 7. ai_cost_daily - 成本统计表（每日汇总）

每日成本统计汇总，用于成本分析。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| stat_date | DATE | 统计日期 |
| provider_id | BIGINT | 提供商ID |
| model_id | BIGINT | 模型ID |
| usage_type | VARCHAR(50) | 使用类型 |
| total_usage | BIGINT | 总使用量 |
| total_cost | DECIMAL(12,6) | 总成本 |
| call_count | INT | 调用次数 |
| created_at | DATETIME | 创建时间 |

### 8. token_packages - Token包配置表

存储可购买的Token包配置。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| name | VARCHAR(200) | 包名称：100万Token包 |
| quota_type | VARCHAR(50) | 配额类型：text_token, image, audio, video |
| amount | BIGINT | Token数量 |
| price | DECIMAL(10,2) | 价格 |
| original_price | DECIMAL(10,2) | 原价（用于显示折扣） |
| bonus_amount | BIGINT | 赠送数量 |
| is_active | BOOLEAN | 是否启用 |
| sort_order | INT | 排序 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

## 表关系

```
users (用户表)
  └── user_token_quota (用户配额表)
  └── token_quota_transaction (配额变动记录表)
  └── ai_usage_records (使用记录表)

ai_providers (提供商表)
  └── ai_models (模型表)
      └── ai_model_pricing (资费配置表)
      └── ai_usage_records (使用记录表)
      └── ai_cost_daily (成本统计表)

subscription_plans (订阅计划表)
  └── (扩展字段: text_token_quota, image_generation_quota, etc.)
```

## 索引设计

- `ai_models`: `uk_provider_model` - (provider_id, model_code) 唯一索引
- `ai_model_pricing`: `idx_model_effective` - (model_id, effective_date, is_active) 索引
- `token_quota_transaction`: `idx_user_type` - (user_id, transaction_type, created_at) 索引
- `ai_usage_records`: 
  - `idx_user_created` - (user_id, created_at) 索引
  - `idx_provider_created` - (provider_id, created_at) 索引
  - `idx_model_created` - (model_id, created_at) 索引
- `ai_cost_daily`: `uk_date_provider_model_type` - (stat_date, provider_id, model_id, usage_type) 唯一索引

## 数据初始化

### 1. 创建提供商和模型

参考 `README.md` 中的初始化模型数据部分。

### 2. 配置资费

为每个模型配置相应的资费标准，包括：
- 输入Token价格
- 输出Token价格
- 图片生成价格
- 音频处理价格
- 视频生成价格

### 3. 配置订阅计划配额

在 `subscription_plans` 表中为每个订阅计划配置相应的配额：
- text_token_quota: 文本Token配额
- image_generation_quota: 图片生成配额
- audio_processing_quota: 语音处理配额
- video_generation_quota: 视频生成配额
- permanent_token_quota: 永久Token配额

