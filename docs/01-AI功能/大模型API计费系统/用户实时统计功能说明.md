# 用户实时统计功能说明

## 功能概述

用户实时统计功能提供了用户实时的token、图片张数等使用数据的记录和统计，并与会员等级中设定的配额进行匹配和对比。

## 功能特性

### 1. 实时数据统计

- **文本Token统计**：统计用户文本生成的token使用情况
- **图片生成统计**：统计用户图片生成的张数
- **音频处理统计**：统计用户音频处理的分钟数
- **视频生成统计**：统计用户视频生成的秒数

### 2. 配额对比

- **月度配额**：显示用户当前会员等级的月度配额
- **总配额**：显示用户的总配额（永久配额）
- **使用率**：实时计算配额使用率，并用颜色标识（绿色/黄色/红色）
- **会员配额对比**：显示会员计划中设定的配额，便于用户了解自己的配额限制

### 3. 数据来源

- **配额数据**：从 `user_token_quota` 表中获取
- **实际使用量**：从 `ai_usage_records` 表中实时统计
- **会员信息**：从 `memberships` 和 `subscription_plans` 表中获取

## 后端实现

### 1. 服务层

**`UserUsageStatisticsService`**

位置：`backend/src/main/java/com/heartsphere/billing/service/UserUsageStatisticsService.java`

主要方法：
- `getUserStatistics(Long userId)`: 获取用户使用统计

统计内容包括：
- 文本Token：总配额、已使用、月度配额、月度已使用、实际使用量、会员配额、永久配额
- 图片：总配额、已使用、月度配额、月度已使用、实际使用量、会员配额
- 音频：总配额、已使用、月度配额、月度已使用、实际使用量、会员配额
- 视频：总配额、已使用、月度配额、月度已使用、实际使用量、会员配额

### 2. 控制器层

**`UserUsageStatisticsController`**

位置：`backend/src/main/java/com/heartsphere/billing/controller/UserUsageStatisticsController.java`

API端点：
- `GET /api/billing/statistics/me` - 获取当前用户的使用统计
- `GET /api/billing/statistics/users/{userId}` - 获取指定用户的使用统计（管理员）

### 3. 数据库扩展

**`SubscriptionPlan` 实体扩展**

新增字段：
- `textTokenQuota` (Long) - 文本Token配额（每月）
- `imageGenerationQuota` (Integer) - 图片生成配额（每月）
- `audioProcessingQuota` (Integer) - 语音处理配额（每月，分钟）
- `videoGenerationQuota` (Integer) - 视频生成配额（每月，秒）
- `permanentTokenQuota` (Long) - 永久Token配额

这些字段在数据库迁移脚本中已定义：
```sql
ALTER TABLE subscription_plans 
  ADD COLUMN IF NOT EXISTS text_token_quota BIGINT DEFAULT 0,
  ADD COLUMN IF NOT EXISTS image_generation_quota INT DEFAULT 0,
  ADD COLUMN IF NOT EXISTS audio_processing_quota INT DEFAULT 0,
  ADD COLUMN IF NOT EXISTS video_generation_quota INT DEFAULT 0,
  ADD COLUMN IF NOT EXISTS permanent_token_quota BIGINT DEFAULT 0;
```

## 前端实现

### 1. API服务

**`billingApi.statistics`**

位置：`frontend/services/api/billing.ts`

方法：
- `getMyStatistics(token)`: 获取当前用户的使用统计
- `getUserStatistics(userId, token)`: 获取指定用户的使用统计（管理员）

### 2. 组件

**`UserUsageStatistics`**

位置：`frontend/components/UserUsageStatistics.tsx`

功能：
- 显示用户当前会员信息
- 显示各类型配额的使用情况（文本Token、图片、音频、视频）
- 实时刷新（每30秒自动刷新）
- 手动刷新按钮
- 使用率可视化（进度条，颜色标识）

显示内容：
- **月度配额**：显示月度配额、已使用、可用、实际使用量、会员配额
- **总配额**：显示总配额、已使用、可用、永久配额（如果有）

## 使用方式

### 1. 前端集成

在需要显示用户统计的地方引入组件：

```tsx
import { UserUsageStatistics } from '../components/UserUsageStatistics';

// 在组件中使用
<UserUsageStatistics />
```

### 2. API调用

**获取当前用户统计**：
```typescript
import { billingApi } from '../services/api/billing';

const stats = await billingApi.statistics.getMyStatistics(token);
console.log(stats);
```

**获取指定用户统计（管理员）**：
```typescript
const stats = await billingApi.statistics.getUserStatistics(userId, adminToken);
```

### 3. 数据格式

```typescript
interface UserUsageStatistics {
  userId: number;
  planName?: string;           // 会员名称
  planType?: string;           // 会员类型
  currentMonth: string;       // 当前统计月份（YYYY-MM）
  lastResetDate?: string;      // 最后重置日期
  textTokenStats: TokenStats;
  imageStats: ImageStats;
  audioStats: AudioStats;
  videoStats: VideoStats;
}

interface TokenStats {
  totalQuota: number;              // 总配额
  totalUsed: number;                // 总已使用
  totalAvailable: number;           // 总可用
  monthlyQuota: number;             // 月度配额
  monthlyUsed: number;              // 月度已使用
  monthlyActualUsage: number;      // 月度实际使用量（从记录统计）
  monthlyAvailable: number;         // 月度可用
  planMonthlyQuota?: number;        // 会员月度配额
  permanentQuota?: number;         // 永久配额
  totalUsageRate?: number;          // 总使用率（百分比）
  monthlyUsageRate?: number;        // 月度使用率（百分比）
}
```

## 统计逻辑

### 1. 月度统计

- 统计当前月份（从1号0点到月末23:59:59）的使用记录
- 从 `ai_usage_records` 表中查询并汇总：
  - 文本Token：统计 `usage_type = 'text_generation'` 的记录
  - 图片：统计 `usage_type = 'image_generation'` 的记录，累加 `image_count`
  - 音频：统计 `usage_type = 'audio_tts'` 或 `'audio_stt'` 的记录，累加 `audio_duration`（转换为分钟）
  - 视频：统计 `usage_type = 'video_generation'` 的记录，累加 `video_duration`（秒）

### 2. 配额对比

- **月度配额 vs 会员配额**：对比用户实际分配的月度配额和会员计划中的配额
- **总配额 vs 永久配额**：对比用户的总配额和会员计划中的永久配额
- **使用率计算**：`使用率 = 已使用 / 配额 * 100%`

### 3. 使用率颜色标识

- **绿色**：使用率 < 70%
- **黄色**：70% ≤ 使用率 < 90%
- **红色**：使用率 ≥ 90%

## 配置会员配额

在管理后台的"会员配置管理"中，可以为每个会员等级设置：

1. **文本Token配额** (`text_token_quota`)：每月文本Token配额
2. **图片生成配额** (`image_generation_quota`)：每月图片生成张数
3. **语音处理配额** (`audio_processing_quota`)：每月语音处理分钟数
4. **视频生成配额** (`video_generation_quota`)：每月视频生成秒数
5. **永久Token配额** (`permanent_token_quota`)：永久Token配额（不按月重置）

## 注意事项

1. **实时性**：前端组件每30秒自动刷新，也可以手动刷新
2. **数据一致性**：实际使用量从使用记录中统计，可能与配额表中的已使用量略有差异（因为记录是实时写入的）
3. **会员状态**：只有状态为"active"的会员才会显示会员配额信息
4. **权限**：普通用户只能查看自己的统计，管理员可以查看任意用户的统计

## 未来优化

1. **历史统计**：支持查看历史月份的使用统计
2. **趋势分析**：显示使用趋势图表
3. **配额预警**：当使用率超过阈值时发送提醒
4. **导出功能**：支持导出使用统计报告

