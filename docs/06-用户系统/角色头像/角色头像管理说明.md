# 角色头像管理说明

## 功能概述

角色编辑器支持三种方式设置头像：
1. **AI生成头像**：使用AI自动生成角色头像
2. **手动上传头像**：用户从本地选择图片上传
3. **选择预置头像**：从系统预置资源中选择

## 文件夹结构

为了区分用户上传的头像和系统预置的头像，系统使用不同的文件夹分类：

### 用户上传的头像
- **分类**：`character/user`
- **存储路径**：`uploads/images/character/user/{year}/{month}/{filename}`
- **访问URL**：`/api/images/files/character/user/{year}/{month}/{filename}`

### 系统预置头像
- **分类**：`character` 或 `character/preset`
- **存储路径**：`uploads/images/character/{year}/{month}/{filename}` 或 `uploads/images/character/preset/{year}/{month}/{filename}`
- **访问URL**：`/api/images/files/character/{year}/{month}/{filename}` 或 `/api/images/files/character/preset/{year}/{month}/{filename}`

## 功能实现

### 1. AI生成头像

**位置**：角色编辑器 → 头像输入框 → "✨ 生成" 按钮

**流程**：
1. 用户点击"生成"按钮
2. 调用 `aiService.generateCharacterImage()` 生成头像
3. 生成的头像自动缓存到本地IndexedDB
4. 自动上传到服务器（使用 `character/user` 分类）
5. 上传成功后使用服务器URL，失败时使用本地缓存

**代码位置**：
- `frontend/components/CharacterConstructorModal.tsx` (第465-520行)

### 2. 手动上传头像

**位置**：角色编辑器 → 头像输入框 → "上传" 按钮

**流程**：
1. 用户点击"上传"按钮，选择本地图片
2. 图片读取为base64并显示预览
3. 自动缓存到本地IndexedDB
4. 自动上传到服务器（使用 `character/user` 分类）
5. 上传成功后使用服务器URL，失败时使用本地缓存

**代码位置**：
- `frontend/components/CharacterConstructorModal.tsx` (第226-275行)

### 3. 选择预置头像

**位置**：角色编辑器 → 头像输入框 → "🖼️" 按钮

**流程**：
1. 用户点击"🖼️"按钮，打开资源选择器
2. 从系统预置资源中选择头像
3. 直接使用预置资源的URL（不缓存，不重新上传）

**代码位置**：
- `frontend/components/CharacterConstructorModal.tsx` (第836-856行)

## 本地缓存

### 缓存策略

- **用户生成/上传的头像**：自动缓存到IndexedDB
- **系统预置头像**：不缓存，直接使用服务器URL
- **占位符URL**（如 `picsum.photos`）：不缓存，会被自动清除

### 缓存服务

**位置**：`frontend/utils/imageCache.ts`

**功能**：
- 使用IndexedDB存储图片数据
- 生成blob URL供前端使用
- 自动识别预置头像和占位符
- 支持清理过期缓存（默认保留30天）

## 后端存储服务

### ImageStorageService

**位置**：`backend/src/main/java/com/heartsphere/service/ImageStorageService.java`

**功能**：
- 根据category参数创建不同的文件夹结构
- 支持文件上传和Base64上传
- 自动生成唯一文件名（UUID）
- 按年月组织文件

### 目录结构示例

```
uploads/images/
├── character/              # 系统预置头像（如果使用）
│   └── 2024/
│       └── 12/
│           └── {uuid}.png
└── character/
    └── user/              # 用户上传/生成的头像
        └── 2024/
            └── 12/
                └── {uuid}.png
```

## API接口

### 上传图片

**端点**：`POST /api/images/upload`

**参数**：
- `file`: 图片文件（MultipartFile）
- `category`: 图片分类（用户上传使用 `character/user`）

**响应**：
```json
{
  "success": true,
  "url": "/api/images/files/character/user/2024/12/{uuid}.png",
  "message": "图片上传成功"
}
```

### 上传Base64图片

**端点**：`POST /api/images/upload-base64`

**参数**：
- `base64`: Base64编码的图片数据
- `category`: 图片分类（用户上传使用 `character/user`）

## 注意事项

1. **文件夹分离**：用户上传的头像和系统预置头像使用不同的文件夹，便于管理和清理
2. **本地缓存**：用户生成/上传的头像会自动缓存到本地，即使服务器URL失效也能正常显示
3. **占位符处理**：`picsum.photos` 等占位符URL会被自动识别并清除，要求用户上传真实头像
4. **上传失败处理**：如果上传失败，系统会使用本地缓存的blob URL，确保用户体验
5. **预置资源**：系统预置的头像来自 `system_resources` 表，不需要重新上传

## 未来优化

1. **批量上传**：支持一次上传多个头像
2. **图片压缩**：上传前自动压缩图片以节省存储空间
3. **图片裁剪**：支持在编辑器中裁剪头像
4. **图片格式转换**：自动转换为WebP格式以优化加载速度
5. **CDN支持**：将图片存储到CDN以提高访问速度

