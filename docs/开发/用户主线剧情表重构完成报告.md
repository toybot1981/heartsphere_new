# 用户主线剧情表重构完成报告

## 完成时间
2025-12-18

## 问题描述
用户主线故事（mainStory）原本存储在 `characters` 表中，通过 `role = '主线剧情'` 来标识。需要将其分离到专门的用户主线剧情表中，与管理后台的预置主线剧情表结构保持一致。

## 完成的工作

### 1. 数据库表设计

#### 新建表：`user_main_stories`
- **实体类**：`com.heartsphere.entity.UserMainStory`
- **表结构**：参考 `system_main_stories` 表，增加用户映射
- **关键字段**：
  - `id`: 主键
  - `user_id`: 用户ID（外键关联 users 表）
  - `era_id`: 场景ID（外键关联 eras 表）
  - `name`: 主线剧情名称
  - `description`: 描述
  - `role`: 角色定位（默认"叙事者"）
  - `bio`: 简介
  - `avatar_url`: 头像URL
  - `background_url`: 背景图URL
  - `first_message`: 第一条消息
  - `system_instruction`: 系统指令
  - `theme_color`: 主题颜色
  - `color_accent`: 强调色
  - `voice_name`: 语音名称
  - `mbti`: MBTI类型
  - `tags`: 标签
  - `speech_style`: 说话风格
  - `catchphrases`: 口头禅
  - `secrets`: 秘密
  - `motivations`: 动机
  - `relationships`: 关系
  - `is_deleted`: 软删除标记
  - `deleted_at`: 删除时间
  - `created_at`: 创建时间
  - `updated_at`: 更新时间

### 2. 后端实现

#### 2.1 实体类
- **文件**：`backend/src/main/java/com/heartsphere/entity/UserMainStory.java`
- **功能**：定义用户主线剧情实体，包含所有必要字段和关联关系

#### 2.2 Repository
- **文件**：`backend/src/main/java/com/heartsphere/repository/UserMainStoryRepository.java`
- **功能**：提供数据访问方法
  - `findByEraId`: 根据场景ID查找
  - `findByUserIdAndEraIdAndIsDeletedFalse`: 根据用户ID和场景ID查找（未删除）
  - `findByUserIdAndIsDeletedFalse`: 根据用户ID查找所有（未删除）
  - `findByEraIdAndIsDeletedFalse`: 根据场景ID查找所有（未删除）

#### 2.3 Controller
- **文件**：`backend/src/main/java/com/heartsphere/controller/UserMainStoryController.java`
- **端点**：
  - `GET /api/user-main-stories` - 获取当前用户的所有主线剧情
  - `GET /api/user-main-stories/era/{eraId}` - 根据场景ID获取主线剧情
  - `GET /api/user-main-stories/{id}` - 根据ID获取主线剧情
  - `POST /api/user-main-stories` - 创建主线剧情
  - `PUT /api/user-main-stories/{id}` - 更新主线剧情
  - `DELETE /api/user-main-stories/{id}` - 删除主线剧情（软删除）

### 3. 前端实现

#### 3.1 API接口
- **文件**：`frontend/services/api.ts`
- **新增**：`userMainStoryApi` 对象
  - `getAll(token)`: 获取所有用户主线剧情
  - `getByEraId(eraId, token)`: 根据场景ID获取
  - `getById(id, token)`: 根据ID获取
  - `create(data, token)`: 创建主线剧情
  - `update(id, data, token)`: 更新主线剧情
  - `delete(id, token)`: 删除主线剧情

#### 3.2 初始化过程修改
- **文件**：`frontend/components/InitializationWizard.tsx`
- **修改**：
  - 导入 `userMainStoryApi`
  - 将创建主线剧情的逻辑从 `characterApi.createCharacter` 改为 `userMainStoryApi.create`
  - 不再创建 `role = '主线剧情'` 的角色，而是创建专门的用户主线剧情记录

#### 3.3 数据加载修改
- **文件**：`frontend/App.tsx`
- **修改**：
  - 在 `loadAndSyncWorldData` 函数中添加加载用户主线剧情的逻辑
  - 按场景分组用户主线剧情
  - 在创建 `WorldScene` 对象时，从用户主线剧情表获取 `mainStory`，而不是使用第一个角色
  - 在初始化向导完成后的数据同步中也添加了用户主线剧情的加载逻辑

### 4. 数据迁移说明

**注意**：现有数据库中可能已有 `role = '主线剧情'` 的角色数据。需要：
1. 将这些角色数据迁移到 `user_main_stories` 表
2. 从 `characters` 表中删除这些记录（或标记为已迁移）

**迁移SQL示例**：
```sql
-- 将现有的主线剧情角色迁移到新表
INSERT INTO user_main_stories (
    user_id, era_id, name, description, role, bio, 
    avatar_url, background_url, theme_color, color_accent,
    first_message, system_instruction, voice_name, mbti,
    tags, speech_style, catchphrases, secrets, motivations, relationships,
    is_deleted, created_at, updated_at
)
SELECT 
    user_id, era_id, name, description, '叙事者', bio,
    avatar_url, background_url, theme_color, color_accent,
    first_message, system_instruction, voice_name, mbti,
    tags, speech_style, catchphrases, secrets, motivations, relationships,
    is_deleted, created_at, updated_at
FROM characters
WHERE role = '主线剧情' AND is_deleted = false;

-- 删除已迁移的角色（或标记为已迁移）
UPDATE characters 
SET is_deleted = true, deleted_at = NOW()
WHERE role = '主线剧情' AND is_deleted = false;
```

## 修改的文件清单

### 后端
1. `backend/src/main/java/com/heartsphere/entity/UserMainStory.java` (新增)
2. `backend/src/main/java/com/heartsphere/repository/UserMainStoryRepository.java` (新增)
3. `backend/src/main/java/com/heartsphere/controller/UserMainStoryController.java` (新增)

### 前端
1. `frontend/services/api.ts`
   - 新增 `userMainStoryApi` 对象

2. `frontend/components/InitializationWizard.tsx`
   - 修改初始化过程，使用 `userMainStoryApi.create` 创建主线剧情

3. `frontend/App.tsx`
   - 修改数据加载逻辑，从用户主线剧情表获取主线故事
   - 在初始化向导完成后的数据同步中也添加了用户主线剧情的加载

## 测试建议

1. **创建主线剧情测试**：
   - 注册新用户并完成初始化
   - 验证主线剧情是否正确创建到 `user_main_stories` 表
   - 验证不再在 `characters` 表中创建 `role = '主线剧情'` 的角色

2. **显示主线剧情测试**：
   - 登录用户，进入场景选择页面
   - 验证主线剧情是否正确显示在角色上方
   - 验证主线剧情的所有字段是否正确显示

3. **数据迁移测试**：
   - 对现有数据进行迁移
   - 验证迁移后的数据完整性
   - 验证前端显示是否正常

## 注意事项

1. **数据一致性**：确保每个场景只有一个主线剧情（在Controller中已添加检查）
2. **权限控制**：所有API端点都需要用户认证，并且只能操作当前用户自己的主线剧情
3. **软删除**：使用软删除机制，保留历史数据
4. **向后兼容**：如果前端仍在使用旧的逻辑（从characters表获取），需要确保数据迁移完成后再切换

## 后续工作

1. 执行数据迁移脚本
2. 测试所有功能点
3. 清理旧的代码逻辑（如果不再需要）
4. 更新API文档




