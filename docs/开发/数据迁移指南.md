# 用户主线剧情表数据迁移指南

## 迁移目标
将现有的 `characters` 表中 `role = '主线剧情'` 的角色数据迁移到新的 `user_main_stories` 表中。

## 迁移步骤

### 1. 备份数据库（重要！）
```bash
# 使用 mysqldump 备份
mysqldump -u [用户名] -p [数据库名] > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 2. 检查需要迁移的数据
```sql
-- 查看需要迁移的数据统计
SELECT 
    COUNT(*) as total_count,
    COUNT(DISTINCT user_id) as user_count,
    COUNT(DISTINCT era_id) as era_count
FROM characters
WHERE role = '主线剧情' AND is_deleted = false;
```

### 3. 执行迁移脚本
```bash
# 方式1：使用 MySQL 命令行
mysql -u [用户名] -p [数据库名] < backend/migration_user_main_stories.sql

# 方式2：在 MySQL 客户端中执行
# 打开 migration_user_main_stories.sql 文件，复制内容到 MySQL 客户端执行
```

### 4. 验证迁移结果
迁移脚本会自动执行验证步骤，检查：
- 迁移后的数据统计
- 清理后的角色统计
- 数据一致性检查

### 5. 手动验证（可选）
```sql
-- 检查某个用户的主线剧情
SELECT * FROM user_main_stories 
WHERE user_id = [用户ID] AND is_deleted = false;

-- 检查某个场景的主线剧情
SELECT * FROM user_main_stories 
WHERE era_id = [场景ID] AND is_deleted = false;

-- 确认没有遗漏的角色
SELECT * FROM characters 
WHERE role = '主线剧情' AND is_deleted = false;
-- 应该返回空结果
```

## 注意事项

1. **数据唯一性**：如果某个场景有多个主线剧情角色，迁移脚本会只保留第一个（按ID排序）
2. **软删除**：迁移后的角色会被标记为已删除（`is_deleted = true`），而不是物理删除
3. **时间戳**：迁移会保留原始的 `created_at` 和 `updated_at` 时间戳
4. **回滚方案**：如果需要回滚，可以从备份中恢复，或者：
   ```sql
   -- 恢复角色数据（如果需要）
   UPDATE characters 
   SET is_deleted = false, deleted_at = NULL 
   WHERE role = '主线剧情' AND deleted_at IS NOT NULL;
   ```

## 迁移后测试

1. **API测试**：
   ```bash
   # 获取用户主线剧情（需要认证）
   curl -H "Authorization: Bearer [token]" \
        http://localhost:8081/api/user-main-stories
   
   # 根据场景ID获取主线剧情
   curl -H "Authorization: Bearer [token]" \
        http://localhost:8081/api/user-main-stories/era/[eraId]
   ```

2. **前端测试**：
   - 登录用户
   - 进入场景选择页面
   - 验证主线剧情是否正确显示在角色上方
   - 验证主线剧情的所有信息是否正确

3. **功能测试**：
   - 创建新用户并完成初始化
   - 验证新创建的主线剧情是否正确存储到 `user_main_stories` 表
   - 验证不再在 `characters` 表中创建 `role = '主线剧情'` 的角色

## 故障排查

如果迁移过程中遇到问题：

1. **主键冲突**：检查 `user_main_stories` 表是否已有数据
2. **外键约束**：确保 `user_id` 和 `era_id` 对应的记录存在
3. **数据不一致**：检查迁移前后的数据统计是否匹配

## 联系支持
如有问题，请检查：
- 数据库日志
- 后端应用日志
- 迁移脚本执行日志




