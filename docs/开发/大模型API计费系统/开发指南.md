# 大模型API计费系统 - 开发指南

## 快速开始

### 1. 数据库初始化

执行数据库迁移脚本：

```bash
# 执行SQL脚本
mysql -u username -p database_name < backend/src/main/resources/db/migration/create_billing_tables.sql
```

或通过数据库管理工具执行 `backend/src/main/resources/db/migration/create_billing_tables.sql` 文件。

### 2. 初始化基础数据

#### 2.1 创建AI提供商

```java
@Autowired
private AIProviderRepository providerRepository;

AIProvider provider = new AIProvider();
provider.setName("dashscope");
provider.setDisplayName("阿里云通义千问");
provider.setEnabled(true);
providerRepository.save(provider);
```

#### 2.2 创建AI模型

```java
@Autowired
private AIModelRepository modelRepository;

AIModel model = new AIModel();
model.setProviderId(provider.getId());
model.setModelCode("qwen-max");
model.setModelName("通义千问-Max");
model.setModelType("text");
model.setEnabled(true);
modelRepository.save(model);
```

#### 2.3 配置资费

```java
@Autowired
private AIModelPricingRepository pricingRepository;

// 输入Token资费
AIModelPricing inputPricing = new AIModelPricing();
inputPricing.setModelId(model.getId());
inputPricing.setPricingType("input_token");
inputPricing.setUnitPrice(new BigDecimal("0.002")); // 每千Token 0.002元
inputPricing.setUnit("per_1k_tokens");
inputPricing.setMinChargeUnit(BigDecimal.ZERO);
inputPricing.setEffectiveDate(LocalDateTime.now());
inputPricing.setIsActive(true);
pricingRepository.save(inputPricing);

// 输出Token资费
AIModelPricing outputPricing = new AIModelPricing();
outputPricing.setModelId(model.getId());
outputPricing.setPricingType("output_token");
outputPricing.setUnitPrice(new BigDecimal("0.008")); // 每千Token 0.008元
outputPricing.setUnit("per_1k_tokens");
outputPricing.setMinChargeUnit(BigDecimal.ZERO);
outputPricing.setEffectiveDate(LocalDateTime.now());
outputPricing.setIsActive(true);
pricingRepository.save(outputPricing);
```

### 3. 配置用户配额

用户配额可以通过以下方式分配：

#### 3.1 会员订阅时分配

```java
@Autowired
private TokenQuotaService tokenQuotaService;

// 当用户开通会员时
Long planId = membership.getPlanId();
SubscriptionPlan plan = planRepository.findById(planId).orElseThrow();

// 分配文本Token配额
if (plan.getTextTokenQuota() > 0) {
    tokenQuotaService.grantQuota(userId, "text_token", plan.getTextTokenQuota().longValue(),
        "membership", planId, "会员开通赠送");
}

// 分配图片配额
if (plan.getImageGenerationQuota() > 0) {
    tokenQuotaService.grantQuota(userId, "image", plan.getImageGenerationQuota().longValue(),
        "membership", planId, "会员开通赠送");
}
```

#### 3.2 Token包购买

```java
// 当用户购买Token包后
TokenPackage tokenPackage = tokenPackageRepository.findById(packageId).orElseThrow();

tokenQuotaService.grantQuota(userId, tokenPackage.getQuotaType(), tokenPackage.getAmount(),
    "purchase", orderId, "Token包购买");
```

#### 3.3 管理员授予

```java
// 管理员手动分配配额
tokenQuotaService.grantQuota(userId, "text_token", 100000L,
    "admin_grant", null, "管理员手动分配");
```

## 集成到现有系统

### 1. 会员服务集成

在会员服务中，当用户开通会员时，自动分配配额：

```java
@Service
public class MembershipService {
    
    @Autowired
    private TokenQuotaService tokenQuotaService;
    
    @Autowired
    private SubscriptionPlanRepository planRepository;
    
    @Transactional
    public Membership activateMembership(Long userId, Long planId) {
        // ... 激活会员逻辑 ...
        
        // 分配配额
        SubscriptionPlan plan = planRepository.findById(planId).orElseThrow();
        if (plan.getTextTokenQuota() != null && plan.getTextTokenQuota() > 0) {
            tokenQuotaService.grantQuota(userId, "text_token", 
                plan.getTextTokenQuota().longValue(), 
                "membership", planId, "会员开通赠送");
        }
        
        // ... 其他逻辑 ...
        
        return membership;
    }
}
```

### 2. 支付服务集成

在支付服务中，当Token包购买成功后，分配配额：

```java
@Service
public class PaymentService {
    
    @Autowired
    private TokenQuotaService tokenQuotaService;
    
    @Transactional
    public void processTokenPackagePayment(Long userId, Long packageId, Long orderId) {
        // ... 支付处理逻辑 ...
        
        TokenPackage tokenPackage = tokenPackageRepository.findById(packageId).orElseThrow();
        
        // 分配配额
        Long amount = tokenPackage.getAmount();
        if (tokenPackage.getBonusAmount() != null && tokenPackage.getBonusAmount() > 0) {
            amount += tokenPackage.getBonusAmount(); // 包含赠送
        }
        
        tokenQuotaService.grantQuota(userId, tokenPackage.getQuotaType(), amount,
            "purchase", orderId, "Token包购买");
    }
}
```

### 3. 月度配额重置

创建定时任务，每月1日重置月度配额：

```java
@Component
public class MonthlyQuotaResetTask {
    
    @Autowired
    private TokenQuotaService tokenQuotaService;
    
    @Autowired
    private MembershipRepository membershipRepository;
    
    @Autowired
    private SubscriptionPlanRepository planRepository;
    
    @Scheduled(cron = "0 0 0 1 * ?") // 每月1日0点执行
    public void resetMonthlyQuota() {
        LocalDate today = LocalDate.now();
        
        // 获取所有活跃会员
        List<Membership> activeMemberships = membershipRepository.findByStatus("active");
        
        for (Membership membership : activeMemberships) {
            try {
                SubscriptionPlan plan = planRepository.findById(membership.getPlanId()).orElse(null);
                if (plan == null) continue;
                
                UserTokenQuota quota = tokenQuotaService.getUserQuota(membership.getUserId());
                
                // 重置月度配额
                if (plan.getTextTokenQuota() != null) {
                    quota.setTextTokenMonthlyQuota(plan.getTextTokenQuota().longValue());
                    quota.setTextTokenMonthlyUsed(0L);
                }
                
                if (plan.getImageGenerationQuota() != null) {
                    quota.setImageQuotaMonthly(plan.getImageGenerationQuota());
                    quota.setImageQuotaMonthlyUsed(0);
                }
                
                // ... 其他配额类型 ...
                
                quota.setLastResetDate(today);
                tokenQuotaService.updateQuota(quota);
                
            } catch (Exception e) {
                log.error("重置用户配额失败: userId={}", membership.getUserId(), e);
            }
        }
    }
}
```

## 测试

### 1. 单元测试示例

```java
@SpringBootTest
@Transactional
class TokenQuotaServiceTest {
    
    @Autowired
    private TokenQuotaService tokenQuotaService;
    
    @Test
    void testGrantQuota() {
        Long userId = 1L;
        
        // 分配配额
        tokenQuotaService.grantQuota(userId, "text_token", 10000L, 
            "test", null, "测试分配");
        
        // 验证配额
        UserTokenQuota quota = tokenQuotaService.getUserQuota(userId);
        assertEquals(10000L, quota.getTextTokenTotal());
    }
    
    @Test
    void testConsumeQuota() {
        Long userId = 1L;
        
        // 先分配配额
        tokenQuotaService.grantQuota(userId, "text_token", 10000L, 
            "test", null, "测试分配");
        
        // 扣除配额
        boolean success = tokenQuotaService.consumeQuota(userId, "text_token", 1000L);
        assertTrue(success);
        
        // 验证配额
        UserTokenQuota quota = tokenQuotaService.getUserQuota(userId);
        assertEquals(9000L, quota.getTextTokenTotal() - quota.getTextTokenUsed());
    }
    
    @Test
    void testInsufficientQuota() {
        Long userId = 1L;
        
        // 分配少量配额
        tokenQuotaService.grantQuota(userId, "text_token", 1000L, 
            "test", null, "测试分配");
        
        // 尝试扣除更多配额
        boolean success = tokenQuotaService.consumeQuota(userId, "text_token", 2000L);
        assertFalse(success);
    }
}
```

### 2. 集成测试示例

```java
@SpringBootTest
@AutoConfigureMockMvc
class AIBillingAspectTest {
    
    @Autowired
    private AIService aiService;
    
    @Autowired
    private TokenQuotaService tokenQuotaService;
    
    @Test
    void testTextGenerationWithBilling() {
        Long userId = 1L;
        
        // 分配配额
        tokenQuotaService.grantQuota(userId, "text_token", 10000L, 
            "test", null, "测试分配");
        
        // 准备请求
        TextGenerationRequest request = new TextGenerationRequest();
        request.setProvider("dashscope");
        request.setModel("qwen-max");
        request.setPrompt("你好");
        
        // 调用AI服务（应该被AOP拦截并计费）
        TextGenerationResponse response = aiService.generateText(userId, request);
        
        // 验证响应
        assertNotNull(response);
        
        // 验证配额被扣除
        UserTokenQuota quota = tokenQuotaService.getUserQuota(userId);
        assertTrue(quota.getTextTokenUsed() > 0);
    }
}
```

## 常见问题

### Q1: 如果模型未配置资费，会怎么样？

A: 如果模型未在计费系统中配置，调用仍然会执行，但不会计费。AOP切面会记录警告日志并跳过计费。

### Q2: 如何处理并发扣费？

A: 使用数据库悲观锁（`PESSIMISTIC_WRITE`）防止并发超扣。`consumeQuota`方法会自动加锁。

### Q3: 流式调用如何计费？

A: 流式调用会在最后完成的响应中进行计费。AOP切面会包装StreamResponseHandler，在done=true时进行计费。

### Q4: 如何查看用户的使用记录？

A: 使用`AIUsageRecordRepository`查询`ai_usage_records`表。

### Q5: 如何统计成本？

A: 使用`AICostDailyRepository`查询`ai_cost_daily`表，或使用`AIUsageRecordRepository`的聚合查询方法。

## 下一步

- 参考 [README.md](./README.md) 了解整体架构
- 参考 [数据库设计.md](./数据库设计.md) 了解数据库结构
- 参考 [API接口说明.md](./API接口说明.md) 了解Service接口
- 参考 [需求分析.md](./需求分析.md) 了解业务需求

