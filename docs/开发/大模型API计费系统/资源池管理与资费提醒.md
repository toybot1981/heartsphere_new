# 资源池管理与资费提醒系统

## 概述

资源池管理系统用于监控和管理各AI供应商的资源池余额，当余额不足时自动提醒并禁用相关模型，确保服务的可持续性。

## 核心功能

### 1. 资源池管理
- **实时余额监控**：实时计算每个供应商的资源池使用情况
- **充值管理**：支持手动充值和记录充值历史
- **余额统计**：显示总余额、已使用金额、可用余额

### 2. 资费提醒
- **自动监控**：每5分钟自动检查资源池水位
- **低余额提醒**：当余额低于10%时自动创建提醒
- **余额不足提醒**：当余额为0或负数时创建紧急提醒
- **提醒管理**：支持查看和标记提醒为已解决

### 3. 模型状态自动管理
- **自动禁用**：当资源池余额不足（<=0）时，自动禁用该供应商下的所有模型
- **状态标识**：模型状态会显示为"资费不足，暂不可用"

## 数据库表结构

### 1. provider_resource_pool - 资源池表
存储每个供应商的资源池信息。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| provider_id | BIGINT | 提供商ID（唯一） |
| total_balance | DECIMAL(15,6) | 总余额（元） |
| used_amount | DECIMAL(15,6) | 已使用金额（元） |
| available_balance | DECIMAL(15,6) | 可用余额（元） |
| warning_threshold | DECIMAL(5,2) | 告警阈值（百分比，默认10%） |
| is_low_balance | BOOLEAN | 是否余额不足 |
| last_recharge_date | DATETIME | 最后充值日期 |
| last_check_date | DATETIME | 最后检查日期 |

### 2. resource_pool_recharge - 充值记录表
记录所有充值操作。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| provider_id | BIGINT | 提供商ID |
| recharge_amount | DECIMAL(15,6) | 充值金额（元） |
| balance_before | DECIMAL(15,6) | 充值前余额 |
| balance_after | DECIMAL(15,6) | 充值后余额 |
| recharge_type | VARCHAR(50) | 充值类型：manual, auto, refund |
| operator_id | BIGINT | 操作员ID |
| remark | VARCHAR(500) | 备注 |

### 3. billing_alert - 资费提醒表
记录所有资费提醒。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| provider_id | BIGINT | 提供商ID |
| alert_type | VARCHAR(50) | 提醒类型：low_balance, insufficient_balance |
| alert_level | VARCHAR(20) | 提醒级别：warning, critical |
| balance_percentage | DECIMAL(5,2) | 余额百分比 |
| available_balance | DECIMAL(15,6) | 可用余额 |
| message | TEXT | 提醒消息 |
| is_resolved | BOOLEAN | 是否已处理 |
| resolved_at | DATETIME | 处理时间 |
| resolved_by | BIGINT | 处理人ID |

## 核心服务

### 1. ResourcePoolService - 资源池管理服务
- `getOrCreatePool(providerId)` - 获取或创建资源池
- `recharge(providerId, amount, operatorId, remark)` - 充值资源池
- `deductBalance(providerId, amount)` - 扣除余额（使用记录时调用）
- `calculateBalancePercentage(pool)` - 计算余额百分比
- `checkBalanceStatus(pool)` - 检查余额状态

### 2. BillingAlertService - 资费提醒服务
- `createLowBalanceAlert(pool, percentage)` - 创建低余额提醒
- `resolveAlert(alertId, resolvedBy)` - 解决提醒
- `getUnresolvedAlerts()` - 获取未解决的提醒列表

### 3. BillingMonitorService - 资费监控服务
- `checkResourcePoolBalance()` - 定时检查资源池水位（每5分钟）
- `updateModelStatus(providerId, pool, percentage)` - 更新模型状态
- `manualCheck()` - 手动触发检查

## 工作流程

### 1. 使用记录扣费流程
```
用户调用AI服务
  ↓
AIBillingAspect拦截
  ↓
计算费用
  ↓
扣除用户配额
  ↓
记录使用记录
  ↓
扣除资源池余额（ResourcePoolService.deductBalance）
```

### 2. 定时监控流程
```
定时任务（每5分钟）
  ↓
遍历所有提供商
  ↓
检查资源池余额
  ↓
计算余额百分比
  ↓
如果 < 10%：创建提醒
  ↓
如果 <= 0%：禁用该提供商下的所有模型
```

### 3. 充值流程
```
管理员在后台充值
  ↓
ResourcePoolService.recharge
  ↓
更新资源池余额
  ↓
记录充值记录
  ↓
如果余额充足：重置isLowBalance状态
```

## API接口

### 资源池管理
- `GET /api/admin/billing/resource-pool` - 获取所有资源池状态
- `GET /api/admin/billing/resource-pool/providers/{providerId}` - 获取指定提供商的资源池
- `POST /api/admin/billing/resource-pool/providers/{providerId}/recharge` - 充值资源池
- `GET /api/admin/billing/resource-pool/providers/{providerId}/recharges` - 获取充值记录

### 资费提醒
- `GET /api/admin/billing/resource-pool/alerts` - 获取提醒列表
- `POST /api/admin/billing/resource-pool/alerts/{alertId}/resolve` - 解决提醒
- `POST /api/admin/billing/resource-pool/check` - 手动触发检查

## 前端管理界面

### 资源池管理页面
- 显示所有供应商的资源池状态
- 实时显示余额百分比和可用余额
- 余额进度条可视化
- 支持在线充值
- 显示资费提醒列表
- 支持手动触发检查

### 功能特点
- **实时监控**：自动刷新资源池状态
- **可视化展示**：进度条显示余额百分比
- **颜色标识**：
  - 绿色：余额充足（>10%）
  - 黄色：余额不足（0-10%）
  - 红色：余额耗尽（<=0%）
- **提醒管理**：顶部显示未解决的提醒，支持标记已解决

## 配置说明

### 告警阈值
默认告警阈值为10%，可在资源池表中为每个供应商单独配置。

### 定时任务频率
默认每5分钟检查一次，可在 `BillingMonitorService` 中修改 `@Scheduled` 注解调整。

## 注意事项

1. **余额计算**：余额 = 总余额 - 已使用金额
2. **模型禁用**：当余额为0或负数时，会自动禁用该供应商下的所有模型
3. **充值后**：充值后会自动重置 `isLowBalance` 状态
4. **提醒去重**：如果已有未解决的提醒，不会重复创建
5. **事务安全**：所有余额操作都在事务中执行，确保数据一致性

## 初始化

系统启动时会自动为每个提供商创建资源池记录。初始余额为0，需要管理员手动充值。

## 使用建议

1. **定期检查**：建议每天检查一次资源池状态
2. **及时充值**：当收到低余额提醒时，应及时充值
3. **监控模型状态**：关注模型是否因余额不足而被禁用
4. **充值记录**：保留充值记录，便于财务对账

