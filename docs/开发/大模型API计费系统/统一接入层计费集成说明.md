# 统一接入层计费集成说明

## 概述

计费能力已完全集成到统一接入层（`AIServiceImpl`），所有AI服务调用都会自动进行配额检查、费用计算、资源池扣费和使用记录。

## 集成方式

### 1. AOP切面集成（非侵入式）

使用Spring AOP切面（`AIBillingAspect`）拦截所有标注了`@RequiresTokenQuota`的方法，实现非侵入式的计费集成。

**优点**：
- 不修改业务代码
- 统一管理计费逻辑
- 易于维护和扩展

### 2. 注解配置

在`AIServiceImpl`的所有AI服务方法上添加了`@RequiresTokenQuota`注解：

```java
@RequiresTokenQuota(quotaType = "text_token", usageType = "text_generation")
public TextGenerationResponse generateText(Long userId, TextGenerationRequest request)

@RequiresTokenQuota(quotaType = "text_token", usageType = "text_generation")
public void generateTextStream(Long userId, TextGenerationRequest request, ...)

@RequiresTokenQuota(quotaType = "image", usageType = "image_generation")
public ImageGenerationResponse generateImage(Long userId, ImageGenerationRequest request)

@RequiresTokenQuota(quotaType = "audio", usageType = "audio_tts")
public AudioResponse textToSpeech(Long userId, AudioRequest request)

@RequiresTokenQuota(quotaType = "audio", usageType = "audio_stt")
public AudioResponse speechToText(Long userId, AudioRequest request)

@RequiresTokenQuota(quotaType = "video", usageType = "video_generation")
public VideoGenerationResponse generateVideo(Long userId, VideoGenerationRequest request)
```

## 计费流程

### 1. 请求拦截
```
用户调用AI服务
  ↓
AIServiceController接收请求
  ↓
从Authentication获取userId
  ↓
调用AIServiceImpl方法
  ↓
AIBillingAspect拦截（@RequiresTokenQuota）
```

### 2. 资源池余额检查
```
提取providerId
  ↓
检查资源池余额是否充足
  ↓
如果余额<=0，抛出QuotaInsufficientException（阻止调用）
```

### 3. 配额检查
```
预估使用量（用于配额检查）
  ↓
检查用户配额是否充足
  ↓
如果不足，抛出QuotaInsufficientException
```

### 3. 执行服务
```
配额充足，执行AI服务调用
  ↓
适配器调用AI提供商API
  ↓
返回响应结果
```

### 4. 计费处理
```
从响应中提取实际使用量
  ↓
计算费用（基于模型和实际使用量）
  ↓
扣除用户配额
  ↓
扣除资源池余额（如果成功）
  ↓
记录使用记录
```

## 资源池管理

### 自动扣费
每次AI服务调用成功后，系统会自动从对应提供商的资源池中扣除费用。

### 余额检查机制
系统在**服务调用前**和**服务调用后**都会检查资源池余额：

1. **调用前检查**（在`AIBillingAspect`中）：
   - 如果资源池余额<=0，直接阻止服务调用
   - 抛出`QuotaInsufficientException`异常
   - 避免无效调用和资源浪费

2. **调用后扣费**：
   - 服务调用成功后，从资源池扣除实际费用
   - 如果扣除后余额为0，下次调用会被阻止

### 余额不足处理
1. **定时检查**：每5分钟自动检查资源池水位
2. **低余额提醒**：余额低于10%时自动创建提醒
3. **自动禁用**：余额为0或负数时，自动禁用该提供商下的所有模型
4. **模型状态**：禁用后的模型在管理后台显示为"资费不足，暂不可用"

### 余额检查时机
- **调用前检查**：每次AI服务调用前自动检查（在切面中）
- **定时检查**：`BillingMonitorService.checkResourcePoolBalance()` 每5分钟执行
- **手动检查**：管理员可在后台手动触发检查
- **实时扣费**：每次AI调用成功后立即扣除

## 配额类型映射

| AI服务类型 | quotaType | usageType |
|-----------|-----------|-----------|
| 文本生成 | text_token | text_generation |
| 图片生成 | image | image_generation |
| 文本转语音 | audio | audio_tts |
| 语音转文本 | audio | audio_stt |
| 视频生成 | video | video_generation |

## 异常处理

### QuotaInsufficientException
当用户配额不足时，会抛出`QuotaInsufficientException`异常。

**建议**：在控制器层添加全局异常处理器，统一处理配额不足的情况：

```java
@ExceptionHandler(QuotaInsufficientException.class)
public ResponseEntity<ApiResponse<?>> handleQuotaInsufficient(QuotaInsufficientException e) {
    return ResponseEntity.status(HttpStatus.PAYMENT_REQUIRED)
            .body(ApiResponse.error(402, "配额不足: " + e.getMessage()));
}
```

## 使用记录

每次AI服务调用都会记录详细的使用信息：

- **用户ID**：调用服务的用户
- **提供商ID**：使用的AI提供商
- **模型ID**：使用的AI模型
- **使用类型**：text_generation, image_generation等
- **使用量**：实际使用的tokens、图片数量等
- **费用**：本次调用产生的费用
- **状态**：success或failed

## 配置要求

### 1. 模型配置
确保所有使用的模型都在`ai_models`表中配置，并且：
- 模型已启用（`enabled = true`）
- 模型关联的提供商已启用
- 模型有对应的资费配置（`ai_model_pricing`）

### 2. 资源池配置
确保每个提供商都有资源池记录：
- 系统启动时自动创建
- 需要管理员手动充值
- 余额不足时会自动禁用模型

### 3. 用户配额
确保用户有足够的配额：
- 系统会自动创建用户配额记录
- 可以通过管理后台或API授予配额
- 配额不足时会阻止服务调用

## 监控和统计

### 1. 使用记录查询
- 管理后台：`/api/admin/billing/usage/records`
- 支持按用户、提供商、模型、时间范围查询

### 2. 成本统计
- 管理后台：`/api/admin/billing/cost/daily`
- 支持按日期、提供商、模型统计

### 3. 资源池监控
- 管理后台：`/api/admin/billing/resource-pool`
- 实时显示各提供商资源池状态
- 支持手动检查和充值

## 注意事项

1. **userId必须有效**：所有AI服务调用都需要有效的userId，从Authentication中获取
2. **模型必须配置**：未配置的模型不会计费，但仍然允许调用
3. **资源池余额**：余额不足时模型会被自动禁用，需要及时充值
4. **配额检查**：配额检查在服务调用前进行，避免无效调用
5. **异常处理**：建议添加全局异常处理器，统一处理计费相关异常

## 测试建议

1. **配额测试**：测试配额不足时的行为
2. **资源池测试**：测试资源池余额不足时的行为
3. **计费准确性**：验证费用计算的准确性
4. **并发测试**：测试并发调用时的配额扣减准确性
5. **异常测试**：测试各种异常情况下的计费行为

