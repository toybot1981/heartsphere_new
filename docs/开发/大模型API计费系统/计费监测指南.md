# 计费监测指南

## 监测入口

### 前端管理后台

**路径**：管理后台 → **计费管理** 💰

在管理后台左侧导航栏中，点击"计费管理"即可进入计费监测和管理界面。

## 监测功能模块

### 1. 📊 使用记录（UsageRecordsView）

**位置**：计费管理 → **使用记录**

**功能**：
- 查看所有AI服务调用的详细记录
- 支持多维度筛选：
  - 按用户ID筛选
  - 按提供商筛选
  - 按模型筛选
  - 按时间范围筛选（开始日期、结束日期）
- 显示信息：
  - 用户ID
  - 提供商名称
  - 模型名称
  - 使用类型（文本生成、图片生成等）
  - 输入/输出Token数
  - 费用金额
  - 状态（成功/失败）
  - 调用时间

**用途**：
- 追踪具体用户的AI使用情况
- 分析某个模型的使用频率
- 查看失败调用的原因
- 审计和问题排查

### 2. 📈 成本统计（CostStatisticsView）

**位置**：计费管理 → **成本统计**

**功能**：
- 查看每日成本统计汇总
- 支持筛选：
  - 按时间范围（默认最近30天）
  - 按提供商筛选
  - 按模型筛选
- 显示信息：
  - 统计日期
  - 提供商名称
  - 模型名称
  - 使用类型
  - 总使用量
  - 总成本
  - 调用次数

**用途**：
- 分析成本趋势
- 对比不同提供商的成本
- 评估模型使用成本
- 制定预算和优化策略

### 3. 💧 资源池管理（ResourcePoolManagement）

**位置**：计费管理 → **资源池管理**

**功能**：
- **实时监控**：查看各供应商资源池的实时状态
  - 总余额
  - 已使用金额
  - 可用余额
  - 余额百分比（可视化进度条）
  - 余额状态（充足/不足/耗尽）
- **资费提醒**：顶部显示未解决的余额提醒
  - 提醒类型（低余额/余额不足）
  - 提醒级别（警告/严重）
  - 余额百分比
  - 可用余额
  - 提醒时间
- **充值管理**：
  - 在线充值资源池
  - 查看充值历史记录
- **手动检查**：触发资源池水位检查

**用途**：
- 实时监控资源池水位
- 及时响应余额不足提醒
- 管理资源池充值
- 确保服务可用性

### 4. 🎫 用户配额管理（UserQuotaManagement）

**位置**：计费管理 → **用户配额**

**功能**：
- 查看用户配额详情
- 授予用户配额
- 查看配额使用情况

**用途**：
- 管理用户配额
- 分析用户使用情况
- 配额分配和调整

### 5. 🤖 模型管理（ModelsManagement）

**位置**：计费管理 → **模型管理**

**功能**：
- 查看所有AI模型
- 按供应商分组显示
- 查看模型状态（启用/禁用）
- 如果资源池余额不足，模型状态会显示为"资费不足，暂不可用"

**用途**：
- 监控模型可用状态
- 了解哪些模型因余额不足被禁用

### 6. 💰 资费配置（PricingManagement）

**位置**：计费管理 → **资费配置**

**功能**：
- 查看和管理模型资费配置
- 按供应商分组显示
- 查看不同使用类型的价格

**用途**：
- 管理模型定价
- 了解计费标准

## 监测数据说明

### 使用记录字段

| 字段 | 说明 |
|------|------|
| userId | 用户ID |
| providerId | 提供商ID |
| modelId | 模型ID |
| usageType | 使用类型：text_generation, image_generation, audio_tts, audio_stt, video_generation |
| inputTokens | 输入Token数 |
| outputTokens | 输出Token数 |
| totalTokens | 总Token数 |
| costAmount | 费用金额（元） |
| status | 状态：success, failed |
| createdAt | 调用时间 |

### 成本统计字段

| 字段 | 说明 |
|------|------|
| statDate | 统计日期 |
| providerId | 提供商ID |
| modelId | 模型ID |
| usageType | 使用类型 |
| totalUsage | 总使用量 |
| totalCost | 总成本（元） |
| callCount | 调用次数 |

### 资源池状态字段

| 字段 | 说明 |
|------|------|
| totalBalance | 总余额（元） |
| usedAmount | 已使用金额（元） |
| availableBalance | 可用余额（元） |
| balancePercentage | 余额百分比 |
| isLowBalance | 是否余额不足 |
| lastRechargeDate | 最后充值日期 |
| lastCheckDate | 最后检查日期 |

## 监测建议

### 日常监测

1. **每日检查资源池管理**
   - 查看各供应商资源池余额
   - 关注余额提醒
   - 及时充值

2. **每周查看成本统计**
   - 分析成本趋势
   - 对比不同供应商成本
   - 优化模型使用策略

3. **定期查看使用记录**
   - 分析用户使用模式
   - 识别异常使用
   - 优化资源配置

### 告警监测

1. **资源池余额提醒**
   - 余额低于10%时自动提醒
   - 余额为0时模型自动禁用
   - 在资源池管理页面顶部显示

2. **配额不足提醒**
   - 用户配额不足时会阻止调用
   - 返回HTTP 402错误

## API接口

如果需要通过API监测，可以使用以下接口：

### 使用记录
```
GET /api/admin/billing/usage/records
参数：
  - userId: 用户ID（可选）
  - providerId: 提供商ID（可选）
  - modelId: 模型ID（可选）
  - startDate: 开始日期（可选）
  - endDate: 结束日期（可选）
  - page: 页码（可选）
  - size: 每页大小（可选）
```

### 成本统计
```
GET /api/admin/billing/cost/daily
参数：
  - startDate: 开始日期（可选）
  - endDate: 结束日期（可选）
  - providerId: 提供商ID（可选）
  - modelId: 模型ID（可选）
```

### 资源池状态
```
GET /api/admin/billing/resource-pool
返回所有资源池状态

GET /api/admin/billing/resource-pool/providers/{providerId}
返回指定提供商的资源池状态
```

### 资费提醒
```
GET /api/admin/billing/resource-pool/alerts
参数：
  - isResolved: 是否已解决（可选）
  - providerId: 提供商ID（可选）
```

## 快速访问

1. **登录管理后台**
2. **点击左侧导航栏的"计费管理"**
3. **选择相应的监测模块**：
   - 📊 使用记录 - 查看详细调用记录
   - 📈 成本统计 - 查看成本分析
   - 💧 资源池管理 - 监控资源池状态和提醒
   - 🎫 用户配额 - 管理用户配额
   - 🤖 模型管理 - 查看模型状态
   - 💰 资费配置 - 查看定价配置

## 注意事项

1. **权限要求**：需要管理员权限才能访问计费管理模块
2. **数据刷新**：页面数据需要手动刷新，资源池管理支持手动触发检查
3. **时间范围**：使用记录和成本统计支持按时间范围筛选
4. **实时性**：资源池余额是实时计算的，但提醒需要等待定时任务（每5分钟）或手动触发检查

