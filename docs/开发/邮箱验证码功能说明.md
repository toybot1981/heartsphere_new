# 邮箱验证码功能说明

## 功能概述

注册时增加了邮箱验证码功能，用户需要先获取邮箱验证码，然后在注册时输入验证码才能完成注册。

## 功能特性

1. **验证码发送**：用户输入邮箱后，系统发送6位数字验证码到邮箱
2. **验证码有效期**：验证码有效期为10分钟
3. **防刷机制**：同一邮箱60秒内只能发送一次验证码
4. **一次性使用**：验证码验证成功后立即失效
5. **可配置邮件服务器**：通过管理系统配置邮件服务器信息

## API接口

### 1. 发送验证码

**接口**: `POST /api/auth/email/send-code`

**请求体**:
```json
{
  "email": "user@example.com"
}
```

**响应**:
```json
{
  "code": 200,
  "message": "验证码已发送，请查收邮件",
  "data": null,
  "timestamp": "2025-01-16T10:30:00"
}
```

### 2. 验证验证码（可选）

**接口**: `POST /api/auth/email/verify-code`

**请求体**:
```json
{
  "email": "user@example.com",
  "code": "123456"
}
```

**响应**:
```json
{
  "code": 200,
  "message": "验证码正确",
  "data": null,
  "timestamp": "2025-01-16T10:30:00"
}
```

### 3. 注册（已更新）

**接口**: `POST /api/auth/register`

**请求体**:
```json
{
  "username": "testuser",
  "email": "user@example.com",
  "password": "password123",
  "nickname": "测试用户",
  "inviteCode": "optional",
  "emailVerificationCode": "123456"
}
```

**注意**: `emailVerificationCode` 字段为必填项

## 邮件服务器配置

### 通过管理系统配置

邮件服务器配置可以通过管理系统进行配置，配置项包括：

1. **email_host**: 邮件服务器地址（SMTP），默认：`smtp.qq.com`
2. **email_port**: 邮件服务器端口，默认：`587`
3. **email_username**: 邮件服务器用户名（通常是邮箱地址），默认：`heartsphere@qq.com`
4. **email_password**: 邮件服务器密码或授权码
5. **email_from**: 发件人邮箱地址，默认：`heartsphere@qq.com`

### 默认配置（163邮箱）

系统默认使用163邮箱发送验证码：
- **默认发件人**: `tongyexin@163.com`
- **默认SMTP服务器**: `smtp.163.com`
- **默认端口**: `25`

### 配置示例（163邮箱 - 默认）

1. 登录163邮箱，进入"设置" -> "POP3/SMTP/IMAP"
2. 开启"POP3/SMTP服务"或"IMAP/SMTP服务"
3. 生成授权码（不是邮箱密码）
4. 在管理系统中配置（如果使用默认邮箱，只需配置授权码）：
   - email_host: `smtp.163.com`（默认）
   - email_port: `25`（默认，也可使用465 SSL端口）
   - email_username: `tongyexin@163.com`（默认）
   - email_password: `[授权码]`（必填）
   - email_from: `tongyexin@163.com`（默认）

**注意**：163邮箱支持以下端口：
- `25`：标准SMTP端口（推荐）
- `465`：SSL加密端口
- `994`：SSL加密端口（IMAP）

### 配置示例（其他邮箱）

**QQ邮箱**:
1. 登录QQ邮箱，进入"设置" -> "账户"
2. 开启"POP3/SMTP服务"或"IMAP/SMTP服务"
3. 生成授权码（不是QQ密码）
4. 在管理系统中配置：
   - email_host: `smtp.qq.com`
   - email_port: `587`
   - email_username: `your-email@qq.com`
   - email_password: `[授权码]`
   - email_from: `your-email@qq.com`

**Gmail**:
- email_host: `smtp.gmail.com`
- email_port: `587`
- email_username: `your-email@gmail.com`
- email_password: `[应用专用密码]`

**126邮箱**:
- email_host: `smtp.126.com`
- email_port: `25`
- email_username: `your-email@126.com`
- email_password: `[授权码]`

## 数据库配置

邮件配置存储在 `system_config` 表中，使用以下配置键：

- `email_host`: 邮件服务器地址
- `email_port`: 邮件服务器端口
- `email_username`: 邮件用户名
- `email_password`: 邮件密码/授权码
- `email_from`: 发件人邮箱

## 验证码存储

当前实现使用内存存储验证码（`ConcurrentHashMap`），适合单机部署。

**生产环境建议**：
- 使用Redis存储验证码，支持分布式部署
- 设置合理的过期时间
- 实现验证码重试次数限制

## 安全考虑

1. **验证码复杂度**：当前为6位数字，可根据需要调整
2. **发送频率限制**：60秒内同一邮箱只能发送一次
3. **验证码有效期**：10分钟，过期自动失效
4. **一次性使用**：验证成功后立即删除，防止重复使用
5. **邮箱格式验证**：发送前验证邮箱格式

## 测试步骤

1. **发送验证码**：
   ```bash
   curl -X POST http://localhost:8081/api/auth/email/send-code \
     -H "Content-Type: application/json" \
     -d '{"email":"test@example.com"}'
   ```

2. **检查邮箱**：查看邮箱中的验证码

3. **注册用户**：
   ```bash
   curl -X POST http://localhost:8081/api/auth/register \
     -H "Content-Type: application/json" \
     -d '{
       "username":"testuser",
       "email":"test@example.com",
       "password":"password123",
       "emailVerificationCode":"123456"
     }'
   ```

## 智能配置功能

系统支持根据发件人邮箱自动检测SMTP配置：
- **163邮箱**：自动检测为 `smtp.163.com:25`
- **QQ邮箱**：自动检测为 `smtp.qq.com:587`
- **Gmail**：自动检测为 `smtp.gmail.com:587`
- **126邮箱**：自动检测为 `smtp.126.com:25`
- **新浪邮箱**：自动检测为 `smtp.sina.com:25`
- **Outlook/Hotmail**：自动检测为 `smtp-mail.outlook.com:587`

当更改发件人邮箱时，系统会自动检测并更新SMTP配置。

## 注意事项

1. **邮件服务器配置**：首次使用前需要在管理系统中配置邮件服务器信息（特别是授权码）
2. **授权码获取**：
   - 163邮箱：登录邮箱 -> 设置 -> POP3/SMTP/IMAP -> 开启服务 -> 生成授权码
   - QQ邮箱：登录邮箱 -> 设置 -> 账户 -> 开启服务 -> 生成授权码
   - 不是直接使用登录密码
3. **网络环境**：确保服务器能够访问邮件服务器的SMTP端口
4. **防火墙**：确保25、465、587等端口未被防火墙阻止
5. **163邮箱端口**：推荐使用25端口，如果25端口被阻止，可以使用465端口（SSL）

## 故障排查

1. **验证码发送失败**：
   - 检查邮件服务器配置是否正确
   - 检查授权码是否正确
   - 检查网络连接
   - 查看服务器日志

2. **验证码验证失败**：
   - 确认验证码未过期（10分钟）
   - 确认验证码输入正确
   - 确认邮箱地址一致

3. **邮件收不到**：
   - 检查垃圾邮件箱
   - 确认邮箱地址正确
   - 检查邮件服务器配置
