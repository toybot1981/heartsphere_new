# 大模型统一接入层 - 测试用例设计文档

**文档版本**: V1.0  
**编写日期**: 2025-12-22  
**测试范围**: AI Agent Service API

---

## 一、测试策略

### 1.1 测试金字塔

```
        /\
       /  \      E2E测试 (10%)
      /----\     
     /      \    集成测试 (20%)
    /--------\   
   /          \  单元测试 (70%)
  /------------\
```

### 1.2 测试分类

- **单元测试**: 测试单个组件/方法的功能
- **集成测试**: 测试组件之间的交互
- **API测试**: 测试REST API接口
- **端到端测试**: 测试完整业务流程

---

## 二、单元测试

### 2.1 适配器测试

#### 2.1.1 DashScopeAdapterTest

**测试类**: `DashScopeAdapterTest.java`

**测试用例**:

1. **文本生成测试**
   ```java
   @Test
   void testGenerateText_Success() {
       // Given
       TextGenerationRequest request = new TextGenerationRequest();
       request.setPrompt("你好");
       request.setProvider("dashscope");
       request.setModel("qwen-max");
       
       // When
       TextGenerationResponse response = adapter.generateText(request);
       
       // Then
       assertNotNull(response);
       assertNotNull(response.getContent());
       assertEquals("dashscope", response.getProvider());
       assertEquals("qwen-max", response.getModel());
   }
   ```

2. **流式文本生成测试**
   ```java
   @Test
   void testGenerateTextStream_Success() {
       // Given
       TextGenerationRequest request = new TextGenerationRequest();
       request.setPrompt("请写一首诗");
       request.setStream(true);
       
       List<String> chunks = new ArrayList<>();
       
       // When
       adapter.generateTextStream(request, (response, done) -> {
           if (response != null && response.getContent() != null) {
               chunks.add(response.getContent());
           }
       });
       
       // Then
       assertFalse(chunks.isEmpty());
   }
   ```

3. **图片生成测试**
   ```java
   @Test
   void testGenerateImage_Success() {
       // Given
       ImageGenerationRequest request = new ImageGenerationRequest();
       request.setPrompt("一只可爱的小猫");
       request.setProvider("dashscope");
       request.setModel("wanx-v1");
       
       // When
       ImageGenerationResponse response = adapter.generateImage(request);
       
       // Then
       assertNotNull(response);
       assertNotNull(response.getImages());
       assertFalse(response.getImages().isEmpty());
       assertNotNull(response.getImages().get(0).getUrl());
   }
   ```

4. **错误处理测试**
   ```java
   @Test
   void testGenerateText_InvalidApiKey() {
       // Given
       // 配置无效的API Key
       TextGenerationRequest request = new TextGenerationRequest();
       request.setPrompt("测试");
       
       // When & Then
       assertThrows(AIServiceException.class, () -> {
           adapter.generateText(request);
       });
   }
   ```

#### 2.1.2 ModelAdapterManagerTest

**测试类**: `ModelAdapterManagerTest.java`

**测试用例**:

1. **获取适配器测试**
   ```java
   @Test
   void testGetAdapter_Success() {
       // When
       ModelAdapter adapter = manager.getAdapter("dashscope");
       
       // Then
       assertNotNull(adapter);
       assertEquals("dashscope", adapter.getProviderType());
   }
   
   @Test
   void testGetAdapter_InvalidProvider() {
       // When & Then
       assertThrows(IllegalArgumentException.class, () -> {
           manager.getAdapter("invalid");
       });
   }
   ```

2. **获取可用提供商测试**
   ```java
   @Test
   void testGetAvailableProviders_Text() {
       // When
       List<String> providers = manager.getAvailableProviders("text");
       
       // Then
       assertNotNull(providers);
       assertTrue(providers.contains("dashscope"));
   }
   ```

---

## 三、服务层测试

### 3.1 AIServiceImplTest

**测试类**: `AIServiceImplTest.java`

**测试用例**:

1. **文本生成服务测试**
   ```java
   @Test
   @MockBean
   void testGenerateText_WithUserConfig() {
       // Given
       Long userId = 1L;
       TextGenerationRequest request = new TextGenerationRequest();
       request.setPrompt("你好");
       
       // Mock用户配置
       UserAIConfig config = new UserAIConfig();
       config.setTextProvider("dashscope");
       config.setTextModel("qwen-max");
       when(configService.getUserConfig(userId)).thenReturn(config);
       
       // Mock适配器
       TextGenerationResponse mockResponse = new TextGenerationResponse();
       mockResponse.setContent("你好！");
       when(adapterManager.getAdapter("dashscope")).thenReturn(adapter);
       when(adapter.generateText(any())).thenReturn(mockResponse);
       
       // When
       TextGenerationResponse response = aiService.generateText(userId, request);
       
       // Then
       assertNotNull(response);
       assertEquals("你好！", response.getContent());
   }
   ```

2. **降级机制测试**
   ```java
   @Test
   void testGenerateText_WithFallback() {
       // Given
       // 主适配器失败
       when(primaryAdapter.generateText(any()))
           .thenThrow(new AIServiceException("Primary failed"));
       
       // 备用适配器成功
       TextGenerationResponse fallbackResponse = new TextGenerationResponse();
       fallbackResponse.setContent("Fallback response");
       when(fallbackAdapter.generateText(any())).thenReturn(fallbackResponse);
       
       // When
       TextGenerationResponse response = aiService.generateText(userId, request);
       
       // Then
       assertNotNull(response);
       assertEquals("Fallback response", response.getContent());
   }
   ```

---

## 四、集成测试

### 4.1 AIServiceControllerIntegrationTest

**测试类**: `AIServiceControllerIntegrationTest.java`

**测试用例**:

1. **文本生成API测试**
   ```java
   @SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
   @AutoConfigureMockMvc
   class AIServiceControllerIntegrationTest {
       
       @Autowired
       private MockMvc mockMvc;
       
       @Test
       @WithMockUser
       void testGenerateText_Success() throws Exception {
           // Given
           TextGenerationRequest request = new TextGenerationRequest();
           request.setPrompt("你好");
           request.setProvider("dashscope");
           
           // When & Then
           mockMvc.perform(post("/api/ai/text/generate")
                   .contentType(MediaType.APPLICATION_JSON)
                   .content(objectMapper.writeValueAsString(request)))
                   .andExpect(status().isOk())
                   .andExpect(jsonPath("$.code").value(200))
                   .andExpect(jsonPath("$.data.content").exists())
                   .andExpect(jsonPath("$.data.provider").value("dashscope"));
       }
       
       @Test
       @WithMockUser
       void testGenerateText_Unauthorized() throws Exception {
           // When & Then
           mockMvc.perform(post("/api/ai/text/generate")
                   .contentType(MediaType.APPLICATION_JSON)
                   .content("{}"))
                   .andExpect(status().isUnauthorized());
       }
   }
   ```

2. **流式文本生成API测试**
   ```java
   @Test
   @WithMockUser
   void testGenerateTextStream_Success() throws Exception {
       // Given
       TextGenerationRequest request = new TextGenerationRequest();
       request.setPrompt("请写一首诗");
       request.setStream(true);
       
       // When & Then
       MvcResult result = mockMvc.perform(post("/api/ai/text/generate/stream")
               .contentType(MediaType.APPLICATION_JSON)
               .content(objectMapper.writeValueAsString(request)))
               .andExpect(status().isOk())
               .andExpect(header().string("Content-Type", "text/event-stream"))
               .andReturn();
   }
   ```

---

## 五、API测试用例

### 5.1 文本生成API

#### 5.1.1 正常场景

| 用例ID | 用例名称 | 请求参数 | 预期结果 |
|--------|---------|---------|---------|
| TC-001 | 基础文本生成 | prompt: "你好" | 返回200，包含生成的文本 |
| TC-002 | 指定提供商和模型 | prompt: "你好", provider: "dashscope", model: "qwen-max" | 返回200，使用指定模型 |
| TC-003 | 带系统指令 | prompt: "你好", systemInstruction: "你是一个助手" | 返回200，遵循系统指令 |
| TC-004 | 带对话历史 | prompt: "继续", messages: [...] | 返回200，基于历史上下文 |
| TC-005 | 自定义温度参数 | prompt: "创作", temperature: 0.9 | 返回200，使用指定温度 |

#### 5.1.2 异常场景

| 用例ID | 用例名称 | 请求参数 | 预期结果 |
|--------|---------|---------|---------|
| TC-101 | 空提示词 | prompt: "" | 返回400，参数错误 |
| TC-102 | 无效提供商 | provider: "invalid" | 返回400，不支持的提供商 |
| TC-103 | 无效模型 | model: "invalid-model" | 返回400，不支持的模型 |
| TC-104 | 未授权请求 | 无Authorization头 | 返回401，未授权 |
| TC-105 | API Key无效 | 配置无效API Key | 返回500，服务错误 |

### 5.2 图片生成API

#### 5.2.1 正常场景

| 用例ID | 用例名称 | 请求参数 | 预期结果 |
|--------|---------|---------|---------|
| TC-201 | 基础图片生成 | prompt: "一只猫" | 返回200，包含图片URL |
| TC-202 | 指定尺寸 | prompt: "风景", width: 1024, height: 1024 | 返回200，生成指定尺寸图片 |
| TC-203 | 生成多张图片 | prompt: "猫", numberOfImages: 3 | 返回200，包含3张图片 |

### 5.3 配置管理API

#### 5.3.1 正常场景

| 用例ID | 用例名称 | 请求参数 | 预期结果 |
|--------|---------|---------|---------|
| TC-301 | 获取用户配置 | GET /api/ai/config | 返回200，包含用户配置 |
| TC-302 | 更新用户配置 | PUT /api/ai/config, body: {...} | 返回200，配置更新成功 |

---

## 六、性能测试

### 6.1 响应时间测试

```java
@Test
void testGenerateText_Performance() {
    // Given
    TextGenerationRequest request = new TextGenerationRequest();
    request.setPrompt("测试性能");
    
    // When
    long startTime = System.currentTimeMillis();
    TextGenerationResponse response = adapter.generateText(request);
    long endTime = System.currentTimeMillis();
    
    // Then
    long duration = endTime - startTime;
    assertTrue(duration < 5000, "响应时间应在5秒内");
}
```

### 6.2 并发测试

```java
@Test
void testGenerateText_Concurrent() throws InterruptedException {
    int threadCount = 10;
    CountDownLatch latch = new CountDownLatch(threadCount);
    AtomicInteger successCount = new AtomicInteger(0);
    
    for (int i = 0; i < threadCount; i++) {
        new Thread(() -> {
            try {
                TextGenerationResponse response = adapter.generateText(request);
                if (response != null) {
                    successCount.incrementAndGet();
                }
            } finally {
                latch.countDown();
            }
        }).start();
    }
    
    latch.await(30, TimeUnit.SECONDS);
    assertEquals(threadCount, successCount.get());
}
```

---

## 七、测试数据准备

### 7.1 Mock数据

```java
public class TestDataFactory {
    
    public static TextGenerationRequest createTextRequest() {
        TextGenerationRequest request = new TextGenerationRequest();
        request.setPrompt("测试提示词");
        request.setProvider("dashscope");
        request.setModel("qwen-max");
        request.setTemperature(0.7);
        return request;
    }
    
    public static ImageGenerationRequest createImageRequest() {
        ImageGenerationRequest request = new ImageGenerationRequest();
        request.setPrompt("测试图片");
        request.setProvider("dashscope");
        request.setModel("wanx-v1");
        request.setWidth(1024);
        request.setHeight(1024);
        return request;
    }
}
```

---

## 八、测试覆盖率目标

- **单元测试覆盖率**: ≥ 80%
- **集成测试覆盖率**: ≥ 60%
- **API测试覆盖率**: 100%（所有公开接口）

---

## 九、测试执行

### 9.1 运行所有测试

```bash
mvn test
```

### 9.2 运行单元测试

```bash
mvn test -Dtest=*Test
```

### 9.3 运行集成测试

```bash
mvn verify -Dtest=*IntegrationTest
```

---

## 十、持续集成

### 10.1 CI配置

在CI/CD流程中：
1. 运行单元测试
2. 运行集成测试
3. 生成测试报告
4. 检查测试覆盖率

---

**文档维护**: 本文档应随代码实现持续更新和完善。


