# 跨时空信箱消息服务测试指南

## 一、测试环境准备

### 1.1 数据库准备

确保数据库迁移脚本已执行：
```bash
# 检查迁移脚本是否已执行
# 脚本位置：backend/src/main/resources/db/migration/
# - V20251230__create_mailbox_messages_table.sql
# - V20251230__create_mailbox_conversations_table.sql
# - V20251230__create_mailbox_conversation_messages_table.sql
# - V20251230__create_mailbox_notification_settings_table.sql
```

### 1.2 启动后端服务

```bash
cd backend
mvn spring-boot:run
# 或
./mvnw spring-boot:run
```

### 1.3 启动前端服务

```bash
cd frontend
npm run dev
```

## 二、API接口测试

### 2.1 获取消息列表

**请求**：
```bash
curl -X GET "http://localhost:8081/api/mailbox/messages?page=0&size=20" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**响应示例**：
```json
{
  "content": [
    {
      "id": 1,
      "receiverId": 1,
      "senderType": "SYSTEM",
      "senderName": "系统",
      "messageType": "SYSTEM_NOTIFICATION",
      "messageCategory": "SYSTEM",
      "title": "欢迎使用跨时空信箱",
      "content": "这是您的第一条消息...",
      "isRead": false,
      "isImportant": false,
      "isStarred": false,
      "createdAt": "2025-12-30T10:00:00"
    }
  ],
  "totalElements": 1,
  "totalPages": 1,
  "size": 20,
  "number": 0
}
```

### 2.2 获取未读消息数量

**请求**：
```bash
curl -X GET "http://localhost:8081/api/mailbox/messages/unread/count" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**响应示例**：
```json
{
  "totalUnread": 5,
  "categoryUnread": {
    "ESOUL_LETTER": 2,
    "RESONANCE": 1,
    "SYSTEM": 1,
    "USER_MESSAGE": 1
  }
}
```

### 2.3 标记消息为已读

**请求**：
```bash
curl -X PUT "http://localhost:8081/api/mailbox/messages/1/read" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 2.4 标记消息为重要

**请求**：
```bash
curl -X PUT "http://localhost:8081/api/mailbox/messages/1/important" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"isImportant": true}'
```

### 2.5 收藏消息

**请求**：
```bash
curl -X PUT "http://localhost:8081/api/mailbox/messages/1/star" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"isStarred": true}'
```

### 2.6 删除消息

**请求**：
```bash
curl -X DELETE "http://localhost:8081/api/mailbox/messages/1" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 2.7 批量删除消息

**请求**：
```bash
curl -X DELETE "http://localhost:8081/api/mailbox/messages/batch" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"messageIds": [1, 2, 3]}'
```

### 2.8 按分类筛选消息

**请求**：
```bash
curl -X GET "http://localhost:8081/api/mailbox/messages?category=ESOUL_LETTER&page=0&size=20" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 2.9 搜索消息

**请求**：
```bash
curl -X GET "http://localhost:8081/api/mailbox/messages?keyword=测试&page=0&size=20" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 三、测试用例

### 3.1 功能测试

#### 测试用例 1：创建消息
1. 使用管理员账号或系统服务创建一条测试消息
2. 验证消息已创建并存储在数据库中
3. 验证接收者可以查看到这条消息

#### 测试用例 2：消息列表查询
1. 查询所有消息（无筛选条件）
2. 按分类筛选（E-SOUL来信、共鸣消息、系统消息、用户消息）
3. 按已读状态筛选（已读/未读）
4. 按重要状态筛选
5. 按收藏状态筛选
6. 验证分页功能

#### 测试用例 3：消息操作
1. 标记消息为已读，验证isRead和readAt字段更新
2. 标记消息为重要，验证isImportant字段更新
3. 收藏消息，验证isStarred字段更新
4. 取消标记，验证字段正确更新

#### 测试用例 4：消息删除
1. 删除单条消息，验证软删除（deletedAt字段）
2. 批量删除消息，验证多条消息被删除
3. 验证删除后的消息不会在列表中显示

#### 测试用例 5：未读数量统计
1. 创建多条不同类型的消息
2. 查询未读数量，验证统计正确
3. 标记部分消息为已读
4. 再次查询，验证数量减少

### 3.2 权限测试

#### 测试用例 6：用户权限
1. 用户A尝试访问用户B的消息，应返回403或空结果
2. 用户只能删除自己的消息
3. 用户只能标记自己的消息

### 3.3 性能测试

#### 测试用例 7：大量数据查询
1. 创建1000+条消息
2. 测试分页查询性能（应< 1秒）
3. 测试搜索性能
4. 测试未读数量统计性能

## 四、前端测试

### 4.1 消息列表组件测试

1. 打开前端应用
2. 导航到跨时空信箱
3. 验证消息列表正常显示
4. 测试筛选功能（全部/未读/重要/收藏）
5. 测试分页加载
6. 测试消息卡片点击

### 4.2 消息详情组件测试

1. 点击消息卡片，打开详情页
2. 验证消息内容正确显示
3. 测试收藏按钮
4. 测试标记重要按钮
5. 测试删除按钮
6. 测试返回按钮

## 五、常见问题排查

### 5.1 数据库表不存在

**问题**：启动时报错表不存在

**解决**：
1. 检查迁移脚本是否已执行
2. 检查application.yml中的数据库配置
3. 手动执行迁移脚本

### 5.2 权限错误

**问题**：401 Unauthorized

**解决**：
1. 检查Authorization header是否正确
2. 检查token是否过期
3. 检查用户是否存在

### 5.3 查询结果为空

**问题**：查询消息列表返回空结果

**解决**：
1. 检查数据库中是否有消息数据
2. 检查receiver_id是否正确
3. 检查deletedAt是否为NULL（软删除的消息不会显示）

## 六、测试数据准备

### 6.1 SQL插入测试数据

```sql
-- 插入测试消息
INSERT INTO mailbox_messages (
    receiver_id, sender_type, sender_id, sender_name, sender_avatar,
    message_type, message_category, title, content,
    is_read, is_important, is_starred, created_at
) VALUES 
(
    1, 'SYSTEM', NULL, '系统', NULL,
    'SYSTEM_NOTIFICATION', 'SYSTEM', '欢迎消息', '欢迎使用跨时空信箱！',
    false, false, false, NOW()
),
(
    1, 'ESOUL', 1, '测试角色', 'https://example.com/avatar.jpg',
    'ESOUL_GREETING', 'ESOUL_LETTER', '问候', '你好！这是一条问候消息。',
    false, false, false, NOW()
);
```

## 七、测试检查清单

- [ ] 数据库迁移脚本执行成功
- [ ] 后端服务正常启动
- [ ] 前端服务正常启动
- [ ] API接口可以正常访问
- [ ] 消息CRUD功能正常
- [ ] 消息查询和筛选正常
- [ ] 未读数量统计正常
- [ ] 前端组件正常显示
- [ ] 用户权限控制正常
- [ ] 性能满足要求（查询< 1秒）

