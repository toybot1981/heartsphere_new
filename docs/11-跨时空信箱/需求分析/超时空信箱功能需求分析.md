# 超时空信箱功能需求分析与设计

**文档版本**: V1.0  
**编写日期**: 2025-12-30  
**功能模块**: 超时空信箱  
**目标**: 实现一个综合性的消息通信系统，支持接收E-SOUL来信、其他心域的共鸣、系统反馈对话以及用户间对话

---

## 一、需求概述

### 1.1 背景

超时空信箱是HeartSphere的核心通信功能，为用户提供一个统一的收件箱，可以接收来自不同来源的消息：

1. **E-SOUL来信**：来自用户心域中E-SOUL的主动来信
2. **共鸣消息**：来自其他共享心域的共鸣和互动消息
3. **系统消息**：系统通知、反馈、对话等
4. **用户消息**：与其他心域拥有者的直接对话

这个功能让用户能够在一个统一的地方管理所有消息，增强用户与系统、与其他用户的连接。

### 1.2 核心需求

- ✅ **统一收件箱**：所有消息统一展示和管理
- ✅ **E-SOUL来信**：接收来自E-SOUL的主动来信
- ✅ **共鸣消息**：接收来自其他心域的共鸣和互动消息
- ✅ **系统对话**：与系统进行反馈、对话
- ✅ **用户对话**：与其他心域拥有者对话
- ✅ **消息分类**：按消息类型分类展示
- ✅ **消息提醒**：新消息提醒和通知
- ✅ **消息管理**：查看、回复、删除等管理功能

### 1.3 设计目标

1. **统一体验**：统一的收件箱体验，所有消息一目了然
2. **情感连接**：增强用户与E-SOUL、与其他用户的情感连接
3. **便捷操作**：消息查看、回复等操作简单便捷
4. **智能分类**：智能分类和筛选，快速找到需要的消息
5. **温暖体验**：界面和交互设计体现温暖和情感

---

## 二、功能需求分析

### 2.1 统一收件箱

#### 2.1.1 功能描述

提供一个统一的收件箱界面，展示所有来源的消息。

#### 2.1.2 消息类型分类

**1. E-SOUL来信**

- **来源标识**：显示来自哪个E-SOUL
- **来信类型**：问候、关怀、分享、提醒等
- **来信内容**：E-SOUL的来信内容
- **来信时间**：来信时间
- **情感标识**：来信的情感倾向（温暖、鼓励等）

**2. 共鸣消息**

- **来源标识**：显示来自哪个心域（心域名称、主人名称）
- **消息类型**：点赞、评论、留言、分享等
- **消息内容**：共鸣消息的内容
- **关联内容**：关联的共享内容（场景、记忆等）
- **消息时间**：消息时间

**3. 系统消息**

- **消息类型**：通知、反馈、系统对话等
- **消息内容**：系统消息内容
- **消息重要性**：重要/普通/提醒
- **消息时间**：消息时间

**4. 用户消息**

- **来源标识**：发送者信息（心域名称、主人名称）
- **消息类型**：私信、回复、互动等
- **消息内容**：用户消息内容
- **消息时间**：消息时间
- **对话上下文**：关联的对话上下文

#### 2.1.3 收件箱布局

- **消息列表**：按时间倒序展示消息列表
- **消息分类**：支持按消息类型筛选
- **未读标识**：未读消息的视觉标识
- **重要消息**：重要消息的特殊标识
- **消息预览**：消息内容的预览

---

### 2.2 E-SOUL来信功能

#### 2.2.1 功能描述

E-SOUL可以主动给用户发送来信，包括问候、关怀、分享等内容。

#### 2.2.2 来信类型

**1. 日常问候**

- **触发时机**：每日首次使用、特定时间等
- **来信内容**：个性化的问候内容
- **情感表达**：温暖的问候和关心

**2. 主动关怀**

- **触发时机**：检测到用户情绪、长时间未使用等
- **来信内容**：关怀和鼓励的内容
- **情感表达**：表达关心和支持

**3. 分享内容**

- **触发时机**：E-SOUL想要分享内容时
- **来信内容**：分享的内容（记忆、想法等）
- **情感表达**：分享的喜悦和期待

**4. 提醒通知**

- **触发时机**：重要提醒、活动提醒等
- **来信内容**：提醒内容
- **情感表达**：友好的提醒方式

#### 2.2.3 来信生成

- **AI生成**：使用AI生成个性化的来信内容
- **模板系统**：基于模板生成来信
- **个性化**：根据用户记忆和偏好个性化内容
- **情感匹配**：根据用户当前情绪匹配来信情感

#### 2.2.4 来信展示

- **来信卡片**：使用卡片形式展示来信
- **E-SOUL头像**：显示E-SOUL的头像和名称
- **来信内容**：来信的完整内容
- **来信时间**：来信的时间（友好格式）
- **操作按钮**：查看详情、回复等操作

#### 2.2.5 来信回复

- **快速回复**：提供快速回复选项
- **完整回复**：进入对话界面进行完整回复
- **回复记录**：记录回复历史

---

### 2.3 共鸣消息功能

#### 2.3.1 功能描述

接收来自其他共享心域的共鸣和互动消息。

#### 2.3.2 消息类型

**1. 点赞消息**

- **消息内容**：某用户点赞了你的心域/场景/内容
- **来源信息**：点赞者的信息（心域名称）
- **关联内容**：被点赞的内容
- **操作**：查看详情、感谢回复等

**2. 评论消息**

- **消息内容**：某用户评论了你的心域/场景/内容
- **评论内容**：评论的完整内容
- **来源信息**：评论者的信息
- **关联内容**：被评论的内容
- **操作**：查看详情、回复评论等

**3. 留言消息**

- **消息内容**：某用户在你的心域留下暖心留言
- **留言内容**：留言的完整内容
- **来源信息**：留言者的信息
- **关联内容**：关联的共享配置
- **操作**：查看详情、回复留言等

**4. 分享消息**

- **消息内容**：某用户分享了你的心域/内容
- **来源信息**：分享者的信息
- **关联内容**：被分享的内容
- **操作**：查看详情、查看分享等

**5. 连接请求消息**

- **消息内容**：某用户请求连接你的心域
- **来源信息**：请求者的信息
- **请求内容**：请求消息内容
- **操作**：同意/拒绝请求等

#### 2.3.3 消息聚合

- **相同来源聚合**：相同来源的多条消息可以聚合显示
- **相同类型聚合**：相同类型的消息可以聚合显示
- **时间聚合**：相近时间的消息可以聚合显示
- **聚合展开**：可以展开查看聚合消息的详情

#### 2.3.4 消息处理

- **查看详情**：查看消息的详细信息
- **快速回复**：快速回复消息
- **完整回复**：进入详情页面进行完整回复
- **标记处理**：标记消息为已处理

---

### 2.4 系统消息功能

#### 2.4.1 功能描述

接收系统通知、反馈、系统对话等消息。

#### 2.4.2 消息类型

**1. 系统通知**

- **通知类型**：功能更新、活动通知、重要提醒等
- **通知内容**：通知的详细内容
- **通知重要性**：重要/普通/提醒
- **操作**：查看详情、确认已读等

**2. 系统反馈**

- **反馈类型**：使用反馈、体验反馈等
- **反馈内容**：系统主动询问的反馈内容
- **操作**：填写反馈、跳过等

**3. 系统对话**

- **对话类型**：系统主动发起的对话
- **对话内容**：对话的完整内容
- **对话上下文**：对话的上下文信息
- **操作**：回复对话、继续对话等

#### 2.4.3 系统对话场景

- **使用引导**：新功能使用引导对话
- **体验询问**：询问用户体验的对话
- **建议收集**：收集用户建议的对话
- **问题帮助**：帮助解决问题的对话

#### 2.4.4 消息管理

- **重要消息置顶**：重要系统消息可以置顶显示
- **消息分类**：按类型分类系统消息
- **已读标记**：标记消息为已读
- **消息删除**：删除不需要的系统消息

---

### 2.5 用户消息功能

#### 2.5.1 功能描述

与其他心域拥有者进行直接对话。

#### 2.5.2 对话场景

**1. 私信对话**

- **发起方式**：用户主动发起私信
- **对话对象**：其他心域拥有者
- **对话内容**：私信内容
- **对话历史**：完整的对话历史记录

**2. 回复对话**

- **触发场景**：回复评论、回复留言等
- **对话对象**：原消息发送者
- **对话内容**：回复内容
- **关联上下文**：关联的原消息内容

**3. 互动对话**

- **触发场景**：基于心域连接的互动
- **对话对象**：连接的心域拥有者
- **对话内容**：互动对话内容
- **对话主题**：对话的主题和上下文

#### 2.5.3 对话界面

- **对话列表**：所有对话的列表
- **对话详情**：单个对话的详情页面
- **消息列表**：对话中的消息列表
- **输入框**：消息输入框
- **发送按钮**：发送消息按钮

#### 2.5.4 对话功能

- **发送消息**：发送文本、表情等消息
- **消息编辑**：编辑已发送的消息（限时内）
- **消息删除**：删除消息
- **消息转发**：转发消息
- **对话搜索**：在对话中搜索消息
- **对话设置**：对话的提醒、免打扰等设置

---

### 2.6 消息管理功能

#### 2.6.1 功能描述

提供消息的查看、回复、删除等管理功能。

#### 2.6.2 查看功能

- **消息列表**：查看所有消息列表
- **消息详情**：查看消息的详细信息
- **消息分类**：按类型查看消息
- **消息搜索**：搜索消息内容
- **消息筛选**：按条件筛选消息

#### 2.6.3 回复功能

- **快速回复**：快速回复消息（表情、快捷文字等）
- **完整回复**：进入详情页面进行完整回复
- **回复历史**：查看回复历史记录
- **回复通知**：回复后的通知机制

#### 2.6.4 标记功能

- **已读标记**：标记消息为已读
- **未读标记**：标记消息为未读
- **重要标记**：标记消息为重要
- **收藏标记**：收藏重要消息

#### 2.6.5 删除功能

- **单条删除**：删除单条消息
- **批量删除**：批量删除多条消息
- **分类删除**：删除某个分类的所有消息
- **删除确认**：删除前的确认机制

#### 2.6.6 其他功能

- **消息导出**：导出消息内容（用于备份）
- **消息归档**：归档旧消息
- **消息统计**：消息的统计信息

---

### 2.7 消息提醒功能

#### 2.7.1 功能描述

提供新消息的提醒和通知功能。

#### 2.7.2 提醒方式

**1. 界面提醒**

- **未读数量**：在收件箱图标上显示未读数量
- **红点提醒**：未读消息的红色圆点提醒
- **消息列表高亮**：未读消息在列表中的高亮显示

**2. 弹窗提醒**

- **新消息弹窗**：新消息到达时的弹窗提醒
- **弹窗内容**：消息预览和快速操作
- **弹窗关闭**：可以关闭或稍后查看

**3. 系统通知**

- **浏览器通知**：浏览器桌面通知
- **推送通知**：移动端推送通知
- **通知内容**：消息的简要信息

#### 2.7.3 提醒设置

- **提醒开关**：开启/关闭消息提醒
- **提醒类型**：选择需要提醒的消息类型
- **提醒时间**：设置提醒的免打扰时间
- **提醒声音**：设置提醒声音（可选）

---

## 三、业务流程设计

### 3.1 E-SOUL来信流程

```
E-SOUL触发来信条件
        ↓
生成来信内容（AI/模板）
        ↓
发送来信到用户信箱
        ↓
用户收到来信通知
        ↓
用户查看来信
        ↓
用户选择回复/忽略
        ↓
记录交互历史
```

### 3.2 共鸣消息流程

```
其他用户产生共鸣行为
        ↓
生成共鸣消息
        ↓
发送到目标用户信箱
        ↓
用户收到消息通知
        ↓
用户查看消息
        ↓
用户选择回复/感谢/忽略
        ↓
记录交互历史
```

### 3.3 系统消息流程

```
系统触发消息（通知/反馈/对话）
        ↓
生成系统消息
        ↓
发送到用户信箱
        ↓
用户收到消息通知
        ↓
用户查看消息
        ↓
用户处理消息（确认/回复/反馈）
        ↓
记录处理历史
```

### 3.4 用户对话流程

```
用户A发起对话
        ↓
创建对话会话
        ↓
发送消息到用户B信箱
        ↓
用户B收到消息通知
        ↓
用户B查看消息
        ↓
用户B回复消息
        ↓
消息进入对话历史
        ↓
持续对话...
```

---

## 四、数据结构设计

### 4.1 消息表

**表名**: `mailbox_messages`

**字段设计**:
- `id` (BIGINT, PRIMARY KEY): 消息ID
- `receiver_id` (BIGINT, NOT NULL): 接收者用户ID
- `sender_type` (VARCHAR, NOT NULL): 发送者类型（esoul/heartsphere/system/user）
- `sender_id` (BIGINT): 发送者ID（E-SOUL ID/心域ID/系统ID/用户ID）
- `sender_name` (VARCHAR): 发送者名称
- `sender_avatar` (VARCHAR): 发送者头像URL
- `message_type` (VARCHAR, NOT NULL): 消息类型（详见消息类型枚举）
- `message_category` (VARCHAR, NOT NULL): 消息分类（esoul_letter/resonance/system/user_message）
- `title` (VARCHAR): 消息标题
- `content` (TEXT, NOT NULL): 消息内容
- `content_data` (TEXT): 消息扩展数据（JSON格式，用于存储关联内容、元数据等）
- `is_read` (BOOLEAN, DEFAULT FALSE): 是否已读
- `is_important` (BOOLEAN, DEFAULT FALSE): 是否重要
- `is_starred` (BOOLEAN, DEFAULT FALSE): 是否收藏
- `related_id` (BIGINT): 关联对象ID（如关联的共享配置ID、场景ID等）
- `related_type` (VARCHAR): 关联对象类型
- `reply_to_id` (BIGINT): 回复的消息ID（如果有）
- `created_at` (DATETIME, DEFAULT CURRENT_TIMESTAMP): 创建时间
- `read_at` (DATETIME): 阅读时间
- `deleted_at` (DATETIME): 删除时间（软删除）

**索引**:
- `idx_receiver` (receiver_id, created_at)
- `idx_category` (message_category, created_at)
- `idx_sender` (sender_type, sender_id)
- `idx_read` (receiver_id, is_read)
- `idx_related` (related_type, related_id)

---

### 4.2 对话表

**表名**: `mailbox_conversations`

**字段设计**:
- `id` (BIGINT, PRIMARY KEY): 对话ID
- `participant1_id` (BIGINT, NOT NULL): 参与者1用户ID
- `participant2_id` (BIGINT, NOT NULL): 参与者2用户ID（或系统ID）
- `conversation_type` (VARCHAR, NOT NULL): 对话类型（user_to_user/user_to_system）
- `last_message_id` (BIGINT): 最后一条消息ID
- `last_message_at` (DATETIME): 最后消息时间
- `unread_count_1` (INT, DEFAULT 0): 参与者1的未读数量
- `unread_count_2` (INT, DEFAULT 0): 参与者2的未读数量
- `is_pinned_1` (BOOLEAN, DEFAULT FALSE): 参与者1是否置顶
- `is_pinned_2` (BOOLEAN, DEFAULT FALSE): 参与者2是否置顶
- `is_muted_1` (BOOLEAN, DEFAULT FALSE): 参与者1是否免打扰
- `is_muted_2` (BOOLEAN, DEFAULT FALSE): 参与者2是否免打扰
- `created_at` (DATETIME, DEFAULT CURRENT_TIMESTAMP): 创建时间
- `updated_at` (DATETIME, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP): 更新时间

**索引**:
- `idx_participant1` (participant1_id, last_message_at)
- `idx_participant2` (participant2_id, last_message_at)
- `idx_participants` (participant1_id, participant2_id)

---

### 4.3 对话消息表

**表名**: `mailbox_conversation_messages`

**字段设计**:
- `id` (BIGINT, PRIMARY KEY): 消息ID
- `conversation_id` (BIGINT, NOT NULL): 对话ID
- `sender_id` (BIGINT, NOT NULL): 发送者ID
- `sender_type` (VARCHAR, NOT NULL): 发送者类型（user/system）
- `message_type` (VARCHAR, NOT NULL): 消息类型（text/image/voice/emoji等）
- `content` (TEXT, NOT NULL): 消息内容
- `content_data` (TEXT): 消息扩展数据（JSON格式）
- `reply_to_id` (BIGINT): 回复的消息ID（如果有）
- `is_edited` (BOOLEAN, DEFAULT FALSE): 是否已编辑
- `is_deleted` (BOOLEAN, DEFAULT FALSE): 是否已删除
- `created_at` (DATETIME, DEFAULT CURRENT_TIMESTAMP): 创建时间
- `updated_at` (DATETIME, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP): 更新时间

**索引**:
- `idx_conversation` (conversation_id, created_at)
- `idx_sender` (sender_id, created_at)

---

### 4.4 消息提醒设置表

**表名**: `mailbox_notification_settings`

**字段设计**:
- `id` (BIGINT, PRIMARY KEY): 设置ID
- `user_id` (BIGINT, NOT NULL, UNIQUE): 用户ID
- `enable_notifications` (BOOLEAN, DEFAULT TRUE): 是否启用提醒
- `esoul_letter_enabled` (BOOLEAN, DEFAULT TRUE): E-SOUL来信提醒
- `resonance_enabled` (BOOLEAN, DEFAULT TRUE): 共鸣消息提醒
- `system_message_enabled` (BOOLEAN, DEFAULT TRUE): 系统消息提醒
- `user_message_enabled` (BOOLEAN, DEFAULT TRUE): 用户消息提醒
- `quiet_hours_start` (TIME): 免打扰开始时间
- `quiet_hours_end` (TIME): 免打扰结束时间
- `sound_enabled` (BOOLEAN, DEFAULT TRUE): 是否启用声音
- `updated_at` (DATETIME, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP): 更新时间

**索引**:
- `idx_user` (user_id)

---

## 五、消息类型枚举

### 5.1 E-SOUL来信类型

- `esoul_greeting`: 日常问候
- `esoul_care`: 主动关怀
- `esoul_share`: 分享内容
- `esoul_reminder`: 提醒通知

### 5.2 共鸣消息类型

- `resonance_like`: 点赞消息
- `resonance_comment`: 评论消息
- `resonance_message`: 留言消息
- `resonance_share`: 分享消息
- `resonance_connection_request`: 连接请求消息

### 5.3 系统消息类型

- `system_notification`: 系统通知
- `system_feedback`: 系统反馈
- `system_dialogue`: 系统对话

### 5.4 用户消息类型

- `user_private_message`: 私信消息
- `user_reply`: 回复消息
- `user_interaction`: 互动消息

---

## 六、API接口设计

### 6.1 收件箱接口

**接口**: `GET /api/mailbox/messages`

**功能**: 获取消息列表

**请求参数**:
- `category` (string): 消息分类（esoul_letter/resonance/system/user_message）
- `isRead` (boolean): 是否已读
- `isImportant` (boolean): 是否重要
- `startDate` (datetime): 开始日期
- `endDate` (datetime): 结束日期
- `page` (integer): 页码
- `size` (integer): 每页数量

**响应数据**:
- `messages` (array): 消息列表
- `total` (integer): 总记录数
- `unreadCount` (integer): 未读数量

---

**接口**: `GET /api/mailbox/messages/{id}`

**功能**: 获取消息详情

**响应数据**:
- `message` (object): 消息详细信息
- `relatedContent` (object): 关联内容（如果有）

---

**接口**: `PUT /api/mailbox/messages/{id}/read`

**功能**: 标记消息为已读

**响应数据**:
- `success` (boolean): 是否成功

---

**接口**: `PUT /api/mailbox/messages/{id}/important`

**功能**: 标记/取消标记消息为重要

**请求参数**:
- `isImportant` (boolean, required): 是否重要

**响应数据**:
- `success` (boolean): 是否成功

---

**接口**: `PUT /api/mailbox/messages/{id}/star`

**功能**: 收藏/取消收藏消息

**请求参数**:
- `isStarred` (boolean, required): 是否收藏

**响应数据**:
- `success` (boolean): 是否成功

---

**接口**: `DELETE /api/mailbox/messages/{id}`

**功能**: 删除消息

**响应数据**:
- `success` (boolean): 是否成功

---

**接口**: `DELETE /api/mailbox/messages/batch`

**功能**: 批量删除消息

**请求参数**:
- `messageIds` (array, required): 消息ID列表

**响应数据**:
- `deletedCount` (integer): 删除的数量

---

### 6.2 E-SOUL来信接口

**接口**: `POST /api/mailbox/esoul-letters`

**功能**: E-SOUL发送来信（系统内部接口）

**请求参数**:
- `esoulId` (long, required): E-SOUL ID
- `userId` (long, required): 接收用户ID
- `letterType` (string, required): 来信类型
- `content` (string, required): 来信内容
- `contentData` (object): 扩展数据

**响应数据**:
- `messageId` (long): 消息ID
- `success` (boolean): 是否成功

---

**接口**: `POST /api/mailbox/esoul-letters/{messageId}/reply`

**功能**: 回复E-SOUL来信

**请求参数**:
- `content` (string, required): 回复内容
- `replyType` (string): 回复类型（quick/full）

**响应数据**:
- `success` (boolean): 是否成功
- `conversationId` (long): 对话ID（如果创建了新对话）

---

### 6.3 共鸣消息接口

**接口**: `POST /api/mailbox/resonance-messages`

**功能**: 创建共鸣消息（系统内部接口）

**请求参数**:
- `senderId` (long, required): 发送者ID
- `receiverId` (long, required): 接收者ID
- `resonanceType` (string, required): 共鸣类型
- `content` (string, required): 消息内容
- `relatedId` (long): 关联对象ID
- `relatedType` (string): 关联对象类型

**响应数据**:
- `messageId` (long): 消息ID
- `success` (boolean): 是否成功

---

**接口**: `POST /api/mailbox/resonance-messages/{messageId}/reply`

**功能**: 回复共鸣消息

**请求参数**:
- `content` (string, required): 回复内容
- `replyType` (string): 回复类型

**响应数据**:
- `success` (boolean): 是否成功

---

### 6.4 系统消息接口

**接口**: `POST /api/mailbox/system-messages`

**功能**: 创建系统消息（系统内部接口）

**请求参数**:
- `userId` (long, required): 接收用户ID
- `messageType` (string, required): 消息类型
- `title` (string): 消息标题
- `content` (string, required): 消息内容
- `isImportant` (boolean): 是否重要
- `contentData` (object): 扩展数据

**响应数据**:
- `messageId` (long): 消息ID
- `success` (boolean): 是否成功

---

**接口**: `POST /api/mailbox/system-messages/{messageId}/reply`

**功能**: 回复系统消息（用于系统对话）

**请求参数**:
- `content` (string, required): 回复内容

**响应数据**:
- `success` (boolean): 是否成功
- `systemReply` (object): 系统回复内容

---

### 6.5 用户对话接口

**接口**: `GET /api/mailbox/conversations`

**功能**: 获取对话列表

**请求参数**:
- `conversationType` (string): 对话类型
- `page` (integer): 页码
- `size` (integer): 每页数量

**响应数据**:
- `conversations` (array): 对话列表
- `total` (integer): 总记录数

---

**接口**: `POST /api/mailbox/conversations`

**功能**: 创建新对话

**请求参数**:
- `participantId` (long, required): 参与者ID
- `initialMessage` (string, required): 初始消息内容

**响应数据**:
- `conversationId` (long): 对话ID
- `success` (boolean): 是否成功

---

**接口**: `GET /api/mailbox/conversations/{conversationId}/messages`

**功能**: 获取对话消息列表

**请求参数**:
- `beforeMessageId` (long): 在此之前的消息ID（用于分页）
- `size` (integer): 每页数量

**响应数据**:
- `messages` (array): 消息列表
- `hasMore` (boolean): 是否还有更多消息

---

**接口**: `POST /api/mailbox/conversations/{conversationId}/messages`

**功能**: 发送对话消息

**请求参数**:
- `content` (string, required): 消息内容
- `messageType` (string): 消息类型（text/image/voice等）
- `contentData` (object): 扩展数据
- `replyToId` (long): 回复的消息ID（如果有）

**响应数据**:
- `messageId` (long): 消息ID
- `success` (boolean): 是否成功

---

**接口**: `PUT /api/mailbox/conversations/{conversationId}/read`

**功能**: 标记对话为已读

**响应数据**:
- `success` (boolean): 是否成功

---

### 6.6 消息提醒接口

**接口**: `GET /api/mailbox/notification-settings`

**功能**: 获取提醒设置

**响应数据**:
- `settings` (object): 提醒设置

---

**接口**: `PUT /api/mailbox/notification-settings`

**功能**: 更新提醒设置

**请求参数**:
- `settings` (object, required): 设置对象

**响应数据**:
- `success` (boolean): 是否成功

---

**接口**: `GET /api/mailbox/unread-count`

**功能**: 获取未读消息数量

**响应数据**:
- `totalUnread` (integer): 总未读数量
- `categoryUnread` (object): 各分类未读数量

---

## 七、UI/UX设计需求

### 7.1 收件箱界面

#### 7.1.1 主界面布局

- **顶部导航**：收件箱标题、搜索框、设置按钮
- **左侧分类**：消息分类导航（全部/E-SOUL来信/共鸣/系统/用户消息）
- **主内容区**：消息列表
- **消息卡片**：每条消息的卡片展示

#### 7.1.2 消息卡片设计

- **发送者信息**：头像、名称、类型标识
- **消息预览**：标题、内容预览、时间
- **状态标识**：未读/已读、重要、收藏标识
- **操作按钮**：快速操作按钮（回复、删除等）

#### 7.1.3 视觉设计

- **温暖配色**：使用温暖的配色方案
- **图标设计**：不同类型消息的图标设计
- **动画效果**：消息到达、查看等的动画效果
- **空状态**：无消息时的空状态设计

---

### 7.2 消息详情界面

#### 7.2.1 详情页面布局

- **消息头部**：发送者信息、时间、类型
- **消息内容**：完整的消息内容展示
- **关联内容**：关联的内容预览（如果有）
- **操作区域**：回复、转发、删除等操作
- **回复区域**：快速回复和完整回复入口

#### 7.2.2 对话界面

- **对话头部**：对话对象信息、设置按钮
- **消息列表**：对话消息列表（时间倒序）
- **输入区域**：消息输入框、发送按钮、附件按钮
- **消息气泡**：消息气泡设计（发送/接收）

---

### 7.3 消息提醒设计

- **未读数量徽章**：红色圆点显示未读数量
- **新消息弹窗**：新消息到达时的弹窗提醒
- **桌面通知**：浏览器桌面通知（需要用户授权）

---

## 八、实施计划

### 8.1 第一阶段：基础功能（2周）

- [ ] 设计数据结构和API接口
- [ ] 实现消息表和数据访问层
- [ ] 实现收件箱基础功能（消息列表、详情查看）
- [ ] 实现消息分类和筛选
- [ ] 前端基础界面开发

### 8.2 第二阶段：消息发送（1.5周）

- [ ] 实现E-SOUL来信功能
- [ ] 实现共鸣消息功能
- [ ] 实现系统消息功能
- [ ] 实现消息提醒功能
- [ ] 前端消息展示优化

### 8.3 第三阶段：对话功能（1.5周）

- [ ] 实现用户对话功能
- [ ] 实现对话消息管理
- [ ] 实现消息回复功能
- [ ] 前端对话界面开发

### 8.4 第四阶段：高级功能（1周）

- [ ] 实现消息搜索
- [ ] 实现消息导出
- [ ] 实现消息归档
- [ ] 性能优化
- [ ] 测试和Bug修复

---

## 九、验收标准

### 9.1 功能验收

- ✅ 收件箱能够正确展示所有类型的消息
- ✅ E-SOUL来信功能正常
- ✅ 共鸣消息功能正常
- ✅ 系统消息功能正常
- ✅ 用户对话功能正常
- ✅ 消息提醒功能有效
- ✅ 消息管理功能完整

### 9.2 性能验收

- ✅ 消息列表加载时间 < 1秒
- ✅ 消息详情加载时间 < 500ms
- ✅ 消息发送响应时间 < 500ms
- ✅ 系统稳定可靠

### 9.3 用户体验验收

- ✅ 界面设计温暖友好
- ✅ 操作流程顺畅
- ✅ 消息提醒及时准确
- ✅ 空状态友好

---

## 十、风险和注意事项

### 10.1 技术风险

- **消息量**：随着用户增长，消息量可能很大，需要优化查询性能
- **实时性**：消息提醒需要实时性，需要考虑性能
- **数据一致性**：多个消息来源需要保证数据一致性

### 10.2 业务风险

- **消息滥用**：防止消息功能被滥用
- **内容安全**：需要审核用户消息内容
- **用户体验**：消息过多可能影响用户体验

### 10.3 注意事项

- 消息内容需要进行安全审核
- 保护用户隐私，不泄露用户信息
- 提供消息屏蔽和举报功能
- 优化消息推送频率，避免打扰用户
- 提供消息批量操作功能

---

**文档状态**: 需求分析已完成

