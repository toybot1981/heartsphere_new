# 跨时空信箱部署配置指南

**文档版本**: V1.0  
**更新日期**: 2025-12-31

---

## 一、部署前准备

### 1.1 环境要求

**后端环境**:
- Java 17+
- MySQL 8.0+
- Maven 3.8+
- Redis（可选，用于缓存）
- MongoDB（可选，用于记忆系统）

**前端环境**:
- Node.js 18+
- npm 或 yarn

---

## 二、数据库配置

### 2.1 数据库迁移脚本

跨时空信箱需要以下数据库表：

1. ✅ `mailbox_messages` - 统一消息表
2. ✅ `mailbox_conversations` - 对话表
3. ✅ `mailbox_conversation_messages` - 对话消息表
4. ✅ `mailbox_notification_settings` - 提醒设置表

**迁移脚本位置**: `backend/src/main/resources/db/migration/`

- `V20251230__create_mailbox_messages_table.sql`
- `V20251230__create_mailbox_conversations_table.sql`
- `V20251230__create_mailbox_conversation_messages_table.sql`
- `V20251230__create_mailbox_notification_settings_table.sql`

### 2.2 执行数据库迁移

#### 方法1: 使用Flyway（推荐）

Flyway会在应用启动时自动执行迁移脚本。

```bash
# 确保application.yml中配置了正确的数据库连接
# 启动应用，Flyway会自动执行迁移
cd backend
mvn spring-boot:run
```

#### 方法2: 手动执行SQL

```bash
# 连接到MySQL数据库
mysql -u root -p heartsphere

# 执行迁移脚本
source backend/src/main/resources/db/migration/V20251230__create_mailbox_messages_table.sql;
source backend/src/main/resources/db/migration/V20251230__create_mailbox_conversations_table.sql;
source backend/src/main/resources/db/migration/V20251230__create_mailbox_conversation_messages_table.sql;
source backend/src/main/resources/db/migration/V20251230__create_mailbox_notification_settings_table.sql;
```

### 2.3 验证数据库表

执行以下SQL验证表是否创建成功：

```sql
-- 检查表是否存在
SHOW TABLES LIKE 'mailbox_%';

-- 检查表结构
DESCRIBE mailbox_messages;
DESCRIBE mailbox_conversations;
DESCRIBE mailbox_conversation_messages;
DESCRIBE mailbox_notification_settings;

-- 检查索引
SHOW INDEX FROM mailbox_messages;
```

---

## 三、应用配置

### 3.1 数据库连接配置

编辑 `backend/src/main/resources/application.yml`:

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/heartsphere?useUnicode=true&characterEncoding=utf8mb4&useSSL=false&serverTimezone=Asia/Shanghai
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:123456}
    driver-class-name: com.mysql.cj.jdbc.Driver
  
  # Flyway配置（如果需要）
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true
    validate-on-migrate: true
```

### 3.2 JPA配置

确保JPA配置正确：

```yaml
spring:
  jpa:
    hibernate:
      ddl-auto: validate  # 生产环境使用validate，不自动创建表
    show-sql: false  # 生产环境建议关闭SQL日志
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
```

### 3.3 日志配置

跨时空信箱相关日志配置：

```yaml
logging:
  level:
    com.heartsphere.mailbox: INFO
    org.springframework.web: INFO
```

---

## 四、环境变量配置

### 4.1 生产环境变量

创建 `.env` 文件或设置环境变量：

```bash
# 数据库配置
export DB_USERNAME=your_db_username
export DB_PASSWORD=your_db_password
export DB_URL=jdbc:mysql://your_db_host:3306/heartsphere

# JWT密钥（生产环境必须修改）
export JWT_SECRET=your-production-jwt-secret-key

# AI服务配置
export DASHSCOPE_API_KEY=your-dashscope-api-key
export DOUBAO_API_KEY=your-doubao-api-key
```

### 4.2 使用Docker Compose（可选）

创建 `docker-compose.yml`:

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: heartsphere
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  mongodb:
    image: mongo:6
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db

volumes:
  mysql_data:
  mongo_data:
```

---

## 五、部署步骤

### 5.1 后端部署

#### 步骤1: 编译项目

```bash
cd backend
mvn clean package -DskipTests
```

#### 步骤2: 执行数据库迁移

```bash
# 方式1: 启动应用自动执行（Flyway）
java -jar target/heartsphere-service-*.jar

# 方式2: 手动执行迁移脚本
mysql -u root -p heartsphere < src/main/resources/db/migration/V20251230__create_mailbox_messages_table.sql
# ... 执行其他迁移脚本
```

#### 步骤3: 启动应用

```bash
# 开发环境
mvn spring-boot:run

# 生产环境
java -jar -Dspring.profiles.active=prod target/heartsphere-service-*.jar
```

### 5.2 前端部署

#### 步骤1: 安装依赖

```bash
cd frontend
npm install
```

#### 步骤2: 构建生产版本

```bash
npm run build
```

#### 步骤3: 部署到Web服务器

将 `build/` 目录部署到Nginx或其他Web服务器。

#### Nginx配置示例

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    root /path/to/frontend/build;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    location /api {
        proxy_pass http://localhost:8081;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

---

## 六、验证部署

### 6.1 数据库验证

```sql
-- 1. 检查表是否存在
SELECT COUNT(*) FROM information_schema.tables 
WHERE table_schema = 'heartsphere' 
AND table_name LIKE 'mailbox_%';
-- 应该返回 4

-- 2. 检查索引
SHOW INDEX FROM mailbox_messages;
-- 应该看到多个索引

-- 3. 测试插入（可选）
INSERT INTO mailbox_messages (
    receiver_id, sender_type, sender_id, sender_name,
    message_type, message_category, title, content, is_read
) VALUES (
    1, 'system', 0, '系统',
    'system_notification', 'system', '测试消息', '这是一条测试消息', false
);
```

### 6.2 API验证

```bash
# 1. 获取未读消息统计（需要先登录获取token）
curl -X GET "http://localhost:8081/api/mailbox/messages/unread/count" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 2. 获取消息列表
curl -X GET "http://localhost:8081/api/mailbox/messages?page=0&size=20" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 3. 获取对话列表
curl -X GET "http://localhost:8081/api/mailbox/conversations" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 6.3 前端验证

1. 打开浏览器访问前端应用
2. 登录系统
3. 打开跨时空信箱功能
4. 验证消息列表显示正常
5. 测试消息操作（已读、收藏等）

---

## 七、常见问题

### 7.1 数据库连接失败

**问题**: 无法连接到MySQL  
**解决**:
- 检查数据库服务是否启动
- 验证连接URL、用户名、密码
- 检查防火墙设置

### 7.2 Flyway迁移失败

**问题**: Flyway迁移脚本执行失败  
**解决**:
- 检查SQL语法错误
- 确认数据库用户有CREATE TABLE权限
- 查看Flyway历史表 `flyway_schema_history`

### 7.3 表已存在错误

**问题**: 表已存在，迁移失败  
**解决**:
- 如果表结构正确，可以跳过：`spring.flyway.baseline-on-migrate=true`
- 或者手动删除表后重新执行

### 7.4 索引创建失败

**问题**: 索引创建失败  
**解决**:
- 检查索引名称是否冲突
- 确认列名正确
- 检查数据量是否过大

---

## 八、生产环境检查清单

### 8.1 部署前

- [ ] 数据库备份
- [ ] 环境变量配置
- [ ] JWT密钥更换
- [ ] 数据库密码修改
- [ ] SSL证书配置
- [ ] 日志目录权限

### 8.2 部署后

- [ ] 数据库迁移执行成功
- [ ] 应用启动无错误
- [ ] API接口正常响应
- [ ] 前端页面正常显示
- [ ] 日志输出正常
- [ ] 性能监控配置

### 8.3 功能验证

- [ ] 消息创建功能
- [ ] 消息查询功能
- [ ] E-SOUL来信触发
- [ ] 对话功能
- [ ] 浏览器通知
- [ ] 提醒设置

---

## 九、回滚方案

### 9.1 数据库回滚

如果迁移出现问题，可以回滚：

```sql
-- 删除表（谨慎操作！）
DROP TABLE IF EXISTS mailbox_notification_settings;
DROP TABLE IF EXISTS mailbox_conversation_messages;
DROP TABLE IF EXISTS mailbox_conversations;
DROP TABLE IF EXISTS mailbox_messages;

-- 从Flyway历史中删除记录（如果使用Flyway）
DELETE FROM flyway_schema_history 
WHERE script LIKE 'V20251230__create_mailbox%';
```

### 9.2 应用回滚

```bash
# 恢复到上一个版本
git checkout previous-tag
mvn clean package
java -jar target/heartsphere-service-*.jar
```

---

## 十、监控和日志

### 10.1 日志位置

- 应用日志: `logs/application.log`
- SQL日志: `logs/sql.log`

### 10.2 监控指标

建议监控以下指标：
- 消息创建速率
- API响应时间
- 数据库连接池使用率
- 错误率

---

**文档状态**: 部署配置指南已创建  
**下一步**: 按照指南执行部署配置

