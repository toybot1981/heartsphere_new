# 旧新信箱系统合并分析

## 一、系统对比

### 1.1 旧信箱系统（MailboxModal）

**数据存储：**
- 数据来源：`gameState.mailbox` (本地状态)
- 数据类型：`Mail[]` 
- 存储位置：前端状态管理（reducer）

**功能特性：**
- 显示来自各个场景切片的问候
- 支持标记已读/未读
- 支持写信功能（给管理员反馈）
- 支持查看回复
- 简单的列表/详情视图

**API调用：**
- `chronosLetterApi.createUserFeedback()` - 创建用户反馈
- `chronosLetterApi.getLetterReplies()` - 获取回复

**数据结构：**
```typescript
interface Mail {
  id: string;
  type: string; // 'chronos_letter', 'user_feedback' 等
  subject: string;
  content: string;
  senderId: string;
  senderName: string;
  senderAvatarUrl?: string;
  themeColor?: string;
  timestamp: number;
  isRead: boolean;
  replies?: Mail[];
}
```

**组件位置：**
- `frontend/components/MailboxModal.tsx`
- 使用 `chronosLetterApi` API

### 1.2 新统一信箱系统（UnifiedMailboxModal）

**数据存储：**
- 数据来源：后端API（`mailboxApi`）
- 数据类型：`MailboxMessage[]`
- 存储位置：MySQL数据库（`mailbox_messages`表）

**功能特性：**
- E-SOUL来信（AI生成，基于情绪）
- 共鸣消息（点赞、评论、连接请求等）
- 系统消息（通知、反馈）
- 用户消息（私信、对话）
- 对话功能（用户间对话）
- 提醒设置
- 消息分类和筛选
- 消息标记（重要、收藏）

**API调用：**
- `mailboxApi.getMessages()` - 获取消息列表
- `mailboxApi.getUnreadCount()` - 获取未读数量
- `mailboxApi.createConversation()` - 创建对话
- 等等...

**数据结构：**
```typescript
interface MailboxMessage {
  id: number;
  receiverId: number;
  senderType: SenderType; // 'ESOUL', 'HEARTSPHERE', 'SYSTEM', 'USER'
  senderId?: number;
  senderName?: string;
  senderAvatar?: string;
  messageType: MessageType;
  messageCategory: MessageCategory; // 'ESOUL_LETTER', 'RESONANCE', 'SYSTEM', 'USER_MESSAGE'
  title?: string;
  content: string;
  isRead: boolean;
  isImportant: boolean;
  isStarred: boolean;
  createdAt: string; // ISO 8601
  // ...更多字段
}
```

**组件位置：**
- `frontend/components/mailbox/UnifiedMailboxModal.tsx`
- 使用 `mailboxApi` API

## 二、差异分析

### 2.1 数据模型差异

| 特性 | 旧系统 (Mail) | 新系统 (MailboxMessage) |
|------|--------------|------------------------|
| ID类型 | string | number |
| 时间戳 | number (Unix timestamp) | string (ISO 8601) |
| 消息类型 | type字段（字符串） | messageType + messageCategory（枚举） |
| 发送者 | senderId, senderName | senderType, senderId, senderName, senderAvatar |
| 状态 | isRead | isRead, isImportant, isStarred |
| 关联 | replies数组 | replyToId (外键) |

### 2.2 功能差异

| 功能 | 旧系统 | 新系统 |
|------|--------|--------|
| 消息类型 | chronos_letter, user_feedback | E-SOUL来信、共鸣、系统、用户消息 |
| 对话功能 | ❌ | ✅ |
| 消息分类 | ❌ | ✅ |
| 消息标记 | ❌ | ✅（重要、收藏） |
| 提醒设置 | ❌ | ✅ |
| 浏览器通知 | ❌ | ✅ |
| 消息聚合 | ❌ | ✅（共鸣消息） |

### 2.3 数据来源差异

- **旧系统**：前端状态管理（gameState.mailbox），可能来自：
  - 本地存储
  - 旧的chronos_letters表
  - 用户创建的反馈

- **新系统**：后端数据库（mailbox_messages表），统一管理

## 三、合并策略

### 3.1 数据迁移方案

#### 方案A：渐进式迁移（推荐）

**步骤：**

1. **保持兼容性**
   - 统一入口：始终使用 `UnifiedMailboxModal`
   - 检测旧数据：如果有 `gameState.mailbox` 数据，显示迁移提示
   - 数据同步：从旧数据创建新消息记录

2. **数据转换函数**
   ```typescript
   function convertOldMailToNewMessage(oldMail: Mail, userId: number): CreateMessageRequest {
     return {
       receiverId: userId,
       senderType: SenderType.ESOUL, // 或根据type判断
       senderName: oldMail.senderName,
       senderAvatar: oldMail.senderAvatarUrl,
       messageType: convertTypeToMessageType(oldMail.type),
       messageCategory: convertTypeToCategory(oldMail.type),
       title: oldMail.subject,
       content: oldMail.content,
       isRead: oldMail.isRead,
       // ...
     };
   }
   ```

3. **迁移时机**
   - 用户首次打开新信箱时
   - 或者提供一个"迁移旧数据"按钮

#### 方案B：一次性迁移

在后台创建一个迁移脚本，批量将旧数据迁移到新表。

### 3.2 功能合并方案

1. **保留旧功能**
   - "写信"功能 → 转换为创建用户反馈消息（SYSTEM类型）
   - 回复功能 → 使用新的对话系统

2. **统一入口**
   - 移除条件判断，始终使用 `UnifiedMailboxModal`
   - 在 `UnifiedMailboxModal` 内部处理数据兼容

3. **API兼容层**
   - 创建适配器，将旧的 `chronosLetterApi` 调用转换为新的 `mailboxApi`
   - 或者直接在新系统中实现这些功能

## 四、实施计划

### 阶段1：数据兼容层

1. 创建数据转换函数（旧Mail → 新MailboxMessage）
2. 在 `UnifiedMailboxModal` 中检测并迁移旧数据
3. 显示迁移进度/结果

### 阶段2：功能统一

1. 将"写信"功能集成到新系统（作为系统消息）
2. 统一API调用（使用mailboxApi）
3. 移除旧的MailboxModal组件

### 阶段3：清理

1. 移除 `gameState.mailbox` 相关代码
2. 移除旧的 `chronosLetterApi`（如果不再使用）
3. 更新所有引用

## 五、关键实现点

### 5.1 数据转换映射

| 旧Mail.type | 新MessageCategory | 新MessageType | 新SenderType |
|------------|------------------|--------------|-------------|
| 'chronos_letter' | ESOUL_LETTER | ESOUL_GREETING | ESOUL |
| 'user_feedback' | SYSTEM | SYSTEM_FEEDBACK | SYSTEM |

### 5.2 迁移时机

- **自动迁移**：用户首次打开新信箱时
- **手动迁移**：提供"导入旧信件"按钮
- **后台迁移**：系统后台批量迁移

### 5.3 兼容性处理

- 如果检测到旧数据但用户未登录 → 显示旧MailboxModal
- 如果用户已登录 → 使用新UnifiedMailboxModal，并提供迁移选项
- 迁移后，标记旧数据为已迁移，避免重复

## 六、风险评估

### 风险1：数据丢失
- **缓解**：迁移前备份，迁移后验证

### 风险2：用户体验中断
- **缓解**：渐进式迁移，保持功能可用

### 风险3：性能影响
- **缓解**：批量迁移，异步处理


