# 跨时空信箱开发计划

**文档版本**: V1.0  
**编写日期**: 2025-12-30  
**功能模块**: 跨时空信箱  
**预计工期**: 6周

---

## 一、项目概述

### 1.1 项目目标

基于需求分析和架构设计，分阶段实现完整的跨时空信箱系统，包括：
- 统一收件箱
- E-SOUL来信功能
- 共鸣消息功能
- 系统消息功能
- 用户对话功能
- 消息管理和提醒功能

### 1.2 开发原则

1. **迭代开发**：分阶段实现，每个阶段可独立交付
2. **向后兼容**：保留现有chronos_letters表，逐步迁移
3. **测试驱动**：每个功能开发完成后进行测试
4. **文档同步**：代码与文档同步更新

---

## 二、开发阶段规划

### 阶段一：基础架构和数据模型（1.5周）

**目标**：建立基础架构和数据库模型

#### 任务清单

**后端任务**：

- [ ] 1.1 创建数据库迁移脚本
  - [ ] 创建 `mailbox_messages` 表
  - [ ] 创建 `mailbox_conversations` 表
  - [ ] 创建 `mailbox_conversation_messages` 表
  - [ ] 创建 `mailbox_notification_settings` 表
  - [ ] 创建必要的索引

- [ ] 1.2 创建实体类
  - [ ] `MailboxMessage` 实体
  - [ ] `Conversation` 实体
  - [ ] `ConversationMessage` 实体
  - [ ] `NotificationSettings` 实体

- [ ] 1.3 创建Repository层
  - [ ] `MailboxMessageRepository`
  - [ ] `ConversationRepository`
  - [ ] `ConversationMessageRepository`
  - [ ] `NotificationSettingsRepository`

- [ ] 1.4 创建DTO和枚举
  - [ ] `MessageType` 枚举
  - [ ] `MessageCategory` 枚举
  - [ ] `SenderType` 枚举
  - [ ] 相关DTO类

**前端任务**：

- [ ] 1.5 创建类型定义
  - [ ] `MailboxMessage` 类型
  - [ ] `Conversation` 类型
  - [ ] `ConversationMessage` 类型
  - [ ] `NotificationSettings` 类型
  - [ ] 相关枚举类型

- [ ] 1.6 创建API服务基础结构
  - [ ] `mailboxApi.ts` 基础结构
  - [ ] API请求类型定义

**测试任务**：

- [ ] 1.7 数据库迁移测试
- [ ] 1.8 实体类单元测试

**验收标准**：
- ✅ 数据库表创建成功
- ✅ 实体类定义完整
- ✅ Repository基础查询方法正常
- ✅ 类型定义完整

---

### 阶段二：统一消息服务（1周）

**目标**：实现统一的消息管理服务

#### 任务清单

**后端任务**：

- [ ] 2.1 实现 `MailboxMessageService`
  - [ ] 消息创建方法
  - [ ] 消息查询方法（列表、详情）
  - [ ] 消息更新方法（已读、重要、收藏）
  - [ ] 消息删除方法（单个、批量）
  - [ ] 消息搜索方法

- [ ] 2.2 实现 `MailboxMessageController`
  - [ ] GET `/api/mailbox/messages` - 获取消息列表
  - [ ] GET `/api/mailbox/messages/{id}` - 获取消息详情
  - [ ] PUT `/api/mailbox/messages/{id}/read` - 标记已读
  - [ ] PUT `/api/mailbox/messages/{id}/important` - 标记重要
  - [ ] PUT `/api/mailbox/messages/{id}/star` - 收藏/取消收藏
  - [ ] DELETE `/api/mailbox/messages/{id}` - 删除消息
  - [ ] DELETE `/api/mailbox/messages/batch` - 批量删除
  - [ ] GET `/api/mailbox/messages/unread/count` - 获取未读数量

- [ ] 2.3 实现消息查询优化
  - [ ] 分页查询
  - [ ] 分类筛选
  - [ ] 状态筛选
  - [ ] 时间范围筛选

**前端任务**：

- [ ] 2.4 实现 `MailboxApi` 服务
  - [ ] 消息列表API
  - [ ] 消息详情API
  - [ ] 消息操作API
  - [ ] 未读统计API

- [ ] 2.5 实现基础消息列表组件
  - [ ] `MessageList` 组件
  - [ ] `MessageCard` 组件
  - [ ] 消息筛选组件

**测试任务**：

- [ ] 2.6 消息服务单元测试
- [ ] 2.7 API接口集成测试
- [ ] 2.8 前端组件测试

**验收标准**：
- ✅ 消息CRUD功能正常
- ✅ 消息查询和筛选正常
- ✅ API接口测试通过
- ✅ 前端基础界面正常显示

---

### 阶段三：E-SOUL来信功能（1周）

**目标**：实现E-SOUL主动来信功能

#### 任务清单

**后端任务**：

- [ ] 3.1 实现 `ESoulLetterService`
  - [ ] 触发条件检查方法
  - [ ] 发件人选择逻辑
  - [ ] 上下文收集方法（日记、对话历史）
  - [ ] 来信生成方法（调用AI服务）

- [ ] 3.2 实现 `ESoulLetterGenerator`
  - [ ] 来信内容生成（调用AI）
  - [ ] 来信个性化处理
  - [ ] 来信类型模板

- [ ] 3.3 实现触发机制
  - [ ] 用户登录时检查离线时间
  - [ ] 定时任务检查（每日首次使用）
  - [ ] 情绪触发机制（可选）

- [ ] 3.4 实现 `ESoulLetterController`
  - [ ] POST `/api/mailbox/esoul-letters` - 触发来信（内部）
  - [ ] POST `/api/mailbox/esoul-letters/{messageId}/reply` - 回复来信

- [ ] 3.5 集成AI服务
  - [ ] 调用AIService生成来信内容
  - [ ] 错误处理和降级策略

**前端任务**：

- [ ] 3.6 实现E-SOUL来信展示
  - [ ] 来信卡片特殊样式
  - [ ] 来信详情页面
  - [ ] 回复功能

**测试任务**：

- [ ] 3.7 E-SOUL来信服务测试
- [ ] 3.8 AI生成测试
- [ ] 3.9 触发机制测试

**验收标准**：
- ✅ E-SOUL来信能够正常生成
- ✅ 来信内容个性化
- ✅ 触发机制正常工作
- ✅ 来信展示正常

---

### 阶段四：共鸣消息和系统消息（1周）

**目标**：实现共鸣消息和系统消息功能

#### 任务清单

**后端任务**：

- [ ] 4.1 实现 `ResonanceMessageService`
  - [ ] 处理点赞消息
  - [ ] 处理评论消息
  - [ ] 处理留言消息
  - [ ] 处理分享消息
  - [ ] 处理连接请求消息

- [ ] 4.2 实现 `SystemMessageService`
  - [ ] 发送系统通知
  - [ ] 发送系统反馈请求
  - [ ] 处理系统对话

- [ ] 4.3 集成心域连接系统
  - [ ] 与HeartConnectService集成
  - [ ] 监听互动事件
  - [ ] 自动创建共鸣消息

- [ ] 4.4 实现相关Controller
  - [ ] POST `/api/mailbox/resonance-messages` - 创建共鸣消息（内部）
  - [ ] POST `/api/mailbox/system-messages` - 发送系统消息（内部）
  - [ ] 回复接口

**前端任务**：

- [ ] 4.5 实现共鸣消息展示
  - [ ] 共鸣消息卡片
  - [ ] 关联内容预览
  - [ ] 快速回复功能

- [ ] 4.6 实现系统消息展示
  - [ ] 系统消息卡片
  - [ ] 系统对话界面

**测试任务**：

- [ ] 4.7 共鸣消息服务测试
- [ ] 4.8 系统消息服务测试
- [ ] 4.9 集成测试

**验收标准**：
- ✅ 共鸣消息能够正常创建和展示
- ✅ 系统消息功能正常
- ✅ 与心域连接系统集成正常

---

### 阶段五：用户对话功能（1周）

**目标**：实现用户间对话功能

#### 任务清单

**后端任务**：

- [ ] 5.1 实现 `ConversationService`
  - [ ] 创建对话
  - [ ] 获取对话列表
  - [ ] 获取对话详情
  - [ ] 发送消息
  - [ ] 获取消息列表
  - [ ] 标记已读
  - [ ] 置顶/取消置顶
  - [ ] 免打扰设置
  - [ ] 删除对话

- [ ] 5.2 实现 `ConversationController`
  - [ ] GET `/api/mailbox/conversations` - 获取对话列表
  - [ ] POST `/api/mailbox/conversations` - 创建对话
  - [ ] GET `/api/mailbox/conversations/{id}` - 获取对话详情
  - [ ] GET `/api/mailbox/conversations/{id}/messages` - 获取消息列表
  - [ ] POST `/api/mailbox/conversations/{id}/messages` - 发送消息
  - [ ] PUT `/api/mailbox/conversations/{id}/read` - 标记已读
  - [ ] PUT `/api/mailbox/conversations/{id}/pin` - 置顶
  - [ ] PUT `/api/mailbox/conversations/{id}/mute` - 免打扰
  - [ ] DELETE `/api/mailbox/conversations/{id}` - 删除对话

**前端任务**：

- [ ] 5.3 实现对话列表组件
  - [ ] `ConversationList` 组件
  - [ ] `ConversationItem` 组件

- [ ] 5.4 实现对话界面组件
  - [ ] `ConversationView` 组件
  - [ ] `MessageBubble` 组件
  - [ ] `MessageInput` 组件
  - [ ] 消息发送和接收
  - [ ] 消息分页加载

**测试任务**：

- [ ] 5.5 对话服务测试
- [ ] 5.6 对话界面测试

**验收标准**：
- ✅ 用户间对话功能正常
- ✅ 消息发送和接收正常
- ✅ 对话状态管理正常
- ✅ 对话界面交互流畅

---

### 阶段六：消息提醒和前端优化（0.5周）

**目标**：完善消息提醒功能和前端优化

#### 任务清单

**后端任务**：

- [ ] 6.1 实现 `NotificationService`
  - [ ] 提醒设置管理
  - [ ] 未读消息统计
  - [ ] 提醒规则判断

- [ ] 6.2 实现 `NotificationSettingsController`
  - [ ] GET `/api/mailbox/notification-settings` - 获取设置
  - [ ] PUT `/api/mailbox/notification-settings` - 更新设置

- [ ] 6.3 实现提醒推送（可选）
  - [ ] WebSocket集成（可选）
  - [ ] 浏览器通知（可选）

**前端任务**：

- [ ] 6.4 实现消息提醒功能
  - [ ] 未读数量徽章
  - [ ] 新消息弹窗提醒
  - [ ] 提醒设置界面

- [ ] 6.5 完善收件箱界面
  - [ ] `MailboxModal` 组件完善
  - [ ] 消息分类导航
  - [ ] 消息搜索功能
  - [ ] 消息筛选功能
  - [ ] 响应式优化

- [ ] 6.6 性能优化
  - [ ] 虚拟滚动（长列表）
  - [ ] 防抖节流
  - [ ] 数据预加载

**测试任务**：

- [ ] 6.7 提醒功能测试
- [ ] 6.8 前端性能测试
- [ ] 6.9 端到端测试

**验收标准**：
- ✅ 消息提醒功能正常
- ✅ 收件箱界面完整
- ✅ 性能满足要求
- ✅ 响应式布局正常

---

## 三、数据迁移计划

### 3.1 迁移策略

1. **保留旧表**：保持 `chronos_letters` 表不变
2. **数据同步**：新系统与旧系统并行运行一段时间
3. **逐步迁移**：提供迁移脚本，支持数据迁移
4. **前端兼容**：前端统一使用新API，后端兼容旧数据

### 3.2 迁移脚本

- [ ] 编写数据迁移脚本
  - [ ] 将 `chronos_letters` 数据迁移到 `mailbox_messages`
  - [ ] 数据映射和转换
  - [ ] 验证迁移结果

---

## 四、测试计划

### 4.1 单元测试

- [ ] 服务层方法测试（覆盖率 > 80%）
- [ ] Repository层测试
- [ ] 工具类测试

### 4.2 集成测试

- [ ] API接口集成测试
- [ ] 数据库操作测试
- [ ] 消息流程测试

### 4.3 性能测试

- [ ] 消息列表查询性能（< 1秒）
- [ ] 消息详情加载性能（< 500ms）
- [ ] 并发消息发送测试

### 4.4 前端测试

- [ ] 组件渲染测试
- [ ] 交互测试
- [ ] 响应式测试

### 4.5 端到端测试

- [ ] 完整用户流程测试
- [ ] 跨浏览器测试
- [ ] 移动端测试

---

## 五、风险与应对

### 5.1 技术风险

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| AI服务调用失败 | 高 | 实现降级策略，使用模板生成 |
| 数据库性能问题 | 中 | 优化索引，使用缓存 |
| 消息量过大 | 中 | 实现分页和归档机制 |

### 5.2 业务风险

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 消息被滥用 | 中 | 实现频率限制和内容审核 |
| 用户体验不佳 | 中 | 充分测试，收集反馈 |

### 5.3 时间风险

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 开发时间超期 | 中 | 优先级排序，分阶段交付 |
| 依赖系统延迟 | 中 | 提前沟通，使用Mock数据 |

---

## 六、进度跟踪

### 6.1 每日站会

- 每日进度汇报
- 问题和阻塞讨论
- 任务调整

### 6.2 周报

- 每周进度总结
- 下周计划
- 风险和问题

### 6.3 里程碑

- **里程碑1**（1.5周）：基础架构完成
- **里程碑2**（2.5周）：统一消息服务完成
- **里程碑3**（3.5周）：E-SOUL来信功能完成
- **里程碑4**（4.5周）：共鸣和系统消息完成
- **里程碑5**（5.5周）：对话功能完成
- **里程碑6**（6周）：整体功能完成

---

## 七、交付物清单

### 7.1 代码交付

- [ ] 后端代码（Java）
- [ ] 前端代码（TypeScript/React）
- [ ] 数据库迁移脚本
- [ ] 配置文件

### 7.2 文档交付

- [ ] API接口文档
- [ ] 数据库设计文档
- [ ] 部署文档
- [ ] 用户使用手册

### 7.3 测试交付

- [ ] 单元测试报告
- [ ] 集成测试报告
- [ ] 性能测试报告
- [ ] 测试用例文档

---

## 八、后续优化计划

### 8.1 功能优化

- [ ] WebSocket实时推送
- [ ] 消息全文搜索
- [ ] 消息导出功能
- [ ] 消息归档功能

### 8.2 性能优化

- [ ] Redis缓存优化
- [ ] 数据库查询优化
- [ ] 前端性能优化

### 8.3 用户体验优化

- [ ] 消息智能分类
- [ ] 消息推荐功能
- [ ] 多设备同步

---

## 九、资源需求

### 9.1 人力资源

- **后端开发**：1人，6周
- **前端开发**：1人，6周
- **测试**：0.5人，最后2周
- **产品/设计**：支持，按需

### 9.2 技术资源

- 开发环境
- 测试环境
- 数据库资源
- AI服务配额

---

**文档状态**: 开发计划已制定

