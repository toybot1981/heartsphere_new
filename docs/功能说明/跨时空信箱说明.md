# 跨时空信箱说明

## 📬 什么是跨时空信箱？

跨时空信箱是一个充满温情的功能，让角色在你离线后能够主动联系你，通过信件的方式表达对你的关心和思念。这些信件不是简单的通知，而是由AI生成的、充满个性和情感的真实信件。

---

## ⏰ 什么时候会收到信件？

### 触发条件

1. **离线时间超过60秒**
   - 当你离开应用超过1分钟后重新登录，系统会自动检查并生成信件
   - 离线时间越长，收到信件的可能性越大

2. **有可用的角色**
   - 系统会优先选择你最近聊过的角色作为发件人
   - 如果没有聊过的角色，会选择第一个场景的第一个角色

3. **AI服务正常**
   - 需要AI服务能够正常生成信件内容
   - 如果AI服务调用失败，信件生成会静默失败（不会显示错误）

---

## 👤 谁会发送信件？

### 发件人选择逻辑

1. **优先选择：最近聊过的角色** ⭐
   - 如果你之前与某个角色有过对话，系统会优先选择这个角色
   - 这样信件会更有连贯性和情感连接
   - 信件会提到你们之前的对话内容

2. **备选方案：第一个场景的第一个角色**
   - 如果你还没有与任何角色聊过天
   - 系统会选择你第一个场景中的第一个角色作为发件人

3. **信件内容个性化**
   - 发件人会根据你的日记内容（如果有）来写信件
   - 信件会提到你之前写过的日记，让信件更加真实和贴心
   - 每封信都是AI根据角色性格和你的互动历史生成的

## 为什么现在没有信？

可能的原因：

1. **离线时间不足**
   - 如果你刚刚登录或频繁刷新页面，离线时间可能不足60秒
   - 解决：等待一段时间后重新登录

2. **没有可用角色**
   - 如果所有场景都没有角色，无法生成信件
   - 解决：确保至少有一个场景包含角色

3. **AI服务调用失败**
   - 如果AI服务出现错误（如之前的messages数组为空错误），信件生成会失败
   - 解决：检查AI服务配置和日志

4. **已经检查过**
   - 系统只会在首次加载时检查一次，刷新页面后不会再次检查
   - 解决：清除浏览器缓存或等待下次登录

## 信件的特点

- **个性化内容**：每封信都是AI根据角色性格和你的日记内容生成的
- **情感连接**：发件人会提到你们之前的对话或你的日记
- **真实感**：信件格式和内容都模拟真实的手写信件
- **主题色**：每封信使用发件人的主题色，保持视觉一致性

## 如何查看信件？

1. 点击界面上的"信箱"图标
2. 在信箱模态框中查看所有收到的信件
3. 点击信件可以查看完整内容
4. 未读信件会有特殊标记

## 技术实现

- **检查时机**：应用首次加载完成且用户信息加载后
- **生成方式**：调用AI服务生成JSON格式的信件（包含subject和content）
- **存储方式**：
  - ✅ **当前**：信件存储在本地浏览器中（IndexedDB 或 localStorage）
  - ❌ **未实现**：信件暂未存储到数据库
  - ⚠️ **影响**：
    - 同一浏览器中，刷新页面后信件会保留
    - 清除浏览器数据后，信件会丢失
    - 不同设备之间不会同步信件

## 未来改进方向

1. **持久化存储**：将信件保存到数据库，避免刷新后丢失
2. **更多触发条件**：除了离线时间，还可以基于其他条件触发
3. **信件类型**：支持不同类型的信件（问候、关心、回忆等）
4. **回复功能**：允许用户回复信件，形成对话
5. **信件收藏**：允许用户收藏特别喜欢的信件

