# 温度感引擎架构设计文档

**文档版本**: V1.0  
**编写日期**: 2025-12-28  
**定位**: 心域温度感引擎 - 独立模块，支撑系统温度感调节

---

## 一、引擎定位

### 1.1 核心概念

**温度感引擎（Temperature Engine）**是一个独立的、可插拔的模块系统，负责：

1. **温度感计算**：根据用户行为、情绪、上下文计算系统温度感
2. **温度感调节**：动态调整UI、交互、内容以匹配目标温度感
3. **个性化适配**：根据用户偏好调整温度感表现
4. **情感分析**：分析用户情绪，提供情感化响应

### 1.2 设计原则

- ✅ **独立性**：作为独立模块，不依赖特定UI框架
- ✅ **可插拔**：支持插件扩展，易于添加新功能
- ✅ **可配置**：丰富的配置选项，支持不同场景
- ✅ **高性能**：轻量级，不影响系统性能
- ✅ **可观测**：提供监控和调试能力

---

## 二、架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    心域应用层                            │
│  (ChatWindow, EntryPoint, Settings, etc.)              │
└────────────────────┬────────────────────────────────────┘
                     │
                     │ API调用
                     ▼
┌─────────────────────────────────────────────────────────┐
│              温度感引擎 (Temperature Engine)             │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │  核心引擎    │  │  插件系统    │  │  配置系统    │ │
│  │   (Core)     │  │  (Plugins)   │  │  (Config)    │ │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘ │
│         │                  │                  │         │
│  ┌──────▼──────────────────▼──────────────────▼──────┐ │
│  │           温度感计算层 (Temperature Calculator)   │ │
│  │  - 情绪分析 (Emotion Analyzer)                     │ │
│  │  - 上下文感知 (Context Awareness)                  │ │
│  │  - 温度感评分 (Temperature Score)                  │ │
│  └──────┬─────────────────────────────────────────────┘ │
│         │                                                 │
│  ┌──────▼─────────────────────────────────────────────┐ │
│  │        温度感调节层 (Temperature Adjuster)         │ │
│  │  - UI调节器 (UI Adjuster)                          │ │
│  │  - 交互调节器 (Interaction Adjuster)                │ │
│  │  - 内容调节器 (Content Adjuster)                    │ │
│  │  - 角色调节器 (Character Adjuster)                  │ │
│  └──────┬─────────────────────────────────────────────┘ │
│         │                                                 │
│  ┌──────▼─────────────────────────────────────────────┐ │
│  │        事件系统 (Event System)                      │ │
│  │  - 事件监听 (Event Listeners)                       │ │
│  │  - 事件分发 (Event Dispatcher)                      │ │
│  │  - 事件处理 (Event Handlers)                        │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                     │
                     │ 输出
                     ▼
┌─────────────────────────────────────────────────────────┐
│              渲染层 (Rendering Layer)                    │
│  - UI组件更新                                           │
│  - 样式应用                                             │
│  - 动画触发                                             │
└─────────────────────────────────────────────────────────┘
```

### 2.2 核心模块

#### 模块1：核心引擎 (Core Engine)

**职责**：
- 引擎初始化和生命周期管理
- 模块协调和通信
- 状态管理
- API暴露

**文件结构**：
```
frontend/services/temperature-engine/
├── core/
│   ├── TemperatureEngine.ts      # 核心引擎类
│   ├── EngineState.ts             # 引擎状态管理
│   └── EngineAPI.ts               # 对外API
```

#### 模块2：温度感计算层 (Temperature Calculator)

**职责**：
- 分析用户情绪
- 计算上下文温度感
- 生成温度感评分
- 预测温度感趋势

**文件结构**：
```
frontend/services/temperature-engine/
├── calculator/
│   ├── EmotionAnalyzer.ts         # 情绪分析器
│   ├── ContextAwareness.ts         # 上下文感知
│   ├── TemperatureScorer.ts        # 温度感评分器
│   └── TemperaturePredictor.ts     # 温度感预测器
```

#### 模块3：温度感调节层 (Temperature Adjuster)

**职责**：
- UI样式调节
- 交互行为调节
- 内容生成调节
- 角色表现调节

**文件结构**：
```
frontend/services/temperature-engine/
├── adjusters/
│   ├── UIAdjuster.ts              # UI调节器
│   ├── InteractionAdjuster.ts     # 交互调节器
│   ├── ContentAdjuster.ts         # 内容调节器
│   └── CharacterAdjuster.ts       # 角色调节器
```

#### 模块4：插件系统 (Plugin System)

**职责**：
- 插件注册和管理
- 插件生命周期
- 插件通信
- 插件配置

**文件结构**：
```
frontend/services/temperature-engine/
├── plugins/
│   ├── PluginManager.ts            # 插件管理器
│   ├── PluginInterface.ts         # 插件接口
│   ├── builtin/                    # 内置插件
│   │   ├── GreetingPlugin.ts      # 问候插件
│   │   ├── ExpressionPlugin.ts    # 表情插件
│   │   └── DialoguePlugin.ts      # 对话插件
│   └── custom/                     # 自定义插件（扩展点）
```

#### 模块5：配置系统 (Configuration System)

**职责**：
- 配置管理
- 配置验证
- 配置持久化
- 配置热更新

**文件结构**：
```
frontend/services/temperature-engine/
├── config/
│   ├── TemperatureConfig.ts       # 配置定义
│   ├── ConfigManager.ts           # 配置管理器
│   └── ConfigValidator.ts         # 配置验证器
```

#### 模块6：事件系统 (Event System)

**职责**：
- 事件定义
- 事件监听
- 事件分发
- 事件处理

**文件结构**：
```
frontend/services/temperature-engine/
├── events/
│   ├── EventSystem.ts             # 事件系统
│   ├── EventTypes.ts              # 事件类型定义
│   └── EventHandlers.ts           # 事件处理器
```

---

## 三、核心API设计

### 3.1 引擎初始化

```typescript
import { TemperatureEngine } from './services/temperature-engine';

// 初始化引擎
const engine = new TemperatureEngine({
  config: {
    enabled: true,
    temperature: 'warm', // 'cold' | 'neutral' | 'warm' | 'hot'
    features: {
      emotionAnalysis: true,
      contextAwareness: true,
      uiAdjustment: true,
      characterAdjustment: true,
    },
  },
  plugins: [
    'greeting',
    'expression',
    'dialogue',
  ],
});

// 启动引擎
await engine.start();

// 注册事件监听
engine.on('temperatureChanged', (temperature) => {
  console.log('温度感变化:', temperature);
});

engine.on('emotionDetected', (emotion) => {
  console.log('检测到情绪:', emotion);
});
```

### 3.2 温度感计算API

```typescript
// 计算当前温度感
const temperature = await engine.calculateTemperature({
  userEmotion: 'happy',
  context: {
    timeOfDay: 'morning',
    conversationLength: 10,
    lastInteraction: Date.now() - 1000,
  },
  history: conversationHistory,
});

// 获取温度感评分 (0-100)
const score = temperature.score; // 75
const level = temperature.level; // 'warm'

// 获取温度感建议
const suggestions = temperature.suggestions;
// [
//   { type: 'greeting', priority: 'high', action: 'showMorningGreeting' },
//   { type: 'expression', priority: 'medium', action: 'showHappyFace' },
// ]
```

### 3.3 温度感调节API

```typescript
// 调节UI温度感
await engine.adjustUI({
  targetTemperature: 'warm',
  elements: ['button', 'card', 'input'],
  animation: true,
});

// 调节交互温度感
await engine.adjustInteraction({
  type: 'greeting',
  content: '早上好！新的一天开始了呢 ✨',
  style: 'warm',
});

// 调节内容温度感
const adjustedContent = await engine.adjustContent({
  original: '你好',
  targetTemperature: 'warm',
  context: { timeOfDay: 'morning' },
});
// 返回: '早上好！新的一天开始了呢 ✨'

// 调节角色温度感
await engine.adjustCharacter({
  characterId: 'character-1',
  expression: 'happy',
  action: 'waving',
  temperature: 'warm',
});
```

### 3.4 情绪分析API

```typescript
// 分析用户情绪
const emotion = await engine.analyzeEmotion({
  text: '我今天很开心！',
  context: {
    conversationHistory: [...],
    userProfile: {...},
  },
});

// 返回:
// {
//   type: 'happy',
//   confidence: 0.85,
//   intensity: 0.7,
//   suggestions: [
//     { type: 'expression', value: 'happy' },
//     { type: 'greeting', value: '看到你开心我也很高兴！' },
//   ],
// }
```

### 3.5 插件API

```typescript
// 注册自定义插件
engine.registerPlugin({
  id: 'custom-greeting',
  name: '自定义问候',
  version: '1.0.0',
  onInit: () => {
    console.log('插件初始化');
  },
  onTemperatureChange: (temperature) => {
    // 处理温度感变化
  },
  onEmotionDetected: (emotion) => {
    // 处理情绪检测
  },
});

// 启用/禁用插件
engine.enablePlugin('custom-greeting');
engine.disablePlugin('custom-greeting');
```

---

## 四、温度感计算模型

### 4.1 温度感评分算法

```typescript
interface TemperatureScore {
  score: number;        // 0-100
  level: 'cold' | 'neutral' | 'warm' | 'hot';
  factors: {
    emotion: number;    // 情绪因子 (0-1)
    context: number;    // 上下文因子 (0-1)
    history: number;    // 历史因子 (0-1)
    interaction: number; // 交互因子 (0-1)
  };
  suggestions: Suggestion[];
}

// 计算公式
score = (
  emotion * 0.4 +
  context * 0.3 +
  history * 0.2 +
  interaction * 0.1
) * 100;

level = 
  score < 30 ? 'cold' :
  score < 60 ? 'neutral' :
  score < 80 ? 'warm' : 'hot';
```

### 4.2 情绪分析模型

```typescript
interface EmotionAnalysis {
  type: EmotionType;
  confidence: number;  // 0-1
  intensity: number;   // 0-1
  factors: {
    text: number;      // 文本分析
    context: number;   // 上下文分析
    history: number;   // 历史分析
  };
}

// 情绪类型
type EmotionType = 
  | 'happy'      // 开心
  | 'sad'         // 难过
  | 'anxious'     // 焦虑
  | 'calm'        // 平静
  | 'excited'     // 兴奋
  | 'tired'       // 疲惫
  | 'neutral';    // 中性
```

### 4.3 上下文感知模型

```typescript
interface Context {
  timeOfDay: 'morning' | 'afternoon' | 'evening' | 'night';
  dayOfWeek: number;           // 0-6
  season: 'spring' | 'summer' | 'autumn' | 'winter';
  weather?: string;
  location?: string;
  device: 'desktop' | 'mobile' | 'tablet';
  connectionSpeed?: 'fast' | 'medium' | 'slow';
  userActivity: {
    sessionDuration: number;
    messageCount: number;
    lastInteraction: number;
  };
  conversation: {
    length: number;
    topic?: string;
    sentiment: 'positive' | 'neutral' | 'negative';
  };
}
```

---

## 五、插件系统设计

### 5.1 插件接口

```typescript
interface TemperaturePlugin {
  id: string;
  name: string;
  version: string;
  description?: string;
  
  // 生命周期钩子
  onInit?: (engine: TemperatureEngine) => void | Promise<void>;
  onStart?: () => void | Promise<void>;
  onStop?: () => void | Promise<void>;
  onDestroy?: () => void | Promise<void>;
  
  // 事件钩子
  onTemperatureChange?: (temperature: TemperatureScore) => void;
  onEmotionDetected?: (emotion: EmotionAnalysis) => void;
  onContextUpdate?: (context: Context) => void;
  onUserInteraction?: (interaction: UserInteraction) => void;
  
  // 配置
  config?: PluginConfig;
  
  // 方法
  methods?: {
    [key: string]: (...args: any[]) => any;
  };
}
```

### 5.2 内置插件示例

#### 问候插件 (GreetingPlugin)

```typescript
class GreetingPlugin implements TemperaturePlugin {
  id = 'greeting';
  name = '问候插件';
  version = '1.0.0';
  
  onTemperatureChange(temperature: TemperatureScore) {
    if (temperature.level === 'warm') {
      // 显示温暖的问候
      this.showWarmGreeting();
    }
  }
  
  onEmotionDetected(emotion: EmotionAnalysis) {
    // 根据情绪调整问候
    const greeting = this.selectGreeting(emotion);
    this.displayGreeting(greeting);
  }
  
  private showWarmGreeting() {
    // 实现逻辑
  }
  
  private selectGreeting(emotion: EmotionAnalysis): string {
    // 实现逻辑
  }
}
```

#### 表情插件 (ExpressionPlugin)

```typescript
class ExpressionPlugin implements TemperaturePlugin {
  id = 'expression';
  name = '表情插件';
  version = '1.0.0';
  
  onEmotionDetected(emotion: EmotionAnalysis) {
    // 根据情绪更新角色表情
    const expression = this.mapEmotionToExpression(emotion.type);
    this.updateCharacterExpression(expression);
  }
  
  private mapEmotionToExpression(emotion: EmotionType): ExpressionType {
    const mapping = {
      happy: 'happy',
      sad: 'sad',
      anxious: 'thinking',
      calm: 'neutral',
      // ...
    };
    return mapping[emotion] || 'neutral';
  }
}
```

---

## 六、配置系统设计

### 6.1 配置结构

```typescript
interface TemperatureEngineConfig {
  // 基础配置
  enabled: boolean;
  mode: 'auto' | 'manual' | 'hybrid';
  
  // 温度感配置
  temperature: {
    default: 'warm' | 'neutral' | 'cold';
    range: {
      min: number;  // 0-100
      max: number;  // 0-100
    };
    sensitivity: 'low' | 'medium' | 'high';
  };
  
  // 功能配置
  features: {
    emotionAnalysis: boolean;
    contextAwareness: boolean;
    uiAdjustment: boolean;
    characterAdjustment: boolean;
    contentAdjustment: boolean;
  };
  
  // 性能配置
  performance: {
    updateInterval: number;      // 更新间隔（毫秒）
    cacheEnabled: boolean;        // 启用缓存
    lazyLoad: boolean;             // 懒加载
    debounceDelay: number;        // 防抖延迟
  };
  
  // 插件配置
  plugins: {
    enabled: string[];            // 启用的插件ID列表
    config: Record<string, any>;  // 插件特定配置
  };
  
  // UI配置
  ui: {
    animation: {
      enabled: boolean;
      duration: number;
      easing: string;
    };
    colors: {
      warm: ColorScheme;
      neutral: ColorScheme;
      cold: ColorScheme;
    };
  };
}
```

### 6.2 配置管理

```typescript
class ConfigManager {
  private config: TemperatureEngineConfig;
  
  // 加载配置
  load(config?: Partial<TemperatureEngineConfig>): void {
    const defaultConfig = this.getDefaultConfig();
    const savedConfig = this.loadFromStorage();
    this.config = merge(defaultConfig, savedConfig, config);
  }
  
  // 保存配置
  save(): void {
    localStorage.setItem('temperature_engine_config', JSON.stringify(this.config));
  }
  
  // 更新配置
  update(updates: Partial<TemperatureEngineConfig>): void {
    this.config = merge(this.config, updates);
    this.save();
    this.notifyConfigChange();
  }
  
  // 验证配置
  validate(config: TemperatureEngineConfig): ValidationResult {
    // 实现验证逻辑
  }
}
```

---

## 七、事件系统设计

### 7.1 事件类型

```typescript
// 温度感相关事件
type TemperatureEvent = 
  | 'temperatureChanged'      // 温度感变化
  | 'temperatureCalculated'   // 温度感计算完成
  | 'temperatureAdjusted';    // 温度感调节完成

// 情绪相关事件
type EmotionEvent =
  | 'emotionDetected'         // 情绪检测
  | 'emotionChanged'          // 情绪变化
  | 'emotionAnalyzed';        // 情绪分析完成

// 上下文相关事件
type ContextEvent =
  | 'contextUpdated'          // 上下文更新
  | 'contextChanged';         // 上下文变化

// 交互相关事件
type InteractionEvent =
  | 'userInteraction'         // 用户交互
  | 'messageSent'             // 消息发送
  | 'messageReceived';        // 消息接收

// 插件相关事件
type PluginEvent =
  | 'pluginRegistered'        // 插件注册
  | 'pluginEnabled'           // 插件启用
  | 'pluginDisabled';         // 插件禁用
```

### 7.2 事件系统实现

```typescript
class EventSystem {
  private listeners: Map<string, Set<EventListener>> = new Map();
  
  // 注册事件监听
  on(event: string, listener: EventListener): void {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, new Set());
    }
    this.listeners.get(event)!.add(listener);
  }
  
  // 移除事件监听
  off(event: string, listener: EventListener): void {
    this.listeners.get(event)?.delete(listener);
  }
  
  // 触发事件
  emit(event: string, data?: any): void {
    const listeners = this.listeners.get(event);
    if (listeners) {
      listeners.forEach(listener => {
        try {
          listener(data);
        } catch (error) {
          console.error(`Error in event listener for ${event}:`, error);
        }
      });
    }
  }
  
  // 一次性事件监听
  once(event: string, listener: EventListener): void {
    const wrapper = (data: any) => {
      listener(data);
      this.off(event, wrapper);
    };
    this.on(event, wrapper);
  }
}
```

---

## 八、使用示例

### 8.1 基础使用

```typescript
import { TemperatureEngine } from './services/temperature-engine';

// 创建引擎实例
const engine = new TemperatureEngine({
  config: {
    enabled: true,
    temperature: { default: 'warm' },
    features: {
      emotionAnalysis: true,
      uiAdjustment: true,
    },
  },
});

// 启动引擎
await engine.start();

// 监听温度感变化
engine.on('temperatureChanged', (temperature) => {
  console.log('当前温度感:', temperature.level, temperature.score);
  
  // 根据温度感调整UI
  if (temperature.level === 'warm') {
    document.body.classList.add('temperature-warm');
  }
});

// 分析用户消息
const emotion = await engine.analyzeEmotion({
  text: userMessage,
  context: currentContext,
});

// 调节内容温度感
const warmMessage = await engine.adjustContent({
  original: aiResponse,
  targetTemperature: 'warm',
});
```

### 8.2 在ChatWindow中集成

```typescript
// ChatWindow.tsx
import { useTemperatureEngine } from '../services/temperature-engine/hooks/useTemperatureEngine';

function ChatWindow() {
  const engine = useTemperatureEngine();
  
  useEffect(() => {
    // 启动引擎
    engine.start();
    
    // 监听温度感变化
    engine.on('temperatureChanged', (temperature) => {
      // 更新UI
      updateUI(temperature);
    });
    
    // 监听情绪检测
    engine.on('emotionDetected', (emotion) => {
      // 更新角色表情
      updateCharacterExpression(emotion.type);
    });
    
    return () => {
      engine.stop();
    };
  }, []);
  
  const handleSendMessage = async (message: string) => {
    // 分析情绪
    const emotion = await engine.analyzeEmotion({
      text: message,
      context: getCurrentContext(),
    });
    
    // 计算温度感
    const temperature = await engine.calculateTemperature({
      userEmotion: emotion.type,
      context: getCurrentContext(),
    });
    
    // 发送消息
    sendMessage(message);
  };
  
  const handleReceiveMessage = async (message: string) => {
    // 调节内容温度感
    const warmMessage = await engine.adjustContent({
      original: message,
      targetTemperature: 'warm',
    });
    
    // 显示消息
    displayMessage(warmMessage);
  };
}
```

---

## 九、文件结构

```
frontend/services/temperature-engine/
├── index.ts                          # 主入口
├── core/                            # 核心引擎
│   ├── TemperatureEngine.ts
│   ├── EngineState.ts
│   └── EngineAPI.ts
├── calculator/                      # 温度感计算
│   ├── EmotionAnalyzer.ts
│   ├── ContextAwareness.ts
│   ├── TemperatureScorer.ts
│   └── TemperaturePredictor.ts
├── adjusters/                       # 温度感调节
│   ├── UIAdjuster.ts
│   ├── InteractionAdjuster.ts
│   ├── ContentAdjuster.ts
│   └── CharacterAdjuster.ts
├── plugins/                         # 插件系统
│   ├── PluginManager.ts
│   ├── PluginInterface.ts
│   ├── builtin/
│   │   ├── GreetingPlugin.ts
│   │   ├── ExpressionPlugin.ts
│   │   └── DialoguePlugin.ts
│   └── custom/                      # 扩展点
├── config/                          # 配置系统
│   ├── TemperatureConfig.ts
│   ├── ConfigManager.ts
│   └── ConfigValidator.ts
├── events/                          # 事件系统
│   ├── EventSystem.ts
│   ├── EventTypes.ts
│   └── EventHandlers.ts
├── hooks/                           # React Hooks
│   ├── useTemperatureEngine.ts
│   ├── useTemperatureConfig.ts
│   └── useEmotionAnalysis.ts
├── utils/                           # 工具函数
│   ├── temperatureUtils.ts
│   └── emotionUtils.ts
└── types/                           # 类型定义
    ├── TemperatureTypes.ts
    ├── EmotionTypes.ts
    └── PluginTypes.ts
```

---

## 十、实施计划

### 阶段一：核心引擎（3-5天）
- [ ] 创建核心引擎类
- [ ] 实现状态管理
- [ ] 实现基础API
- [ ] 实现事件系统

### 阶段二：计算层（3-5天）
- [ ] 实现情绪分析器
- [ ] 实现上下文感知
- [ ] 实现温度感评分器
- [ ] 实现温度感预测器

### 阶段三：调节层（3-5天）
- [ ] 实现UI调节器
- [ ] 实现交互调节器
- [ ] 实现内容调节器
- [ ] 实现角色调节器

### 阶段四：插件系统（2-3天）
- [ ] 实现插件管理器
- [ ] 实现插件接口
- [ ] 创建内置插件
- [ ] 实现插件配置

### 阶段五：集成和测试（2-3天）
- [ ] 集成到ChatWindow
- [ ] 集成到EntryPoint
- [ ] 性能测试
- [ ] 用户体验测试

**总计**：13-21天（约2-3周）

---

## 十一、优势总结

### ✅ 作为独立引擎的优势

1. **模块化**：独立模块，易于维护和扩展
2. **可复用**：可在不同场景复用
3. **可测试**：独立测试，不影响其他模块
4. **可配置**：丰富的配置选项
5. **可扩展**：插件系统支持扩展
6. **高性能**：轻量级，不影响系统性能
7. **可观测**：提供监控和调试能力

---

**文档维护者**：开发团队  
**最后更新**：2025-12-28

