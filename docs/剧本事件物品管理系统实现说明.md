# 剧本事件/物品管理系统实现说明

## 概述

已实现完整的剧本事件和物品管理系统，包括后端实体、API接口和前端服务层。

## 已完成的组件

### 后端实现

1. **实体类**
   - `ScenarioEvent.java` - 剧本事件实体
   - `ScenarioItem.java` - 剧本物品实体
   - 关联到 `Era`（场景）和 `User`（用户）
   - 支持系统预设和用户自定义

2. **Repository**
   - `ScenarioEventRepository.java`
   - `ScenarioItemRepository.java`
   - 提供按场景、用户、系统等条件查询

3. **Service**
   - `ScenarioEventService.java` - 事件业务逻辑
   - `ScenarioItemService.java` - 物品业务逻辑

4. **Controller**
   - `ScenarioEventController.java` - 事件API端点
   - `ScenarioItemController.java` - 物品API端点

5. **DTO**
   - `ScenarioEventDTO.java`
   - `ScenarioItemDTO.java`

6. **数据库迁移**
   - `V10021__create_scenario_events_and_items_tables.sql`

### 前端实现

1. **API服务**
   - `frontend/services/api/scenario/types.ts` - 类型定义
   - `frontend/services/api/scenario/event.ts` - 事件API
   - `frontend/services/api/scenario/item.ts` - 物品API
   - `frontend/services/api/scenario/index.ts` - 统一导出

## API端点

### 事件API (`/api/scenario-events`)

- `GET /api/scenario-events/era/{eraId}` - 获取场景的所有事件
- `GET /api/scenario-events/my` - 获取用户的自定义事件
- `GET /api/scenario-events/{id}` - 根据ID获取事件
- `GET /api/scenario-events/by-event-id/{eventId}` - 根据eventId获取事件
- `POST /api/scenario-events` - 创建事件
- `PUT /api/scenario-events/{id}` - 更新事件
- `DELETE /api/scenario-events/{id}` - 删除事件（软删除）

### 物品API (`/api/scenario-items`)

- `GET /api/scenario-items/era/{eraId}` - 获取场景的所有物品
- `GET /api/scenario-items/era/{eraId}/type/{itemType}` - 根据类型获取物品
- `GET /api/scenario-items/my` - 获取用户的自定义物品
- `GET /api/scenario-items/{id}` - 根据ID获取物品
- `GET /api/scenario-items/by-item-id/{itemId}` - 根据itemId获取物品
- `POST /api/scenario-items` - 创建物品
- `PUT /api/scenario-items/{id}` - 更新物品
- `DELETE /api/scenario-items/{id}` - 删除物品（软删除）

## 使用示例

### 前端API调用

```typescript
import { scenarioEventApi, scenarioItemApi } from './services/api';

// 获取场景的所有事件
const events = await scenarioEventApi.getEventsByEraId(eraId, token);

// 创建新事件
const newEvent = await scenarioEventApi.createEvent({
  name: '发现线索',
  eventId: 'event_find_clue',
  description: '在图书馆发现重要线索',
  eraId: eraId,
  tags: 'mystery,clue'
}, token);

// 获取场景的所有物品
const items = await scenarioItemApi.getItemsByEraId(eraId, token);

// 创建新物品
const newItem = await scenarioItemApi.createItem({
  name: '神秘钥匙',
  itemId: 'item_mysterious_key',
  description: '一把古老的钥匙',
  eraId: eraId,
  itemType: 'key',
  tags: 'key,mystery'
}, token);
```

## 待实现的功能

### 1. 管理后台界面
需要在 `frontend/admin` 目录下创建管理界面：
- `EventsManagement.tsx` - 事件管理组件
- `ItemsManagement.tsx` - 物品管理组件
- 集成到管理后台主界面

### 2. 编辑器快捷入口
在 `ScenarioBuilder.tsx` 中：
- 在事件ID/物品ID输入框旁添加"+"按钮
- 点击后弹出创建对话框
- 创建成功后自动填入ID并刷新列表

## 数据结构

### ScenarioEvent 字段

- `id` - 主键
- `name` - 事件名称
- `eventId` - 唯一标识（用于剧本引用）
- `description` - 事件描述
- `eraId` - 所属场景ID
- `userId` - 创建者ID
- `isSystem` - 是否为系统预设
- `iconUrl` - 图标URL
- `tags` - 标签（逗号分隔）
- `sortOrder` - 排序顺序
- `isActive` - 是否启用
- `isDeleted` - 软删除标志

### ScenarioItem 字段

- `id` - 主键
- `name` - 物品名称
- `itemId` - 唯一标识（用于剧本引用）
- `description` - 物品描述
- `eraId` - 所属场景ID
- `userId` - 创建者ID
- `isSystem` - 是否为系统预设
- `iconUrl` - 图标URL
- `itemType` - 物品类型（weapon, tool, key, consumable, collectible等）
- `tags` - 标签（逗号分隔）
- `sortOrder` - 排序顺序
- `isActive` - 是否启用
- `isDeleted` - 软删除标志

## 注意事项

1. **ID唯一性**：`eventId` 和 `itemId` 必须全局唯一
2. **权限控制**：用户只能修改和删除自己创建的事件/物品
3. **软删除**：删除操作使用软删除，不会真正删除数据
4. **场景关联**：事件和物品关联到场景（Era），也可以创建全局的系统预设

## 后续扩展

1. 可以在管理后台添加批量导入/导出功能
2. 可以添加事件/物品的图标上传功能
3. 可以在编辑器中支持从已有事件/物品中选择图标和描述

