# 心域小程序系统架构设计

**文档版本**: V1.0  
**编写日期**: 2025-12-31  
**功能模块**: 心域小程序系统（低代码插件系统）  
**架构类型**: 基于提示词驱动的低代码平台架构

---

## 一、架构概述

### 1.1 设计原则

1. **低代码原则**：用户通过自然语言描述需求，系统自动生成代码
2. **自动化原则**：代码生成、审核、部署全流程自动化
3. **模块化原则**：各组件模块化设计，易于扩展和维护
4. **安全性原则**：代码运行在隔离环境中，权限严格控制
5. **可扩展原则**：支持新功能模块和外部服务集成

### 1.2 技术栈

**后端技术栈**：
- **语言**：Java (Spring Boot) / Node.js (可选)
- **AI代码生成**：集成AipexBase（后端）、自研AI服务（前端）
- **数据库**：MySQL（元数据）、MongoDB（可选，存储生成代码）
- **消息队列**：RabbitMQ / Kafka（异步任务处理）
- **对象存储**：MinIO / OSS（存储生成的代码包）
- **API网关**：Spring Cloud Gateway / Kong

**前端技术栈**：
- **框架**：React + TypeScript
- **UI库**：Ant Design / Material-UI
- **状态管理**：Redux / Zustand
- **代码生成**：基于AI模型的代码生成服务

**AI服务**：
- **需求解析**：大语言模型（GPT-4 / Claude / 国产大模型）
- **代码生成**：代码生成模型（CodeT5 / Codex等）
- **AipexBase集成**：通过API调用AipexBase服务

### 1.3 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户层 (User Layer)                        │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ 提示词编程   │  │ 小程序商店   │  │ 小程序运行   │          │
│  │   平台       │  │   界面       │  │   容器       │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       API网关层 (Gateway Layer)                   │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────────┐   │
│  │            API Gateway (路由、鉴权、限流)                  │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                ┌─────────────┼─────────────┐
                ▼             ▼             ▼
┌──────────────────┐  ┌──────────────┐  ┌──────────────┐
│  代码生成服务层   │  │  管理服务层   │  │  运行服务层   │
│ (Code Generation)│  │  (Management)│  │   (Runtime)  │
└──────────────────┘  └──────────────┘  └──────────────┘
         │                    │                    │
         └─────────────┬──────┴──────┬────────────┘
                       ▼              ▼
              ┌──────────────────────────────┐
              │      数据存储层 (Storage)      │
              ├──────────────────────────────┤
              │  MySQL  │  MongoDB  │  MinIO │
              └──────────────────────────────┘
                       │
                       ▼
              ┌──────────────────────────────┐
              │   外部服务 (External Services) │
              ├──────────────────────────────┤
              │  AipexBase  │  AI模型服务    │
              └──────────────────────────────┘
```

---

## 二、核心组件架构

### 2.1 提示词编程平台（前端）

**组件职责**：
- 提供需求输入界面
- 实时预览生成的代码
- 支持迭代优化

**技术实现**：
- **需求输入组件**：富文本编辑器或Markdown编辑器
- **预览组件**：iframe容器预览生成的界面
- **代码查看器**：代码高亮显示组件
- **状态管理**：管理生成状态、版本历史等

**核心模块**：
```
frontend/
├── components/
│   ├── PromptEditor/          # 提示词编辑器
│   ├── CodePreview/           # 代码预览
│   ├── GenerationStatus/      # 生成状态显示
│   └── OptimizationPanel/     # 优化面板
├── services/
│   ├── codeGeneration.ts      # 代码生成服务
│   ├── requirementParser.ts   # 需求解析服务
│   └── previewService.ts      # 预览服务
└── hooks/
    ├── useCodeGeneration.ts   # 代码生成Hook
    └── usePreview.ts          # 预览Hook
```

---

### 2.2 需求解析服务

**组件职责**：
- 解析自然语言需求
- 提取结构化信息
- 验证需求完整性

**技术实现**：
- **AI模型调用**：调用大语言模型API
- **需求提取**：提取功能点、数据模型、界面要求等
- **需求验证**：检查需求完整性和合理性

**核心流程**：
```
自然语言需求
    ↓
AI模型解析
    ↓
结构化需求文档（JSON）
{
  "name": "小程序名称",
  "functions": [...],      # 功能列表
  "dataModel": {...},      # 数据模型
  "uiRequirements": {...}, # UI要求
  "integrations": [...]    # 集成需求
}
    ↓
需求验证
    ↓
返回结构化需求
```

**API设计**：
```java
@RestController
@RequestMapping("/api/requirement-parser")
public class RequirementParserController {
    
    @PostMapping("/parse")
    public ResponseEntity<ParsedRequirement> parseRequirement(
        @RequestBody RequirementText requirementText
    ) {
        // 调用AI模型解析需求
        // 返回结构化需求
    }
    
    @PostMapping("/validate")
    public ResponseEntity<ValidationResult> validateRequirement(
        @RequestBody ParsedRequirement requirement
    ) {
        // 验证需求完整性
        // 检查权限合理性
    }
}
```

---

### 2.3 后端代码生成服务（AipexBase集成）

**组件职责**：
- 集成AipexBase API
- 将结构化需求转换为AipexBase格式
- 获取生成的后端代码
- 部署后端服务

**技术实现**：
- **AipexBase客户端**：封装AipexBase API调用
- **需求转换器**：将结构化需求转换为AipexBase可理解的格式
- **代码获取**：获取AipexBase生成的代码
- **代码部署**：将代码部署到运行环境

**核心流程**：
```
结构化需求
    ↓
转换为AipexBase格式
    ↓
调用AipexBase API
    ↓
AipexBase生成后端代码
    ↓
获取生成的代码
    ↓
代码审查（安全检查）
    ↓
部署到后端服务
    ↓
生成API文档
    ↓
返回API端点信息
```

**服务设计**：
```java
@Service
public class BackendGenerationService {
    
    @Autowired
    private AipexBaseClient aipexBaseClient;
    
    @Autowired
    private CodeDeploymentService deploymentService;
    
    public BackendGenerationResult generateBackend(
        ParsedRequirement requirement
    ) {
        // 1. 转换需求格式
        AipexBaseRequest request = convertToAipexBaseFormat(requirement);
        
        // 2. 调用AipexBase
        AipexBaseResponse response = aipexBaseClient.generate(request);
        
        // 3. 获取生成的代码
        BackendCode code = extractCode(response);
        
        // 4. 代码审查
        CodeReviewResult review = reviewCode(code);
        if (!review.isPassed()) {
            throw new CodeGenerationException(review.getMessage());
        }
        
        // 5. 部署代码
        DeploymentResult deployment = deploymentService.deploy(code);
        
        // 6. 返回结果
        return BackendGenerationResult.builder()
            .codeUrl(deployment.getCodeUrl())
            .apiEndpoints(deployment.getApiEndpoints())
            .build();
    }
}
```

---

### 2.4 前端代码生成服务

**组件职责**：
- 根据需求生成前端代码
- 生成React组件、路由、样式等
- 集成API调用代码

**技术实现**：
- **AI代码生成**：调用代码生成模型
- **模板引擎**：基于模板生成代码
- **代码组装**：组装完整的项目结构

**核心流程**：
```
结构化需求
    ↓
UI设计生成（AI）
    ↓
组件代码生成（AI）
    ↓
路由配置生成
    ↓
样式代码生成
    ↓
API集成代码生成
    ↓
代码组装和优化
    ↓
生成前端代码包
    ↓
返回代码URL
```

**服务设计**：
```java
@Service
public class FrontendGenerationService {
    
    @Autowired
    private AICodeGenerator aiCodeGenerator;
    
    @Autowired
    private CodePackager codePackager;
    
    public FrontendGenerationResult generateFrontend(
        ParsedRequirement requirement,
        BackendGenerationResult backendResult
    ) {
        // 1. 生成UI设计
        UIDesign uiDesign = generateUIDesign(requirement);
        
        // 2. 生成组件代码
        List<ComponentCode> components = generateComponents(uiDesign);
        
        // 3. 生成路由配置
        RouteConfig routes = generateRoutes(requirement);
        
        // 4. 生成样式代码
        StyleCode styles = generateStyles(uiDesign);
        
        // 5. 生成API集成代码
        APIIntegrationCode apiCode = generateAPIIntegration(backendResult);
        
        // 6. 组装代码包
        FrontendCodePackage codePackage = codePackager.packageCode(
            components, routes, styles, apiCode
        );
        
        // 7. 上传代码包
        String codeUrl = uploadCodePackage(codePackage);
        
        return FrontendGenerationResult.builder()
            .codeUrl(codeUrl)
            .previewUrl(generatePreviewUrl(codeUrl))
            .build();
    }
}
```

---

### 2.5 代码审查服务

**组件职责**：
- 自动代码安全检查
- 性能检查
- 兼容性检查

**技术实现**：
- **安全扫描**：使用SonarQube、ESLint等工具
- **静态分析**：代码静态分析
- **规则引擎**：基于规则的安全检查

**检查项**：
- **安全漏洞**：XSS、SQL注入、CSRF等
- **代码质量**：代码规范、最佳实践
- **性能问题**：性能瓶颈、资源使用
- **兼容性**：与心域系统的兼容性

---

### 2.6 小程序运行服务

**组件职责**：
- 运行小程序前端代码
- 管理小程序生命周期
- API代理和权限控制

**技术实现**：
- **运行容器**：基于iframe或WebView的运行容器
- **生命周期管理**：管理小程序的加载、运行、卸载
- **API代理**：代理小程序API调用，进行权限验证

**运行架构**：
```
┌─────────────────────────────────────┐
│       小程序运行容器 (Container)      │
├─────────────────────────────────────┤
│  ┌───────────────────────────────┐  │
│  │  小程序前端代码 (iframe)       │  │
│  │  - React应用                   │  │
│  │  - 路由、组件、状态管理        │  │
│  └───────────────────────────────┘  │
│              │                       │
│              ▼                       │
│  ┌───────────────────────────────┐  │
│  │      API代理层 (Proxy)         │  │
│  │  - 权限验证                    │  │
│  │  - 参数验证                    │  │
│  │  - 限流控制                    │  │
│  │  - 日志记录                    │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
              │
              ▼
      ┌───────────────┐
      │  后端API服务   │
      │  (AipexBase)  │
      └───────────────┘
```

**服务设计**：
```java
@Service
public class MiniprogramRuntimeService {
    
    @Autowired
    private PermissionService permissionService;
    
    @Autowired
    private RateLimitService rateLimitService;
    
    public RuntimeContext launchMiniprogram(
        Long appId, Long userId
    ) {
        // 1. 加载小程序信息
        MiniprogramApp app = loadApp(appId);
        
        // 2. 检查权限
        checkPermissions(userId, app);
        
        // 3. 加载代码
        String frontendCodeUrl = app.getFrontendCodeUrl();
        String backendApiUrl = app.getBackendApiUrl();
        
        // 4. 创建运行时上下文
        RuntimeContext context = RuntimeContext.builder()
            .appId(appId)
            .userId(userId)
            .frontendUrl(frontendCodeUrl)
            .apiProxyUrl(buildProxyUrl(appId, userId))
            .build();
        
        return context;
    }
    
    @PostMapping("/proxy/{appId}/**")
    public ResponseEntity<?> proxyAPI(
        @PathVariable Long appId,
        @PathVariable String path,
        HttpServletRequest request
    ) {
        // 1. 验证权限
        Long userId = getCurrentUserId();
        if (!permissionService.checkPermission(userId, appId, path)) {
            return ResponseEntity.status(403).build();
        }
        
        // 2. 限流检查
        if (!rateLimitService.allow(userId, appId)) {
            return ResponseEntity.status(429).build();
        }
        
        // 3. 转发请求到后端API
        return forwardToBackendAPI(appId, path, request);
    }
}
```

---

### 2.7 小程序管理服务

**组件职责**：
- 小程序创建、更新、删除
- 版本管理
- 安装管理
- 数据统计

**核心功能**：
- **应用管理**：CRUD操作
- **版本管理**：版本创建、回滚
- **安装管理**：用户安装、卸载
- **数据统计**：使用统计、性能统计

---

## 三、数据流设计

### 3.1 小程序创建流程

```
用户输入需求描述
    ↓
[前端] 发送到需求解析服务
    ↓
[需求解析服务] AI解析需求 → 结构化需求
    ↓
[前端] 展示解析结果，用户确认
    ↓
[前端] 发送创建请求
    ↓
[代码生成服务] 异步启动代码生成任务
    ├─→ [后端生成服务] 调用AipexBase → 生成后端代码 → 部署
    └─→ [前端生成服务] AI生成前端代码 → 打包上传
    ↓
[代码审查服务] 自动代码审查
    ↓
[管理服务] 创建小程序记录，更新状态
    ↓
[前端] 轮询生成状态，显示进度
    ↓
生成完成，用户可以预览和发布
```

### 3.2 小程序运行流程

```
用户点击启动小程序
    ↓
[前端] 调用启动API
    ↓
[运行服务] 创建运行时上下文
    ├─→ 加载前端代码URL
    ├─→ 创建API代理URL
    └─→ 生成运行时配置
    ↓
[前端] 在iframe中加载小程序前端
    ↓
小程序前端运行
    ├─→ 调用API代理
    ├─→ [API代理] 权限验证 → 转发到后端API
    └─→ [后端API] 处理请求 → 返回数据
    ↓
小程序前端展示结果
```

### 3.3 代码优化流程

```
用户在预览界面发现问题
    ↓
用户输入优化需求（自然语言）
    ↓
[前端] 发送优化请求
    ↓
[代码生成服务] 基于原代码和优化需求
    ├─→ [前端生成服务] 生成优化后的代码
    └─→ 创建新版本
    ↓
[代码审查服务] 审查新版本
    ↓
[管理服务] 更新版本记录
    ↓
[前端] 更新预览，用户可以继续优化
```

---

## 四、数据库设计

### 4.1 核心表结构

**小程序信息表 (miniprogram_apps)**
- 存储小程序基本信息、需求描述、代码地址等

**小程序版本表 (miniprogram_versions)**
- 存储版本信息、代码地址、审核状态等

**用户安装表 (miniprogram_installs)**
- 存储用户安装的小程序列表

**小程序数据表 (miniprogram_user_data)**
- 存储小程序产生的用户数据（由AipexBase生成的表管理）

### 4.2 数据关系图

```
miniprogram_apps (1) ──── (N) miniprogram_versions
    │
    │ (1)
    │
    └─── (N) miniprogram_installs ──── (1) users
            │
            │ (1)
            │
            └─── (N) miniprogram_user_data
```

---

## 五、API设计

### 5.1 需求解析API

```
POST /api/requirement-parser/parse
- 解析自然语言需求
- 返回结构化需求

POST /api/requirement-parser/validate
- 验证需求完整性
```

### 5.2 代码生成API

```
POST /api/miniprogram/create
- 创建小程序（启动代码生成）

GET /api/miniprogram/{appId}/generate-status
- 查询代码生成状态

POST /api/miniprogram/{appId}/optimize
- 优化小程序代码
```

### 5.3 运行API

```
POST /api/miniprogram/apps/{appId}/launch
- 启动小程序
- 返回运行时配置

POST /api/miniprogram/proxy/{appId}/**
- API代理端点（转发小程序API请求）
```

### 5.4 管理API

```
GET /api/miniprogram/my-apps
- 获取我的小程序列表

GET /api/miniprogram/store/apps
- 获取小程序商店列表

POST /api/miniprogram/install
- 安装小程序

POST /api/miniprogram/apps/{appId}/publish
- 发布小程序
```

---

## 六、安全设计

### 6.1 代码安全

- **沙箱隔离**：小程序运行在隔离的iframe中
- **CSP策略**：内容安全策略限制代码执行
- **代码审查**：自动扫描安全漏洞

### 6.2 权限控制

- **API权限**：基于manifest.json中的权限配置
- **数据隔离**：用户数据按用户ID隔离
- **访问控制**：API代理层进行权限验证

### 6.3 数据安全

- **数据加密**：敏感数据加密存储
- **数据脱敏**：API返回时自动脱敏
- **访问日志**：记录所有数据访问日志

---

## 七、性能优化

### 7.1 代码生成优化

- **异步处理**：代码生成采用异步任务
- **缓存机制**：缓存AI模型响应
- **批量处理**：支持批量生成

### 7.2 运行优化

- **代码缓存**：缓存小程序代码
- **懒加载**：按需加载代码模块
- **CDN加速**：使用CDN加速代码加载

### 7.3 数据库优化

- **索引优化**：合理设计数据库索引
- **分页查询**：列表查询使用分页
- **读写分离**：数据库读写分离

---

## 八、扩展性设计

### 8.1 水平扩展

- **无状态服务**：服务设计为无状态，支持水平扩展
- **负载均衡**：使用负载均衡分发请求
- **消息队列**：异步任务使用消息队列

### 8.2 功能扩展

- **插件机制**：支持插件扩展功能
- **模板系统**：支持代码生成模板扩展
- **规则引擎**：支持审核规则扩展

---

## 九、监控和日志

### 9.1 监控指标

- **代码生成成功率**：代码生成成功/失败率
- **生成耗时**：代码生成平均耗时
- **运行性能**：小程序运行性能指标
- **API调用量**：API调用统计

### 9.2 日志设计

- **操作日志**：记录用户操作
- **错误日志**：记录错误信息
- **性能日志**：记录性能数据
- **审计日志**：记录安全相关操作

---

## 十、部署架构

### 10.1 部署方案

```
┌─────────────────────────────────────┐
│         负载均衡 (Nginx)              │
└─────────────────────────────────────┘
              │
    ┌─────────┼─────────┐
    ▼         ▼         ▼
┌────────┐ ┌────────┐ ┌────────┐
│ API    │ │ API    │ │ API    │
│ Gateway│ │ Gateway│ │ Gateway│
└────────┘ └────────┘ └────────┘
    │         │         │
    └─────────┼─────────┘
              ▼
    ┌─────────────────┐
    │   应用服务集群    │
    │  (Spring Boot)  │
    └─────────────────┘
              │
    ┌─────────┼─────────┐
    ▼         ▼         ▼
┌────────┐ ┌────────┐ ┌────────┐
│ MySQL  │ │ MongoDB│ │ MinIO  │
│ (主从) │ │        │ │        │
└────────┘ └────────┘ └────────┘
```

### 10.2 容器化部署

- **Docker**：服务容器化
- **Kubernetes**：容器编排
- **CI/CD**：自动化部署流程

---

**文档状态**: 架构设计已完成


