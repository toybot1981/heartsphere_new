# 心域小程序系统需求分析与设计（简化版）

**文档版本**: V2.0（简化版）  
**编写日期**: 2025-12-31  
**功能模块**: 心域小程序系统（低代码插件系统）  
**目标**: 设计一套基于提示词驱动的低代码小程序规范，支持用户通过自然语言描述需求，系统自动生成和部署小程序

---

## 一、需求概述

### 1.1 背景

心域小程序系统（也称为插件系统或挂件系统）是一个基于提示词驱动的低代码扩展平台。用户无需编写代码，只需要用自然语言描述需求，系统就能自动生成小程序的后端和前端代码，并部署运行。

**核心特点**：
- **零代码开发**：用户只需提供需求描述（提示词）
- **自动代码生成**：后端通过AipexBase自动生成，前端通过提示词平台自动生成
- **快速部署**：生成后自动审核、部署和运行
- **简单易用**：降低开发门槛，让普通用户也能创建小程序

### 1.2 技术方案

**后端生成**：
- 使用 **AipexBase**（国产开源AI原生后端即服务平台）
- 根据需求描述自动生成后端业务逻辑、数据库设计、API接口
- 自动处理后端开发中的业务逻辑、数据库管理及外部API交互

**前端生成**：
- 提供简单的**提示词编程平台**
- 开发者输入需求描述（自然语言）
- 系统自动生成前端代码（React组件、界面布局等）
- 支持迭代优化（通过补充提示词修改和优化）

**运行框架**：
- 自动集成到心域系统中
- 提供统一的运行容器和API代理
- 支持数据访问和权限控制

### 1.3 核心价值

1. **零代码开发**：用户无需编程技能，用自然语言即可创建小程序
2. **快速迭代**：通过补充提示词快速优化和迭代小程序
3. **功能扩展**：通过小程序丰富心域的功能生态
4. **个性化定制**：用户可以选择或创建适合自己需求的小程序
5. **场景化应用**：针对特定场景（如家庭相册、健康记录等）提供专门解决方案
6. **数据集成**：小程序可以充分利用心域的数据资源

### 1.4 典型应用场景

**1. 快乐相册小程序**

**需求描述示例**：
```
我想创建一个家庭相册小程序，用户可以：
1. 上传照片
2. 为照片添加标题和描述
3. 给照片添加标签（如：家庭聚餐、旅行、生日等）
4. 查看所有照片的列表，可以按时间、标签筛选
5. 查看单张照片的详情
6. 照片可以关联心域的记忆系统
7. E-SOUL可以基于相册内容进行互动
```

**系统自动生成**：
- 后端：自动生成照片上传、存储、查询API（通过AipexBase）
- 前端：自动生成相册列表、上传界面、详情页面（通过提示词平台）
- 集成：自动接入心域记忆API和E-SOUL交互API

**2. 健康记录小程序**

**需求描述示例**：
```
创建一个健康记录小程序：
1. 记录每天的体重、步数、睡眠时长
2. 记录运动数据（跑步、游泳等）
3. 生成健康数据图表
4. 设置健康目标
5. 健康数据可以影响情绪分析
6. E-SOUL可以基于健康数据提供关怀和建议
```

**3. 目标管理小程序**

**需求描述示例**：
```
目标管理小程序：
1. 创建目标（如：学习、运动、阅读等）
2. 设置目标完成期限
3. 记录目标进度
4. 目标完成后可以庆祝
5. 与成长记录系统集成
6. E-SOUL可以鼓励和提醒
```

---

## 二、核心功能需求

### 2.1 需求描述规范

#### 2.1.1 需求描述格式

用户通过自然语言描述小程序需求，系统自动解析并生成代码。

**标准格式**（可选，系统也支持自由格式）：

```
小程序名称：[名称]

功能描述：
[详细描述小程序的功能，包括：
 1. 主要功能点
 2. 数据输入和输出
 3. 界面要求
 4. 与心域系统的集成需求（如果需要）]

数据需求：
[描述需要存储的数据：
 - 数据结构
 - 数据关系]

界面要求：
[描述界面布局和交互：
 - 页面列表
 - 主要组件
 - 交互流程]

集成需求：
[描述与心域系统的集成：
 - 需要访问的心域API（记忆、情绪、E-SOUL等）
 - 需要的权限]
```

#### 2.1.2 需求描述示例

**示例1：快乐相册小程序**

```
小程序名称：快乐相册

功能描述：
我想创建一个家庭相册小程序，用户可以：
1. 上传照片（支持多张）
2. 为每张照片添加标题和描述
3. 给照片添加标签（如：家庭聚餐、旅行、生日等），支持多个标签
4. 查看所有照片的列表，可以按时间倒序、标签筛选
5. 查看单张照片的详情（大图、标题、描述、标签、上传时间）
6. 删除照片
7. 照片可以关联心域的记忆系统（可选）
8. E-SOUL可以基于相册内容进行互动（可选）

数据需求：
- 照片表：id, 用户id, 照片url, 标题, 描述, 标签列表, 上传时间, 关联记忆id（可选）
- 支持按标签筛选和按时间排序

界面要求：
- 首页：照片网格列表，显示缩略图、标题
- 上传页：上传按钮、标题输入、描述输入、标签选择（可输入新标签）
- 详情页：大图显示、标题、描述、标签、操作按钮（删除、关联记忆）
- 顶部导航栏：标题"快乐相册"，右侧上传按钮

集成需求：
- 需要写入权限：write:user_data（存储照片数据）
- 可选：read:memory, write:memory（关联记忆系统）
- 可选：access:esoul（E-SOUL互动）
```

**示例2：健康记录小程序**

```
小程序名称：健康记录

功能描述：
记录和管理个人健康数据：
1. 记录每天的体重、步数、睡眠时长
2. 记录运动数据（类型、时长、强度）
3. 查看历史数据列表（按日期倒序）
4. 生成数据图表（体重趋势、步数趋势、睡眠趋势）
5. 设置健康目标（如：目标体重、目标步数）
6. 显示目标完成进度

数据需求：
- 每日健康数据：id, 用户id, 日期, 体重, 步数, 睡眠时长
- 运动记录：id, 用户id, 日期, 运动类型, 时长, 强度
- 健康目标：id, 用户id, 目标类型, 目标值, 当前值, 截止日期

界面要求：
- 首页：今日数据录入表单、目标进度卡片、最近7天趋势图表
- 历史记录页：数据列表、筛选（按日期范围）
- 目标设置页：目标列表、添加目标、编辑目标

集成需求：
- 需要权限：write:user_data（存储健康数据）
- 可选：read:emotion（影响情绪分析）
- 可选：access:esoul（E-SOUL关怀建议）
```

#### 2.1.3 需求解析和验证

**自动解析**：
- 使用AI模型解析自然语言需求
- 提取关键信息：功能点、数据模型、界面要求、集成需求
- 生成结构化的需求文档

**需求验证**：
- 检查需求完整性
- 检查权限申请的合理性
- 检查与心域系统的兼容性
- 如有不清楚的地方，系统可以提问澄清

---

### 2.2 后端自动生成（基于AipexBase）

#### 2.2.1 AipexBase集成

**集成方式**：
- 将解析后的需求描述发送给AipexBase
- AipexBase自动生成：
  - 数据库表结构
  - 业务逻辑代码
  - RESTful API接口
  - 数据验证规则
  - 错误处理逻辑

**生成内容**：
- **数据库设计**：根据数据需求自动生成表结构
- **业务逻辑**：根据功能描述自动生成业务逻辑代码
- **API接口**：自动生成标准的RESTful API
- **数据验证**：自动生成数据验证和错误处理

#### 2.2.2 后端生成流程

```
需求描述
    ↓
需求解析（AI解析）
    ↓
生成结构化需求文档
    ↓
发送给AipexBase
    ↓
AipexBase生成后端代码
    ↓
代码审查（自动检查）
    ↓
部署到后端服务
    ↓
生成API文档
```

#### 2.2.3 心域API集成

- 自动集成心域提供的标准API
- 根据权限需求自动配置API访问权限
- 生成API调用代码

---

### 2.3 前端自动生成（提示词编程平台）

#### 2.3.1 提示词编程平台

**平台功能**：
- **需求输入**：用户输入需求描述（自然语言）
- **界面预览**：实时预览生成的界面
- **迭代优化**：通过补充提示词修改和优化界面
- **代码生成**：自动生成React组件代码

**生成内容**：
- React组件代码
- 页面路由配置
- 样式代码（CSS/SCSS）
- API调用代码
- 状态管理代码

#### 2.3.2 前端生成流程

```
需求描述
    ↓
界面设计生成（AI生成）
    ↓
组件代码生成（AI生成）
    ↓
样式代码生成（AI生成）
    ↓
API集成代码生成
    ↓
代码审查和优化
    ↓
生成前端代码包
```

#### 2.3.3 迭代优化

**优化方式**：
- 用户可以在预览界面直接指出需要修改的地方
- 通过自然语言描述修改需求
- 系统自动重新生成对应部分的代码
- 支持多次迭代直到满意

**优化示例**：
```
用户："照片列表的缩略图太小了，改成大一点"
系统：重新生成列表组件，调整缩略图尺寸

用户："上传按钮改成在底部固定位置"
系统：修改布局，将上传按钮改为固定定位

用户："详情页的标题字体改成更大更醒目"
系统：修改样式，增大标题字体
```

---

### 2.4 简化的配置文件

#### 2.4.1 自动生成的manifest.json

系统根据需求描述自动生成配置文件：

**自动生成字段**：
- `name`: 从需求描述中提取
- `version`: 默认1.0.0
- `description`: 从需求描述中提取
- `author`: 当前用户信息
- `icon`: 可自动生成或用户上传
- `permissions`: 根据集成需求自动生成
- `apiEndpoints`: 自动生成的API端点列表
- `pages`: 自动生成的页面列表

**用户可配置字段**（可选）：
- `theme`: 主题配置（颜色、字体等）
- `settings`: 小程序设置项

---

### 2.5 简化的审核流程

#### 2.5.1 自动审核

**审核内容**：
- **代码安全检查**：自动扫描生成的代码（XSS、SQL注入等）
- **权限检查**：检查权限申请的合理性
- **性能检查**：检查代码性能和资源使用
- **兼容性检查**：检查与心域系统的兼容性

**审核标准**：
- 代码安全性：无明显的安全漏洞
- 权限合理性：申请的权限与功能匹配
- 性能达标：代码性能在可接受范围内
- 兼容性良好：与心域系统API兼容

#### 2.5.2 人工审核（可选）

**触发条件**：
- 自动审核不通过
- 涉及敏感功能
- 用户举报

**审核内容**：
- 功能合理性
- 内容合规性
- UI/UX质量

---

### 2.6 简化的部署流程

#### 2.6.1 自动部署

**部署流程**：
1. 代码生成完成
2. 自动审核通过
3. 自动部署到测试环境
4. 自动测试
5. 测试通过后自动部署到生产环境
6. 自动发布

**版本管理**：
- 自动版本号管理（每次修改自动递增版本号）
- 保留历史版本
- 支持回滚到历史版本

---

### 2.7 简化的运行框架

#### 2.7.1 运行容器

- 统一的小程序运行容器
- 自动加载生成的代码
- 提供统一的API代理
- 管理权限和数据访问

#### 2.7.2 API代理

- 自动代理小程序API调用
- 权限验证
- 数据访问控制
- 日志记录

---

### 2.2 小程序上传功能

#### 2.2.1 上传方式

**1. Web端上传**

- **上传入口**：开发者中心的上传页面
- **上传文件**：支持ZIP格式的打包文件
- **文件大小限制**：建议不超过50MB
- **上传进度**：显示上传进度
- **上传验证**：上传时进行基础验证（文件格式、manifest.json等）

**2. CLI工具上传**

- **命令**：`heartsphere-cli upload`
- **自动化**：支持CI/CD集成
- **配置**：通过配置文件指定上传参数

#### 2.2.2 上传内容

**必需文件**：

- `manifest.json`：小程序配置文件
- 源代码文件：小程序的源代码
- 静态资源：图片、字体等静态资源
- `README.md`：说明文档

**可选文件**：

- `screenshots/`：截图目录（用于应用商店展示）
- `docs/`：详细文档
- `tests/`：测试用例
- `CHANGELOG.md`：更新日志

#### 2.2.3 上传验证

**基础验证**：

- 文件格式验证（必须是ZIP格式）
- manifest.json格式验证
- 必需字段检查
- 文件大小检查
- 文件名规范检查

**代码验证**（可选）：

- 代码格式检查
- 安全扫描（扫描恶意代码）
- 依赖检查（检查依赖的合法性和版本）

---

### 2.3 小程序审核功能

#### 2.3.1 审核流程

**1. 自动审核**

- **触发时机**：小程序上传后自动触发
- **审核内容**：
  - 代码安全检查（XSS、SQL注入、恶意代码等）
  - 权限使用合理性检查
  - 性能检查（包大小、加载时间等）
  - 兼容性检查（API版本兼容性）
- **审核结果**：通过/不通过/需人工审核

**2. 人工审核**

- **触发条件**：
  - 自动审核不通过
  - 首次发布的小程序
  - 重大版本更新
  - 用户举报
- **审核内容**：
  - 功能完整性审核
  - UI/UX审核
  - 内容合规性审核
  - 隐私政策审核
  - 使用场景合理性审核

**3. 审核状态**

- `pending`：待审核
- `reviewing`：审核中
- `approved`：审核通过
- `rejected`：审核不通过
- `need_fix`：需要修改

#### 2.3.2 审核标准

**功能标准**：

- 功能完整可用
- 符合心域小程序规范
- 与心域系统集成正确
- 用户体验良好

**安全标准**：

- 无恶意代码
- 无数据泄露风险
- 权限使用合理
- 遵循安全最佳实践

**内容标准**：

- 内容健康合规
- 无违法内容
- 尊重用户隐私
- 有明确的隐私政策

**技术标准**：

- 代码质量良好
- 性能达标
- 兼容性良好
- 错误处理完善

#### 2.3.3 审核反馈

- **审核结果通知**：通过站内信、邮件等方式通知开发者
- **审核意见**：详细说明审核不通过的原因
- **修改建议**：提供修改建议和最佳实践
- **申诉机制**：开发者可以对审核结果进行申诉

---

### 2.4 小程序部署功能

#### 2.4.1 部署方式

**1. 版本管理**

- **版本号**：使用语义化版本号（semver）
- **版本历史**：保存历史版本
- **回滚功能**：支持回滚到历史版本
- **灰度发布**：支持灰度发布新版本

**2. 部署环境**

- **开发环境**：开发者测试环境
- **测试环境**：审核测试环境
- **生产环境**：正式运行环境

**3. 部署流程**

- 审核通过后进入部署流程
- 自动部署到生产环境
- 部署后自动发布
- 支持一键发布和定时发布

#### 2.4.2 小程序发布

**发布方式**：

- **公开发布**：所有用户可见可用
- **私有发布**：仅开发者可用
- **邀请发布**：仅受邀用户可用
- **内测发布**：仅内测用户可用

**发布渠道**：

- **小程序商店**：公开的小程序应用商店
- **直接安装**：通过小程序ID直接安装
- **推荐推荐**：系统推荐的小程序

---

### 2.5 小程序运行框架

#### 2.5.1 运行环境

**沙箱环境**：

- **隔离机制**：小程序运行在隔离的沙箱环境中
- **资源限制**：限制CPU、内存、存储等资源使用
- **权限控制**：基于manifest.json中声明的权限进行控制
- **安全防护**：防止恶意代码执行

**运行容器**：

- **前端容器**：基于WebView或React Native容器
- **后端容器**（可选）：独立的服务容器
- **生命周期管理**：管理小程序的生命周期
- **资源管理**：管理小程序的资源加载和释放

#### 2.5.2 生命周期管理

**小程序生命周期**：

- `onLaunch`：小程序启动
- `onShow`：小程序显示
- `onHide`：小程序隐藏
- `onError`：小程序错误
- `onUnload`：小程序卸载

**页面生命周期**：

- `onLoad`：页面加载
- `onShow`：页面显示
- `onReady`：页面渲染完成
- `onHide`：页面隐藏
- `onUnload`：页面卸载

#### 2.5.3 API调用机制

**API代理**：

- 所有API调用通过API代理层
- 权限验证：检查小程序是否有权限调用该API
- 参数验证：验证API调用参数
- 限流控制：限制API调用频率
- 日志记录：记录所有API调用

**数据访问控制**：

- 基于权限配置控制数据访问
- 数据脱敏：敏感数据自动脱敏
- 数据范围限制：只能访问授权的数据范围
- 数据审计：记录数据访问日志

#### 2.5.4 错误处理和日志

**错误处理**：

- 统一的错误处理机制
- 错误信息友好提示
- 错误上报机制
- 错误恢复机制

**日志系统**：

- 运行日志记录
- 错误日志记录
- 性能日志记录
- 用户行为日志记录（可选，需用户同意）

---

### 2.6 小程序管理功能

#### 2.6.1 用户端管理

**小程序安装**：

- **浏览商店**：浏览小程序商店
- **搜索小程序**：搜索和筛选小程序
- **查看详情**：查看小程序详情、截图、评价
- **安装小程序**：一键安装小程序
- **权限确认**：安装时确认权限

**小程序使用**：

- **打开小程序**：从心域中打开小程序
- **小程序列表**：管理已安装的小程序
- **小程序设置**：配置小程序设置
- **权限管理**：管理小程序权限
- **卸载小程序**：卸载不需要的小程序

**小程序数据**：

- **数据查看**：查看小程序产生的数据
- **数据导出**：导出小程序数据
- **数据删除**：删除小程序数据
- **数据备份**：备份小程序数据

#### 2.6.2 开发者端管理

**小程序管理**：

- **我的小程序**：查看我开发的小程序列表
- **小程序统计**：查看使用统计、用户数等
- **版本管理**：管理小程序版本
- **更新发布**：发布新版本

**数据分析**：

- **使用统计**：用户数、使用时长、使用频率等
- **错误统计**：错误率、错误类型等
- **性能统计**：加载时间、响应时间等
- **用户反馈**：用户评价、反馈等

---

### 2.7 小程序商店功能

#### 2.7.1 商店首页

- **推荐小程序**：推荐优质小程序
- **分类浏览**：按分类浏览小程序
- **热门排行**：热门小程序排行
- **最新上架**：最新上架的小程序
- **搜索功能**：搜索小程序

#### 2.7.2 小程序详情页

- **基本信息**：名称、图标、描述、开发者
- **截图展示**：小程序截图
- **功能特点**：功能特点介绍
- **权限说明**：所需权限说明
- **用户评价**：用户评价和评分
- **版本历史**：版本更新历史
- **安装按钮**：安装/打开按钮

#### 2.7.3 分类和标签

**分类**：

- 工具类
- 生活类
- 健康类
- 娱乐类
- 教育类
- 社交类
- 其他

**标签**：

- 基于功能、场景等定义标签
- 支持多个标签
- 支持标签筛选

---

## 三、技术架构设计

### 3.1 整体架构

**分层架构**：

1. **展示层**：小程序前端界面
2. **运行层**：小程序运行框架和容器
3. **API层**：心域API和权限控制
4. **数据层**：心域数据存储和小程序数据存储
5. **管理层**：小程序管理后台

**微服务架构**：

- **小程序管理服务**：处理上传、审核、部署等
- **小程序运行服务**：运行小程序容器
- **API网关服务**：API代理和权限控制
- **商店服务**：小程序商店功能
- **审核服务**：自动化审核功能

### 3.2 核心技术组件

**1. 小程序运行时**

- 基于WebView或React Native的运行容器
- JavaScript引擎（V8等）
- 生命周期管理
- 资源管理

**2. API代理层**

- API路由和转发
- 权限验证
- 参数验证
- 限流控制
- 日志记录

**3. 沙箱隔离**

- 进程隔离
- 资源限制
- 权限控制
- 安全防护

**4. 数据存储**

- 小程序代码存储（对象存储）
- 小程序数据存储（数据库）
- 用户数据存储（隔离存储）

### 3.3 安全机制

**代码安全**：

- 代码加密和混淆
- 恶意代码检测
- 代码审计

**运行安全**：

- 沙箱隔离
- 权限控制
- API调用限制
- 资源限制

**数据安全**：

- 数据加密存储
- 数据访问控制
- 数据脱敏
- 隐私保护

---

## 四、数据结构设计

### 4.1 小程序信息表

**表名**: `miniprogram_apps`

**字段设计**:
- `id` (BIGINT, PRIMARY KEY): 小程序ID
- `app_id` (VARCHAR, UNIQUE, NOT NULL): 小程序唯一标识（自动生成）
- `name` (VARCHAR, NOT NULL): 小程序名称（从需求描述提取）
- `version` (VARCHAR, NOT NULL): 当前版本号（自动管理）
- `description` (TEXT): 小程序描述（从需求描述提取）
- `icon` (VARCHAR): 图标URL（可自动生成或用户上传）
- `author_id` (BIGINT, NOT NULL): 开发者用户ID
- `author_name` (VARCHAR): 开发者名称
- `category` (VARCHAR): 分类（自动分类或用户选择）
- `tags` (JSON): 标签列表（自动提取或用户添加）
- `status` (VARCHAR, NOT NULL): 状态（generating/reviewing/approved/rejected/published/offline）
- `requirement_text` (TEXT, NOT NULL): 原始需求描述文本
- `requirement_parsed` (TEXT): 解析后的结构化需求（JSON）
- `manifest_data` (TEXT): manifest.json完整数据（JSON，自动生成）
- `permissions` (JSON): 权限列表（从需求自动提取）
- `backend_code_url` (VARCHAR): 后端代码存储地址（AipexBase生成）
- `frontend_code_url` (VARCHAR): 前端代码存储地址
- `api_endpoints` (JSON): API端点列表（自动生成）
- `install_count` (INT, DEFAULT 0): 安装数量
- `rating` (DECIMAL): 评分（0-5）
- `rating_count` (INT, DEFAULT 0): 评分人数
- `published_at` (DATETIME): 发布时间
- `created_at` (DATETIME, DEFAULT CURRENT_TIMESTAMP): 创建时间
- `updated_at` (DATETIME, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP): 更新时间

**索引**:
- `idx_app_id` (app_id)
- `idx_author` (author_id)
- `idx_status` (status, published_at)
- `idx_category` (category, install_count)

---

### 4.2 小程序版本表

**表名**: `miniprogram_versions`

**字段设计**:
- `id` (BIGINT, PRIMARY KEY): 版本ID
- `app_id` (BIGINT, NOT NULL): 小程序ID
- `version` (VARCHAR, NOT NULL): 版本号（自动递增）
- `requirement_text` (TEXT): 该版本的需求描述（如果有修改）
- `requirement_parsed` (TEXT): 解析后的需求（JSON）
- `backend_code_url` (VARCHAR): 后端代码存储地址
- `frontend_code_url` (VARCHAR): 前端代码存储地址
- `manifest_data` (TEXT): manifest.json数据
- `changelog` (TEXT): 更新日志（自动生成或用户填写）
- `status` (VARCHAR, NOT NULL): 状态（generating/reviewing/approved/rejected/published）
- `review_comment` (TEXT): 审核意见
- `reviewed_at` (DATETIME): 审核时间
- `reviewed_by` (BIGINT): 审核人ID（自动审核为null）
- `published_at` (DATETIME): 发布时间
- `created_at` (DATETIME, DEFAULT CURRENT_TIMESTAMP): 创建时间

**索引**:
- `idx_app_version` (app_id, version)
- `idx_status` (status, created_at)

**说明**：
- 每次用户修改需求描述或优化代码时，自动创建新版本
- 版本号自动递增（如：1.0.0 -> 1.0.1 -> 1.1.0）

---

### 4.3 用户小程序安装表

**表名**: `miniprogram_installs`

**字段设计**:
- `id` (BIGINT, PRIMARY KEY): 安装ID
- `user_id` (BIGINT, NOT NULL): 用户ID
- `app_id` (BIGINT, NOT NULL): 小程序ID
- `version` (VARCHAR, NOT NULL): 安装的版本
- `permissions_granted` (JSON): 已授予的权限
- `is_enabled` (BOOLEAN, DEFAULT TRUE): 是否启用
- `last_used_at` (DATETIME): 最后使用时间
- `installed_at` (DATETIME, DEFAULT CURRENT_TIMESTAMP): 安装时间
- `updated_at` (DATETIME, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP): 更新时间

**索引**:
- `idx_user_app` (user_id, app_id)
- `idx_user` (user_id, last_used_at)
- `idx_app` (app_id, installed_at)

---

### 4.4 小程序数据表

**表名**: `miniprogram_user_data`

**字段设计**:
- `id` (BIGINT, PRIMARY KEY): 数据ID
- `user_id` (BIGINT, NOT NULL): 用户ID
- `app_id` (BIGINT, NOT NULL): 小程序ID
- `data_key` (VARCHAR, NOT NULL): 数据键
- `data_value` (TEXT): 数据值（JSON格式）
- `data_type` (VARCHAR): 数据类型
- `created_at` (DATETIME, DEFAULT CURRENT_TIMESTAMP): 创建时间
- `updated_at` (DATETIME, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP): 更新时间

**索引**:
- `idx_user_app_key` (user_id, app_id, data_key)
- `idx_user_app` (user_id, app_id)

---

### 4.5 小程序审核记录表

**表名**: `miniprogram_reviews`

**字段设计**:
- `id` (BIGINT, PRIMARY KEY): 审核ID
- `version_id` (BIGINT, NOT NULL): 版本ID
- `review_type` (VARCHAR, NOT NULL): 审核类型（auto/manual）
- `status` (VARCHAR, NOT NULL): 审核状态（pending/passed/rejected）
- `review_comment` (TEXT): 审核意见
- `security_score` (INT): 安全评分
- `quality_score` (INT): 质量评分
- `reviewed_at` (DATETIME): 审核时间
- `reviewed_by` (BIGINT): 审核人ID（人工审核）
- `created_at` (DATETIME, DEFAULT CURRENT_TIMESTAMP): 创建时间

**索引**:
- `idx_version` (version_id)
- `idx_status` (status, created_at)

---

### 4.6 小程序统计表

**表名**: `miniprogram_statistics`

**字段设计**:
- `id` (BIGINT, PRIMARY KEY): 统计ID
- `app_id` (BIGINT, NOT NULL): 小程序ID
- `stat_date` (DATE, NOT NULL): 统计日期
- `install_count` (INT, DEFAULT 0): 当日安装数
- `active_users` (INT, DEFAULT 0): 活跃用户数
- `launch_count` (INT, DEFAULT 0): 启动次数
- `avg_session_duration` (INT): 平均会话时长（秒）
- `error_count` (INT, DEFAULT 0): 错误次数
- `api_call_count` (INT, DEFAULT 0): API调用次数
- `created_at` (DATETIME, DEFAULT CURRENT_TIMESTAMP): 创建时间

**索引**:
- `idx_app_date` (app_id, stat_date)

---

## 五、API接口设计

### 5.1 开发者API

**接口**: `POST /api/miniprogram/upload`

**功能**: 上传小程序

**请求参数**:
- `file` (file, required): ZIP文件
- `version` (string, required): 版本号
- `changelog` (string): 更新日志

**响应数据**:
- `versionId` (long): 版本ID
- `status` (string): 状态
- `message` (string): 消息

---

**接口**: `GET /api/miniprogram/my-apps`

**功能**: 获取我的小程序列表

**请求参数**:
- `status` (string): 状态筛选
- `page` (integer): 页码
- `size` (integer): 每页数量

**响应数据**:
- `apps` (array): 小程序列表
- `total` (integer): 总数量

---

**接口**: `GET /api/miniprogram/apps/{appId}/versions`

**功能**: 获取小程序版本列表

**响应数据**:
- `versions` (array): 版本列表

---

**接口**: `GET /api/miniprogram/apps/{appId}/statistics`

**功能**: 获取小程序统计数据

**请求参数**:
- `startDate` (date): 开始日期
- `endDate` (date): 结束日期

**响应数据**:
- `statistics` (object): 统计数据

---

### 5.2 开发者管理API

**接口**: `GET /api/miniprogram/my-apps`

**功能**: 获取我的小程序列表

**请求参数**:
- `status` (string): 状态筛选
- `page` (integer): 页码
- `size` (integer): 每页数量

**响应数据**:
- `apps` (array): 小程序列表
- `total` (integer): 总数量

---

**接口**: `GET /api/miniprogram/apps/{appId}`

**功能**: 获取小程序详情（开发者视图）

**响应数据**:
- `app` (object): 小程序详细信息
- `requirementText` (string): 原始需求描述
- `requirementParsed` (object): 解析后的需求
- `versions` (array): 版本列表
- `codeUrls` (object): 代码地址
  - `backendCodeUrl` (string): 后端代码地址
  - `frontendCodeUrl` (string): 前端代码地址
- `apiEndpoints` (array): API端点列表

---

**接口**: `POST /api/miniprogram/apps/{appId}/publish`

**功能**: 发布小程序

**响应数据**:
- `success` (boolean): 是否成功
- `message` (string): 消息

---

**接口**: `POST /api/miniprogram/apps/{appId}/unpublish`

**功能**: 下架小程序

**响应数据**:
- `success` (boolean): 是否成功

---

### 5.3 用户API

**接口**: `GET /api/miniprogram/store/apps`

**功能**: 获取小程序商店列表

**请求参数**:
- `category` (string): 分类
- `tag` (string): 标签
- `keyword` (string): 关键词
- `sort` (string): 排序方式
- `page` (integer): 页码
- `size` (integer): 每页数量

**响应数据**:
- `apps` (array): 小程序列表
- `total` (integer): 总数量

---

**接口**: `GET /api/miniprogram/store/apps/{appId}`

**功能**: 获取小程序详情（商店视图）

**响应数据**:
- `app` (object): 小程序详细信息
- `description` (string): 小程序描述
- `screenshots` (array): 截图列表（自动生成）
- `reviews` (array): 用户评价
- `permissions` (array): 所需权限列表

---

**接口**: `POST /api/miniprogram/install`

**功能**: 安装小程序

**请求参数**:
- `appId` (long, required): 小程序ID

**响应数据**:
- `installId` (long): 安装ID
- `success` (boolean): 是否成功

**说明**：
- 权限在manifest.json中已定义，安装时自动确认

---

**接口**: `GET /api/miniprogram/my-installs`

**功能**: 获取已安装的小程序列表

**响应数据**:
- `installs` (array): 安装列表

---

**接口**: `DELETE /api/miniprogram/uninstall/{appId}`

**功能**: 卸载小程序

**响应数据**:
- `success` (boolean): 是否成功

---

**接口**: `POST /api/miniprogram/apps/{appId}/launch`

**功能**: 启动小程序

**响应数据**:
- `sessionId` (string): 会话ID
- `launchUrl` (string): 启动URL（前端代码URL）
- `apiBaseUrl` (string): API基础URL（后端API地址）
- `config` (object): 配置信息

---

### 5.3 小程序运行时API（提供给小程序调用）

**接口**: `GET /api/miniprogram/runtime/user-info`

**功能**: 获取用户信息（需权限）

**响应数据**:
- `userInfo` (object): 用户信息

---

**接口**: `GET /api/miniprogram/runtime/memories`

**功能**: 获取记忆数据（需权限）

**请求参数**:
- `page` (integer): 页码
- `size` (integer): 每页数量

**响应数据**:
- `memories` (array): 记忆列表

---

**接口**: `POST /api/miniprogram/runtime/memories`

**功能**: 创建记忆（需权限）

**请求参数**:
- `content` (string, required): 记忆内容
- `emotion` (string): 情绪
- `tags` (array): 标签

**响应数据**:
- `memoryId` (long): 记忆ID

---

**接口**: `GET /api/miniprogram/runtime/emotions`

**功能**: 获取情绪数据（需权限）

**响应数据**:
- `emotions` (array): 情绪列表

---

**接口**: `POST /api/miniprogram/runtime/storage/set`

**功能**: 设置小程序数据存储

**请求参数**:
- `key` (string, required): 数据键
- `value` (any, required): 数据值

**响应数据**:
- `success` (boolean): 是否成功

---

**接口**: `GET /api/miniprogram/runtime/storage/get`

**功能**: 获取小程序数据存储

**请求参数**:
- `key` (string, required): 数据键

**响应数据**:
- `value` (any): 数据值

---

### 5.4 管理后台API

**接口**: `GET /api/admin/miniprogram/review/list`

**功能**: 获取待审核小程序列表

**请求参数**:
- `status` (string): 状态
- `page` (integer): 页码
- `size` (integer): 每页数量

**响应数据**:
- `reviews` (array): 审核列表

---

**接口**: `POST /api/admin/miniprogram/review/{versionId}/approve`

**功能**: 审核通过

**请求参数**:
- `comment` (string): 审核意见

**响应数据**:
- `success` (boolean): 是否成功

---

**接口**: `POST /api/admin/miniprogram/review/{versionId}/reject`

**功能**: 审核不通过

**请求参数**:
- `comment` (string, required): 拒绝原因

**响应数据**:
- `success` (boolean): 是否成功

---

## 六、UI/UX设计需求

### 6.1 小程序商店界面

- **商店首页**：推荐、分类、排行榜
- **小程序详情页**：基本信息、截图、评价、安装
- **分类页面**：分类浏览和筛选
- **搜索页面**：搜索和结果展示

### 6.2 用户小程序管理界面

- **我的小程序**：已安装小程序列表
- **小程序详情**：小程序信息和设置
- **权限管理**：管理小程序权限
- **使用统计**：查看使用数据

### 6.3 开发者中心界面

- **我的应用**：我开发的小程序列表
- **上传小程序**：上传新版本
- **数据统计**：使用统计和分析
- **版本管理**：版本历史和管理

### 6.4 小程序运行界面

- **小程序容器**：运行小程序的容器界面
- **导航栏**：小程序导航栏（可自定义）
- **加载状态**：加载中的状态展示
- **错误提示**：错误信息的友好提示

---

## 七、实施计划

### 7.1 第一阶段：规范和框架设计（2周）

- [ ] 完成小程序开发规范文档
- [ ] 设计manifest.json规范
- [ ] 设计API接口规范
- [ ] 设计运行框架架构
- [ ] 开发小程序开发脚手架（CLI工具）

### 7.2 第二阶段：基础功能开发（3周）

- [ ] 开发小程序上传功能
- [ ] 开发小程序存储功能
- [ ] 开发小程序运行容器
- [ ] 开发API代理层
- [ ] 开发权限控制系统

### 7.3 第三阶段：审核和管理功能（2周）

- [ ] 开发自动审核功能
- [ ] 开发人工审核功能
- [ ] 开发小程序管理后台
- [ ] 开发版本管理系统
- [ ] 开发部署系统

### 7.4 第四阶段：商店和用户功能（2周）

- [ ] 开发小程序商店
- [ ] 开发小程序安装功能
- [ ] 开发用户小程序管理
- [ ] 开发小程序运行界面
- [ ] 开发数据统计功能

### 7.5 第五阶段：优化和测试（2周）

- [ ] 性能优化
- [ ] 安全加固
- [ ] 全面测试
- [ ] 文档完善
- [ ] 示例小程序开发

---

## 八、验收标准

### 8.1 功能验收

- ✅ 用户可以通过自然语言描述创建小程序
- ✅ 系统可以正确解析需求并生成后端代码（通过AipexBase）
- ✅ 系统可以正确生成前端代码（通过提示词平台）
- ✅ 生成的代码可以正常运行
- ✅ 代码生成和部署流程自动化
- ✅ 用户可以通过提示词优化和迭代小程序
- ✅ 审核流程正常运行
- ✅ 用户可以在商店中浏览和安装小程序
- ✅ 小程序可以正常运行
- ✅ 权限控制有效
- ✅ 数据隔离正确

### 8.2 性能验收

- ✅ 代码生成时间 < 5分钟（后端+前端）
- ✅ 小程序启动时间 < 2秒
- ✅ 小程序页面加载时间 < 1秒
- ✅ API响应时间 < 500ms
- ✅ 系统稳定可靠

### 8.3 安全验收

- ✅ 自动代码安全扫描有效
- ✅ 沙箱隔离有效
- ✅ 权限控制有效
- ✅ 数据安全保护有效
- ✅ 生成的代码无明显的安全漏洞

---

## 九、风险和注意事项

### 9.1 技术风险

- **代码生成质量**：AI生成的代码质量可能不稳定，需要验证和优化
- **AipexBase集成**：需要确保AipexBase的稳定性和可用性
- **需求解析准确性**：自然语言解析可能存在偏差，需要迭代优化
- **性能问题**：小程序数量增多可能影响系统性能，需要优化
- **兼容性问题**：生成的代码与心域系统可能不兼容，需要测试和验证

### 9.2 业务风险

- **用户接受度**：用户需要适应通过自然语言描述需求的方式
- **质量控制**：生成的代码质量需要保证，避免劣质小程序影响用户体验
- **运营成本**：代码生成、审核、维护等需要计算资源成本

### 9.3 注意事项

- **需求描述清晰度**：引导用户提供清晰、详细的需求描述
- **迭代优化机制**：提供便捷的迭代优化方式，让用户可以逐步完善小程序
- **示例和模板**：提供丰富的示例和模板，帮助用户理解如何描述需求
- **代码审查**：自动生成的代码需要进行安全审查和质量检查
- **用户教育**：提供使用指南和最佳实践，帮助用户更好地使用平台
- **AipexBase依赖**：需要考虑AipexBase服务不可用时的备选方案
- **数据隐私**：保护用户数据隐私，确保生成的小程序符合隐私要求

---

**文档状态**: 需求分析已完成

