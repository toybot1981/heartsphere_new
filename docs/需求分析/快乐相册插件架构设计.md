# 快乐相册插件架构设计

**文档版本**: V1.0  
**编写日期**: 2025-12-31  
**功能模块**: 快乐相册插件  
**架构类型**: 标准前后端分离架构

---

## 一、架构概述

### 1.1 设计原则

1. **前后端分离**：标准的前后端分离架构，前端React，后端Spring Boot
2. **模块化设计**：独立的插件模块，易于集成到心域系统
3. **可扩展性**：支持未来功能扩展（如AI图片识别、自动标签等）
4. **性能优化**：图片压缩、缩略图生成、CDN加速
5. **数据安全**：用户数据隔离，权限控制

### 1.2 技术栈

**后端技术栈**：
- **框架**：Spring Boot 3.x
- **ORM**：Spring Data JPA
- **数据库**：MySQL 8.0+
- **文件存储**：MinIO / OSS（对象存储）
- **图片处理**：ImageIO / Thumbnailator（图片压缩和缩略图生成）
- **缓存**：Redis（可选，用于缓存常用数据）

**前端技术栈**：
- **框架**：React 18+ + TypeScript
- **构建工具**：Vite
- **UI库**：Tailwind CSS + Ant Design（可选）
- **状态管理**：React Hooks / Zustand
- **图片预览**：react-image-viewer / react-viewer

### 1.3 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      前端层 (Frontend)                        │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ 相册列表组件  │  │ 相册详情组件  │  │ 照片上传组件  │     │
│  │ AlbumList   │  │ AlbumDetail  │  │ PhotoUpload  │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ 照片列表组件  │  │ 照片详情组件  │  │ 场景集成组件  │     │
│  │ PhotoList   │  │ PhotoDetail  │  │ ScenePlugin  │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                              │
│  ┌────────────────────────────────────────────────────┐   │
│  │         PhotoAlbumService (API Client)              │   │
│  └────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↕ HTTP/REST
┌─────────────────────────────────────────────────────────────┐
│                      API层 (Backend API)                      │
├─────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────┐     │
│  │         PhotoAlbumController                       │     │
│  │  - GET    /api/photo-albums                       │     │
│  │  - POST   /api/photo-albums                       │     │
│  │  - GET    /api/photo-albums/{id}                  │     │
│  │  - PUT    /api/photo-albums/{id}                  │     │
│  │  - DELETE /api/photo-albums/{id}                  │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│  ┌────────────────────────────────────────────────────┐     │
│  │         PhotoController                            │     │
│  │  - POST   /api/photo-albums/{id}/photos           │     │
│  │  - POST   /api/photo-albums/{id}/photos/batch     │     │
│  │  - GET    /api/photo-albums/{id}/photos           │     │
│  │  - GET    /api/photos/{id}                        │     │
│  │  - PUT    /api/photos/{id}                        │     │
│  │  - DELETE /api/photos/{id}                        │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│  ┌────────────────────────────────────────────────────┐     │
│  │         PhotoSearchController                      │     │
│  │  - GET    /api/photo-albums/search                 │     │
│  │  - GET    /api/photos/search                       │     │
│  └────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────────┐
│                   业务逻辑层 (Service Layer)                   │
├─────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────┐     │
│  │         PhotoAlbumService                          │     │
│  │  - 相册CRUD操作                                    │     │
│  │  - 相册统计                                        │     │
│  │  - 相册关联场景                                    │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│  ┌────────────────────────────────────────────────────┐     │
│  │         PhotoService                               │     │
│  │  - 照片上传和处理                                  │     │
│  │  - 照片CRUD操作                                    │     │
│  │  - 照片排序                                        │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│  ┌────────────────────────────────────────────────────┐     │
│  │         ImageProcessingService                     │     │
│  │  - 图片压缩                                        │     │
│  │  - 缩略图生成                                      │     │
│  │  - 图片格式转换                                    │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│  ┌────────────────────────────────────────────────────┐     │
│  │         FileStorageService                         │     │
│  │  - 文件上传到对象存储                              │     │
│  │  - 文件URL生成                                     │     │
│  │  - 文件删除                                        │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│  ┌────────────────────────────────────────────────────┐     │
│  │         PhotoSearchService                         │     │
│  │  - 相册搜索                                        │     │
│  │  - 照片搜索                                        │     │
│  │  - 标签搜索                                        │     │
│  └────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────────┐
│                   数据访问层 (Repository Layer)                │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ PhotoAlbum   │  │ Photo        │  │ (场景相关)   │       │
│  │ Repository   │  │ Repository   │  │ Repository   │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────────┐
│                     数据库层 (Database)                        │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐                         │
│  │photo_albums  │  │   photos     │                         │
│  │    table     │  │    table     │                         │
│  └──────────────┘  └──────────────┘                         │
└─────────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────────┐
│                   对象存储 (Object Storage)                    │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐                         │
│  │  原始图片    │  │   缩略图     │                         │
│  │   (MinIO)    │  │   (MinIO)    │                         │
│  └──────────────┘  └──────────────┘                         │
└─────────────────────────────────────────────────────────────┘
```

---

## 二、模块结构设计

### 2.1 后端模块结构

```
com.heartsphere.photoalbum/
├── controller/
│   ├── PhotoAlbumController.java      # 相册管理控制器
│   ├── PhotoController.java           # 照片管理控制器
│   └── PhotoSearchController.java     # 搜索控制器
├── service/
│   ├── PhotoAlbumService.java         # 相册业务逻辑
│   ├── PhotoService.java              # 照片业务逻辑
│   ├── ImageProcessingService.java    # 图片处理服务
│   ├── FileStorageService.java        # 文件存储服务
│   └── PhotoSearchService.java        # 搜索服务
├── repository/
│   ├── PhotoAlbumRepository.java      # 相册数据访问
│   └── PhotoRepository.java           # 照片数据访问
├── entity/
│   ├── PhotoAlbum.java                # 相册实体
│   └── Photo.java                     # 照片实体
├── dto/
│   ├── request/
│   │   ├── CreateAlbumDTO.java        # 创建相册请求
│   │   ├── UpdateAlbumDTO.java        # 更新相册请求
│   │   ├── UploadPhotoDTO.java        # 上传照片请求
│   │   └── UpdatePhotoDTO.java        # 更新照片请求
│   └── response/
│       ├── AlbumDTO.java              # 相册响应
│       └── PhotoDTO.java              # 照片响应
├── config/
│   ├── ImageProcessingConfig.java     # 图片处理配置
│   └── StorageConfig.java             # 存储配置
└── exception/
    ├── AlbumNotFoundException.java    # 相册未找到异常
    └── PhotoNotFoundException.java    # 照片未找到异常
```

### 2.2 前端模块结构

```
frontend/
├── components/
│   └── photo-album/
│       ├── AlbumList.tsx              # 相册列表组件
│       ├── AlbumCard.tsx              # 相册卡片组件
│       ├── AlbumDetail.tsx            # 相册详情组件
│       ├── AlbumForm.tsx              # 相册表单组件
│       ├── PhotoList.tsx              # 照片列表组件
│       ├── PhotoCard.tsx              # 照片卡片组件
│       ├── PhotoDetail.tsx            # 照片详情组件
│       ├── PhotoUpload.tsx            # 照片上传组件
│       ├── PhotoUploadBatch.tsx       # 批量上传组件
│       ├── PhotoForm.tsx              # 照片表单组件
│       ├── PhotoViewer.tsx            # 照片查看器组件
│       ├── PhotoSearch.tsx            # 照片搜索组件
│       └── SceneIntegration.tsx       # 场景集成组件
├── services/
│   └── api/
│       └── photoAlbum.ts              # 相册API服务
├── hooks/
│   ├── useAlbums.ts                   # 相册Hook
│   ├── usePhotos.ts                   # 照片Hook
│   ├── usePhotoUpload.ts              # 照片上传Hook
│   └── usePhotoSearch.ts              # 照片搜索Hook
├── types/
│   └── photoAlbum.ts                  # 相册类型定义
└── utils/
    ├── imageUtils.ts                  # 图片工具函数
    └── photoUtils.ts                  # 照片工具函数
```

---

## 三、核心服务设计

### 3.1 PhotoAlbumService（相册服务）

**职责**：
- 相册的CRUD操作
- 相册统计信息更新
- 相册与场景的关联管理

**核心方法**：

```java
@Service
@Transactional
public class PhotoAlbumService {
    
    @Autowired
    private PhotoAlbumRepository albumRepository;
    
    @Autowired
    private PhotoRepository photoRepository;
    
    /**
     * 创建相册
     */
    public PhotoAlbum createAlbum(Long userId, CreateAlbumDTO dto) {
        PhotoAlbum album = new PhotoAlbum();
        album.setUserId(userId);
        album.setName(dto.getName());
        album.setDescription(dto.getDescription());
        album.setTags(dto.getTags());
        album.setSceneIds(dto.getSceneIds());
        album.setPhotoCount(0);
        
        return albumRepository.save(album);
    }
    
    /**
     * 更新相册
     */
    public PhotoAlbum updateAlbum(Long albumId, Long userId, UpdateAlbumDTO dto) {
        PhotoAlbum album = findAlbumByIdAndUserId(albumId, userId);
        
        if (dto.getName() != null) {
            album.setName(dto.getName());
        }
        if (dto.getDescription() != null) {
            album.setDescription(dto.getDescription());
        }
        if (dto.getTags() != null) {
            album.setTags(dto.getTags());
        }
        if (dto.getSceneIds() != null) {
            album.setSceneIds(dto.getSceneIds());
        }
        if (dto.getCoverPhotoId() != null) {
            Photo coverPhoto = photoRepository.findById(dto.getCoverPhotoId())
                .orElseThrow(() -> new PhotoNotFoundException(dto.getCoverPhotoId()));
            album.setCoverPhotoId(coverPhoto.getId());
            album.setCoverPhotoUrl(coverPhoto.getThumbnailUrl());
        }
        
        return albumRepository.save(album);
    }
    
    /**
     * 删除相册（软删除）
     */
    public void deleteAlbum(Long albumId, Long userId) {
        PhotoAlbum album = findAlbumByIdAndUserId(albumId, userId);
        album.setDeleted(true);
        albumRepository.save(album);
        
        // 同时软删除相册中的所有照片
        photoRepository.markAsDeletedByAlbumId(albumId);
    }
    
    /**
     * 更新相册照片数量
     */
    public void updatePhotoCount(Long albumId) {
        long count = photoRepository.countByAlbumIdAndDeletedFalse(albumId);
        albumRepository.updatePhotoCount(albumId, count);
    }
    
    /**
     * 获取用户的相册列表
     */
    public Page<PhotoAlbum> getUserAlbums(Long userId, Pageable pageable) {
        return albumRepository.findByUserIdAndDeletedFalse(userId, pageable);
    }
    
    /**
     * 根据场景ID获取相册列表
     */
    public List<PhotoAlbum> getAlbumsBySceneId(Long sceneId, Long userId) {
        return albumRepository.findBySceneIdsContainsAndUserIdAndDeletedFalse(
            sceneId, userId
        );
    }
    
    private PhotoAlbum findAlbumByIdAndUserId(Long albumId, Long userId) {
        return albumRepository.findByIdAndUserIdAndDeletedFalse(albumId, userId)
            .orElseThrow(() -> new AlbumNotFoundException(albumId));
    }
}
```

---

### 3.2 PhotoService（照片服务）

**职责**：
- 照片上传和处理
- 照片CRUD操作
- 照片排序管理

**核心方法**：

```java
@Service
@Transactional
public class PhotoService {
    
    @Autowired
    private PhotoRepository photoRepository;
    
    @Autowired
    private PhotoAlbumService albumService;
    
    @Autowired
    private ImageProcessingService imageProcessingService;
    
    @Autowired
    private FileStorageService fileStorageService;
    
    /**
     * 上传照片
     */
    public Photo uploadPhoto(Long albumId, Long userId, MultipartFile file, 
                             UploadPhotoDTO dto) {
        // 1. 验证相册存在且属于用户
        PhotoAlbum album = albumService.findAlbumByIdAndUserId(albumId, userId);
        
        // 2. 处理图片（压缩、生成缩略图）
        ImageProcessingResult result = imageProcessingService.processImage(file);
        
        // 3. 上传到对象存储
        String photoUrl = fileStorageService.uploadFile(
            result.getProcessedImage(), 
            "photos/original"
        );
        String thumbnailUrl = fileStorageService.uploadFile(
            result.getThumbnail(), 
            "photos/thumbnail"
        );
        
        // 4. 创建照片记录
        Photo photo = new Photo();
        photo.setAlbumId(albumId);
        photo.setUserId(userId);
        photo.setTitle(dto.getTitle());
        photo.setDescription(dto.getDescription());
        photo.setPhotoUrl(photoUrl);
        photo.setThumbnailUrl(thumbnailUrl);
        photo.setFileSize(result.getFileSize());
        photo.setWidth(result.getWidth());
        photo.setHeight(result.getHeight());
        photo.setTakenAt(dto.getTakenAt() != null ? dto.getTakenAt() : LocalDateTime.now());
        photo.setLocation(dto.getLocation());
        photo.setTags(dto.getTags());
        photo.setMoodTags(dto.getMoodTags());
        photo.setParticipantIds(dto.getParticipantIds());
        photo.setMemoryId(dto.getMemoryId());
        
        // 5. 设置排序顺序（最后一张）
        Integer maxSortOrder = photoRepository.findMaxSortOrderByAlbumId(albumId);
        photo.setSortOrder(maxSortOrder != null ? maxSortOrder + 1 : 0);
        
        Photo savedPhoto = photoRepository.save(photo);
        
        // 6. 更新相册照片数量
        albumService.updatePhotoCount(albumId);
        
        // 7. 如果是第一张照片，自动设置为封面
        if (album.getCoverPhotoId() == null) {
            album.setCoverPhotoId(savedPhoto.getId());
            album.setCoverPhotoUrl(savedPhoto.getThumbnailUrl());
            albumService.save(album);
        }
        
        return savedPhoto;
    }
    
    /**
     * 批量上传照片
     */
    public List<Photo> uploadPhotosBatch(Long albumId, Long userId, 
                                        List<MultipartFile> files,
                                        UploadPhotoDTO defaultDto) {
        List<Photo> photos = new ArrayList<>();
        List<String> failedFiles = new ArrayList<>();
        
        for (MultipartFile file : files) {
            try {
                UploadPhotoDTO dto = new UploadPhotoDTO();
                dto.setTitle(defaultDto.getTitle() != null ? 
                    defaultDto.getTitle() : file.getOriginalFilename());
                dto.setDescription(defaultDto.getDescription());
                dto.setTags(defaultDto.getTags());
                dto.setTakenAt(defaultDto.getTakenAt());
                
                Photo photo = uploadPhoto(albumId, userId, file, dto);
                photos.add(photo);
            } catch (Exception e) {
                failedFiles.add(file.getOriginalFilename());
                log.error("Failed to upload photo: {}", file.getOriginalFilename(), e);
            }
        }
        
        return photos;
    }
    
    /**
     * 更新照片信息
     */
    public Photo updatePhoto(Long photoId, Long userId, UpdatePhotoDTO dto) {
        Photo photo = findPhotoByIdAndUserId(photoId, userId);
        
        if (dto.getTitle() != null) {
            photo.setTitle(dto.getTitle());
        }
        if (dto.getDescription() != null) {
            photo.setDescription(dto.getDescription());
        }
        if (dto.getTakenAt() != null) {
            photo.setTakenAt(dto.getTakenAt());
        }
        if (dto.getLocation() != null) {
            photo.setLocation(dto.getLocation());
        }
        if (dto.getTags() != null) {
            photo.setTags(dto.getTags());
        }
        if (dto.getMoodTags() != null) {
            photo.setMoodTags(dto.getMoodTags());
        }
        if (dto.getParticipantIds() != null) {
            photo.setParticipantIds(dto.getParticipantIds());
        }
        if (dto.getMemoryId() != null) {
            photo.setMemoryId(dto.getMemoryId());
        }
        
        return photoRepository.save(photo);
    }
    
    /**
     * 删除照片（软删除）
     */
    public void deletePhoto(Long photoId, Long userId) {
        Photo photo = findPhotoByIdAndUserId(photoId, userId);
        photo.setDeleted(true);
        photoRepository.save(photo);
        
        // 更新相册照片数量
        albumService.updatePhotoCount(photo.getAlbumId());
        
        // 如果删除的是封面照片，需要重新设置封面
        PhotoAlbum album = albumService.findById(photo.getAlbumId());
        if (album.getCoverPhotoId() != null && album.getCoverPhotoId().equals(photoId)) {
            Photo newCoverPhoto = photoRepository.findFirstByAlbumIdAndDeletedFalseOrderBySortOrder(
                photo.getAlbumId()
            ).orElse(null);
            
            if (newCoverPhoto != null) {
                album.setCoverPhotoId(newCoverPhoto.getId());
                album.setCoverPhotoUrl(newCoverPhoto.getThumbnailUrl());
            } else {
                album.setCoverPhotoId(null);
                album.setCoverPhotoUrl(null);
            }
            albumService.save(album);
        }
    }
    
    /**
     * 调整照片顺序
     */
    public void reorderPhotos(Long albumId, Long userId, 
                             List<PhotoOrderDTO> photoOrders) {
        PhotoAlbum album = albumService.findAlbumByIdAndUserId(albumId, userId);
        
        for (PhotoOrderDTO order : photoOrders) {
            Photo photo = photoRepository.findById(order.getPhotoId())
                .orElseThrow(() -> new PhotoNotFoundException(order.getPhotoId()));
            
            if (!photo.getAlbumId().equals(albumId)) {
                throw new IllegalArgumentException("Photo does not belong to album");
            }
            
            photo.setSortOrder(order.getSortOrder());
            photoRepository.save(photo);
        }
    }
    
    private Photo findPhotoByIdAndUserId(Long photoId, Long userId) {
        return photoRepository.findByIdAndUserIdAndDeletedFalse(photoId, userId)
            .orElseThrow(() -> new PhotoNotFoundException(photoId));
    }
}
```

---

### 3.3 ImageProcessingService（图片处理服务）

**职责**：
- 图片压缩
- 缩略图生成
- 图片格式转换

**核心方法**：

```java
@Service
public class ImageProcessingService {
    
    @Value("${photo.max-width:1920}")
    private int maxWidth;
    
    @Value("${photo.max-height:1920}")
    private int maxHeight;
    
    @Value("${photo.thumbnail-width:300}")
    private int thumbnailWidth;
    
    @Value("${photo.thumbnail-height:300}")
    private int thumbnailHeight;
    
    @Value("${photo.quality:0.85}")
    private double quality;
    
    /**
     * 处理图片（压缩和生成缩略图）
     */
    public ImageProcessingResult processImage(MultipartFile file) throws IOException {
        // 1. 读取原始图片
        BufferedImage originalImage = ImageIO.read(file.getInputStream());
        int originalWidth = originalImage.getWidth();
        int originalHeight = originalImage.getHeight();
        
        // 2. 压缩图片
        BufferedImage processedImage = resizeImage(originalImage, maxWidth, maxHeight);
        ByteArrayOutputStream processedOs = new ByteArrayOutputStream();
        ImageIO.write(processedImage, "jpg", processedOs);
        byte[] processedBytes = processedOs.toByteArray();
        
        // 3. 生成缩略图
        BufferedImage thumbnail = resizeImage(originalImage, thumbnailWidth, thumbnailHeight);
        ByteArrayOutputStream thumbnailOs = new ByteArrayOutputStream();
        ImageIO.write(thumbnail, "jpg", thumbnailOs);
        byte[] thumbnailBytes = thumbnailOs.toByteArray();
        
        // 4. 返回结果
        return ImageProcessingResult.builder()
            .processedImage(new ByteArrayInputStream(processedBytes))
            .thumbnail(new ByteArrayInputStream(thumbnailBytes))
            .fileSize(processedBytes.length)
            .width(processedImage.getWidth())
            .height(processedImage.getHeight())
            .build();
    }
    
    /**
     * 调整图片大小（保持宽高比）
     */
    private BufferedImage resizeImage(BufferedImage originalImage, 
                                     int targetWidth, int targetHeight) {
        int originalWidth = originalImage.getWidth();
        int originalHeight = originalImage.getHeight();
        
        // 计算缩放比例
        double scaleX = (double) targetWidth / originalWidth;
        double scaleY = (double) targetHeight / originalHeight;
        double scale = Math.min(scaleX, scaleY);
        
        // 如果图片已经小于目标尺寸，不进行放大
        if (scale >= 1.0) {
            return originalImage;
        }
        
        int newWidth = (int) (originalWidth * scale);
        int newHeight = (int) (originalHeight * scale);
        
        // 使用高质量缩放
        Image scaledImage = originalImage.getScaledInstance(
            newWidth, newHeight, Image.SCALE_SMOOTH
        );
        
        BufferedImage resizedImage = new BufferedImage(
            newWidth, newHeight, BufferedImage.TYPE_INT_RGB
        );
        Graphics2D g = resizedImage.createGraphics();
        g.setRenderingHint(RenderingHints.KEY_INTERPOLATION, 
                          RenderingHints.VALUE_INTERPOLATION_BILINEAR);
        g.drawImage(scaledImage, 0, 0, null);
        g.dispose();
        
        return resizedImage;
    }
}
```

---

### 3.4 FileStorageService（文件存储服务）

**职责**：
- 文件上传到对象存储
- 文件URL生成
- 文件删除

**核心方法**：

```java
@Service
public class FileStorageService {
    
    @Autowired
    private MinioClient minioClient;
    
    @Value("${minio.bucket:photo-album}")
    private String bucketName;
    
    @Value("${minio.endpoint}")
    private String endpoint;
    
    /**
     * 上传文件到对象存储
     */
    public String uploadFile(InputStream inputStream, String objectName) {
        try {
            // 确保bucket存在
            if (!minioClient.bucketExists(BucketExistsArgs.builder()
                    .bucket(bucketName).build())) {
                minioClient.makeBucket(MakeBucketArgs.builder()
                    .bucket(bucketName).build());
            }
            
            // 生成唯一的文件名
            String fileName = UUID.randomUUID().toString() + ".jpg";
            String fullObjectName = objectName + "/" + fileName;
            
            // 上传文件
            minioClient.putObject(
                PutObjectArgs.builder()
                    .bucket(bucketName)
                    .object(fullObjectName)
                    .stream(inputStream, -1, 10485760) // 10MB chunks
                    .contentType("image/jpeg")
                    .build()
            );
            
            // 生成访问URL
            return generateUrl(fullObjectName);
            
        } catch (Exception e) {
            throw new RuntimeException("Failed to upload file", e);
        }
    }
    
    /**
     * 删除文件
     */
    public void deleteFile(String objectName) {
        try {
            minioClient.removeObject(
                RemoveObjectArgs.builder()
                    .bucket(bucketName)
                    .object(objectName)
                    .build()
            );
        } catch (Exception e) {
            log.error("Failed to delete file: {}", objectName, e);
        }
    }
    
    /**
     * 生成文件访问URL
     */
    private String generateUrl(String objectName) {
        return endpoint + "/" + bucketName + "/" + objectName;
    }
}
```

---

### 3.5 PhotoSearchService（搜索服务）

**职责**：
- 相册搜索
- 照片搜索
- 标签搜索

**核心方法**：

```java
@Service
public class PhotoSearchService {
    
    @Autowired
    private PhotoAlbumRepository albumRepository;
    
    @Autowired
    private PhotoRepository photoRepository;
    
    /**
     * 搜索相册
     */
    public List<PhotoAlbum> searchAlbums(Long userId, String keyword, 
                                        List<String> tags, Long sceneId) {
        Specification<PhotoAlbum> spec = Specification.where(
            (root, query, cb) -> cb.equal(root.get("userId"), userId)
        ).and((root, query, cb) -> cb.equal(root.get("deleted"), false));
        
        if (keyword != null && !keyword.isEmpty()) {
            spec = spec.and((root, query, cb) -> cb.or(
                cb.like(cb.lower(root.get("name")), "%" + keyword.toLowerCase() + "%"),
                cb.like(cb.lower(root.get("description")), "%" + keyword.toLowerCase() + "%")
            ));
        }
        
        if (tags != null && !tags.isEmpty()) {
            spec = spec.and((root, query, cb) -> {
                // JSON字段搜索（需要根据实际数据库支持调整）
                return cb.isTrue(cb.literal(true)); // 简化实现
            });
        }
        
        if (sceneId != null) {
            spec = spec.and((root, query, cb) -> {
                // JSON数组包含检查（需要根据实际数据库支持调整）
                return cb.isTrue(cb.literal(true)); // 简化实现
            });
        }
        
        return albumRepository.findAll(spec);
    }
    
    /**
     * 搜索照片
     */
    public List<Photo> searchPhotos(Long userId, String keyword, 
                                   List<String> tags, List<String> moodTags,
                                   LocalDate startDate, LocalDate endDate) {
        Specification<Photo> spec = Specification.where(
            (root, query, cb) -> cb.equal(root.get("userId"), userId)
        ).and((root, query, cb) -> cb.equal(root.get("deleted"), false));
        
        if (keyword != null && !keyword.isEmpty()) {
            spec = spec.and((root, query, cb) -> cb.or(
                cb.like(cb.lower(root.get("title")), "%" + keyword.toLowerCase() + "%"),
                cb.like(cb.lower(root.get("description")), "%" + keyword.toLowerCase() + "%")
            ));
        }
        
        if (startDate != null) {
            spec = spec.and((root, query, cb) -> 
                cb.greaterThanOrEqualTo(root.get("takenAt"), startDate.atStartOfDay())
            );
        }
        
        if (endDate != null) {
            spec = spec.and((root, query, cb) -> 
                cb.lessThanOrEqualTo(root.get("takenAt"), endDate.atTime(23, 59, 59))
            );
        }
        
        return photoRepository.findAll(spec);
    }
}
```

---

## 四、数据流设计

### 4.1 照片上传流程

```
用户选择照片文件
    ↓
[前端] 选择文件，显示预览
    ↓
[前端] 填写照片信息（标题、描述等）
    ↓
[前端] 调用上传API（POST /api/photo-albums/{id}/photos）
    ↓
[后端] PhotoController接收请求
    ↓
[后端] PhotoService.uploadPhoto()
    ├─→ 验证相册和权限
    ├─→ ImageProcessingService.processImage()（压缩、生成缩略图）
    ├─→ FileStorageService.uploadFile()（上传原始图）
    ├─→ FileStorageService.uploadFile()（上传缩略图）
    ├─→ PhotoRepository.save()（保存照片记录）
    └─→ PhotoAlbumService.updatePhotoCount()（更新相册统计）
    ↓
[后端] 返回照片信息
    ↓
[前端] 更新照片列表，显示新上传的照片
```

### 4.2 照片查看流程

```
用户点击照片
    ↓
[前端] 调用照片详情API（GET /api/photos/{id}）
    ↓
[后端] PhotoController获取照片详情
    ↓
[后端] PhotoService.getPhotoById()
    ├─→ PhotoRepository.findById()
    └─→ 返回照片信息（包含URL）
    ↓
[前端] PhotoDetail组件显示
    ├─→ 显示大图（从对象存储加载）
    ├─→ 显示照片信息
    └─→ 支持左右滑动查看相邻照片
```

### 4.3 场景集成流程

```
用户在场景中打开相册插件
    ↓
[前端] SceneIntegration组件加载
    ↓
[前端] 调用相册列表API（GET /api/photo-albums?sceneId={id}）
    ↓
[后端] PhotoAlbumController获取关联场景的相册列表
    ↓
[后端] PhotoAlbumService.getAlbumsBySceneId()
    ├─→ PhotoAlbumRepository.findBySceneIdsContains()
    └─→ 返回相册列表
    ↓
[前端] 显示相册列表
    ↓
用户点击相册查看照片
    ↓
[前端] 显示照片列表
    ↓
E-SOUL可以基于照片内容进行互动
    ├─→ 用户向E-SOUL展示照片
    └─→ E-SOUL基于照片内容进行对话
```

---

## 五、数据库设计

### 5.1 表结构详情

**相册表 (photo_albums)**

```sql
CREATE TABLE photo_albums (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    cover_photo_id BIGINT,
    cover_photo_url VARCHAR(500),
    photo_count INT DEFAULT 0,
    tags JSON,
    scene_ids JSON,
    is_deleted BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id, is_deleted, created_at),
    INDEX idx_cover_photo_id (cover_photo_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**照片表 (photos)**

```sql
CREATE TABLE photos (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    album_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    title VARCHAR(255),
    description TEXT,
    photo_url VARCHAR(500) NOT NULL,
    thumbnail_url VARCHAR(500),
    file_size BIGINT,
    width INT,
    height INT,
    taken_at DATETIME,
    location VARCHAR(255),
    tags JSON,
    mood_tags JSON,
    participant_ids JSON,
    memory_id BIGINT,
    sort_order INT DEFAULT 0,
    is_deleted BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_album_id (album_id, sort_order, is_deleted),
    INDEX idx_user_id (user_id, is_deleted, created_at),
    INDEX idx_taken_at (taken_at),
    INDEX idx_memory_id (memory_id),
    FOREIGN KEY (album_id) REFERENCES photo_albums(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## 六、API接口设计

### 6.1 相册管理API

**创建相册**
- `POST /api/photo-albums`
- 请求体：`CreateAlbumDTO`
- 响应：`AlbumDTO`

**获取相册列表**
- `GET /api/photo-albums?page=0&size=20&keyword=&tags=&sceneId=`
- 响应：`Page<AlbumDTO>`

**获取相册详情**
- `GET /api/photo-albums/{id}`
- 响应：`AlbumDTO`

**更新相册**
- `PUT /api/photo-albums/{id}`
- 请求体：`UpdateAlbumDTO`
- 响应：`AlbumDTO`

**删除相册**
- `DELETE /api/photo-albums/{id}`
- 响应：`void`

### 6.2 照片管理API

**上传照片**
- `POST /api/photo-albums/{albumId}/photos`
- 请求：`multipart/form-data`（file + JSON数据）
- 响应：`PhotoDTO`

**批量上传照片**
- `POST /api/photo-albums/{albumId}/photos/batch`
- 请求：`multipart/form-data`（files + JSON数据）
- 响应：`List<PhotoDTO>`

**获取照片列表**
- `GET /api/photo-albums/{albumId}/photos?page=0&size=20&sort=`
- 响应：`Page<PhotoDTO>`

**获取照片详情**
- `GET /api/photos/{id}`
- 响应：`PhotoDTO`

**更新照片**
- `PUT /api/photos/{id}`
- 请求体：`UpdatePhotoDTO`
- 响应：`PhotoDTO`

**删除照片**
- `DELETE /api/photos/{id}`
- 响应：`void`

**调整照片顺序**
- `PUT /api/photo-albums/{albumId}/photos/reorder`
- 请求体：`List<PhotoOrderDTO>`
- 响应：`void`

### 6.3 搜索API

**搜索相册**
- `GET /api/photo-albums/search?keyword=&tags=&sceneId=`
- 响应：`List<AlbumDTO>`

**搜索照片**
- `GET /api/photos/search?keyword=&tags=&moodTags=&startDate=&endDate=`
- 响应：`List<PhotoDTO>`

---

## 七、前端组件设计

### 7.1 AlbumList组件

**功能**：显示相册列表

**Props**：
```typescript
interface AlbumListProps {
  userId: number;
  sceneId?: number; // 可选，如果指定则只显示关联该场景的相册
  onAlbumClick: (albumId: number) => void;
  onCreateAlbum: () => void;
}
```

**状态管理**：
- 使用`useAlbums` Hook管理相册数据
- 支持分页加载
- 支持搜索和筛选

---

### 7.2 PhotoUpload组件

**功能**：上传单张照片

**Props**：
```typescript
interface PhotoUploadProps {
  albumId: number;
  onUploadSuccess: (photo: Photo) => void;
  onUploadError: (error: Error) => void;
}
```

**功能特点**：
- 支持拖拽上传
- 支持点击选择文件
- 上传前预览
- 上传进度显示
- 支持添加照片信息（标题、描述、标签等）

---

### 7.3 PhotoViewer组件

**功能**：照片查看器（支持缩放、左右滑动）

**Props**：
```typescript
interface PhotoViewerProps {
  photos: Photo[];
  initialIndex: number;
  onClose: () => void;
  onPhotoChange?: (photo: Photo, index: number) => void;
}
```

**功能特点**：
- 大图显示
- 支持缩放（鼠标滚轮、双指缩放）
- 左右箭头切换照片
- 键盘快捷键支持（← → ESC）
- 显示照片信息

---

### 7.4 SceneIntegration组件

**功能**：场景集成组件

**Props**：
```typescript
interface SceneIntegrationProps {
  sceneId: number;
  onPhotoSelect?: (photo: Photo) => void; // 用户选择照片后回调（可用于E-SOUL互动）
}
```

**功能特点**：
- 显示场景关联的相册列表
- 支持在场景中查看相册和照片
- 支持向E-SOUL展示照片
- 集成到场景界面中

---

## 八、性能优化

### 8.1 图片优化

- **压缩处理**：上传时自动压缩大图
- **缩略图生成**：列表显示使用缩略图，详情页显示原图
- **懒加载**：照片列表使用懒加载，只加载可见区域
- **CDN加速**：图片存储在CDN，加速访问

### 8.2 数据库优化

- **索引优化**：在常用查询字段上建立索引
- **分页查询**：列表查询使用分页，避免一次性加载大量数据
- **软删除**：使用软删除，保留数据便于恢复

### 8.3 前端优化

- **虚拟滚动**：大量照片列表使用虚拟滚动
- **图片预加载**：查看照片时预加载相邻照片
- **缓存策略**：使用React Query等工具缓存API响应

---

## 九、安全设计

### 9.1 权限控制

- **用户隔离**：所有查询都基于用户ID，确保数据隔离
- **相册权限**：只有相册创建者才能修改和删除
- **照片权限**：只有照片上传者才能修改和删除

### 9.2 文件安全

- **文件类型验证**：只允许图片格式（JPG、PNG等）
- **文件大小限制**：限制上传文件大小
- **病毒扫描**：上传文件进行安全扫描（可选）

### 9.3 数据安全

- **SQL注入防护**：使用参数化查询
- **XSS防护**：前端输出转义
- **CSRF防护**：使用CSRF Token

---

## 十、扩展性设计

### 10.1 未来扩展功能

- **AI图片识别**：自动识别照片内容，生成标签
- **人脸识别**：识别照片中的人物
- **地理位置**：基于GPS信息自动添加地点
- **照片编辑**：简单的照片编辑功能（裁剪、滤镜等）
- **照片分享**：分享照片到外部平台

### 10.2 插件化设计

- **插件接口**：定义标准的插件接口
- **事件系统**：支持事件监听和触发
- **钩子函数**：支持在关键节点插入自定义逻辑

---

## 十一、部署架构

### 11.1 部署方案

```
┌─────────────────────────────────────┐
│         负载均衡 (Nginx)              │
└─────────────────────────────────────┘
              │
    ┌─────────┼─────────┐
    ▼         ▼         ▼
┌────────┐ ┌────────┐ ┌────────┐
│ Backend│ │ Backend│ │ Backend│
│ Service│ │ Service│ │ Service│
└────────┘ └────────┘ └────────┘
    │         │         │
    └─────────┼─────────┘
              ▼
      ┌───────────────┐
      │     MySQL     │
      │   (主从复制)   │
      └───────────────┘
              │
              ▼
      ┌───────────────┐
      │     MinIO     │
      │  (对象存储)    │
      └───────────────┘
              │
              ▼
      ┌───────────────┐
      │      CDN      │
      │  (图片加速)    │
      └───────────────┘
```

### 11.2 容器化部署

- **Docker**：服务容器化
- **Kubernetes**：容器编排（可选）
- **CI/CD**：自动化部署流程

---

**文档状态**: 架构设计已完成

