# 快乐相册插件需求分析

**文档版本**: V1.0  
**编写日期**: 2025-12-31  
**功能模块**: 快乐相册插件  
**目标**: 设计一个照片管理插件，用户可以记录和管理重要快乐时刻的照片，配以文字记录，在场景中使用

---

## 一、需求概述

### 1.1 背景

快乐相册插件是心域系统中的一个场景增强功能模块，允许用户在场景中记录和管理重要的快乐时刻。用户可以上传照片，为照片添加文字描述，记录那些值得珍藏的美好瞬间，如恋爱纪念日、孩子出生、重要节日等。

这个插件可以在用户创建的场景中使用，为场景增添情感色彩和真实感，让E-SOUL可以基于这些照片和记忆进行更个性化的互动。

### 1.2 核心价值

1. **记录美好时刻**：帮助用户记录和保存重要的快乐时刻
2. **情感连接**：通过照片和文字增强用户与场景的情感连接
3. **个性化互动**：E-SOUL可以基于相册内容进行更个性化的互动和对话
4. **场景丰富**：为场景增添真实感和趣味性
5. **记忆保存**：永久保存珍贵的回忆

### 1.3 使用场景

**1. 恋爱纪念相册**
- 记录恋爱中的重要时刻（第一次约会、求婚、结婚等）
- 上传照片并配上文字描述
- 在恋爱场景中使用，E-SOUL可以基于这些照片进行互动

**2. 孩子成长相册**
- 记录孩子出生、满月、周岁等重要时刻
- 上传照片记录孩子的成长
- 在家庭场景中使用，E-SOUL可以作为家庭成员与用户分享这些回忆

**3. 旅行相册**
- 记录旅行的美好瞬间
- 上传照片和游记
- 在旅行场景中使用，E-SOUL可以讨论这些旅行经历

**4. 节日庆祝相册**
- 记录节日庆祝的照片
- 上传照片和节日回忆
- 在不同场景中使用，增加节日氛围

---

## 二、功能需求

### 2.1 相册管理功能

#### 2.1.1 相册创建

- **创建相册**：
  - 用户可以创建新的相册
  - 设置相册名称（如："恋爱纪念"、"宝宝成长"等）
  - 设置相册描述
  - 选择相册封面照片
  - 设置相册分类/标签

- **相册属性**：
  - 相册名称
  - 相册描述
  - 封面照片
  - 创建时间
  - 照片数量
  - 标签/分类
  - 关联的场景（可选）

#### 2.1.2 相册列表

- **查看相册列表**：
  - 显示用户创建的所有相册
  - 支持按名称、创建时间、照片数量排序
  - 支持按标签/分类筛选
  - 显示相册封面、名称、描述、照片数量

- **相册卡片**：
  - 封面照片
  - 相册名称
  - 照片数量
  - 创建时间
  - 标签/分类

#### 2.1.3 相册编辑和删除

- **编辑相册**：
  - 修改相册名称和描述
  - 更换封面照片
  - 修改标签/分类
  - 关联/取消关联场景

- **删除相册**：
  - 删除相册（同时删除相册中的所有照片）
  - 删除前需要确认
  - 支持恢复功能（软删除）

---

### 2.2 照片管理功能

#### 2.2.1 照片上传

- **上传方式**：
  - 单张上传
  - 批量上传（多张照片）
  - 支持拖拽上传
  - 支持图片格式：JPG、PNG、WEBP等

- **上传功能**：
  - 图片压缩（自动压缩大图）
  - 图片预览
  - 上传进度显示
  - 上传失败重试

#### 2.2.2 照片信息编辑

- **基本信息**：
  - 照片标题
  - 照片描述（支持富文本）
  - 拍摄时间（可选，默认上传时间）
  - 标签（可添加多个标签）

- **高级信息**（可选）：
  - 地点信息
  - 参与者（可以@场景中的E-SOUL）
  - 心情标签（快乐、温馨、感动等）
  - 关联的记忆（关联到心域记忆系统）

#### 2.2.3 照片列表和查看

- **照片列表**：
  - 相册中的照片列表（网格视图/列表视图）
  - 显示缩略图、标题、上传时间
  - 支持按时间、标题排序
  - 支持按标签筛选

- **照片详情**：
  - 查看大图
  - 显示照片信息（标题、描述、时间、标签等）
  - 照片操作（编辑、删除、设为封面等）
  - 左右滑动查看上一张/下一张

#### 2.2.4 照片编辑和删除

- **编辑照片**：
  - 修改标题和描述
  - 修改拍摄时间
  - 添加/删除标签
  - 关联/取消关联记忆

- **删除照片**：
  - 删除单张照片
  - 批量删除照片
  - 删除前需要确认
  - 支持恢复功能（软删除）

---

### 2.3 场景集成功能

#### 2.3.1 场景关联

- **关联场景**：
  - 相册可以关联到一个或多个场景
  - 在场景中显示相册入口
  - 场景中的E-SOUL可以访问相册内容

- **场景中展示**：
  - 在场景界面中显示相册卡片
  - 点击卡片可以查看相册
  - 显示相册封面和名称

#### 2.3.2 E-SOUL互动

- **基于相册的互动**：
  - E-SOUL可以查看相册内容
  - E-SOUL可以基于照片内容进行对话
  - E-SOUL可以询问关于照片的问题
  - E-SOUL可以分享对照片的感受

- **互动触发**：
  - 用户主动向E-SOUL展示照片
  - E-SOUL主动询问用户关于相册的问题
  - 基于时间触发（如纪念日提醒）

---

### 2.4 搜索和筛选功能

#### 2.4.1 相册搜索

- **搜索功能**：
  - 按相册名称搜索
  - 按相册描述搜索
  - 按标签搜索

#### 2.4.2 照片搜索

- **搜索功能**：
  - 按照片标题搜索
  - 按照片描述搜索
  - 按标签搜索
  - 按时间范围搜索

#### 2.4.3 筛选功能

- **相册筛选**：
  - 按标签筛选
  - 按创建时间筛选
  - 按关联场景筛选

- **照片筛选**：
  - 按标签筛选
  - 按拍摄时间筛选
  - 按心情标签筛选

---

## 三、数据结构设计

### 3.1 相册表

**表名**: `photo_albums`

**字段设计**:
- `id` (BIGINT, PRIMARY KEY): 相册ID
- `user_id` (BIGINT, NOT NULL): 用户ID
- `name` (VARCHAR(255), NOT NULL): 相册名称
- `description` (TEXT): 相册描述
- `cover_photo_id` (BIGINT): 封面照片ID（关联photo表）
- `cover_photo_url` (VARCHAR(500)): 封面照片URL（冗余字段，提高查询性能）
- `photo_count` (INT, DEFAULT 0): 照片数量
- `tags` (JSON): 标签列表（如：["恋爱", "纪念日"]）
- `scene_ids` (JSON): 关联的场景ID列表
- `is_deleted` (BOOLEAN, DEFAULT FALSE): 是否已删除（软删除）
- `created_at` (DATETIME, DEFAULT CURRENT_TIMESTAMP): 创建时间
- `updated_at` (DATETIME, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP): 更新时间

**索引**:
- `idx_user_id` (user_id, is_deleted, created_at)
- `idx_tags` (tags) - JSON索引
- `idx_scene_ids` (scene_ids) - JSON索引

---

### 3.2 照片表

**表名**: `photos`

**字段设计**:
- `id` (BIGINT, PRIMARY KEY): 照片ID
- `album_id` (BIGINT, NOT NULL): 相册ID（关联photo_albums表）
- `user_id` (BIGINT, NOT NULL): 用户ID
- `title` (VARCHAR(255)): 照片标题
- `description` (TEXT): 照片描述（支持富文本）
- `photo_url` (VARCHAR(500), NOT NULL): 照片URL（原始图）
- `thumbnail_url` (VARCHAR(500)): 缩略图URL
- `file_size` (BIGINT): 文件大小（字节）
- `width` (INT): 图片宽度
- `height` (INT): 图片高度
- `taken_at` (DATETIME): 拍摄时间（用户可编辑）
- `location` (VARCHAR(255)): 地点信息
- `tags` (JSON): 标签列表
- `mood_tags` (JSON): 心情标签（如：["快乐", "温馨"]）
- `participant_ids` (JSON): 参与者ID列表（关联角色ID或用户ID）
- `memory_id` (BIGINT): 关联的记忆ID（关联记忆系统）
- `sort_order` (INT, DEFAULT 0): 排序顺序
- `is_deleted` (BOOLEAN, DEFAULT FALSE): 是否已删除（软删除）
- `created_at` (DATETIME, DEFAULT CURRENT_TIMESTAMP): 上传时间
- `updated_at` (DATETIME, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP): 更新时间

**索引**:
- `idx_album_id` (album_id, sort_order, is_deleted)
- `idx_user_id` (user_id, is_deleted, created_at)
- `idx_taken_at` (taken_at)
- `idx_tags` (tags) - JSON索引
- `idx_memory_id` (memory_id)

---

## 四、API接口设计

### 4.1 相册管理API

**接口**: `POST /api/photo-albums`

**功能**: 创建相册

**请求参数**:
- `name` (string, required): 相册名称
- `description` (string): 相册描述
- `tags` (array): 标签列表
- `sceneIds` (array): 关联的场景ID列表

**响应数据**:
- `id` (long): 相册ID
- `name` (string): 相册名称
- `description` (string): 相册描述
- `photoCount` (integer): 照片数量
- `createdAt` (datetime): 创建时间

---

**接口**: `GET /api/photo-albums`

**功能**: 获取相册列表

**请求参数**:
- `keyword` (string): 搜索关键词（名称/描述）
- `tags` (array): 标签筛选
- `sceneId` (long): 关联的场景ID
- `page` (integer): 页码
- `size` (integer): 每页数量
- `sort` (string): 排序方式（created_at/photo_count/name）

**响应数据**:
- `albums` (array): 相册列表
  - `id` (long)
  - `name` (string)
  - `description` (string)
  - `coverPhotoUrl` (string)
  - `photoCount` (integer)
  - `tags` (array)
  - `createdAt` (datetime)
- `total` (integer): 总数量

---

**接口**: `GET /api/photo-albums/{albumId}`

**功能**: 获取相册详情

**响应数据**:
- `id` (long): 相册ID
- `name` (string): 相册名称
- `description` (string): 相册描述
- `coverPhotoUrl` (string): 封面照片URL
- `photoCount` (integer): 照片数量
- `tags` (array): 标签列表
- `sceneIds` (array): 关联的场景ID列表
- `createdAt` (datetime): 创建时间
- `updatedAt` (datetime): 更新时间

---

**接口**: `PUT /api/photo-albums/{albumId}`

**功能**: 更新相册

**请求参数**:
- `name` (string): 相册名称
- `description` (string): 相册描述
- `coverPhotoId` (long): 封面照片ID
- `tags` (array): 标签列表
- `sceneIds` (array): 关联的场景ID列表

**响应数据**:
- `success` (boolean): 是否成功

---

**接口**: `DELETE /api/photo-albums/{albumId}`

**功能**: 删除相册

**响应数据**:
- `success` (boolean): 是否成功

---

### 4.2 照片管理API

**接口**: `POST /api/photo-albums/{albumId}/photos`

**功能**: 上传照片

**请求参数**:
- `file` (file, required): 照片文件
- `title` (string): 照片标题
- `description` (string): 照片描述
- `takenAt` (datetime): 拍摄时间
- `location` (string): 地点信息
- `tags` (array): 标签列表
- `moodTags` (array): 心情标签
- `participantIds` (array): 参与者ID列表

**响应数据**:
- `id` (long): 照片ID
- `photoUrl` (string): 照片URL
- `thumbnailUrl` (string): 缩略图URL
- `title` (string): 照片标题

---

**接口**: `POST /api/photo-albums/{albumId}/photos/batch`

**功能**: 批量上传照片

**请求参数**:
- `files` (array[file], required): 照片文件列表
- `defaultTitle` (string): 默认标题
- `defaultTags` (array): 默认标签

**响应数据**:
- `photos` (array): 上传成功的照片列表
- `failedCount` (integer): 失败数量

---

**接口**: `GET /api/photo-albums/{albumId}/photos`

**功能**: 获取照片列表

**请求参数**:
- `keyword` (string): 搜索关键词
- `tags` (array): 标签筛选
- `moodTags` (array): 心情标签筛选
- `startDate` (date): 开始日期
- `endDate` (date): 结束日期
- `page` (integer): 页码
- `size` (integer): 每页数量
- `sort` (string): 排序方式（taken_at/created_at/title）

**响应数据**:
- `photos` (array): 照片列表
  - `id` (long)
  - `title` (string)
  - `thumbnailUrl` (string)
  - `takenAt` (datetime)
  - `tags` (array)
  - `moodTags` (array)
- `total` (integer): 总数量

---

**接口**: `GET /api/photos/{photoId}`

**功能**: 获取照片详情

**响应数据**:
- `id` (long): 照片ID
- `albumId` (long): 相册ID
- `title` (string): 照片标题
- `description` (string): 照片描述
- `photoUrl` (string): 照片URL
- `thumbnailUrl` (string): 缩略图URL
- `takenAt` (datetime): 拍摄时间
- `location` (string): 地点信息
- `tags` (array): 标签列表
- `moodTags` (array): 心情标签
- `participantIds` (array): 参与者ID列表
- `memoryId` (long): 关联的记忆ID
- `createdAt` (datetime): 上传时间

---

**接口**: `PUT /api/photos/{photoId}`

**功能**: 更新照片信息

**请求参数**:
- `title` (string): 照片标题
- `description` (string): 照片描述
- `takenAt` (datetime): 拍摄时间
- `location` (string): 地点信息
- `tags` (array): 标签列表
- `moodTags` (array): 心情标签
- `participantIds` (array): 参与者ID列表
- `memoryId` (long): 关联的记忆ID

**响应数据**:
- `success` (boolean): 是否成功

---

**接口**: `DELETE /api/photos/{photoId}`

**功能**: 删除照片

**响应数据**:
- `success` (boolean): 是否成功

---

**接口**: `PUT /api/photo-albums/{albumId}/photos/reorder`

**功能**: 调整照片顺序

**请求参数**:
- `photoOrders` (array): 照片顺序列表
  - `photoId` (long): 照片ID
  - `sortOrder` (integer): 排序顺序

**响应数据**:
- `success` (boolean): 是否成功

---

### 4.3 搜索API

**接口**: `GET /api/photo-albums/search`

**功能**: 搜索相册

**请求参数**:
- `keyword` (string): 搜索关键词
- `tags` (array): 标签筛选
- `sceneId` (long): 场景ID筛选

**响应数据**:
- `albums` (array): 匹配的相册列表

---

**接口**: `GET /api/photos/search`

**功能**: 搜索照片

**请求参数**:
- `keyword` (string): 搜索关键词
- `tags` (array): 标签筛选
- `moodTags` (array): 心情标签筛选
- `startDate` (date): 开始日期
- `endDate` (date): 结束日期

**响应数据**:
- `photos` (array): 匹配的照片列表

---

## 五、UI/UX设计需求

### 5.1 相册列表页面

- **布局**：网格布局，每行显示3-4个相册卡片
- **相册卡片**：
  - 封面照片（16:9比例）
  - 相册名称（卡片底部）
  - 照片数量（右上角徽章）
  - 悬停效果（阴影、放大）
- **操作**：
  - 点击卡片进入相册详情
  - 右上角菜单（编辑、删除、设为封面等）

---

### 5.2 相册详情页面

- **顶部**：
  - 相册名称和描述
  - 相册操作按钮（编辑、删除、分享等）
  - 照片数量统计
- **照片列表**：
  - 网格视图（默认）/列表视图
  - 照片缩略图
  - 照片标题和拍摄时间
  - 批量选择功能
- **操作**：
  - 上传照片按钮
  - 排序功能
  - 筛选功能

---

### 5.3 照片上传页面

- **上传区域**：
  - 拖拽上传区域
  - 点击选择文件
  - 支持多文件选择
  - 上传进度显示
- **照片信息编辑**：
  - 标题输入
  - 描述输入（富文本编辑器）
  - 拍摄时间选择
  - 标签选择
  - 地点输入
- **预览**：
  - 上传后预览
  - 可以删除重新上传

---

### 5.4 照片详情页面

- **照片展示**：
  - 大图展示（支持缩放）
  - 左右滑动查看上一张/下一张
- **照片信息**：
  - 标题和描述
  - 拍摄时间和地点
  - 标签列表
  - 参与者信息
- **操作**：
  - 编辑按钮
  - 删除按钮
  - 设为封面按钮
  - 关联记忆按钮

---

### 5.5 场景集成界面

- **场景中的展示**：
  - 相册卡片（在场景界面侧边栏或内容区）
  - 点击卡片打开相册预览
  - E-SOUL可以查看相册内容

---

## 六、实施计划

### 6.1 第一阶段：基础功能（2周）

- [ ] 数据库设计和创建
- [ ] 相册CRUD API开发
- [ ] 照片上传API开发
- [ ] 照片CRUD API开发
- [ ] 基础前端界面开发（相册列表、详情）

### 6.2 第二阶段：高级功能（1.5周）

- [ ] 照片批量上传功能
- [ ] 照片搜索和筛选功能
- [ ] 照片排序功能
- [ ] 标签管理功能
- [ ] 前端界面完善

### 6.3 第三阶段：场景集成（1周）

- [ ] 场景关联功能
- [ ] 场景中展示相册
- [ ] E-SOUL互动接口开发
- [ ] 前端场景集成

### 6.4 第四阶段：优化和测试（1周）

- [ ] 性能优化（图片压缩、CDN）
- [ ] 用户体验优化
- [ ] 全面测试
- [ ] 文档完善

---

## 七、验收标准

### 7.1 功能验收

- ✅ 用户可以创建、编辑、删除相册
- ✅ 用户可以上传、编辑、删除照片
- ✅ 照片可以批量上传
- ✅ 支持照片搜索和筛选
- ✅ 相册可以关联到场景
- ✅ 在场景中可以查看相册

### 7.2 性能验收

- ✅ 照片上传响应时间 < 3秒
- ✅ 相册列表加载时间 < 1秒
- ✅ 照片列表加载时间 < 1.5秒
- ✅ 大图加载时间 < 2秒

### 7.3 用户体验验收

- ✅ 界面友好美观
- ✅ 操作流程顺畅
- ✅ 上传进度清晰
- ✅ 错误提示友好

---

## 八、风险和注意事项

### 8.1 技术风险

- **存储成本**：照片文件较大，需要考虑存储成本
- **性能问题**：大量照片可能影响加载性能
- **图片处理**：需要图片压缩和缩略图生成

### 8.2 业务风险

- **隐私安全**：照片涉及用户隐私，需要严格保护
- **存储管理**：需要合理的存储空间管理策略

### 8.3 注意事项

- 照片上传需要压缩处理
- 生成缩略图以提高加载速度
- 使用CDN加速图片访问
- 实现图片懒加载
- 提供照片备份和导出功能
- 考虑存储空间限制和清理策略

---

**文档状态**: 需求分析已完成

