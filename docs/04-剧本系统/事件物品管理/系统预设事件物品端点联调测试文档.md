# 系统预设事件物品端点联调测试文档

## 概述

本文档提供了完整的前后端联调测试方案，确保 `/api/scenario-events/system/all` 和 `/api/scenario-items/system/all` 端点正常工作。

## 一、后端代码完整性检查

### 1.1 已创建的文件

✅ **Controller层**
- `backend/src/main/java/com/heartsphere/controller/ScenarioEventController.java`
- `backend/src/main/java/com/heartsphere/controller/ScenarioItemController.java`

✅ **Service层**
- `backend/src/main/java/com/heartsphere/service/ScenarioEventService.java`
- `backend/src/main/java/com/heartsphere/service/ScenarioItemService.java`

✅ **DTO层**
- `backend/src/main/java/com/heartsphere/dto/ApiResponse.java`
- `backend/src/main/java/com/heartsphere/dto/ScenarioEventDTO.java`
- `backend/src/main/java/com/heartsphere/dto/ScenarioItemDTO.java`

✅ **Entity层**
- `backend/src/main/java/com/heartsphere/entity/ScenarioEvent.java`
- `backend/src/main/java/com/heartsphere/entity/ScenarioItem.java`

✅ **Repository层**
- `backend/src/main/java/com/heartsphere/repository/ScenarioEventRepository.java`
- `backend/src/main/java/com/heartsphere/repository/ScenarioItemRepository.java`

### 1.2 端点信息

- **GET** `/api/scenario-events/system/all` - 获取所有系统预设事件
- **GET** `/api/scenario-items/system/all` - 获取所有系统预设物品

**注意**：使用 `/system/all` 路径避免与 `/{id}` 路由冲突。

## 二、后端测试步骤

### 2.1 编译项目

```bash
cd backend
mvn clean compile
```

### 2.2 启动后端服务

```bash
mvn spring-boot:run
```

或者使用IDE启动 `Application.java`

### 2.3 使用curl测试端点

#### 测试系统预设事件端点

```bash
# 测试系统预设事件端点
curl -X GET "http://localhost:8081/api/scenario-events/system/all" \
  -H "Content-Type: application/json" \
  -v
```

**预期响应**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "上课迟到",
      "eventId": "event_university_late_to_class",
      "description": "早上第一节课迟到了，被老师点名",
      "eraId": null,
      "systemEraId": 1,
      "userId": null,
      "isSystem": true,
      "iconUrl": null,
      "tags": "大学,学习,迟到,课堂",
      "sortOrder": 1,
      "isActive": true,
      "isDeleted": false,
      "createdAt": "2024-01-01T00:00:00",
      "updatedAt": "2024-01-01T00:00:00"
    }
    // ... 更多事件
  ],
  "timestamp": "2024-12-28T10:00:00"
}
```

#### 测试系统预设物品端点

```bash
# 测试系统预设物品端点
curl -X GET "http://localhost:8081/api/scenario-items/system/all" \
  -H "Content-Type: application/json" \
  -v
```

**预期响应**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "教材",
      "itemId": "item_university_textbook",
      "description": "大学教材",
      "eraId": null,
      "systemEraId": 1,
      "userId": null,
      "isSystem": true,
      "iconUrl": null,
      "itemType": "tool",
      "tags": "大学,学习,教材",
      "sortOrder": 1,
      "isActive": true,
      "isDeleted": false,
      "createdAt": "2024-01-01T00:00:00",
      "updatedAt": "2024-01-01T00:00:00"
    }
    // ... 更多物品
  ],
  "timestamp": "2024-12-28T10:00:00"
}
```

### 2.4 验证数据库数据

确保数据库中有系统预设的事件和物品数据：

```sql
-- 检查系统预设事件数量
SELECT COUNT(*) FROM scenario_events WHERE is_system = 1 AND is_deleted = 0;

-- 检查系统预设物品数量
SELECT COUNT(*) FROM scenario_items WHERE is_system = 1 AND is_deleted = 0;

-- 查看前5条事件数据
SELECT id, name, event_id, system_era_id FROM scenario_events 
WHERE is_system = 1 AND is_deleted = 0 
LIMIT 5;

-- 查看前5条物品数据
SELECT id, name, item_id, system_era_id FROM scenario_items 
WHERE is_system = 1 AND is_deleted = 0 
LIMIT 5;
```

## 三、前端测试步骤

### 3.1 前端API调用代码

前端已经实现了API调用，位于：
- `frontend/services/api/scenario/event.ts` - `getSystemEvents()` 方法
- `frontend/services/api/scenario/item.ts` - `getSystemItems()` 方法

### 3.2 测试前端调用

#### 在浏览器控制台测试

打开浏览器开发者工具，在控制台中执行：

```javascript
// 获取token（从localStorage）
const token = localStorage.getItem('auth_token');

// 测试获取系统预设事件
fetch('http://localhost:8081/api/scenario-events/system/all', {
  method: 'GET',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  }
})
.then(res => res.json())
.then(data => {
  console.log('系统预设事件:', data);
  if (data.code === 200) {
    console.log('✅ 事件数量:', data.data.length);
  } else {
    console.error('❌ 错误:', data.message);
  }
})
.catch(err => console.error('❌ 请求失败:', err));

// 测试获取系统预设物品
fetch('http://localhost:8081/api/scenario-items/system/all', {
  method: 'GET',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  }
})
.then(res => res.json())
.then(data => {
  console.log('系统预设物品:', data);
  if (data.code === 200) {
    console.log('✅ 物品数量:', data.data.length);
  } else {
    console.error('❌ 错误:', data.message);
  }
})
.catch(err => console.error('❌ 请求失败:', err));
```

### 3.3 在管理后台界面测试

1. 登录管理后台
2. 导航到 "剧本事件 Events" 或 "剧本物品 Items" 页面
3. 检查事件/物品列表是否正确加载
4. 验证场景列显示是否正确（应该显示场景名称，而不是"全局"）

### 3.4 验证前端组件集成

检查以下文件是否正确调用API：

- `frontend/admin/components/EventsManagement.tsx`
  - 应该调用 `scenarioEventApi.getSystemEvents(adminToken)`
  - 应该调用 `scenarioEventApi.getMyEvents(adminToken)`
  - 合并两个结果并显示

- `frontend/admin/components/ItemsManagement.tsx`
  - 应该调用 `scenarioItemApi.getSystemItems(adminToken)`
  - 应该调用 `scenarioItemApi.getMyItems(adminToken)`
  - 合并两个结果并显示

## 四、常见问题排查

### 4.1 404错误 - 端点未找到

**可能原因**：
- Controller未正确注册
- 路径拼写错误

**解决方法**：
1. 检查Controller类是否有 `@RestController` 和 `@RequestMapping` 注解
2. 检查方法是否有 `@GetMapping("/system/all")` 注解
3. 重启后端服务

### 4.2 500错误 - 服务器内部错误

**可能原因**：
- Service或Repository未正确注入
- 数据库连接问题
- 实体类字段映射错误

**解决方法**：
1. 查看后端日志，查找具体错误信息
2. 检查Service类是否有 `@Service` 注解
3. 检查Repository接口是否正确继承 `JpaRepository`
4. 检查实体类字段是否与数据库表字段匹配

### 4.3 空数据返回

**可能原因**：
- 数据库中没有系统预设数据
- Repository查询条件错误

**解决方法**：
1. 执行数据库查询，确认数据存在
2. 检查Repository方法 `findByIsSystemTrueAndIsDeletedFalse()` 是否正确
3. 检查实体类的 `isSystem` 和 `isDeleted` 字段映射

### 4.4 路由冲突

**可能原因**：
- `/system` 路径被 `/{id}` 路径拦截

**解决方法**：
- ✅ 已使用 `/system/all` 路径避免冲突
- 确保 `/system/all` 方法定义在 `/{id}` 方法之前

### 4.5 前端响应格式不匹配

**可能原因**：
- 后端返回格式与前端期望不一致

**解决方法**：
1. 检查后端返回的是 `ApiResponse<T>` 格式
2. 前端 `request.ts` 会自动提取 `data` 字段
3. 确保响应包含 `code`, `message`, `data`, `timestamp` 字段

## 五、完整测试检查清单

### 后端测试 ✅

- [ ] 项目编译成功，无错误
- [ ] 后端服务启动成功
- [ ] `/api/scenario-events/system/all` 端点返回200状态码
- [ ] `/api/scenario-items/system/all` 端点返回200状态码
- [ ] 响应格式符合 `ApiResponse<T>` 结构
- [ ] 返回的事件/物品数据包含所有必需字段
- [ ] 数据库中有系统预设数据（168个事件，168个物品）

### 前端测试 ✅

- [ ] 浏览器控制台测试成功
- [ ] 管理后台事件管理页面正常加载
- [ ] 管理后台物品管理页面正常加载
- [ ] 事件/物品列表正确显示
- [ ] 场景列显示正确的场景名称
- [ ] 系统预设和用户自定义数据正确合并

### 前后端联调 ✅

- [ ] 前端能正确调用后端API
- [ ] 响应数据正确解析和显示
- [ ] 错误处理正确（404、500等）
- [ ] 加载状态正确显示
- [ ] 无CORS错误
- [ ] 无控制台错误

## 六、测试脚本

### 后端测试脚本

创建文件 `test_endpoints.sh`：

```bash
#!/bin/bash

echo "=== 测试系统预设事件物品端点 ==="
echo ""

echo "1. 测试系统预设事件端点："
curl -X GET "http://localhost:8081/api/scenario-events/system/all" \
  -H "Content-Type: application/json" \
  -w "\nHTTP Status: %{http_code}\n" \
  -s | jq '.code, .message, (.data | length)'

echo ""
echo "2. 测试系统预设物品端点："
curl -X GET "http://localhost:8081/api/scenario-items/system/all" \
  -H "Content-Type: application/json" \
  -w "\nHTTP Status: %{http_code}\n" \
  -s | jq '.code, .message, (.data | length)'

echo ""
echo "=== 测试完成 ==="
```

运行测试：
```bash
chmod +x test_endpoints.sh
./test_endpoints.sh
```

## 七、总结

完成以上所有测试步骤后，前后端联调应该能够正常工作。如果遇到问题，请参考"常见问题排查"部分进行排查。

