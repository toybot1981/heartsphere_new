# 剧本模式可玩性改进建议

## 📊 当前剧本模式分析

### 现有功能
- 基于节点的线性流程（StoryNode）
- 每个节点显示预设的prompt内容
- 用户从预设选项中做出选择
- 支持多节点分支结构

### 可玩性问题
1. **线性推进**：剧情过于固定，缺少探索性
2. **选择有限**：只能从预设选项中选择，缺乏自由度
3. **内容固定**：节点内容固定不变，缺乏动态性
4. **缺少游戏化元素**：没有随机事件、成就、收集等
5. **缺少状态系统**：没有角色好感度、隐藏属性等

---

## 🎮 改进建议

### 1. **混合模式：流程 + AI动态生成**

#### 核心思路
剧本节点作为"骨架"，AI负责"血肉"，在节点框架内动态生成对话内容。

#### 实现方案
```typescript
interface StoryNode {
  id: string;
  title: string;
  // 基础场景描述（固定）
  basePrompt: string;
  // AI系统指令（用于动态生成）
  aiInstruction?: string;
  // 参与角色
  characterIds?: string[];
  // 选项配置
  options: StoryOption[];
  // 节点类型：'fixed' | 'ai-dynamic' | 'hybrid'
  nodeType?: 'fixed' | 'ai-dynamic' | 'hybrid';
}
```

#### 效果
- **fixed模式**：保持现有固定内容（适合关键剧情点）
- **ai-dynamic模式**：AI根据场景和角色动态生成对话（增加可玩性）
- **hybrid模式**：基础描述固定 + AI补充细节（平衡体验）

---

### 2. **条件分支系统**

#### 核心思路
选项的可见性和结果根据玩家状态、角色好感度、已触发事件等条件动态变化。

#### 实现方案
```typescript
interface StoryOption {
  id: string;
  text: string;
  nextNodeId: string;
  // 条件系统
  conditions?: {
    // 需要的最小好感度（角色ID -> 好感度）
    minAffection?: Record<string, number>;
    // 需要已触发的事件ID列表
    requiredEvents?: string[];
    // 需要未触发的事件ID列表
    excludedEvents?: string[];
    // 自定义条件函数
    customCondition?: string; // JavaScript表达式
  };
  // 隐藏文本（满足条件时显示的替代选项）
  hiddenText?: string;
  // 权重（影响AI推荐）
  weight?: number;
}
```

#### 效果
- 解锁隐藏选项（提高好感度后出现特殊对话）
- 根据选择历史改变剧情走向
- 多周目可玩性（不同选择导致不同体验）

---

### 3. **状态追踪系统**

#### 核心思路
在剧本执行过程中追踪角色状态、玩家选择、触发事件等，影响后续剧情。

#### 实现方案
```typescript
interface ScenarioState {
  scenarioId: string;
  currentNodeId: string;
  // 角色好感度/属性
  characterStats: Record<string, {
    affection: number;      // 好感度
    trust: number;          // 信任度
    relationship: string;   // 关系类型：'stranger' | 'friend' | 'close' | 'lover'
    customAttributes?: Record<string, number>;
  }>;
  // 已触发事件
  triggeredEvents: string[];
  // 收集物品
  collectedItems: string[];
  // 全局变量（可用于条件判断）
  globalVars: Record<string, any>;
  // 选择历史
  choiceHistory: Array<{
    nodeId: string;
    optionId: string;
    timestamp: number;
  }>;
}
```

#### 效果
- 角色好感度系统（不同好感度触发不同剧情）
- 收集系统（收集特殊物品解锁新内容）
- 成就系统（完成特定选择获得成就）

---

### 4. **随机事件系统**

#### 核心思路
在节点间插入随机事件，增加不可预测性和重玩价值。

#### 实现方案
```typescript
interface StoryNode {
  // ... 现有字段
  // 随机事件配置
  randomEvents?: Array<{
    id: string;
    probability: number;    // 触发概率 0-1
    prompt: string;         // 随机事件描述
    effects?: {             // 触发后的效果
      affectionChange?: Record<string, number>;
      addEvent?: string;
      addItem?: string;
      setVar?: Record<string, any>;
    };
  }>;
}
```

#### 效果
- 增加不确定性（每次游玩体验不同）
- 增加重玩价值
- 意外惊喜（随机遇到特殊事件）

---

### 5. **多角色互动系统**

#### 核心思路
在节点中引入多个角色，支持角色间的互动和对话。

#### 实现方案
```typescript
interface StoryNode {
  // ... 现有字段
  // 参与角色
  characterIds?: string[];
  // 角色对话配置
  characterDialogs?: Array<{
    characterId: string;
    dialog: string;
    triggerCondition?: string; // 触发条件
    order: number;             // 对话顺序
  }>;
  // 角色互动选项（影响角色关系）
  interactionOptions?: Array<{
    text: string;
    targetCharacterId: string;
    affectionChange: number;
    nextNodeId: string;
  }>;
}
```

#### 效果
- 多角色对话场景（更丰富的互动）
- 角色关系网络（角色间的关系影响剧情）
- 三角关系、团队合作等复杂剧情

---

### 6. **时间系统**

#### 核心思路
引入时间概念，不同时间段触发不同剧情，增加策略性。

#### 实现方案
```typescript
interface ScenarioState {
  // ... 现有字段
  // 游戏内时间
  gameTime: {
    day: number;      // 第几天
    hour: number;     // 小时 0-23
    minute: number;   // 分钟 0-59
  };
}

interface StoryNode {
  // ... 现有字段
  // 时间限制
  timeRestrictions?: {
    availableHours?: number[];      // 可访问的小时
    requiredDay?: number;            // 要求的第几天
    duration?: number;               // 节点消耗的时间（分钟）
  };
}
```

#### 效果
- 时间管理玩法（需要在有限时间内做出选择）
- 限时事件（特定时间才能触发的剧情）
- 日程规划（合理安排时间推进剧情）

---

### 7. **探索与地图系统**

#### 核心思路
将剧本节点可视化为地图，玩家可以自由探索不同区域。

#### 实现方案
```typescript
interface StoryNode {
  // ... 现有字段
  // 地理位置
  location?: {
    x: number;
    y: number;
    zone: string;      // 区域名称
    description: string;
  };
  // 可探索的相邻节点
  adjacentNodes?: string[];
  // 探索奖励
  explorationRewards?: {
    items?: string[];
    events?: string[];
    affectionChange?: Record<string, number>;
  };
}
```

#### 效果
- 地图探索（可视化场景选择）
- 自由移动（玩家可以选择去哪个地点）
- 隐藏区域（满足条件才能解锁的新区域）

---

### 8. **小游戏与互动玩法**

#### 核心思路
在剧情节点中插入小游戏，增加趣味性和参与感。

#### 实现方案
```typescript
interface StoryNode {
  // ... 现有字段
  // 小游戏配置
  miniGame?: {
    type: 'quiz' | 'memory' | 'puzzle' | 'dialogue-challenge';
    config: any;              // 游戏配置
    successNodeId: string;    // 成功后的节点
    failureNodeId: string;    // 失败后的节点
    rewards?: {               // 奖励
      affectionChange?: Record<string, number>;
      items?: string[];
    };
  };
}
```

#### 效果
- 问答挑战（测试玩家对角色/剧情的了解）
- 记忆游戏（记住角色说过的话）
- 解谜元素（解决谜题推进剧情）

---

### 9. **分支剧情与多结局系统**

#### 核心思路
根据玩家的选择和状态，剧本走向不同的结局。

#### 实现方案
```typescript
interface CustomScenario {
  // ... 现有字段
  // 结局配置
  endings?: Array<{
    id: string;
    title: string;
    description: string;
    // 达成条件
    conditions: {
      minAffection?: Record<string, number>;
      requiredEvents?: string[];
      choicePath?: string[];  // 需要经过的选择路径
    };
    // 结局节点ID
    endingNodeId: string;
  }>;
  // 成就系统
  achievements?: Array<{
    id: string;
    title: string;
    description: string;
    condition: string;        // 条件表达式
    icon?: string;
  }>;
}
```

#### 效果
- 多结局系统（增加重玩价值）
- 成就收集（鼓励探索不同选择）
- 剧情分支可视化（显示已解锁的结局）

---

### 10. **AI辅助内容生成**

#### 核心思路
AI根据剧本框架和角色设定，动态生成对话内容和选项建议。

#### 实现方案
```typescript
interface StoryNode {
  // ... 现有字段
  // AI生成配置
  aiGeneration?: {
    // 是否使用AI生成对话
    generateDialog: boolean;
    // AI系统提示词
    systemPrompt?: string;
    // 角色个性强化
    characterPersonality?: Record<string, string>;
    // 选项生成策略
    optionGeneration?: 'fixed' | 'ai-suggested' | 'hybrid';
  };
}
```

#### 效果
- 动态对话（每次游玩对话略有不同）
- AI生成选项（在保持剧情框架的同时增加灵活性）
- 角色个性化（AI根据角色设定生成符合人设的对话）

---

## 🎯 推荐实施优先级

### 第一阶段（快速提升可玩性）
1. **混合模式（流程+AI）** ⭐⭐⭐⭐⭐
   - 实施难度：中
   - 效果提升：高
   - 快速让剧本内容更生动

2. **状态追踪系统** ⭐⭐⭐⭐⭐
   - 实施难度：中
   - 效果提升：高
   - 为其他功能奠定基础

3. **条件分支系统** ⭐⭐⭐⭐
   - 实施难度：中
   - 效果提升：高
   - 解锁隐藏内容，增加探索性

### 第二阶段（深度玩法）
4. **多角色互动系统** ⭐⭐⭐⭐
   - 实施难度：高
   - 效果提升：高
   - 更丰富的剧情体验

5. **随机事件系统** ⭐⭐⭐
   - 实施难度：低
   - 效果提升：中
   - 增加不确定性

6. **多结局系统** ⭐⭐⭐⭐
   - 实施难度：中
   - 效果提升：高
   - 增加重玩价值

### 第三阶段（高级功能）
7. **时间系统** ⭐⭐⭐
   - 实施难度：高
   - 效果提升：中
   - 增加策略性

8. **探索地图系统** ⭐⭐⭐
   - 实施难度：高
   - 效果提升：中
   - 可视化增强

9. **小游戏系统** ⭐⭐
   - 实施难度：高
   - 效果提升：中
   - 增加趣味性

10. **AI辅助生成** ⭐⭐⭐⭐⭐
    - 实施难度：中
    - 效果提升：高
    - 与现有AI服务结合，动态内容生成

---

## 💡 快速原型建议

### 最小可行改进（MVP）

**在现有基础上快速实现的改进：**

1. **节点类型扩展**
   - 添加 `nodeType` 字段：'fixed' | 'ai-dynamic'
   - AI动态节点：使用AI根据场景和角色生成对话
   - 保留固定节点用于关键剧情

2. **简单的状态追踪**
   - 在 `scenarioState` 中添加 `characterAffection` 记录好感度
   - 选项选择时更新好感度
   - 根据好感度显示/隐藏选项

3. **AI生成选项建议**
   - 在固定选项基础上，AI生成1-2个额外选项
   - 选项标记为"AI建议"，玩家可以选择

4. **简单的多结局**
   - 在剧本末尾根据好感度走向不同结局节点
   - 显示"普通结局"、"好感结局"等

---

## 🔧 技术实现要点

### 1. 数据结构扩展
- 扩展 `StoryNode` 和 `StoryOption` 接口
- 扩展 `ScenarioState` 支持状态追踪
- 保持向后兼容（新字段可选）

### 2. AI集成
- 在 `ChatWindow` 中根据节点类型决定是否调用AI
- AI生成时传入场景上下文、角色信息、历史状态
- 缓存AI生成结果（相同条件下复用）

### 3. 状态管理
- 在 `GameState` 中维护 `scenarioState`
- 状态持久化（保存到本地存储）
- 状态同步（多设备同步）

### 4. UI增强
- 显示角色好感度（进度条/数值）
- 显示已解锁事件/成就
- 分支剧情可视化
- 选项条件提示（"需要好感度≥50"）

---

## 📝 实施示例

### 示例1：AI动态节点
```typescript
// 节点配置
const dynamicNode: StoryNode = {
  id: 'meet_character',
  title: '初次相遇',
  basePrompt: '你在咖啡店遇到了一个神秘的人',
  nodeType: 'ai-dynamic',
  aiInstruction: '根据角色个性生成一段生动的初次相遇场景，包含对话和动作描述',
  characterIds: ['character_001'],
  options: [...]
};

// 渲染时
if (node.nodeType === 'ai-dynamic') {
  const aiContent = await aiService.generateText({
    prompt: node.basePrompt,
    systemInstruction: node.aiInstruction + character.systemInstruction,
    messages: history
  });
  // 显示AI生成的内容
}
```

### 示例2：条件分支
```typescript
// 选项配置
const hiddenOption: StoryOption = {
  id: 'confess',
  text: '向她表白（需要好感度≥80）',
  nextNodeId: 'confession_scene',
  conditions: {
    minAffection: { 'character_001': 80 }
  },
  hiddenText: '【隐藏选项】向她表白'
};

// 渲染时过滤选项
const availableOptions = node.options.filter(opt => {
  if (!opt.conditions) return true;
  // 检查条件...
  const hasMinAffection = checkAffection(opt.conditions.minAffection);
  return hasMinAffection;
});
```

---

## 🎨 UI/UX建议

1. **状态显示面板**
   - 角色头像 + 好感度条
   - 已收集物品列表
   - 已触发事件标记

2. **选项增强**
   - 条件满足：正常显示
   - 条件未满足：灰色显示 + 提示条件
   - 隐藏选项：特殊标记（如"✨"）

3. **剧情可视化**
   - 节点流程图（显示已解锁路径）
   - 分支树（显示不同结局）
   - 探索进度（显示已访问节点百分比）

4. **成就系统UI**
   - 成就列表页面
   - 成就通知（解锁时弹出）
   - 成就进度显示

---

## 📊 预期效果

实施这些改进后，剧本模式将：
- ✅ 内容更生动（AI动态生成）
- ✅ 选择更自由（条件分支、AI选项）
- ✅ 重玩价值更高（多结局、随机事件）
- ✅ 互动性更强（状态系统、多角色）
- ✅ 探索性更好（隐藏内容、收集要素）

这些改进将显著提升剧本模式的可玩性和吸引力！

