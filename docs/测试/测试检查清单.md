# 用户主线剧情功能测试检查清单

## 已完成的工作 ✅

### 1. 数据库表
- ✅ `user_main_stories` 表已创建
- ✅ 表结构正确，包含所有必要字段
- ✅ 外键约束已设置

### 2. 后端实现
- ✅ `UserMainStory` 实体类已创建
- ✅ `UserMainStoryRepository` 已创建
- ✅ `UserMainStoryController` 已创建，提供完整CRUD API
- ✅ 所有API端点需要用户认证

### 3. 前端实现
- ✅ `userMainStoryApi` API接口已创建
- ✅ 初始化过程已修改，使用新API创建主线剧情
- ✅ 数据加载逻辑已修改，从新表获取主线故事
- ✅ 展示逻辑已更新

### 4. 数据迁移
- ✅ 迁移脚本已创建：`backend/migration_user_main_stories.sql`
- ✅ 当前数据库中没有需要迁移的数据（count = 0）

## 待测试项目

### 1. 后端API测试

#### 1.1 创建主线剧情
```bash
# 需要先登录获取token
curl -X POST http://localhost:8081/api/user-main-stories \
  -H "Authorization: Bearer [token]" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "测试主线剧情",
    "description": "这是一个测试主线剧情",
    "eraId": [场景ID],
    "role": "叙事者",
    "bio": "剧情简介",
    "firstMessage": "开场白",
    "systemInstruction": "系统指令"
  }'
```

#### 1.2 获取所有主线剧情
```bash
curl -H "Authorization: Bearer [token]" \
  http://localhost:8081/api/user-main-stories
```

#### 1.3 根据场景ID获取主线剧情
```bash
curl -H "Authorization: Bearer [token]" \
  http://localhost:8081/api/user-main-stories/era/[eraId]
```

#### 1.4 更新主线剧情
```bash
curl -X PUT http://localhost:8081/api/user-main-stories/[id] \
  -H "Authorization: Bearer [token]" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "更新后的名称",
    "bio": "更新后的简介"
  }'
```

#### 1.5 删除主线剧情
```bash
curl -X DELETE http://localhost:8081/api/user-main-stories/[id] \
  -H "Authorization: Bearer [token]"
```

### 2. 前端功能测试

#### 2.1 初始化流程测试
1. 注册新用户
2. 完成初始化向导
3. 选择主线剧情
4. 验证：
   - ✅ 主线剧情是否正确创建到 `user_main_stories` 表
   - ✅ 不再在 `characters` 表中创建 `role = '主线剧情'` 的角色

#### 2.2 显示测试
1. 登录用户
2. 进入场景选择页面
3. 选择一个场景
4. 验证：
   - ✅ 主线剧情显示在角色上方
   - ✅ 主线剧情的所有信息正确显示（名称、头像、简介等）
   - ✅ 点击主线剧情可以开始对话

#### 2.3 数据加载测试
1. 登录已有数据的用户
2. 验证：
   - ✅ 主线剧情正确加载
   - ✅ 场景列表正确显示
   - ✅ 角色列表正确显示（不包含主线剧情角色）

### 3. 数据库验证

#### 3.1 检查表结构
```sql
DESCRIBE user_main_stories;
```

#### 3.2 检查数据
```sql
-- 查看所有用户主线剧情
SELECT * FROM user_main_stories WHERE is_deleted = false;

-- 查看某个用户的主线剧情
SELECT * FROM user_main_stories 
WHERE user_id = [用户ID] AND is_deleted = false;

-- 查看某个场景的主线剧情
SELECT * FROM user_main_stories 
WHERE era_id = [场景ID] AND is_deleted = false;
```

#### 3.3 验证数据一致性
```sql
-- 确认没有遗漏的角色
SELECT * FROM characters 
WHERE role = '主线剧情' AND is_deleted = false;
-- 应该返回空结果
```

## 已知问题

1. **后端服务启动**：需要确保后端服务正常启动并加载新的Controller
2. **API路由**：确保Spring Security配置允许 `/api/user-main-stories` 路径（需要认证）

## 下一步行动

1. ✅ 数据库表已创建
2. ✅ 代码已实现
3. ⏳ 重启后端服务并验证API
4. ⏳ 执行端到端测试
5. ⏳ 验证前端功能

## 测试账号

- 用户名：t5
- 密码：Tyx@12345

可以使用此账号进行测试。




