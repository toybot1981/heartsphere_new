# 数字生命体交互系统（心域）源代码说明文档

## 一、源代码结构说明

### 1.1 项目总体结构
```
heartsphere_new/
├── frontend/              # 前端项目
│   ├── src/              # 源代码目录
│   ├── components/       # React组件
│   ├── services/         # 服务层
│   ├── utils/            # 工具函数
│   ├── types.ts          # TypeScript类型定义
│   └── package.json      # 依赖配置
├── backend/              # 后端项目
│   └── src/main/java/com/heartsphere/
│       ├── controller/   # REST控制器
│       ├── service/      # 业务服务层
│       ├── repository/   # 数据访问层
│       ├── entity/       # 实体类
│       ├── dto/          # 数据传输对象
│       ├── security/     # 安全配置
│       └── config/       # 配置类
└── aiagent/              # AI Agent服务
    └── src/main/java/com/heartsphere/aiagent/
        ├── agent/        # Agent核心
        ├── adapter/      # 模型适配器
        ├── graph/        # 工作流引擎
        ├── tool/         # 工具集成
        └── controller/   # REST API
```

---

## 二、前端源代码说明

### 2.1 核心文件列表

#### 2.1.1 入口文件
- **index.tsx**：React应用入口文件，负责应用初始化和路由配置
- **index.html**：HTML模板文件
- **App.tsx**：主应用组件，包含全局状态管理和主要业务逻辑

#### 2.1.2 类型定义
- **types.ts**：TypeScript类型定义文件，包含所有数据模型和接口定义
  - UserProfile：用户资料类型
  - Character：角色类型
  - Era：时代切片类型
  - World：世界类型
  - GameState：游戏状态类型
  - 其他业务类型定义

#### 2.1.3 核心组件（components/）

**认证相关组件**
- **LoginModal.tsx**：用户登录和注册模态框组件
  - 功能：用户登录、注册、微信授权登录
  - 技术：React Hooks、表单验证

**世界管理组件**
- **EraSelectionModal.tsx**：时代选择模态框
  - 功能：显示和选择不同的时代切片
- **EraConstructorModal.tsx**：时代创建和编辑组件
  - 功能：创建和编辑时代切片信息
- **WorldController.tsx**：世界管理组件（如存在）

**角色管理组件**
- **CharacterCard.tsx**：角色卡片组件
  - 功能：展示角色基本信息
- **PersonaCard.tsx**：人格卡片组件
  - 功能：展示角色详细人格信息
- **CharacterConstructorModal.tsx**：角色创建和编辑组件
  - 功能：创建和编辑角色信息，包括属性、背景故事等

**对话交互组件**
- **ChatWindow.tsx**：聊天窗口组件
  - 功能：实时对话界面，集成Gemini API
  - 技术：流式响应、消息历史管理

**场景构建组件**
- **ScenarioBuilder.tsx**：场景构建器组件
  - 功能：创建和编辑虚拟场景
- **SceneCard.tsx**：场景卡片组件
  - 功能：展示场景信息

**日记功能组件**
- **RealWorldJournal.tsx**：现实世界日记组件
  - 功能：日记记录和查看
- **RealWorldScreen.tsx**：现实世界界面组件

**管理后台组件**
- **AdminScreen.tsx**：管理后台主界面
  - 功能：系统数据管理、用户管理、配置管理
- **admin/AdminUIComponents.tsx**：管理后台UI组件

**其他功能组件**
- **ConnectionSpace.tsx**：连接空间组件
- **MailboxModal.tsx**：邮箱模态框
- **MembershipModal.tsx**：会员订阅模态框
- **SettingsModal.tsx**：设置模态框
- **RecycleBinModal.tsx**：回收站模态框
- **ResourcePicker.tsx**：资源选择器
- **WelcomeOverlay.tsx**：欢迎覆盖层
- **DebugConsole.tsx**：调试控制台

**移动端组件（mobile/）**
- **MobileApp.tsx**：移动端主应用
- **MobileCharacterSelection.tsx**：移动端角色选择
- **MobileProfile.tsx**：移动端个人资料
- **MobileRealWorld.tsx**：移动端现实世界
- **MobileScenarioBuilder.tsx**：移动端场景构建
- **MobileSceneSelection.tsx**：移动端场景选择
- **components/MobileBottomNav.tsx**：移动端底部导航

#### 2.1.4 服务层（services/）

**API服务**
- **api.ts**：后端API调用服务
  - 功能：封装所有后端REST API调用
  - 技术：Fetch API、错误处理、请求拦截

**Gemini服务**
- **gemini.ts**：Google Gemini API集成服务
  - 功能：与Gemini API交互，实现智能对话
  - 技术：流式响应处理、上下文管理

**存储服务**
- **storage.ts**：本地存储服务
  - 功能：本地数据持久化
  - 技术：localStorage API

**同步服务**
- **syncService.ts**：数据同步服务
  - 功能：前后端数据同步

#### 2.1.5 工具函数（utils/）

- **promptTemplates.ts**：提示词模板
  - 功能：定义各种场景的提示词模板
  - 包含：场景上下文生成、角色设定注入等

- **journalTemplates.ts**：日记模板
  - 功能：提供日记写作模板

#### 2.1.6 常量定义
- **constants.ts**：常量定义文件
  - 功能：定义系统常量、角色数据、时代数据等
  - 包含：createScenarioContext函数、角色列表定义

#### 2.1.7 配置文件
- **package.json**：项目依赖配置
  - 主要依赖：React 19.2.0、TypeScript 5.8.2、Vite 5.0.0
  - AI依赖：@google/genai 1.30.0
  - 测试依赖：Jest、React Testing Library

- **tsconfig.json**：TypeScript编译配置
- **vite.config.ts**：Vite构建配置
- **jest.config.js**：Jest测试配置

#### 2.1.8 测试文件（src/__tests__/）
- **setup.ts**：测试环境配置
- **MembershipModal.test.tsx**：会员模态框测试
- **membershipApi.test.ts**：会员API测试

---

## 三、后端源代码说明

### 3.1 核心文件列表

#### 3.1.1 应用入口
- **HeartSphereApplication.java**：Spring Boot应用主类
  - 功能：应用启动入口
  - 注解：@SpringBootApplication

#### 3.1.2 实体类（entity/）

**用户相关实体**
- **User.java**：用户实体类
  - 字段：id、username、email、password、nickname等
  - 关系：与World、Membership等实体的一对多关系

**内容相关实体**
- **World.java**：世界实体类
  - 字段：id、name、description、imageUrl等
  - 关系：属于User，包含多个Era

- **Era.java**：时代切片实体类
  - 字段：id、name、description、imageUrl等
  - 关系：属于World和User，包含多个Character

- **Character.java**：角色实体类
  - 字段：id、name、description、age、gender、bio、avatarUrl等
  - 字段：systemInstruction、mbti、tags、speechStyle等
  - 关系：属于World和Era

- **Script.java**：对话脚本实体类
  - 字段：id、content、characterId等
  - 功能：存储对话记录

- **JournalEntry.java**：日记实体类
  - 字段：id、title、content、userId等
  - 功能：存储用户日记

**会员相关实体**
- **Membership.java**：会员实体类
  - 字段：id、userId、planId、startDate、endDate等
  - 关系：属于User

- **SubscriptionPlan.java**：订阅计划实体类
  - 字段：id、name、price、duration等

- **PointTransaction.java**：积分交易实体类
  - 字段：id、userId、amount、type、description等

- **PaymentOrder.java**：支付订单实体类
  - 字段：id、userId、amount、status、orderId等

#### 3.1.3 数据传输对象（dto/）

- **UserDTO.java**：用户数据传输对象
- **WorldDTO.java**：世界数据传输对象
- **EraDTO.java**：时代数据传输对象
- **CharacterDTO.java**：角色数据传输对象
- **ScriptDTO.java**：脚本数据传输对象
- **JournalEntryDTO.java**：日记数据传输对象
- **LoginRequest.java**：登录请求对象
- **RegisterRequest.java**：注册请求对象
- **AuthResponse.java**：认证响应对象

#### 3.1.4 控制器（controller/）

**认证控制器**
- **AuthController.java**：用户认证控制器
  - 接口：POST /api/auth/register（注册）
  - 接口：POST /api/auth/login（登录）
  - 接口：GET /api/auth/me（获取当前用户）

**内容管理控制器**
- **WorldController.java**：世界管理控制器
  - 接口：GET /api/worlds（获取世界列表）
  - 接口：POST /api/worlds（创建世界）
  - 接口：PUT /api/worlds/{id}（更新世界）
  - 接口：DELETE /api/worlds/{id}（删除世界）

- **EraController.java**：时代管理控制器
  - 接口：GET /api/eras（获取时代列表）
  - 接口：POST /api/eras（创建时代）
  - 接口：PUT /api/eras/{id}（更新时代）
  - 接口：DELETE /api/eras/{id}（删除时代）

- **CharacterController.java**：角色管理控制器
  - 接口：GET /api/characters（获取角色列表）
  - 接口：POST /api/characters（创建角色）
  - 接口：PUT /api/characters/{id}（更新角色）
  - 接口：DELETE /api/characters/{id}（删除角色）

- **ScriptController.java**：脚本管理控制器
  - 接口：管理对话脚本的CRUD操作

**资源管理控制器**
- **ResourceController.java**：资源管理控制器
  - 接口：资源上传、查询、删除

- **ImageController.java**：图片管理控制器
  - 接口：图片上传、存储、访问

**会员和支付控制器**
- **MembershipController.java**：会员管理控制器
  - 接口：GET /api/memberships（获取会员信息）
  - 接口：POST /api/memberships/subscribe（订阅会员）

- **PaymentController.java**：支付管理控制器
  - 接口：POST /api/payments/create（创建支付订单）
  - 接口：POST /api/payments/callback（支付回调）

**其他功能控制器**
- **JournalEntryController.java**：日记管理控制器
- **RecycleBinController.java**：回收站管理控制器
- **WeChatController.java**：微信相关控制器

#### 3.1.5 服务层（service/）

- **InitializationService.java**：初始化服务
  - 功能：用户数据初始化，创建默认世界、时代、角色

- **MembershipService.java**：会员服务
  - 功能：会员订阅、积分管理

- **PaymentService.java**：支付服务
  - 功能：支付订单创建、支付回调处理

- **ImageStorageService.java**：图片存储服务
  - 功能：图片上传、存储、访问

- **WeChatAuthService.java**：微信认证服务
  - 功能：微信OAuth2.0授权

#### 3.1.6 数据访问层（repository/）

所有Repository接口继承JpaRepository，提供标准CRUD操作：
- **UserRepository.java**：用户数据访问
- **WorldRepository.java**：世界数据访问
- **EraRepository.java**：时代数据访问
- **CharacterRepository.java**：角色数据访问
- **ScriptRepository.java**：脚本数据访问
- **JournalEntryRepository.java**：日记数据访问
- **MembershipRepository.java**：会员数据访问
- **SubscriptionPlanRepository.java**：订阅计划数据访问
- **PointTransactionRepository.java**：积分交易数据访问
- **PaymentOrderRepository.java**：支付订单数据访问

#### 3.1.7 安全模块（security/）

- **JwtAuthenticationFilter.java**：JWT认证过滤器
  - 功能：拦截请求，验证JWT令牌

- **UserDetailsImpl.java**：用户详情实现类
  - 功能：实现UserDetails接口

- **UserDetailsServiceImpl.java**：用户详情服务实现
  - 功能：加载用户信息

- **JwtUtils.java**（utils/）：JWT工具类
  - 功能：JWT令牌生成、验证、解析

#### 3.1.8 配置类（config/）

- **WebSecurityConfig.java**：Spring Security配置
  - 功能：安全策略配置、JWT过滤器配置

- **WebMvcConfig.java**：Web MVC配置
  - 功能：CORS配置、拦截器配置

#### 3.1.9 工具类（utils/）

- **DTOMapper.java**：DTO映射工具
  - 功能：实体类与DTO之间的转换

#### 3.1.10 管理后台模块（admin/）

**实体类（admin/entity/）**
- **SystemWorld.java**：系统世界实体
- **SystemEra.java**：系统时代实体
- **SystemCharacter.java**：系统角色实体
- **SystemResource.java**：系统资源实体
- **SystemAdmin.java**：系统管理员实体
- **SystemConfig.java**：系统配置实体
- **InviteCode.java**：邀请码实体

**控制器（admin/controller/）**
- **AdminAuthController.java**：管理员认证控制器
- **AdminSystemDataController.java**：系统数据管理控制器

**服务（admin/service/）**
- **AdminAuthService.java**：管理员认证服务
- **SystemDataService.java**：系统数据服务
- **SystemResourceService.java**：系统资源服务
- **SystemConfigService.java**：系统配置服务
- **InviteCodeService.java**：邀请码服务
- **AdminInitializationService.java**：管理员初始化服务

**DTO（admin/dto/）**
- 各种系统数据的DTO类

**Repository（admin/repository/）**
- 各种系统数据的Repository接口

#### 3.1.11 配置文件
- **pom.xml**：Maven项目配置
  - Spring Boot 3.2.0
  - Java 17
  - Spring Data JPA
  - Spring Security
  - JWT
  - MySQL Connector

- **application.yml**：应用配置文件
  - 数据库连接配置
  - JWT密钥配置
  - 服务器端口配置

---

## 四、AI Agent服务源代码说明

### 4.1 核心文件列表

#### 4.1.1 应用入口
- **AiAgentApplication.java**：AI Agent服务主类
  - 功能：服务启动入口

#### 4.1.2 Agent核心（agent/）

- **Agent.java**：Agent核心类
  - 功能：定义Agent的基本属性和行为

- **AgentRegistry.java**：Agent注册表
  - 功能：管理所有注册的Agent

#### 4.1.3 模型适配器（adapter/）

- **ModelAdapter.java**：模型适配器接口
- **AlibabaAdapter.java**：阿里云通义千问适配器
- **OpenAIAdapter.java**：OpenAI适配器
- **OllamaAdapter.java**：Ollama适配器

#### 4.1.4 工作流引擎（graph/）

- **WorkflowBuilder.java**：工作流构建器
  - 功能：构建和执行工作流

#### 4.1.5 工具集成（tool/）

- **Tool.java**：工具接口
- **ToolRegistry.java**：工具注册表
- **DataSearchTool.java**：数据搜索工具
- **ChartGeneratorTool.java**：图表生成工具

#### 4.1.6 工作流定义（workflow/）

- 各种工作流定义类

#### 4.1.7 控制器（controller/）

- **AgentController.java**：Agent管理控制器
  - 接口：POST /api/agents（注册Agent）
  - 接口：POST /api/agents/{id}/execute（执行Agent）
  - 接口：GET /api/agents（获取Agent列表）

#### 4.1.8 服务（service/）

- **AgentService.java**：Agent服务
  - 功能：Agent的创建、执行、管理

#### 4.1.9 配置（config/）

- **AiConfig.java**：AI配置类
  - 功能：配置大语言模型API密钥等

#### 4.1.10 配置文件
- **pom.xml**：Maven项目配置
  - Spring Boot 3.2.0
  - Spring AI Alibaba 1.1.0.0-RC1
  - Spring AI Alibaba Graph Core
  - Spring AI Alibaba Agent Framework

- **application.yml**：应用配置文件
  - 大语言模型API密钥配置

---

## 五、源代码统计信息

### 5.1 代码规模
- **前端代码**：约50+个TypeScript/TSX文件
- **后端代码**：约60+个Java文件
- **AI Agent代码**：约20+个Java文件
- **总计**：约130+个源代码文件

### 5.2 技术栈统计
- **前端**：React 19、TypeScript 5.8、Vite 5.0
- **后端**：Spring Boot 3.2、Java 17、Spring Data JPA、Spring Security
- **AI Agent**：Spring AI Alibaba 1.1.0.0-RC1
- **数据库**：MySQL 8.0+
- **构建工具**：Maven、npm

### 5.3 主要功能模块代码分布
- **用户认证模块**：约10个文件
- **内容管理模块**：约30个文件
- **对话交互模块**：约15个文件
- **会员支付模块**：约10个文件
- **AI Agent模块**：约20个文件
- **管理后台模块**：约25个文件
- **工具和配置**：约10个文件

---

## 六、源代码文件清单

### 6.1 前端核心文件（部分）
```
frontend/
├── index.tsx                    # 应用入口
├── App.tsx                      # 主应用组件
├── types.ts                     # 类型定义
├── constants.ts                 # 常量定义
├── components/
│   ├── EntryPoint.tsx           # 入口组件
│   ├── LoginModal.tsx           # 登录组件
│   ├── CharacterCard.tsx       # 角色卡片
│   ├── ChatWindow.tsx           # 聊天窗口
│   ├── ScenarioBuilder.tsx      # 场景构建器
│   ├── AdminScreen.tsx          # 管理后台
│   └── ...                      # 其他组件
├── services/
│   ├── api.ts                   # API服务
│   ├── gemini.ts                # Gemini服务
│   └── storage.ts               # 存储服务
└── utils/
    ├── promptTemplates.ts       # 提示词模板
    └── journalTemplates.ts      # 日记模板
```

### 6.2 后端核心文件（部分）
```
backend/src/main/java/com/heartsphere/
├── HeartSphereApplication.java  # 应用入口
├── entity/
│   ├── User.java                # 用户实体
│   ├── World.java               # 世界实体
│   ├── Era.java                 # 时代实体
│   ├── Character.java           # 角色实体
│   └── ...                      # 其他实体
├── controller/
│   ├── AuthController.java      # 认证控制器
│   ├── WorldController.java     # 世界控制器
│   ├── CharacterController.java # 角色控制器
│   └── ...                      # 其他控制器
├── service/
│   ├── InitializationService.java # 初始化服务
│   └── ...                      # 其他服务
├── repository/
│   └── ...                      # 数据访问层
└── security/
    ├── JwtAuthenticationFilter.java # JWT过滤器
    └── ...                      # 其他安全类
```

### 6.3 AI Agent核心文件（部分）
```
aiagent/src/main/java/com/heartsphere/aiagent/
├── AiAgentApplication.java      # 应用入口
├── agent/
│   ├── Agent.java               # Agent核心
│   └── AgentRegistry.java       # Agent注册表
├── adapter/
│   └── ...                      # 模型适配器
├── graph/
│   └── WorkflowBuilder.java     # 工作流构建器
├── tool/
│   ├── Tool.java                # 工具接口
│   └── ...                      # 具体工具
└── controller/
    └── AgentController.java     # Agent控制器
```

---

## 七、源代码特点说明

### 7.1 代码组织特点
1. **模块化设计**：前后端分离，功能模块清晰
2. **分层架构**：Controller-Service-Repository三层架构
3. **RESTful API**：标准的REST API设计
4. **类型安全**：TypeScript提供类型检查

### 7.2 代码质量特点
1. **注释完善**：关键代码有详细注释
2. **命名规范**：遵循Java和TypeScript命名规范
3. **错误处理**：完善的异常处理机制
4. **安全机制**：JWT认证、权限控制

### 7.3 技术亮点
1. **前后端分离**：现代化架构设计
2. **微服务架构**：AI Agent独立服务
3. **工作流引擎**：灵活的AI任务处理
4. **多模型支持**：统一接口支持多种大语言模型

---

**注：本文档列出了数字生命体交互系统（心域）的主要源代码文件及其功能说明，用于软件著作权申请。实际源代码文件数量可能更多，此处列出的是核心和代表性文件。**
