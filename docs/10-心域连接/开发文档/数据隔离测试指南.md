# 数据隔离功能测试指南

**测试日期**: 2025-12-28  
**测试范围**: 体验模式数据隔离机制

---

## 一、测试准备

### 1.1 环境要求

- ✅ 后端服务运行在 `http://localhost:8081`
- ✅ 前端服务运行在 `http://localhost:5173`
- ✅ 数据库已迁移（包含体验模式相关表）
- ✅ 已创建测试用户和共享配置

### 1.2 测试数据准备

1. **创建测试用户**：
   - 用户A（主人）：用于创建共享配置
   - 用户B（访问者）：用于体验模式测试

2. **创建共享配置**：
   - 使用用户A创建共享配置
   - 获取共享码（shareCode）

---

## 二、前端集成测试

### 2.1 检查请求头配置

**文件**: `frontend/services/api/base/request.ts`

确保在发送请求时添加体验模式标识：

```typescript
// 在request函数中添加
const experienceMode = sessionStorage.getItem('experience_mode');
if (experienceMode) {
  try {
    const data = JSON.parse(experienceMode);
    headers['X-Experience-Mode'] = 'true';
    headers['X-Share-Config-Id'] = data.shareConfigId.toString();
  } catch (err) {
    console.error('解析体验模式数据失败:', err);
  }
}
```

### 2.2 测试步骤

1. **进入体验模式**：
   ```typescript
   // 在浏览器控制台执行
   sessionStorage.setItem('experience_mode', JSON.stringify({
     shareConfigId: 1,  // 替换为实际的共享配置ID
     visitorId: 2,      // 替换为访问者用户ID
     startTime: Date.now()
   }));
   ```

2. **发送测试请求**：
   - 打开浏览器开发者工具
   - 切换到Network标签
   - 执行一个会保存数据的操作（如发送消息）
   - 检查请求头是否包含：
     - `X-Experience-Mode: true`
     - `X-Share-Config-Id: 1`

3. **验证响应**：
   - 检查响应是否正常
   - 检查后端日志是否显示"体验模式"

---

## 三、后端功能测试

### 3.1 测试拦截器

**测试用例1：正常请求（无体验模式标识）**

```bash
curl -X POST http://localhost:8081/api/memory/v1/sessions/test-session/messages \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{
    "role": "user",
    "content": "测试消息"
  }'
```

**预期结果**：
- 请求正常处理
- 数据保存到数据库
- 日志显示正常保存

**测试用例2：体验模式请求**

```bash
curl -X POST http://localhost:8081/api/memory/v1/sessions/test-session/messages \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {visitor_token}" \
  -H "X-Experience-Mode: true" \
  -H "X-Share-Config-Id: 1" \
  -d '{
    "role": "user",
    "content": "体验模式测试消息"
  }'
```

**预期结果**：
- 请求正常处理
- 数据保存到临时存储（不保存到数据库）
- 日志显示"体验模式：保存消息到临时存储"

### 3.2 测试记忆服务

**测试步骤**：

1. **正常模式保存消息**：
   - 发送消息（无体验模式标识）
   - 检查数据库是否有记录
   - 检查临时存储是否有记录（应该没有）

2. **体验模式保存消息**：
   - 发送消息（带体验模式标识）
   - 检查数据库是否有记录（应该没有）
   - 检查临时存储是否有记录

**验证方法**：

```java
// 在MemoryManagerImpl中添加日志
log.info("保存消息 - 体验模式: {}, shareConfigId: {}, visitorId: {}", 
    ExperienceModeContext.isActive(),
    ExperienceModeContext.getShareConfigId(),
    ExperienceModeContext.getVisitorId());
```

### 3.3 测试情绪服务

**测试步骤**：

1. **正常模式保存情绪**：
   ```bash
   curl -X POST http://localhost:8081/api/emotion/analyze \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer {token}" \
     -d '{
       "userId": 1,
       "text": "我很开心",
       "source": "chat"
     }'
   ```

2. **体验模式保存情绪**：
   ```bash
   curl -X POST http://localhost:8081/api/emotion/analyze \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer {visitor_token}" \
     -H "X-Experience-Mode: true" \
     -H "X-Share-Config-Id: 1" \
     -d '{
       "userId": 2,
       "text": "体验模式测试",
       "source": "chat"
     }'
   ```

**验证**：
- 检查数据库记录
- 检查临时存储记录
- 检查日志

---

## 四、集成测试场景

### 4.1 场景1：完整体验流程

**步骤**：

1. 用户A创建共享配置，获取共享码
2. 用户B通过共享码访问
3. 用户B进入体验模式
4. 用户B发送消息、产生情绪记录
5. 用户B离开体验模式
6. 验证：
   - 用户A的心域数据未受影响
   - 用户B的体验数据在临时存储中

### 4.2 场景2：多访问者隔离

**步骤**：

1. 用户A创建共享配置
2. 用户B进入体验模式，发送消息1
3. 用户C进入体验模式，发送消息2
4. 验证：
   - 用户B和用户C的数据相互隔离
   - 用户A的数据未受影响

### 4.3 场景3：正常模式和体验模式切换

**步骤**：

1. 用户B正常发送消息（保存到数据库）
2. 用户B进入体验模式，发送消息（保存到临时存储）
3. 用户B离开体验模式，发送消息（保存到数据库）
4. 验证：
   - 正常模式的数据在数据库
   - 体验模式的数据在临时存储
   - 切换正常

---

## 五、验证检查清单

### 5.1 前端验证

- [ ] 请求头正确添加体验模式标识
- [ ] sessionStorage正确存储体验模式数据
- [ ] 体验模式标识栏正确显示
- [ ] 离开体验模式时清除标识

### 5.2 后端验证

- [ ] 拦截器正确识别体验模式请求
- [ ] 上下文正确设置和清除
- [ ] 记忆服务正确隔离数据
- [ ] 情绪服务正确隔离数据
- [ ] 临时存储正确保存和检索数据

### 5.3 数据验证

- [ ] 体验模式下的数据不保存到数据库
- [ ] 体验模式下的数据保存到临时存储
- [ ] 正常模式下的数据正常保存到数据库
- [ ] 不同访问者的数据相互隔离

---

## 六、测试工具

### 6.1 Postman测试集合

创建Postman测试集合，包含：
- 正常模式保存消息
- 体验模式保存消息
- 正常模式保存情绪
- 体验模式保存情绪

### 6.2 单元测试

**MemoryManagerImplTest.java**:
```java
@Test
public void testSaveMessageInExperienceMode() {
    // 设置体验模式上下文
    ExperienceModeContext.set(new ExperienceModeContext.ExperienceModeInfo(
        true, 1L, 2L, 1L
    ));
    
    // 保存消息
    memoryManager.saveMessage("2", "session1", message);
    
    // 验证：数据库无记录，临时存储有记录
    // ...
}
```

---

## 七、常见问题

### 7.1 请求头未添加

**问题**：前端请求头中缺少体验模式标识

**解决**：
- 检查 `request.ts` 是否正确添加标识
- 检查 `sessionStorage` 是否有体验模式数据
- 检查浏览器控制台是否有错误

### 7.2 拦截器未生效

**问题**：拦截器未正确拦截请求

**解决**：
- 检查 `ExperienceModeConfig` 是否正确注册
- 检查路径匹配是否正确
- 检查拦截器是否被Spring加载

### 7.3 数据未隔离

**问题**：体验模式下的数据仍然保存到数据库

**解决**：
- 检查 `ExperienceModeContext.isActive()` 是否正确
- 检查服务方法是否正确检查体验模式
- 检查临时存储是否正确注入

---

## 八、性能测试

### 8.1 内存使用

- 监控临时存储的内存使用
- 测试大量数据时的性能
- 测试数据清理机制

### 8.2 响应时间

- 对比正常模式和体验模式的响应时间
- 确保体验模式不影响性能

---

**测试完成后，请更新测试结果到本文档**



