# 心域共享功能集成指南

**文档版本**: V1.0  
**编写日期**: 2025-12-28

---

## 一、快速开始

### 1.1 在个人中心添加共享入口

```tsx
import { ShareButton } from '@/components/heartsphere-share/ShareButton';

function ProfilePage() {
  return (
    <div>
      <h1>个人中心</h1>
      <ShareButton variant="button" />
    </div>
  );
}
```

### 1.2 在导航栏添加共享图标

```tsx
import { ShareButton } from '@/components/heartsphere-share/ShareButton';

function NavigationBar() {
  return (
    <nav>
      <ShareButton variant="icon" />
    </nav>
  );
}
```

### 1.3 在场景管理页面添加共享按钮

```tsx
import { ShareButton } from '@/components/heartsphere-share/ShareButton';

function SceneManagementPage() {
  return (
    <div>
      <div className="flex items-center justify-between">
        <h1>场景管理</h1>
        <ShareButton variant="text" />
      </div>
    </div>
  );
}
```

---

## 二、体验模式集成

### 2.1 在App根组件添加Provider

```tsx
import { ExperienceModeProvider } from '@/components/heartsphere-share/ExperienceModeProvider';

function App() {
  return (
    <ExperienceModeProvider>
      <Router>
        {/* 你的应用路由 */}
      </Router>
    </ExperienceModeProvider>
  );
}
```

### 2.2 在分享页面处理连接

```tsx
import { useExperienceModeContext } from '@/components/heartsphere-share/ExperienceModeProvider';
import { heartSphereShareApi } from '@/services/api/heartsphere-share';

function SharePage({ shareCode }: { shareCode: string }) {
  const { enterExperienceMode } = useExperienceModeContext();
  const [shareConfig, setShareConfig] = useState(null);
  
  useEffect(() => {
    loadShareConfig();
  }, [shareCode]);
  
  const loadShareConfig = async () => {
    try {
      const config = await heartSphereShareApi.getShareConfigByCode(shareCode);
      setShareConfig(config);
      
      // 如果是自由连接，直接进入体验模式
      if (config.accessPermission === 'free') {
        const userId = getCurrentUserId(); // 获取当前用户ID
        enterExperienceMode(config, userId);
      }
    } catch (err) {
      console.error('加载共享配置失败:', err);
    }
  };
  
  const handleRequestApproved = () => {
    if (shareConfig) {
      const userId = getCurrentUserId();
      enterExperienceMode(shareConfig, userId);
    }
  };
  
  return (
    <div>
      {shareConfig && (
        <div>
          <h1>{shareConfig.description || '心域分享'}</h1>
          {shareConfig.accessPermission === 'approval' && (
            <ConnectionRequestModal
              isOpen={true}
              shareCode={shareCode}
              onSuccess={handleRequestApproved}
            />
          )}
        </div>
      )}
    </div>
  );
}
```

---

## 三、数据隔离集成

### 3.1 在API请求中添加体验模式标识

修改 `frontend/services/api/base/request.ts`：

```typescript
export const request = async <T>(url: string, options?: RequestOptions): Promise<T> => {
  // ... 现有代码 ...
  
  // 添加体验模式标识
  const experienceMode = sessionStorage.getItem('experience_mode');
  if (experienceMode) {
    const data = JSON.parse(experienceMode);
    headers['X-Experience-Mode'] = 'true';
    headers['X-Share-Config-Id'] = data.shareConfigId.toString();
  }
  
  // ... 继续处理请求 ...
};
```

### 3.2 在对话服务中检查体验模式

```typescript
// 在保存对话前检查体验模式
const saveDialogue = async (dialogue: Dialogue) => {
  const experienceMode = sessionStorage.getItem('experience_mode');
  if (experienceMode) {
    // 体验模式下，不保存对话到主人的心域
    console.log('体验模式：对话不保存');
    return;
  }
  
  // 正常保存
  await dialogueApi.saveDialogue(dialogue);
};
```

---

## 四、完整集成示例

### 4.1 主应用集成

```tsx
// App.tsx
import { ExperienceModeProvider } from '@/components/heartsphere-share/ExperienceModeProvider';
import { ShareButton } from '@/components/heartsphere-share/ShareButton';

function App() {
  return (
    <ExperienceModeProvider>
      <div className="app">
        <header>
          <nav>
            <ShareButton variant="icon" />
          </nav>
        </header>
        <main>
          <Router>
            {/* 路由配置 */}
          </Router>
        </main>
      </div>
    </ExperienceModeProvider>
  );
}
```

### 4.2 分享页面路由

```tsx
// routes/ShareRoute.tsx
import { SharePage } from '@/pages/SharePage';

<Route path="/share/:shareCode" element={<SharePage />} />
```

### 4.3 分享页面实现

```tsx
// pages/SharePage.tsx
import { useParams } from 'react-router-dom';
import { useExperienceModeContext } from '@/components/heartsphere-share/ExperienceModeProvider';
import { ConnectionRequestModal } from '@/components/heartsphere-share/ConnectionRequestModal';
import { heartSphereShareApi } from '@/services/api/heartsphere-share';

export const SharePage = () => {
  const { shareCode } = useParams<{ shareCode: string }>();
  const { enterExperienceMode } = useExperienceModeContext();
  const [shareConfig, setShareConfig] = useState(null);
  const [showRequestModal, setShowRequestModal] = useState(false);
  
  useEffect(() => {
    if (shareCode) {
      loadShareConfig();
    }
  }, [shareCode]);
  
  const loadShareConfig = async () => {
    try {
      const config = await heartSphereShareApi.getShareConfigByCode(shareCode!);
      setShareConfig(config);
      
      // 自由连接直接进入体验模式
      if (config.accessPermission === 'free') {
        const userId = getCurrentUserId();
        enterExperienceMode(config, userId);
        // 重定向到心域页面
        navigate('/heartsphere');
      } else {
        // 需要审批，显示请求模态框
        setShowRequestModal(true);
      }
    } catch (err) {
      console.error('加载共享配置失败:', err);
    }
  };
  
  const handleRequestSuccess = () => {
    if (shareConfig) {
      const userId = getCurrentUserId();
      enterExperienceMode(shareConfig, userId);
      navigate('/heartsphere');
    }
  };
  
  return (
    <div>
      {shareConfig && (
        <>
          <div className="share-preview">
            <h1>{shareConfig.description || '心域分享'}</h1>
            {/* 预览内容 */}
          </div>
          
          <ConnectionRequestModal
            isOpen={showRequestModal}
            onClose={() => setShowRequestModal(false)}
            shareCode={shareCode!}
            onSuccess={handleRequestSuccess}
          />
        </>
      )}
    </div>
  );
};
```

---

## 五、使用场景

### 5.1 场景1：用户想要共享自己的心域

1. 点击"共享心域"按钮
2. 打开共享配置模态框
3. 选择共享范围和权限
4. 保存配置
5. 获取共享码和分享链接
6. 分享给其他人

### 5.2 场景2：用户想要访问他人的心域

1. 通过分享链接或共享码访问
2. 如果是自由连接，直接进入体验模式
3. 如果需要审批，发送连接请求
4. 等待主人批准
5. 批准后进入体验模式

### 5.3 场景3：用户在体验模式下使用

1. 顶部显示体验模式标识栏
2. 可以正常使用所有功能
3. 数据不会保存到主人的心域
4. 离开时可以选择留下暖心留言

---

## 六、注意事项

1. **体验模式标识**：确保在体验模式下始终显示标识栏
2. **数据隔离**：确保所有数据操作都检查体验模式状态
3. **权限验证**：后端需要验证体验模式的权限
4. **性能优化**：体验模式不应影响正常用户的性能

---

**文档维护**: 如有变更，请及时更新本文档



