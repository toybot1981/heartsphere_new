# 心域连接模块架构设计文档

**文档版本**: V1.0  
**编写日期**: 2025-12-28  
**模块名称**: 心域连接 (HeartSphere Connect)  
**模块类型**: 独立功能模块

---

## 一、模块概述

### 1.1 模块定位

心域连接模块是一个独立的业务模块，旨在为用户提供快速连接和访问心域内部E-SOUL（角色）的能力。该模块通过智能推荐、收藏管理、访问历史等功能，显著提升用户与E-SOUL交互的效率。

### 1.2 核心价值

- **效率提升**：将连接E-SOUL的步骤从3-4步减少到1-2步
- **个性化体验**：基于用户行为的智能推荐
- **便捷管理**：收藏、搜索、筛选等便捷功能
- **视觉吸引力**：星光效果等视觉增强

### 1.3 模块边界

**包含功能**：
- 快速连接入口和界面
- E-SOUL卡片展示
- 搜索和筛选功能
- 收藏管理
- 访问历史记录
- 智能推荐算法

**不包含功能**：
- E-SOUL的创建和编辑（属于角色管理模块）
- 对话功能（属于对话模块）
- 场景管理（属于场景模块）

---

## 二、技术架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      前端层 (Frontend)                        │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ QuickConnect │  │ CharacterCard │  │ SearchFilter │     │
│  │   Button     │  │   Component   │  │  Component   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ QuickConnect │  │ StarParticles│  │ FavoriteBtn  │     │
│  │    Modal     │  │   Component  │  │  Component   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                              │
│  ┌────────────────────────────────────────────────────┐   │
│  │         QuickConnectService (API Client)            │   │
│  └────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↕ HTTP/REST
┌─────────────────────────────────────────────────────────────┐
│                      API层 (Backend API)                      │
├─────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────┐     │
│  │         QuickConnectController                     │     │
│  │  - GET  /api/quick-connect/characters             │     │
│  │  - GET  /api/quick-connect/search                 │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│  ┌────────────────────────────────────────────────────┐     │
│  │         FavoriteController                         │     │
│  │  - POST   /api/favorites                           │     │
│  │  - DELETE /api/favorites/{characterId}             │     │
│  │  - GET    /api/favorites                           │     │
│  │  - PUT    /api/favorites/reorder                   │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│  ┌────────────────────────────────────────────────────┐     │
│  │         AccessHistoryController                    │     │
│  │  - POST /api/access-history                       │     │
│  │  - GET  /api/access-history                       │     │
│  └────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────────┐
│                   业务逻辑层 (Service Layer)                   │
├─────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────┐     │
│  │         QuickConnectService                         │     │
│  │  - 获取E-SOUL列表                                   │     │
│  │  - 搜索E-SOUL                                       │     │
│  │  - 推荐算法                                         │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│  ┌────────────────────────────────────────────────────┐     │
│  │         FavoriteService                            │     │
│  │  - 收藏/取消收藏                                    │     │
│  │  - 获取收藏列表                                     │     │
│  │  - 调整收藏顺序                                     │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│  ┌────────────────────────────────────────────────────┐     │
│  │         AccessHistoryService                       │     │
│  │  - 记录访问历史                                     │     │
│  │  - 获取访问历史                                     │     │
│  │  - 计算推荐分数                                     │     │
│  └────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────────┐
│                   数据访问层 (Repository Layer)                │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  Character   │  │ UserFavorite │  │ AccessHistory│       │
│  │  Repository  │  │  Repository  │  │  Repository  │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────────┐
│                     数据库层 (Database)                        │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  characters  │  │user_favorites│  │access_history│       │
│  │    table     │  │    table     │  │    table     │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 技术栈

**后端技术栈**：
- Spring Boot 3.2.0
- Spring Data JPA
- MySQL 8.0+
- JWT认证
- Flyway数据库迁移

**前端技术栈**：
- React 18+
- TypeScript
- Vite
- Tailwind CSS
- React Hooks

---

## 三、模块结构设计

### 3.1 后端模块结构

```
backend/src/main/java/com/heartsphere/
└── quickconnect/                          # 心域连接模块
    ├── controller/
    │   ├── QuickConnectController.java    # 快速连接主控制器
    │   ├── FavoriteController.java        # 收藏管理控制器
    │   └── AccessHistoryController.java  # 访问历史控制器
    │
    ├── service/
    │   ├── QuickConnectService.java       # 快速连接业务逻辑
    │   ├── FavoriteService.java           # 收藏业务逻辑
    │   ├── AccessHistoryService.java      # 访问历史业务逻辑
    │   └── RecommendationService.java     # 推荐算法服务
    │
    ├── repository/
    │   ├── UserFavoriteRepository.java    # 收藏数据访问
    │   └── AccessHistoryRepository.java   # 访问历史数据访问
    │
    ├── entity/
    │   ├── UserFavorite.java              # 用户收藏实体
    │   └── AccessHistory.java             # 访问历史实体
    │
    ├── dto/
    │   ├── QuickConnectCharacterDTO.java  # 快速连接角色DTO
    │   ├── FavoriteDTO.java                # 收藏DTO
    │   ├── AccessHistoryDTO.java          # 访问历史DTO
    │   └── RecommendationDTO.java      # 推荐结果DTO
    │
    └── util/
        └── RecommendationCalculator.java   # 推荐算法工具类
```

### 3.2 前端模块结构

```
frontend/
├── components/
│   └── quickconnect/                      # 心域连接组件目录
│       ├── QuickConnectButton.tsx         # 快速连接入口按钮
│       ├── QuickConnectModal.tsx           # 快速连接主界面
│       ├── CharacterCard.tsx               # E-SOUL卡片组件
│       ├── CharacterGrid.tsx               # E-SOUL网格布局
│       ├── SearchBox.tsx                   # 搜索框组件
│       ├── FilterTabs.tsx                  # 筛选标签组件
│       ├── StarParticles.tsx               # 星光粒子效果组件
│       ├── FavoriteButton.tsx              # 收藏按钮组件
│       └── EmptyState.tsx                  # 空状态组件
│
├── services/
│   └── api/
│       └── quickconnect.ts                 # 快速连接API服务
│
├── hooks/
│   └── useQuickConnect.ts                  # 快速连接Hook
│
└── types/
    └── quickconnect.ts                     # 快速连接类型定义
```

### 3.3 数据库表结构

#### 3.3.1 用户收藏表 (user_favorites)

```sql
CREATE TABLE user_favorites (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
  user_id BIGINT NOT NULL COMMENT '用户ID',
  character_id BIGINT NOT NULL COMMENT '角色ID',
  sort_order INT DEFAULT 0 COMMENT '排序顺序',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (character_id) REFERENCES characters(id) ON DELETE CASCADE,
  UNIQUE KEY uk_user_character (user_id, character_id),
  INDEX idx_user_id (user_id),
  INDEX idx_user_sort (user_id, sort_order),
  INDEX idx_character_id (character_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci 
  COMMENT='用户收藏表';
```

#### 3.3.2 访问历史表 (access_history)

```sql
CREATE TABLE access_history (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
  user_id BIGINT NOT NULL COMMENT '用户ID',
  character_id BIGINT NOT NULL COMMENT '角色ID',
  access_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '访问时间',
  access_duration INT DEFAULT 0 COMMENT '访问时长（秒）',
  conversation_rounds INT DEFAULT 0 COMMENT '对话轮数',
  session_id VARCHAR(100) COMMENT '会话ID',
  
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (character_id) REFERENCES characters(id) ON DELETE CASCADE,
  INDEX idx_user_id (user_id),
  INDEX idx_user_time (user_id, access_time DESC),
  INDEX idx_character_id (character_id),
  INDEX idx_character_time (character_id, access_time DESC),
  INDEX idx_session_id (session_id),
  INDEX idx_access_time (access_time DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci 
  COMMENT='访问历史表';
```

---

## 四、核心功能设计

### 4.1 快速连接服务

**职责**：
- 获取用户的E-SOUL列表
- 支持搜索、筛选、排序
- 计算推荐分数
- 返回格式化的角色数据

**关键方法**：
```java
// 获取快速连接列表
List<QuickConnectCharacterDTO> getQuickConnectCharacters(
    Long userId, 
    String filter, 
    String sortBy, 
    String searchQuery
);

// 搜索E-SOUL
List<QuickConnectCharacterDTO> searchCharacters(
    Long userId, 
    String query
);
```

### 4.2 收藏服务

**职责**：
- 添加/删除收藏
- 获取收藏列表
- 调整收藏顺序
- 验证收藏状态

**关键方法**：
```java
// 添加收藏
UserFavorite addFavorite(Long userId, Long characterId, Integer sortOrder);

// 删除收藏
void removeFavorite(Long userId, Long characterId);

// 获取收藏列表
List<FavoriteDTO> getFavorites(Long userId, String sortBy);

// 调整收藏顺序
void reorderFavorites(Long userId, List<Long> characterIds);
```

### 4.3 访问历史服务

**职责**：
- 记录访问历史
- 获取访问历史
- 计算访问统计
- 支持推荐算法

**关键方法**：
```java
// 记录访问
AccessHistory recordAccess(
    Long userId, 
    Long characterId, 
    Integer duration, 
    Integer rounds
);

// 获取访问历史
List<AccessHistoryDTO> getAccessHistory(
    Long userId, 
    Long characterId, 
    Integer limit
);

// 获取访问统计
AccessStatistics getAccessStatistics(Long userId, Long characterId);
```

### 4.4 推荐算法服务

**职责**：
- 计算推荐分数
- 基于多因素排序
- 个性化推荐

**推荐因素权重**：
- 访问频率：30%
- 最近访问时间：25%
- 收藏状态：20%
- 对话时长：15%
- 对话轮数：10%

**关键方法**：
```java
// 计算推荐分数
Double calculateRecommendationScore(
    Long userId, 
    Long characterId
);

// 获取推荐列表
List<QuickConnectCharacterDTO> getRecommendedCharacters(
    Long userId, 
    Integer limit
);
```

---

## 五、API接口设计

### 5.1 快速连接接口

#### 5.1.1 获取快速连接列表

```
GET /api/quick-connect/characters

请求参数：
- filter: 'all' | 'favorite' | 'recent' | 'scene' (可选)
- sceneId: number (当filter=scene时必填)
- sortBy: 'frequency' | 'recent' | 'name' | 'favorite' (可选，默认frequency)
- limit: number (可选，默认50)
- offset: number (可选，默认0)
- search: string (可选，搜索关键词)

响应：
{
  "success": true,
  "data": {
    "characters": [...],
    "totalCount": 50,
    "favoriteCount": 12,
    "recentCount": 8,
    "pagination": {
      "limit": 50,
      "offset": 0,
      "hasMore": false
    }
  }
}
```

#### 5.1.2 搜索E-SOUL

```
GET /api/quick-connect/search

请求参数：
- query: string (必填，搜索关键词)
- filter: 'all' | 'favorite' | 'recent' (可选)
- limit: number (可选，默认20)

响应：
{
  "success": true,
  "data": {
    "characters": [...],
    "totalCount": 5,
    "searchQuery": "关键词",
    "highlightedFields": {...}
  }
}
```

### 5.2 收藏接口

#### 5.2.1 添加收藏

```
POST /api/favorites

请求体：
{
  "characterId": 123,
  "sortOrder": 0 (可选)
}

响应：
{
  "success": true,
  "data": {
    "id": 1,
    "userId": 1,
    "characterId": 123,
    "sortOrder": 0,
    "createdAt": "2025-12-28T10:00:00"
  }
}
```

#### 5.2.2 删除收藏

```
DELETE /api/favorites/{characterId}

响应：
{
  "success": true,
  "message": "取消收藏成功"
}
```

#### 5.2.3 获取收藏列表

```
GET /api/favorites

请求参数：
- sortBy: 'created' | 'sortOrder' | 'access' (可选)

响应：
{
  "success": true,
  "data": {
    "favorites": [...],
    "totalCount": 12
  }
}
```

#### 5.2.4 调整收藏顺序

```
PUT /api/favorites/reorder

请求体：
{
  "favorites": [
    {"characterId": 123, "sortOrder": 0},
    {"characterId": 456, "sortOrder": 1}
  ]
}

响应：
{
  "success": true,
  "message": "排序更新成功"
}
```

### 5.3 访问历史接口

#### 5.3.1 记录访问历史

```
POST /api/access-history

请求体：
{
  "characterId": 123,
  "accessDuration": 3600 (可选，秒),
  "conversationRounds": 10 (可选)
}

响应：
{
  "success": true,
  "data": {
    "historyId": 1
  }
}
```

#### 5.3.2 获取访问历史

```
GET /api/access-history

请求参数：
- characterId: number (可选，筛选特定角色)
- limit: number (可选，默认20)
- offset: number (可选，默认0)
- startTime: number (可选，时间戳)
- endTime: number (可选，时间戳)

响应：
{
  "success": true,
  "data": {
    "history": [...],
    "totalCount": 50,
    "pagination": {...}
  }
}
```

---

## 六、数据流设计

### 6.1 打开快速连接流程

```
用户点击快速连接按钮
    ↓
前端：QuickConnectButton触发onClick
    ↓
前端：打开QuickConnectModal
    ↓
前端：调用useQuickConnect Hook
    ↓
前端：QuickConnectService.getQuickConnectList()
    ↓
HTTP请求 → 后端：QuickConnectController.getCharacters()
    ↓
后端：QuickConnectService.getQuickConnectCharacters()
    ↓
后端：查询CharacterRepository（获取角色列表）
    ↓
后端：查询UserFavoriteRepository（获取收藏状态）
    ↓
后端：查询AccessHistoryRepository（获取访问历史）
    ↓
后端：RecommendationService计算推荐分数
    ↓
后端：组装QuickConnectCharacterDTO列表
    ↓
HTTP响应 → 前端：接收数据
    ↓
前端：更新状态，渲染CharacterCard列表
    ↓
前端：加载星光动画效果
```

### 6.2 收藏操作流程

```
用户点击收藏按钮
    ↓
前端：CharacterCard触发onToggleFavorite
    ↓
前端：立即更新UI（乐观更新）
    ↓
前端：QuickConnectService.toggleFavorite()
    ↓
HTTP请求 → 后端：FavoriteController.addFavorite() 或 removeFavorite()
    ↓
后端：FavoriteService.addFavorite() 或 removeFavorite()
    ↓
后端：UserFavoriteRepository保存/删除
    ↓
HTTP响应 → 前端：接收结果
    ↓
如果失败：前端回滚UI状态，显示错误提示
如果成功：保持UI状态，显示成功动画
```

### 6.3 访问历史记录流程

```
用户点击E-SOUL卡片进入对话
    ↓
前端：记录开始时间，生成sessionId
    ↓
用户关闭对话或离开
    ↓
前端：计算访问时长和对话轮数
    ↓
前端：QuickConnectService.recordAccess()
    ↓
HTTP请求 → 后端：AccessHistoryController.recordAccess()
    ↓
后端：AccessHistoryService.recordAccess()
    ↓
后端：AccessHistoryRepository保存记录
    ↓
后端：异步更新推荐分数（可选）
    ↓
HTTP响应 → 前端：确认记录成功
```

---

## 七、性能优化策略

### 7.1 数据库优化

1. **索引优化**
   - user_favorites表：user_id + character_id联合索引
   - access_history表：user_id + access_time复合索引
   - 定期分析慢查询日志

2. **查询优化**
   - 使用EntityGraph避免N+1查询
   - 分页查询避免一次性加载大量数据
   - 使用缓存减少数据库查询

3. **数据归档**
   - 定期归档6个月前的访问历史
   - 保留统计数据，删除详细记录

### 7.2 前端优化

1. **组件优化**
   - 使用React.memo避免不必要的重渲染
   - 虚拟滚动处理大量卡片
   - 懒加载图片和动画

2. **请求优化**
   - 防抖搜索请求（300ms）
   - 缓存API响应结果
   - 乐观更新UI，减少等待时间

3. **动画优化**
   - 使用CSS动画而非JavaScript动画
   - 使用transform和opacity实现动画
   - 减少重绘和回流

### 7.3 缓存策略

1. **后端缓存**
   - Redis缓存用户收藏列表（TTL: 5分钟）
   - Redis缓存推荐分数（TTL: 10分钟）
   - 缓存失效策略：收藏变更时清除缓存

2. **前端缓存**
   - LocalStorage缓存收藏状态
   - 内存缓存API响应（5分钟）
   - 图片缓存策略

---

## 八、安全设计

### 8.1 认证授权

- 所有API接口需要JWT认证
- 用户只能访问自己的收藏和访问历史
- 验证characterId属于当前用户

### 8.2 数据验证

- 输入参数验证（长度、格式等）
- SQL注入防护（使用JPA参数化查询）
- XSS防护（前端转义用户输入）

### 8.3 限流保护

- API限流：每个用户每分钟最多100次请求
- 搜索接口限流：每个用户每分钟最多20次
- 防止恶意刷接口

---

## 九、错误处理

### 9.1 错误分类

1. **客户端错误（4xx）**
   - 400 Bad Request：参数错误
   - 401 Unauthorized：未认证
   - 403 Forbidden：无权限
   - 404 Not Found：资源不存在
   - 409 Conflict：资源冲突（如重复收藏）

2. **服务器错误（5xx）**
   - 500 Internal Server Error：服务器内部错误
   - 503 Service Unavailable：服务不可用

### 9.2 错误响应格式

```json
{
  "success": false,
  "error": {
    "code": "INVALID_PARAMETER",
    "message": "参数错误：characterId不能为空",
    "details": {...}
  },
  "timestamp": 1703234567890
}
```

### 9.3 前端错误处理

- 统一错误处理中间件
- 用户友好的错误提示
- 错误日志记录
- 自动重试机制（网络错误）

---

## 十、测试策略

### 10.1 单元测试

**后端**：
- Service层单元测试（Mock Repository）
- Repository层集成测试
- DTO转换测试

**前端**：
- 组件单元测试（React Testing Library）
- Hook测试
- 工具函数测试

### 10.2 集成测试

- API接口集成测试
- 数据库操作集成测试
- 前后端联调测试

### 10.3 E2E测试

- 快速连接完整流程测试
- 收藏操作流程测试
- 搜索功能测试

---

## 十一、部署和监控

### 11.1 部署策略

- 数据库迁移使用Flyway
- 渐进式发布（灰度发布）
- 回滚方案准备

### 11.2 监控指标

- API响应时间
- 错误率
- 数据库查询性能
- 用户使用统计

### 11.3 日志规范

- 结构化日志（JSON格式）
- 日志级别：ERROR、WARN、INFO、DEBUG
- 关键操作记录审计日志

---

## 十二、扩展性设计

### 12.1 未来扩展点

1. **推荐算法增强**
   - 机器学习推荐
   - 协同过滤
   - 内容推荐

2. **社交功能**
   - 分享E-SOUL
   - 推荐给好友
   - 热门E-SOUL榜单

3. **高级筛选**
   - 多标签筛选
   - 自定义筛选条件
   - 保存筛选方案

4. **数据分析**
   - 用户行为分析
   - 推荐效果分析
   - 使用趋势分析

### 12.2 模块解耦

- 通过接口定义模块边界
- 使用事件驱动架构（可选）
- 支持插件化扩展

---

## 附录

### A. 相关文档

- [心域连接功能需求分析-第一阶段](./需求分析/心域连接功能需求分析-第一阶段.md)
- [API接口详细设计](./API接口设计.md)（待创建）
- [数据库设计文档](./数据库设计.md)（待创建）

### B. 技术参考

- Spring Boot官方文档
- React官方文档
- MySQL性能优化指南
- RESTful API设计规范

---

**文档维护**：
- 架构变更时及时更新本文档
- 定期审查架构设计合理性
- 记录架构决策和原因




