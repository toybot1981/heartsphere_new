# 数据隔离功能快速测试步骤

**测试时间**: 2025-12-28

---

## 一、前端测试（浏览器）

### 步骤1：启动应用

```bash
# 启动后端
cd backend
mvn spring-boot:run

# 启动前端
cd frontend
npm run dev
```

### 步骤2：设置体验模式

在浏览器控制台执行：

```javascript
// 设置体验模式（替换为实际的shareConfigId和visitorId）
sessionStorage.setItem('experience_mode', JSON.stringify({
  shareConfigId: 1,  // 替换为实际的共享配置ID
  visitorId: 2,      // 替换为访问者用户ID
  startTime: Date.now()
}));

// 验证设置
console.log('体验模式数据:', sessionStorage.getItem('experience_mode'));
```

### 步骤3：发送测试请求

1. 打开浏览器开发者工具（F12）
2. 切换到 **Network** 标签
3. 在应用中执行一个会保存数据的操作（如发送消息）
4. 查看请求详情：
   - 点击请求
   - 查看 **Headers** 标签
   - 检查 **Request Headers** 中是否包含：
     - `X-Experience-Mode: true`
     - `X-Share-Config-Id: 1`

### 步骤4：验证后端日志

查看后端控制台日志，应该看到类似：

```
DEBUG ExperienceModeInterceptor - 设置体验模式上下文: shareConfigId=1, visitorId=2, ownerId=1
DEBUG MemoryManagerImpl - 体验模式：保存消息到临时存储: shareConfigId=1, visitorId=2, sessionId=xxx
```

---

## 二、后端测试（Postman/cURL）

### 测试1：正常模式保存消息

```bash
curl -X POST http://localhost:8081/api/memory/v1/sessions/test-session/messages \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "role": "user",
    "content": "正常模式测试消息"
  }'
```

**预期结果**：
- 请求成功
- 数据保存到数据库
- 日志显示正常保存

### 测试2：体验模式保存消息

```bash
curl -X POST http://localhost:8081/api/memory/v1/sessions/test-session/messages \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer VISITOR_TOKEN" \
  -H "X-Experience-Mode: true" \
  -H "X-Share-Config-Id: 1" \
  -d '{
    "role": "user",
    "content": "体验模式测试消息"
  }'
```

**预期结果**：
- 请求成功
- 数据**不**保存到数据库
- 数据保存到临时存储
- 日志显示"体验模式：保存消息到临时存储"

### 测试3：验证数据隔离

1. **检查数据库**：
   ```sql
   -- 检查对话记录表（应该没有体验模式的数据）
   SELECT * FROM chat_messages WHERE content LIKE '%体验模式%';
   ```

2. **检查临时存储**（通过日志或API）：
   - 查看后端日志中的临时存储记录
   - 或添加一个API端点查看临时存储数据

---

## 三、完整流程测试

### 场景：用户B体验用户A的心域

1. **准备**：
   - 用户A登录，创建共享配置，获取共享码
   - 用户B登录

2. **用户B进入体验模式**：
   ```javascript
   // 在浏览器控制台执行
   sessionStorage.setItem('experience_mode', JSON.stringify({
     shareConfigId: 1,  // 用户A的共享配置ID
     visitorId: 2,      // 用户B的用户ID
     startTime: Date.now()
   }));
   ```

3. **用户B发送消息**：
   - 在聊天界面发送消息
   - 检查Network标签，确认请求头包含体验模式标识

4. **验证数据隔离**：
   - 用户A的心域数据未受影响
   - 用户B的体验数据在临时存储中

5. **用户B离开体验模式**：
   ```javascript
   sessionStorage.removeItem('experience_mode');
   ```

6. **用户B正常发送消息**：
   - 消息应该正常保存到数据库

---

## 四、验证检查清单

### 前端验证

- [ ] 体验模式数据正确保存到sessionStorage
- [ ] 请求头正确添加 `X-Experience-Mode: true`
- [ ] 请求头正确添加 `X-Share-Config-Id: {id}`
- [ ] 体验模式标识栏正确显示
- [ ] 离开体验模式时清除标识

### 后端验证

- [ ] 拦截器正确识别体验模式请求
- [ ] 上下文正确设置（shareConfigId, visitorId, ownerId）
- [ ] 记忆服务正确隔离数据
- [ ] 情绪服务正确隔离数据
- [ ] 临时存储正确保存数据
- [ ] 请求完成后上下文正确清除

### 数据验证

- [ ] 体验模式下的消息不保存到数据库
- [ ] 体验模式下的消息保存到临时存储
- [ ] 正常模式下的消息正常保存到数据库
- [ ] 不同访问者的数据相互隔离

---

## 五、常见问题排查

### 问题1：请求头未添加

**检查**：
1. 打开浏览器控制台，检查是否有错误
2. 检查 `sessionStorage.getItem('experience_mode')` 是否有值
3. 检查 `request.ts` 中的代码是否正确

**解决**：
- 确保sessionStorage中有体验模式数据
- 检查request.ts中的代码逻辑

### 问题2：拦截器未生效

**检查**：
1. 查看后端日志，是否有拦截器的日志
2. 检查 `ExperienceModeConfig` 是否正确注册
3. 检查路径匹配是否正确

**解决**：
- 确认拦截器已注册
- 检查路径排除列表

### 问题3：数据未隔离

**检查**：
1. 查看后端日志，是否显示"体验模式"
2. 检查 `ExperienceModeContext.isActive()` 返回值
3. 检查服务方法是否正确检查体验模式

**解决**：
- 确认上下文正确设置
- 检查服务方法的逻辑

---

## 六、测试结果记录

### 测试日期：__________

### 测试结果：

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 前端请求头添加 | ⬜ 通过 / ⬜ 失败 | |
| 拦截器识别 | ⬜ 通过 / ⬜ 失败 | |
| 记忆服务隔离 | ⬜ 通过 / ⬜ 失败 | |
| 情绪服务隔离 | ⬜ 通过 / ⬜ 失败 | |
| 数据隔离验证 | ⬜ 通过 / ⬜ 失败 | |
| 多访问者隔离 | ⬜ 通过 / ⬜ 失败 | |

### 发现的问题：

1. 
2. 
3. 

### 修复情况：

1. 
2. 
3. 

---

**测试完成后，请更新测试结果**

