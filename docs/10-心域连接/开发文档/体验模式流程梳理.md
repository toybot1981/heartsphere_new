# 体验模式流程梳理

## 完整流程（从前端到后端）

### 1. 前端触发体验模式

#### 1.1 用户点击"立即体验"按钮
- **位置**: `SharedHeartSphereCard.tsx` 或 `SharePageContentSimple`
- **动作**: 跳转到 `/share/{shareCode}` 页面

#### 1.2 加载共享配置
- **位置**: `App.tsx` -> `SharePageContentSimple`
- **代码**: `heartConnectApi.getShareConfigByCode(shareCode)`
- **结果**: 获取 `ShareConfig` 对象

#### 1.3 进入体验模式
- **位置**: `App.tsx` -> `handleEnterExperience` 或自动进入
- **代码**: `enterExperienceMode(shareConfig, currentUser.id)`
- **作用**: 
  - 设置 React 状态 (`useExperienceMode` hook)
  - 保存到 `sessionStorage`: `{ shareConfigId, visitorId, startTime }`
- **重定向**: `window.location.href = '/'`

### 2. 前端状态管理

#### 2.1 useExperienceMode Hook
- **文件**: `frontend/hooks/useExperienceMode.ts`
- **状态**: 
  - `isActive: boolean`
  - `shareConfig: ShareConfig | null`
  - `visitorId: number | null`
- **初始化**: 从 `sessionStorage` 恢复状态（如果有）

#### 2.2 请求头自动添加
- **文件**: `frontend/services/api/base/request.ts`
- **逻辑**: 
  ```typescript
  const experienceMode = sessionStorage.getItem('experience_mode');
  if (experienceMode && data.shareConfigId) {
    headers['X-Experience-Mode'] = 'true';
    headers['X-Share-Config-Id'] = data.shareConfigId.toString();
  }
  ```
- **作用**: 所有 API 请求自动携带体验模式标识

### 3. 后端拦截器

#### 3.1 ExperienceModeInterceptor
- **文件**: `backend/.../ExperienceModeInterceptor.java`
- **注册**: `ExperienceModeConfig.java` 注册到所有 `/api/**` 路径
- **逻辑**:
  1. 检查请求头 `X-Experience-Mode` 和 `X-Share-Config-Id`
  2. 验证共享配置存在且状态为 `ACTIVE`
  3. 检查是否过期
  4. 验证访问权限（FREE/APPROVAL/INVITE）
  5. 设置 `ExperienceModeContext`
- **清除**: `afterCompletion` 中清除上下文

#### 3.2 ExperienceModeContext
- **文件**: `backend/.../ExperienceModeContext.java`
- **存储**: ThreadLocal，每个请求独立
- **内容**: `{ isActive, shareConfigId, visitorId, ownerId }`

### 4. 数据加载

#### 4.1 前端数据加载
- **文件**: `frontend/hooks/useDataLoader.ts`
- **检查**: `experienceMode.isActive && experienceMode.shareConfig !== null`
- **体验模式**: 调用 `experienceApi.getSharedWorlds(token)` 和 `experienceApi.getSharedEras(token)`
- **正常模式**: 调用 `worldApi.getAllWorlds(token)` 和 `eraApi.getAllEras(token)`

#### 4.2 后端体验模式接口
- **文件**: `backend/.../ExperienceController.java`
- **路径**: `/api/heartconnect/experience/worlds` 和 `/api/heartconnect/experience/eras`
- **验证**: 检查 `ExperienceModeContext.isActive()`
- **数据过滤**: 
  - 根据 `shareConfigId` 获取共享范围 (`HeartSphereShareScope`)
  - 只返回共享的世界/场景，且属于主人 (`ownerId`)

## 可能的问题点

### 1. 前端问题

#### 问题1: 状态不同步
- **现象**: `useExperienceMode` hook 的状态和 `sessionStorage` 不同步
- **原因**: 直接操作 `sessionStorage` 而不是通过 hook
- **解决**: 统一使用 `useExperienceMode` hook

#### 问题2: 重定向后状态丢失
- **现象**: `window.location.href = '/'` 后体验模式状态丢失
- **原因**: 页面刷新，React 状态重置
- **解决**: 依赖 `sessionStorage` 恢复状态（已实现）

#### 问题3: 数据加载时机
- **现象**: 体验模式激活后，数据加载仍使用正常接口
- **原因**: `useDataLoader` 没有正确检查体验模式状态
- **解决**: 已修复，使用 `useExperienceMode` hook

### 2. 后端问题

#### 问题1: 拦截器上下文清除过早
- **现象**: `afterCompletion` 中清除上下文，导致后续请求无法使用
- **原因**: ThreadLocal 在请求完成后被清除
- **解决**: 这是正常的，每个请求独立设置上下文

#### 问题2: 权限验证失败
- **现象**: 拦截器验证失败，但没有设置上下文
- **原因**: 权限检查逻辑问题
- **解决**: 检查日志，确认权限验证逻辑

#### 问题3: 共享范围为空
- **现象**: 体验模式接口返回空数据
- **原因**: `HeartSphereShareScope` 中没有配置共享范围
- **解决**: 检查共享配置的共享范围设置

## 调试步骤

### 1. 前端调试
1. 打开浏览器控制台
2. 检查 `sessionStorage.getItem('experience_mode')` 是否有值
3. 检查网络请求，确认请求头包含 `X-Experience-Mode` 和 `X-Share-Config-Id`
4. 检查 `useExperienceMode` hook 的状态

### 2. 后端调试
1. 检查拦截器日志：`ExperienceModeInterceptor` 的日志
2. 检查上下文设置：`ExperienceModeContext.isActive()` 是否为 true
3. 检查共享范围：`HeartSphereShareScope` 表中是否有数据
4. 检查权限验证：确认访问权限类型和连接状态

### 3. 数据库检查
```sql
-- 检查共享配置
SELECT * FROM heart_sphere_share_config WHERE id = ?;

-- 检查共享范围
SELECT * FROM heart_sphere_share_scope WHERE share_config_id = ?;

-- 检查连接（如果是 APPROVAL 或 INVITE 类型）
SELECT * FROM heart_sphere_connection 
WHERE share_config_id = ? AND visitor_id = ? AND connection_status = 'ACTIVE';
```

## 修复记录

### 2025-12-30
1. ✅ 修复 `useDataLoader` 使用 `useExperienceMode` hook 而不是直接读取 `sessionStorage`
2. ✅ 在 `handleLoginSuccess` 中也检查体验模式
3. ✅ 添加调试日志，追踪整个流程
4. ✅ 在 `request.ts` 中添加体验模式请求头的日志



