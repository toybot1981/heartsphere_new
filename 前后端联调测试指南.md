# 前后端联调测试指南

## 📋 测试前准备

### 1. 确认服务运行状态

```bash
# 检查后端服务（端口 8081）
lsof -ti:8081 && echo "✅ 后端服务运行中" || echo "❌ 后端服务未运行"

# 检查前端服务（端口 3000）
lsof -ti:3000 && echo "✅ 前端服务运行中" || echo "❌ 前端服务未运行"
```

### 2. 运行自动化API测试

```bash
# 运行自动化测试脚本
./test_integration.sh
```

测试脚本会自动验证：
- ✅ 系统预置场景API
- ✅ 主线剧情API
- ✅ 剧本API
- ✅ 用户注册API
- ✅ 用户认证API
- ✅ 用户数据API

---

## 🧪 手动测试步骤

### 测试场景1: 完整初始化流程测试

#### 步骤1: 打开前端页面
1. 打开浏览器，访问：http://localhost:3000
2. 确认页面正常加载

#### 步骤2: 注册新用户
1. 点击"注册"按钮
2. 填写注册信息：
   - 用户名：`test_user_$(date +%s)` （使用时间戳确保唯一）
   - 密码：`password123`
   - 邮箱：`test_$(date +%s)@example.com`
3. 点击"注册"
4. **验证点**：
   - ✅ 注册成功提示
   - ✅ 自动跳转到初始化向导
   - ✅ 浏览器控制台无错误

#### 步骤3: 初始化向导 - 场景选择
1. **验证点**：
   - ✅ 显示系统预置场景列表
   - ✅ 场景信息完整（名称、描述、图片）
   - ✅ 可以选择多个场景
2. 选择一个场景（如"我的大学"）
3. 尝试自定义场景名称（如改为"我的校园"）
4. **验证点**：
   - ✅ 可以正常输入和修改名称
   - ✅ 删除第一个字符不会自动恢复原名称
5. 点击"下一步"

#### 步骤4: 初始化向导 - 角色选择
1. **验证点**：
   - ✅ 显示选中场景的角色列表
   - ✅ 角色信息完整（头像、名称、描述）
2. 选择一个或多个角色
3. 尝试自定义角色名称
4. **验证点**：
   - ✅ 可以正常输入和修改名称
5. 点击"下一步"

#### 步骤5: 初始化向导 - 主线剧情选择
1. **验证点**：
   - ✅ 显示选中场景的主线剧情
   - ✅ **关键验证**：如果选择了"我的大学"场景，应该能看到"青春校园的序曲"主线剧情
   - ✅ 主线剧情信息完整（名称、描述、头像）
2. 如果显示了主线剧情，尝试自定义名称
3. **验证点**：
   - ✅ 可以正常输入和修改名称
4. 点击"下一步"

#### 步骤6: 初始化向导 - 剧本选择
1. **验证点**：
   - ✅ 显示选中场景的剧本列表
   - ✅ 剧本信息完整（标题、描述）
2. 选择一个或多个剧本
3. 尝试自定义剧本标题
4. **验证点**：
   - ✅ 可以正常输入和修改标题
5. 点击"完成"

#### 步骤7: 初始化完成验证
1. **验证点**：
   - ✅ 显示友好的过渡效果（"正在同步您的数据..."）
   - ✅ 过渡效果持续时间合理（1-2秒）
   - ✅ 数据同步完成后进入主界面
2. **关键验证 - 场景列表**：
   - ✅ 打开场景选择页面
   - ✅ **验证不包含体验场景**：
     - ❌ 不应该看到"大学时代"（university_era）
     - ❌ 不应该看到"赛博都市"（cyberpunk_city）
     - ❌ 不应该看到"心域心理治疗诊所"（clinic）
   - ✅ 只看到初始化时选择的场景
3. **验证数据完整性**：
   - ✅ 场景数据正确显示
   - ✅ 角色数据正确显示
   - ✅ 主线剧情数据正确显示（如果选择了）
   - ✅ 剧本数据正确显示（如果选择了）

---

### 测试场景2: 数据获取验证

#### 步骤1: 验证场景数据
1. 打开浏览器开发者工具（F12）
2. 切换到"Network"标签
3. 刷新页面或切换场景
4. **验证点**：
   - ✅ API请求成功（状态码 200）
   - ✅ 响应数据格式正确
   - ✅ 场景列表不包含体验场景ID

#### 步骤2: 验证主线剧情数据
1. 选择一个有主线剧情的场景
2. **验证点**：
   - ✅ 主线剧情数据正确加载
   - ✅ 主线剧情的 systemEraId 与场景匹配
   - ✅ 主线剧情信息完整

#### 步骤3: 验证剧本数据
1. 查看场景中的剧本列表
2. **验证点**：
   - ✅ 剧本数据正确加载
   - ✅ 剧本与场景正确关联（通过 eraId）
   - ✅ 剧本信息完整

---

### 测试场景3: 场景列表显示逻辑

#### 步骤1: 登录用户场景列表
1. 使用已注册的账号登录
2. 进入场景选择页面
3. **验证点**：
   - ✅ 只显示 userWorldScenes（用户创建的场景）
   - ✅ **不显示** WORLD_SCENES（体验场景）
   - ✅ 场景ID不包含：`university_era`, `cyberpunk_city`, `clinic`

#### 步骤2: 游客场景列表
1. 退出登录或清除 localStorage 中的 `auth_token`
2. 刷新页面
3. **验证点**：
   - ✅ 显示 WORLD_SCENES（体验场景）
   - ✅ 场景ID包含：`university_era`, `cyberpunk_city`, `clinic`

---

## 🔍 浏览器控制台检查

### 检查点
1. **打开浏览器控制台**（F12 → Console）
2. **检查错误**：
   - ❌ 不应该有红色错误信息
   - ⚠️ 警告信息可以接受（如某些API返回404是正常的）
3. **检查日志**：
   - ✅ 查看初始化相关的日志
   - ✅ 查看数据加载相关的日志
   - ✅ 查看API请求相关的日志

### 关键日志检查
```
[InitializationWizard] 加载场景 X 的主线剧情...
[InitializationWizard] ✓ 成功加载场景 X 的主线剧情: "青春校园的序曲"
[App] 数据同步完成，页面已更新。
```

---

## 📊 API测试（使用curl）

### 1. 测试系统预置场景API
```bash
curl http://localhost:8081/api/preset-eras | jq
```

### 2. 测试主线剧情API（替换场景ID）
```bash
# 获取场景ID为1的主线剧情
curl http://localhost:8081/api/system/main-stories/era/1 | jq
```

### 3. 测试剧本API（替换场景ID）
```bash
# 获取场景ID为1的剧本
curl http://localhost:8081/api/system/scripts/era/1 | jq
```

### 4. 测试用户注册
```bash
curl -X POST http://localhost:8081/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser_'$(date +%s)'",
    "password": "password123",
    "email": "test_'$(date +%s)'@example.com"
  }' | jq
```

### 5. 测试用户登录（使用注册返回的token）
```bash
TOKEN="your-token-here"

# 获取当前用户信息
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8081/api/auth/me | jq

# 获取用户的世界列表
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8081/api/worlds | jq

# 获取用户的场景列表
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8081/api/eras | jq

# 获取用户的角色列表
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8081/api/characters | jq

# 获取用户的剧本列表
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8081/api/scripts | jq
```

---

## ✅ 测试检查清单

### 功能检查
- [ ] 用户注册功能正常
- [ ] 初始化向导正常显示
- [ ] 场景选择功能正常
- [ ] 角色选择功能正常
- [ ] **主线剧情选择功能正常（特别是"我的大学"场景的"青春校园的序曲"）**
- [ ] 剧本选择功能正常
- [ ] 初始化完成后数据同步正常
- [ ] **场景列表显示正确（不包含体验场景）**

### 数据检查
- [ ] 注册后 token 正确保存
- [ ] 初始化后场景数据正确创建
- [ ] 初始化后角色数据正确创建
- [ ] 初始化后主线剧情数据正确创建
- [ ] 初始化后剧本数据正确创建
- [ ] 数据关联正确（剧本与场景、主线剧情与场景）

### UI/UX 检查
- [ ] 初始化向导步骤清晰
- [ ] 过渡效果友好（"正在同步您的数据..."）
- [ ] 错误提示友好
- [ ] 加载状态显示正确

### 性能检查
- [ ] API 响应时间合理（< 1秒）
- [ ] 页面加载流畅
- [ ] 数据同步不卡顿

---

## 🐛 常见问题排查

### 问题1: 初始化向导不显示
**排查步骤：**
1. 检查浏览器控制台是否有错误
2. 检查 localStorage 中是否有 `auth_token`
3. 检查后端 `/api/auth/me` 接口是否正常
4. 检查 `App.tsx` 中的 `showInitializationWizard` 状态

### 问题2: 主线剧情未显示
**排查步骤：**
1. 检查后端 `/api/system/main-stories/era/{eraId}` 接口
2. 检查数据库中是否有对应场景的主线剧情数据
3. 检查 `systemEraId` 是否匹配
4. 检查浏览器控制台日志

### 问题3: 体验场景仍然显示
**排查步骤：**
1. 检查前端场景列表构建逻辑（`App.tsx` 中的 `getCurrentScenes`）
2. 检查 `userWorldScenes` 是否正确加载
3. 检查用户是否已登录（`userProfile.isGuest` 是否为 false）
4. 检查场景ID是否匹配体验场景ID

### 问题4: 剧本未显示
**排查步骤：**
1. 检查后端 `/api/system/scripts/era/{eraId}` 接口
2. 检查初始化时是否正确创建剧本
3. 检查剧本与场景的关联（`eraId`）
4. 检查 `WorldScene` 中的 `scripts` 字段是否正确填充

---

## 📝 测试报告模板

### 测试环境
- **测试时间**: YYYY-MM-DD HH:mm:ss
- **测试人员**: 
- **后端版本**: 
- **前端版本**: 
- **浏览器**: Chrome/Firefox/Safari (版本号)

### 测试结果
- **测试用例1（完整初始化流程）**: ✅/❌
- **测试用例2（数据获取验证）**: ✅/❌
- **测试用例3（场景列表显示逻辑）**: ✅/❌

### 发现的问题
1. **问题描述**: 
   - **复现步骤**: 
   - **预期结果**: 
   - **实际结果**: 
   - **严重程度**: 高/中/低
   - **截图/日志**: 

### 测试结论
- **通过/不通过**: 
- **备注**: 

---

## 🚀 快速测试命令

```bash
# 1. 运行自动化API测试
./test_integration.sh

# 2. 检查服务状态
lsof -ti:8081 && echo "后端运行中" || echo "后端未运行"
lsof -ti:3000 && echo "前端运行中" || echo "前端未运行"

# 3. 测试系统预置场景API
curl -s http://localhost:8081/api/preset-eras | jq '.[0]'

# 4. 测试主线剧情API（需要替换场景ID）
curl -s http://localhost:8081/api/system/main-stories/era/1 | jq

# 5. 测试剧本API（需要替换场景ID）
curl -s http://localhost:8081/api/system/scripts/era/1 | jq
```

---

## 📚 相关文档

- [初始化流程测试用例](./初始化流程测试用例.md)
- [前后端联调测试方案](./前后端联调测试方案.md)
- [API测试脚本](./test_integration.sh)




