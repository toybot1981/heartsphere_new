# 修复重复同步创建问题

## 问题描述

本地缓存不断向服务端同步创建，导致重复创建相同的日志条目。

## 根本原因

1. **两个同步服务同时运行**：
   - 旧的 `syncService` (在 `frontend/services/syncService.ts`) - 每60秒自动同步一次
   - 新的 `SyncService` (在 `frontend/services/sync/SyncService.ts`) - 每30秒自动同步一次
   - 两个服务同时运行，导致重复同步

2. **状态更新不同步**：
   - `syncJournalEntries` 更新了本地存储，但没有通知 React 组件
   - React 状态中的条目仍然是 `syncStatus=0`（待同步）
   - 下次同步时，又认为这些条目需要同步，导致重复创建

3. **同步状态检查不完整**：
   - 虽然更新了本地存储，但可能因为异步问题，状态没有及时更新
   - 或者 React 状态和本地存储不同步

## 修复方案

### 1. 禁用旧的同步服务

已禁用 `syncService.startPeriodicSync()` 和 `syncService.syncData()`，避免与新的 `SyncService` 冲突。

### 2. 确保状态同步

新的 `SyncService` 在同步成功后会：
- 更新本地存储
- 通过 `onEntityUpdated` 回调通知 React 组件
- 确保 React 状态和本地存储保持一致

### 3. 添加防重复机制

在同步前检查：
- 条目是否已同步（`syncStatus === 1`）
- 服务器是否已存在相同内容的条目
- 条目是否正在被其他同步流程处理

## 临时解决方案

如果问题仍然存在，可以：

### 方法1：清除同步状态（推荐）

```javascript
// 在浏览器控制台执行
(async () => {
  const { storageService } = await import('./services/storage');
  await storageService.clearSyncStatus();
  window.location.reload();
})();
```

### 方法2：停止自动同步

```javascript
// 在浏览器控制台执行
const { syncService } = await import('./services/sync/SyncService');
syncService.stopAutoSync();
console.log('自动同步已停止');
```

### 方法3：清除所有数据

```javascript
// 在浏览器控制台执行
(async () => {
  const { storageService } = await import('./services/storage');
  await storageService.clearMemory({ keepAuth: true });
  window.location.reload();
})();
```

## 检查同步状态

```javascript
// 检查待同步的条目数量
const { syncService } = await import('./services/sync/SyncService');
const pendingCount = syncService.getPendingCount('journal');
console.log(`待同步的日记条目数量: ${pendingCount}`);

// 检查所有日记条目的同步状态
const entries = syncService.loadAllEntitiesFromLocal('journal');
const statusCount = {
  pending: entries.filter(e => e.syncStatus === 0).length,
  synced: entries.filter(e => e.syncStatus === 1).length,
  failed: entries.filter(e => e.syncStatus === -1).length
};
console.log('同步状态统计:', statusCount);
```

## 预防措施

1. **只使用新的 SyncService**：确保代码中不再调用旧的 `syncService.syncData()` 或 `syncService.startPeriodicSync()`

2. **确保状态更新**：同步成功后，必须：
   - 更新本地存储
   - 通知 React 组件（通过 dispatch 或回调）
   - 确保状态一致性

3. **添加同步锁**：防止多个同步流程同时运行

4. **添加去重检查**：在创建前检查服务器是否已存在相同条目

## 修改的文件

- `frontend/services/syncService.ts` - 禁用旧的同步方法
- `frontend/services/sync/SyncService.ts` - 使用新的同步服务（已存在）

## 下一步

1. 检查是否还有其他地方调用了旧的同步服务
2. 确保所有同步操作都通过新的 `SyncService` 进行
3. 添加更完善的日志记录，便于调试



