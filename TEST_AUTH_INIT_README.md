# 注册、登录、初始化过程全面测试

本文档说明如何使用测试脚本对系统的注册、登录和初始化过程进行全面测试。

## 测试脚本

提供了两个版本的测试脚本：

1. **test-auth-init.sh** - Bash版本（需要安装jq以更好解析JSON）
2. **test-auth-init.py** - Python版本（推荐，JSON处理更可靠）

## 测试内容

### 1. 服务可用性检查
- 检查后端服务是否正常运行

### 2. 系统配置检查
- 检查是否需要邀请码
- 检查是否需要邮箱验证码

### 3. 注册功能测试
- ✅ 正常注册（用户名、邮箱、密码、昵称）
- ✅ 无效注册请求（缺少必填字段）
- ✅ 无效密码验证（长度、复杂度）
- ✅ 重复用户名检测
- ✅ 重复邮箱检测
- ✅ 注册后初始化验证（检查是否创建了默认世界）
- ✅ 返回JWT Token验证
- ✅ 首次登录标识验证

### 4. 登录功能测试
- ✅ 正常登录
- ✅ 错误密码登录（应被拒绝）
- ✅ 不存在用户登录（应被拒绝）
- ✅ 首次登录标识验证
- ✅ 登录后世界数据验证
- ✅ 返回JWT Token验证

### 5. 获取当前用户信息测试
- ✅ 使用Token获取用户信息
- ✅ 无Token访问（应被拒绝）
- ✅ 用户信息完整性验证

### 6. 初始化过程验证
- ✅ 验证注册后是否创建了默认世界
- ✅ 验证世界数据完整性
- ✅ 验证世界名称（应为"心域"）

### 7. 首次登录初始化测试
- ✅ 新用户注册时的初始化
- ✅ 首次登录标识
- ✅ 世界创建验证

## 使用方法

### Python版本（推荐）

```bash
# 使用默认地址 (http://localhost:8081)
python3 test-auth-init.py

# 指定后端地址
python3 test-auth-init.py --base-url http://your-backend-url:8081
```

### Bash版本

```bash
# 使用默认地址 (http://localhost:8081)
./test-auth-init.sh

# 指定后端地址
BASE_URL=http://your-backend-url:8081 ./test-auth-init.sh
```

## 前置要求

### Python版本
- Python 3.6+
- requests库（如果没有，运行：`pip install requests`）

### Bash版本
- bash 4.0+
- curl
- jq（可选，但推荐安装以获得更好的JSON解析）

安装jq：
```bash
# macOS
brew install jq

# Ubuntu/Debian
sudo apt-get install jq

# CentOS/RHEL
sudo yum install jq
```

## 测试输出示例

```
========================================
注册、登录、初始化过程全面测试
========================================

测试环境: http://localhost:8081
API地址: http://localhost:8081/api

========================================
1. 服务可用性检查
========================================

[测试] 检查后端服务是否运行
✅ PASS - 后端服务运行正常
✅ 后端服务正在运行 (http://localhost:8081)

========================================
2. 系统配置检查
========================================

[测试] 检查是否需要邀请码
   邀请码要求: false
✅ PASS - 邀请码配置查询成功
[测试] 检查是否需要邮箱验证码
   邮箱验证码要求: false
✅ PASS - 邮箱验证码配置查询成功

...

========================================
测试总结
========================================

总测试数: 25
通过: 25
失败: 0

========================================
✅ 所有测试通过！
========================================
```

## 测试覆盖的场景

### 正常流程
1. 用户注册 → 创建账户 → 初始化世界 → 返回Token
2. 用户登录 → 验证凭证 → 返回Token和用户信息
3. 使用Token访问受保护资源 → 验证身份 → 返回数据

### 异常流程
1. 无效注册请求 → 验证失败 → 返回错误
2. 重复用户名/邮箱 → 检测冲突 → 返回错误
3. 错误密码登录 → 认证失败 → 返回401
4. 无Token访问 → 授权失败 → 返回401

### 边界情况
1. 密码复杂度验证（长度、字符类型）
2. 用户名长度验证
3. 邮箱格式验证
4. Token有效性验证
5. 首次登录标识验证

## 注意事项

1. **测试数据清理**：测试脚本会创建测试用户，这些用户会保留在数据库中。如果需要清理，请手动删除测试用户（用户名通常以`testuser_`开头）。

2. **并发测试**：如果需要并发测试，请修改脚本以生成唯一的用户名和邮箱。

3. **生产环境**：不建议在生产环境运行此测试脚本，因为会创建测试数据。

4. **网络超时**：如果后端服务响应较慢，可以修改脚本中的超时时间（Python版本默认10秒）。

## 故障排查

### 问题1: 无法连接到后端服务

**错误信息**: `后端服务未运行或无法访问`

**解决方法**:
- 检查后端服务是否已启动
- 检查端口是否正确（默认8081）
- 检查防火墙设置
- 检查BASE_URL配置是否正确

### 问题2: 测试失败 - 注册被拒绝

**可能原因**:
- 用户名或邮箱已存在
- 密码不符合规则（需要8-50位，包含大小写字母、数字和特殊字符）
- 邀请码要求开启但未提供
- 邮箱验证码要求开启但未提供

**解决方法**:
- 检查系统配置（邀请码、邮箱验证码要求）
- 使用符合规则的密码
- 查看后端日志获取详细错误信息

### 问题3: JSON解析错误（Bash版本）

**可能原因**: jq未安装或JSON格式不正确

**解决方法**:
- 安装jq: `brew install jq` (macOS) 或 `sudo apt-get install jq` (Linux)
- 使用Python版本脚本（推荐）

### 问题4: Python版本缺少requests库

**错误信息**: `ModuleNotFoundError: No module named 'requests'`

**解决方法**:
```bash
pip install requests
# 或
pip3 install requests
```

## 扩展测试

如果需要扩展测试，可以修改脚本添加以下测试：

1. **邮箱验证码测试**（如果系统启用了邮箱验证码）
2. **邀请码测试**（如果系统启用了邀请码）
3. **Token过期测试**
4. **并发注册/登录测试**
5. **性能测试**（响应时间、吞吐量）

## 相关文档

- [API文档](../backend/docs/API测试文档.md)
- [用户系统文档](../docs/06-用户系统/)
- [快速开始指南](../backend/docs/快速开始指南.md)
