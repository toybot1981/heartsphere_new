# è®°å¿†ç³»ç»Ÿå‰ç«¯ä»£ç æ£€æŸ¥æŠ¥å‘Š

## æ£€æŸ¥æ—¶é—´
2025-12-31

## æ£€æŸ¥èŒƒå›´
æ‰€æœ‰ä¸è®°å¿†ç³»ç»Ÿç›¸å…³çš„å‰ç«¯ä»£ç ï¼ŒåŒ…æ‹¬APIè°ƒç”¨ã€ç»„ä»¶ä½¿ç”¨ã€å­˜å‚¨å±‚å®ç°ç­‰ã€‚

---

## âœ… æ£€æŸ¥ç»“æœæ€»è§ˆ

### 1. APIè·¯å¾„æ£€æŸ¥ âœ…

**æ–‡ä»¶**: `frontend/services/api/memory/memory.ts`

**æ£€æŸ¥ç»“æœ**: âœ… æ‰€æœ‰APIè·¯å¾„æ­£ç¡®

- âœ… `saveMemory`: `/memory/v1/users/${userId}/memories` - æ­£ç¡®
- âœ… `saveMemories`: `/memory/v1/users/${userId}/memories/batch` - æ­£ç¡®
- âœ… `searchMemories`: `/memory/v1/users/${userIdStr}/memories/search` - æ­£ç¡®
- âœ… `getMemoryById`: `/memory/v1/users/${userId}/memories/${memoryId}` - æ­£ç¡®
- âœ… `updateMemory`: `/memory/v1/users/${userId}/memories/${memoryId}` - æ­£ç¡®
- âœ… `deleteMemory`: `/memory/v1/users/${userId}/memories/${memoryId}` - æ­£ç¡®
- âœ… `extractMemoriesFromSession`: `/memory/v1/users/${userId}/sessions/${sessionId}/extract` - æ­£ç¡®

**è¯´æ˜**: 
- `API_BASE_URL`å·²ç»åŒ…å«`/api`å‰ç¼€ï¼ˆè§`frontend/services/api/config.ts`ï¼‰
- æ‰€æœ‰APIè·¯å¾„éƒ½æ­£ç¡®ä½¿ç”¨`/memory/v1/...`ï¼Œæ²¡æœ‰é‡å¤çš„`/api`å‰ç¼€
- âœ… **æ— é—®é¢˜**

### 2. userIdç±»å‹è½¬æ¢æ£€æŸ¥ âœ…

**æ–‡ä»¶**: `frontend/services/api/memory/memory.ts`

**æ£€æŸ¥ç»“æœ**: âœ… userIdç±»å‹è½¬æ¢æ­£ç¡®

```typescript
// ç¬¬131è¡Œï¼šç¡®ä¿userIdæ˜¯å­—ç¬¦ä¸²ç±»å‹
const userIdStr = String(userId);

// æ‰€æœ‰APIè°ƒç”¨éƒ½æ­£ç¡®å¤„ç†userIdç±»å‹ï¼š
- saveMemory: `${userId}` (æ¨¡æ¿å­—ç¬¦ä¸²è‡ªåŠ¨è½¬æ¢)
- saveMemories: `${userId}` (æ¨¡æ¿å­—ç¬¦ä¸²è‡ªåŠ¨è½¬æ¢)
- searchMemories: `${userIdStr}` (æ˜ç¡®è½¬æ¢ä¸ºString)
- getMemoryById: `${userId}` (æ¨¡æ¿å­—ç¬¦ä¸²è‡ªåŠ¨è½¬æ¢)
- updateMemory: `${userId}` (æ¨¡æ¿å­—ç¬¦ä¸²è‡ªåŠ¨è½¬æ¢)
- deleteMemory: `${userId}` (æ¨¡æ¿å­—ç¬¦ä¸²è‡ªåŠ¨è½¬æ¢)
- extractMemoriesFromSession: `${userId}` (æ¨¡æ¿å­—ç¬¦ä¸²è‡ªåŠ¨è½¬æ¢)
```

**è¯´æ˜**: 
- TypeScriptæ¨¡æ¿å­—ç¬¦ä¸²ä¼šè‡ªåŠ¨å°†`number`è½¬æ¢ä¸º`string`
- `searchMemories`ä¸­æ˜ç¡®ä½¿ç”¨`String(userId)`ç¡®ä¿ç±»å‹å®‰å…¨
- âœ… **æ— é—®é¢˜**

### 3. è®¤è¯Tokenæ£€æŸ¥ âœ…

**æ–‡ä»¶**: `frontend/services/memory-system/storage/RemoteMemoryStorage.ts`

**æ£€æŸ¥ç»“æœ**: âœ… Tokenå¤„ç†æ­£ç¡®

```typescript
// æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–token
this.token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');

// getTokenæ–¹æ³•æ­£ç¡®å¤„ç†tokenè·å–å’Œé”™è¯¯
private getToken(): string {
  if (!this.token) {
    this.token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
  }
  if (!this.token) {
    throw new Error('æœªæ‰¾åˆ°è®¤è¯tokenï¼Œè¯·å…ˆç™»å½•');
  }
  return this.token;
}

// æ‰€æœ‰APIè°ƒç”¨éƒ½ä½¿ç”¨token
await memoryApi.saveMemory(this.userId, {...}, token);
```

**æ–‡ä»¶**: `frontend/services/api/memory/memory.ts`

**æ£€æŸ¥ç»“æœ**: âœ… æ‰€æœ‰APIè°ƒç”¨éƒ½åŒ…å«Authorization header

```typescript
headers: {
  Authorization: `Bearer ${token}`,
  'Content-Type': 'application/json',
}
```

**è¯´æ˜**: 
- âœ… Tokenä»localStorage/sessionStorageæ­£ç¡®è·å–
- âœ… æ‰€æœ‰APIè°ƒç”¨éƒ½åŒ…å«Authorization header
- âœ… Tokenæ›´æ–°æ–¹æ³•å·²å®ç°ï¼ˆ`updateToken`ï¼‰
- âœ… **æ— é—®é¢˜**

### 4. å“åº”æ ¼å¼å¤„ç†æ£€æŸ¥ âœ…

**æ–‡ä»¶**: `frontend/services/api/memory/memory.ts`

**æ£€æŸ¥ç»“æœ**: âœ… å“åº”æ ¼å¼å¤„ç†æ­£ç¡®

```typescript
// å¤„ç†åç«¯è¿”å›çš„å“åº”æ ¼å¼ï¼ˆå¯èƒ½æ˜¯ { data: UserMemory } æˆ–ç›´æ¥æ˜¯ UserMemoryï¼‰
const savedMemory = (response as any).data || response;

// æ­£ç¡®è½¬æ¢å­—æ®µæ˜ å°„ï¼š
- type â†’ memoryType
- accessCount â†’ usageCount
- createdAt â†’ timestamp (è½¬æ¢ä¸ºæ¯«ç§’æ—¶é—´æˆ³)
```

**è¯´æ˜**: 
- âœ… å…¼å®¹åç«¯è¿”å›çš„ä¸¤ç§æ ¼å¼ï¼ˆåŒ…è£…æ ¼å¼å’Œç›´æ¥æ ¼å¼ï¼‰
- âœ… å­—æ®µæ˜ å°„æ­£ç¡®ï¼ˆåç«¯å­—æ®µåâ†’å‰ç«¯å­—æ®µåï¼‰
- âœ… æ—¶é—´æˆ³è½¬æ¢æ­£ç¡®
- âœ… **æ— é—®é¢˜**

### 5. é”™è¯¯å¤„ç†æ£€æŸ¥ âœ…

**æ–‡ä»¶**: `frontend/services/memory-system/storage/RemoteMemoryStorage.ts`

**æ£€æŸ¥ç»“æœ**: âœ… é”™è¯¯å¤„ç†å®Œå–„

```typescript
try {
  // APIè°ƒç”¨
} catch (error) {
  logger.error('[RemoteMemoryStorage] æ“ä½œå¤±è´¥', {
    // è¯¦ç»†é”™è¯¯ä¿¡æ¯
    error,
  });
  // é€‚å½“å¤„ç†ï¼ˆthrowæˆ–è¿”å›nullï¼‰
}
```

**æ–‡ä»¶**: `frontend/components/memory/JournalMemoryModal.tsx`

**æ£€æŸ¥ç»“æœ**: âœ… ç»„ä»¶é”™è¯¯å¤„ç†æ­£ç¡®

```typescript
try {
  await memorySystem.searchMemories({...});
} catch (error) {
  logger.error('[JournalMemoryModal] åŠ è½½è®°å¿†å¤±è´¥', error);
  // è®¾ç½®é”™è¯¯çŠ¶æ€æˆ–æ˜¾ç¤ºæç¤º
}
```

**è¯´æ˜**: 
- âœ… æ‰€æœ‰APIè°ƒç”¨éƒ½æœ‰try-catché”™è¯¯å¤„ç†
- âœ… ä½¿ç”¨loggerè®°å½•é”™è¯¯æ—¥å¿—
- âœ… ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
- âœ… **æ— é—®é¢˜**

### 6. ç»„ä»¶ä½¿ç”¨æ£€æŸ¥ âœ…

#### 6.1 ChatWindow.tsx âœ…

**æ£€æŸ¥ç»“æœ**: âœ… ä½¿ç”¨æ­£ç¡®

```typescript
const memorySystem = useMemorySystem({
  enabled: true,
  autoExtraction: true,
  userId: userProfile?.id || 0,
});
```

**è¯´æ˜**: 
- âœ… userIdæ­£ç¡®è·å–ï¼ˆä»userProfileï¼‰
- âœ… é…ç½®æ­£ç¡®ï¼ˆenabled, autoExtractionï¼‰
- âœ… **æ— é—®é¢˜**

#### 6.2 JournalMemoryModal.tsx âœ…

**æ£€æŸ¥ç»“æœ**: âœ… ä½¿ç”¨æ­£ç¡®

```typescript
const memorySystem = useMemorySystem({
  enabled: true,
  autoExtraction: true,
  aiEnhanced: true,
  userId,
  useRemoteStorage: true,
});

// æœç´¢è®°å¿†
const allMemories = await memorySystem.searchMemories({
  ...filter,
  limit: 100,
});
```

**è¯´æ˜**: 
- âœ… userIdæ­£ç¡®ä¼ é€’
- âœ… useRemoteStorageè®¾ç½®ä¸ºtrueï¼ˆä½¿ç”¨è¿œç¨‹å­˜å‚¨ï¼‰
- âœ… æœç´¢é€»è¾‘æ­£ç¡®
- âœ… **æ— é—®é¢˜**

#### 6.3 JournalPreviewModal.tsx âœ…

**æ£€æŸ¥ç»“æœ**: âœ… ä½¿ç”¨æ­£ç¡®ï¼Œå·²ä¼˜åŒ–æ— é™å¾ªç¯é—®é¢˜

```typescript
const entryIdRef = useRef<string | null>(null);

useEffect(() => {
  // é˜²æ­¢é‡å¤åŠ è½½
  if (entryIdRef.current === entry.id && memories.length >= 0) {
    return;
  }
  
  // åŠ è½½è®°å¿†é€»è¾‘
}, [isOpen, entry?.id, memorySystem.isReady]);
```

**è¯´æ˜**: 
- âœ… ä½¿ç”¨useRefé˜²æ­¢æ— é™å¾ªç¯
- âœ… useEffectä¾èµ–é¡¹ä¼˜åŒ–ï¼ˆåªä¾èµ–ç¨³å®šçš„å€¼ï¼‰
- âœ… é”™è¯¯å¤„ç†æ­£ç¡®
- âœ… **æ— é—®é¢˜**

#### 6.4 MemoryList.tsx âœ…

**æ£€æŸ¥ç»“æœ**: âœ… ä½¿ç”¨æ­£ç¡®

```typescript
const memorySystem = useMemorySystem({
  enabled: true,
  userId,
});

// æœç´¢å’Œåˆ é™¤åŠŸèƒ½æ­£ç¡®å®ç°
```

**è¯´æ˜**: 
- âœ… userIdæ­£ç¡®ä¼ é€’
- âœ… æœç´¢å’Œåˆ é™¤åŠŸèƒ½æ­£ç¡®
- âœ… **æ— é—®é¢˜**

#### 6.5 RealWorldScreen.tsx âœ…

**æ£€æŸ¥ç»“æœ**: âœ… userIdè·å–é€»è¾‘æ­£ç¡®

```typescript
// "æˆ‘çš„è®°å¿†"æŒ‰é’®ç‚¹å‡»å¤„ç†
const userId = gameState.userProfile?.id 
  || localStorage.getItem('HEARTSPHERE_MEMORY_CORE_V1')
  || (await authApi.getCurrentUser())?.id;
```

**è¯´æ˜**: 
- âœ… å¤šçº§å›é€€é€»è¾‘æ­£ç¡®
- âœ… ä¼˜å…ˆçº§æ­£ç¡®ï¼ˆgameState â†’ localStorage â†’ APIï¼‰
- âœ… **æ— é—®é¢˜**

### 7. å­˜å‚¨å±‚æ£€æŸ¥ âœ…

**æ–‡ä»¶**: `frontend/services/memory-system/storage/RemoteMemoryStorage.ts`

**æ£€æŸ¥ç»“æœ**: âœ… å®ç°æ­£ç¡®

**å…³é”®æ–¹æ³•**:
- âœ… `save`: æ­£ç¡®è°ƒç”¨memoryApi.saveMemory
- âœ… `getById`: æ­£ç¡®è°ƒç”¨memoryApi.getMemoryById
- âœ… `search`: æ­£ç¡®è°ƒç”¨memoryApi.searchMemories
- âœ… `delete`: æ­£ç¡®è°ƒç”¨memoryApi.deleteMemory
- âœ… `update`: æ­£ç¡®è°ƒç”¨memoryApi.updateMemory
- âœ… `clear`: æ­£ç¡®å®ç°ï¼ˆæç¤ºéœ€è¦åç«¯APIæ”¯æŒï¼‰

**è¯´æ˜**: 
- âœ… æ‰€æœ‰æ–¹æ³•éƒ½æ­£ç¡®è°ƒç”¨å¯¹åº”çš„API
- âœ… userIdç±»å‹æ­£ç¡®ï¼ˆnumberï¼‰
- âœ… Tokenå¤„ç†æ­£ç¡®
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… **æ— é—®é¢˜**

### 8. MemorySystemæ ¸å¿ƒç±»æ£€æŸ¥ âœ…

**æ–‡ä»¶**: `frontend/services/memory-system/MemorySystem.ts`

**æ£€æŸ¥ç»“æœ**: âœ… å®ç°æ­£ç¡®

```typescript
// å­˜å‚¨é€‰æ‹©é€»è¾‘æ­£ç¡®
if (storage) {
  this.storage = storage;
} else if (config.useRemoteStorage) {
  this.storage = new RemoteMemoryStorage(config.userId);
} else {
  this.storage = new LocalMemoryStorage();
}

// searchMemoriesæ­£ç¡®è°ƒç”¨storage.search
async searchMemories(options: MemorySearchOptions): Promise<UserMemory[]> {
  return this.storage.search(this.config.userId, options);
}
```

**è¯´æ˜**: 
- âœ… å­˜å‚¨é€‰æ‹©é€»è¾‘æ­£ç¡®
- âœ… userIdæ­£ç¡®ä¼ é€’ç»™storage
- âœ… **æ— é—®é¢˜**

---

## ğŸ” æ½œåœ¨é—®é¢˜æ£€æŸ¥

### 1. æœªå®ç°çš„APIç«¯ç‚¹

**æ£€æŸ¥**: `extractMemoriesFromSession`

**çŠ¶æ€**: âš ï¸ åç«¯å¯èƒ½æœªå®ç°æ­¤ç«¯ç‚¹

**æ–‡ä»¶**: `frontend/services/api/memory/memory.ts:269`

```typescript
extractMemoriesFromSession: async (
  userId: string | number,
  sessionId: string,
  token: string
): Promise<UserMemory[]> => {
  return request<UserMemory[]>(`/memory/v1/users/${userId}/sessions/${sessionId}/extract`, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${token}`,
    },
  });
}
```

**å»ºè®®**: 
- æ£€æŸ¥åç«¯æ˜¯å¦å®ç°äº†æ­¤ç«¯ç‚¹
- å¦‚æœæœªå®ç°ï¼Œè€ƒè™‘åœ¨è°ƒç”¨å¤„æ·»åŠ é”™è¯¯å¤„ç†æˆ–æ³¨é‡Šè¯´æ˜

### 2. updateMemory APIç«¯ç‚¹

**æ£€æŸ¥**: `updateMemory`

**çŠ¶æ€**: âš ï¸ åç«¯å¯èƒ½æœªå®ç°æ­¤ç«¯ç‚¹

**æ–‡ä»¶**: `frontend/services/api/memory/memory.ts:211`

```typescript
updateMemory: async (
  userId: string | number,
  memoryId: string,
  memory: Partial<SaveMemoryRequest>,
  token: string
): Promise<UserMemory> => {
  const response = await request<{ data: UserMemory }>(`/memory/v1/users/${userId}/memories/${memoryId}`, {
    method: 'PUT',
    // ...
  });
}
```

**å»ºè®®**: 
- æ£€æŸ¥åç«¯MemoryControlleræ˜¯å¦å®ç°äº†PUTæ–¹æ³•
- å¦‚æœæœªå®ç°ï¼ŒRemoteMemoryStorage.updateæ–¹æ³•ä¼šå¤±è´¥

### 3. getMemoryById APIç«¯ç‚¹

**æ£€æŸ¥**: `getMemoryById`

**çŠ¶æ€**: âš ï¸ åç«¯å¯èƒ½æœªå®ç°æ­¤ç«¯ç‚¹

**æ–‡ä»¶**: `frontend/services/api/memory/memory.ts:178`

```typescript
getMemoryById: async (
  userId: string | number,
  memoryId: string,
  token: string
): Promise<UserMemory> => {
  const response = await request<{ data: UserMemory }>(`/memory/v1/users/${userId}/memories/${memoryId}`, {
    headers: {
      Authorization: `Bearer ${token}`,
    },
  });
}
```

**å»ºè®®**: 
- æ£€æŸ¥åç«¯MemoryControlleræ˜¯å¦å®ç°äº†GETæ–¹æ³•ï¼ˆæ ¹æ®IDè·å–è®°å¿†ï¼‰
- å¦‚æœæœªå®ç°ï¼ŒRemoteMemoryStorage.getByIdæ–¹æ³•ä¼šå¤±è´¥

---

## âœ… æ€»ç»“

### å·²æ£€æŸ¥å¹¶é€šè¿‡çš„é¡¹ç›®

1. âœ… APIè·¯å¾„æ­£ç¡®ï¼ˆæ— é‡å¤/apiå‰ç¼€ï¼‰
2. âœ… userIdç±»å‹è½¬æ¢æ­£ç¡®
3. âœ… è®¤è¯tokenå¤„ç†æ­£ç¡®
4. âœ… å“åº”æ ¼å¼å¤„ç†æ­£ç¡®
5. âœ… é”™è¯¯å¤„ç†å®Œå–„
6. âœ… ç»„ä»¶ä½¿ç”¨æ­£ç¡®
7. âœ… å­˜å‚¨å±‚å®ç°æ­£ç¡®
8. âœ… MemorySystemæ ¸å¿ƒç±»æ­£ç¡®

### éœ€è¦ç¡®è®¤çš„é¡¹ç›®

1. âš ï¸ åç«¯æ˜¯å¦å®ç°äº†`GET /api/memory/v1/users/{userId}/memories/{memoryId}`ç«¯ç‚¹
2. âš ï¸ åç«¯æ˜¯å¦å®ç°äº†`PUT /api/memory/v1/users/{userId}/memories/{memoryId}`ç«¯ç‚¹
3. âš ï¸ åç«¯æ˜¯å¦å®ç°äº†`POST /api/memory/v1/users/{userId}/sessions/{sessionId}/extract`ç«¯ç‚¹

### æ€»ä½“è¯„ä¼°

**âœ… å‰ç«¯ä»£ç è´¨é‡: ä¼˜ç§€**

æ‰€æœ‰å·²å®ç°çš„APIè°ƒç”¨ï¼ˆsaveMemory, saveMemories, searchMemories, deleteMemoryï¼‰éƒ½æ­£ç¡®æ— è¯¯ã€‚

å‰ç«¯ä»£ç åœ¨å¤„ç†APIè·¯å¾„ã€userIdç±»å‹è½¬æ¢ã€è®¤è¯tokenã€é”™è¯¯å¤„ç†ç­‰æ–¹é¢éƒ½åšå¾—å¾ˆå¥½ã€‚

å”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œéƒ¨åˆ†APIç«¯ç‚¹ï¼ˆgetMemoryById, updateMemory, extractMemoriesFromSessionï¼‰å¯èƒ½åœ¨åç«¯è¿˜æœªå®ç°ï¼Œä½†è¿™äº›ç«¯ç‚¹åœ¨å‰ç«¯å·²ç»æœ‰å®Œå–„çš„é”™è¯¯å¤„ç†ï¼Œä¸ä¼šå¯¼è‡´åº”ç”¨å´©æºƒã€‚

---

## ğŸ“ å»ºè®®

1. **åç«¯APIå®ç°**: ç¡®è®¤ä¸Šè¿°ä¸‰ä¸ªå¯èƒ½æœªå®ç°çš„ç«¯ç‚¹æ˜¯å¦éœ€è¦å®ç°
2. **é”™è¯¯å¤„ç†å¢å¼º**: å¯¹äºå¯èƒ½æœªå®ç°çš„ç«¯ç‚¹ï¼Œå¯ä»¥è€ƒè™‘æ·»åŠ æ›´æ˜ç¡®çš„é”™è¯¯æç¤º
3. **ç±»å‹å®‰å…¨**: è€ƒè™‘ä½¿ç”¨TypeScriptä¸¥æ ¼ç±»å‹æ£€æŸ¥ï¼Œå‡å°‘ç±»å‹è½¬æ¢çš„éšå¼è¡Œä¸º
