# 清除本地缓存指南

当本地数据出现问题时，可以通过以下方法清除缓存。

## 方法一：通过设置界面清除（推荐）

1. 打开应用
2. 点击右上角的**设置**按钮（⚙️）
3. 在设置界面中找到**清除数据**或**重置**选项
4. 点击确认清除

## 方法二：通过浏览器控制台清除

### 清除所有数据（完全重置）

在浏览器控制台（F12）中执行以下代码：

```javascript
// 方法1：使用存储服务清除（推荐）
(async () => {
  const { storageService } = await import('./services/storage');
  await storageService.clearMemory();
})();

// 方法2：手动清除所有存储
// 清除 IndexedDB
indexedDB.deleteDatabase('HeartSphereDB');

// 清除 localStorage
localStorage.removeItem('HEARTSPHERE_MEMORY_CORE_V1');
localStorage.removeItem('HEARTSPHERE_MEMORY_CORE_V2');
localStorage.removeItem('customSceneMappings');
localStorage.removeItem('auth_token');
localStorage.removeItem('lastLoginTime');

// 清除其他可能的存储
localStorage.removeItem('emotion_records');
localStorage.removeItem('memory_records');
localStorage.removeItem('interaction_records');
localStorage.removeItem('card_records');
localStorage.removeItem('emoji_records');

// 刷新页面
window.location.reload();
```

### 只清除特定类型的数据

#### 只清除游戏状态（保留登录信息）

```javascript
// 清除 IndexedDB 中的游戏状态
indexedDB.open('HeartSphereDB').onsuccess = (event) => {
  const db = event.target.result;
  const transaction = db.transaction(['gameState'], 'readwrite');
  const store = transaction.objectStore('gameState');
  store.clear();
  console.log('游戏状态已清除');
};

// 清除 localStorage 中的游戏状态
localStorage.removeItem('HEARTSPHERE_MEMORY_CORE_V1');
localStorage.removeItem('HEARTSPHERE_MEMORY_CORE_V2');
```

#### 只清除日记条目

```javascript
(async () => {
  const { storageService } = await import('./services/storage');
  const state = await storageService.loadState();
  if (state) {
    state.journalEntries = [];
    await storageService.saveState(state);
    console.log('日记条目已清除');
    window.location.reload();
  }
})();
```

#### 只清除同步状态（重新同步所有数据）

```javascript
// 清除所有 syncStatus，强制重新同步
(async () => {
  const { storageService } = await import('./services/storage');
  const state = await storageService.loadState();
  if (state && state.journalEntries) {
    state.journalEntries = state.journalEntries.map(entry => ({
      ...entry,
      syncStatus: 0, // 重置为待同步状态
      syncError: undefined,
      lastSyncTime: undefined
    }));
    await storageService.saveState(state);
    console.log('同步状态已重置，下次登录时会重新同步');
    window.location.reload();
  }
})();
```

#### 只清除认证信息（退出登录）

```javascript
localStorage.removeItem('auth_token');
localStorage.removeItem('lastLoginTime');
console.log('认证信息已清除，请刷新页面');
window.location.reload();
```

## 方法三：通过浏览器开发者工具手动清除

### Chrome/Edge

1. 按 `F12` 打开开发者工具
2. 切换到 **Application**（应用程序）标签
3. 在左侧找到 **Storage**（存储）部分
4. 展开 **Local Storage** 或 **IndexedDB**
5. 找到 `http://localhost:3000`（或你的应用地址）
6. 右键点击，选择 **Clear**（清除）

### Firefox

1. 按 `F12` 打开开发者工具
2. 切换到 **Storage**（存储）标签
3. 展开 **Local Storage** 或 **IndexedDB**
4. 找到你的应用域名
5. 右键点击，选择 **Delete All**（删除全部）

### Safari

1. 按 `Cmd + Option + I` 打开开发者工具
2. 切换到 **Storage**（存储）标签
3. 展开 **Local Storage** 或 **IndexedDB**
4. 选择要清除的项目并删除

## 存储位置说明

### IndexedDB
- **数据库名**: `HeartSphereDB`
- **存储名**: `gameState`（游戏状态）
- **存储名**: `customSceneMappings`（自定义场景映射）

### localStorage
- `HEARTSPHERE_MEMORY_CORE_V1` - 旧版本的游戏状态（已废弃）
- `HEARTSPHERE_MEMORY_CORE_V2` - 当前版本的游戏状态（降级存储）
- `auth_token` - 用户认证令牌
- `lastLoginTime` - 最后登录时间
- `customSceneMappings` - 自定义场景映射（降级存储）
- `emotion_records` - 情绪记录
- `memory_records` - 记忆记录
- `interaction_records` - 交互记录
- `card_records` - 卡片记录
- `emoji_records` - 表情记录

## 注意事项

⚠️ **警告**：
- 清除所有数据会**永久删除**本地存储的所有信息
- 如果数据未同步到服务器，清除后**无法恢复**
- 建议在清除前先**导出备份**（如果应用支持）

✅ **建议**：
- 如果只是数据同步问题，建议只清除同步状态，而不是全部数据
- 如果只是登录问题，建议只清除认证信息
- 清除后需要重新登录并等待数据同步

## 常见问题

### Q: 清除后数据会从服务器恢复吗？
A: 会的。如果之前已经同步到服务器，清除本地缓存后重新登录，数据会从服务器重新加载。

### Q: 如何确认数据已同步到服务器？
A: 检查日记条目的 `syncStatus` 字段：
- `1` = 已同步
- `0` = 待同步
- `-1` = 同步失败

### Q: 清除后应用无法正常使用？
A: 尝试：
1. 完全关闭浏览器标签页
2. 重新打开应用
3. 如果仍有问题，清除浏览器缓存并重新加载




