# 前后端联调测试方案

## 测试环境

- **后端服务**: http://localhost:8081
- **前端服务**: http://localhost:3000
- **数据库**: MySQL (localhost:3306/heartsphere)

## 测试前准备

### 1. 确认服务运行状态

```bash
# 检查后端服务
lsof -ti:8081 && echo "后端服务运行中" || echo "后端服务未运行"

# 检查前端服务
lsof -ti:3000 && echo "前端服务运行中" || echo "前端服务未运行"
```

### 2. 启动服务（如未运行）

**启动后端：**
```bash
cd backend
mvn spring-boot:run
```

**启动前端：**
```bash
cd frontend
npm run dev
```

---

## 测试用例清单

### 测试用例1: 用户注册和初始化流程

#### 1.1 用户注册
- [ ] 打开前端页面 http://localhost:3000
- [ ] 点击注册按钮
- [ ] 填写注册信息（用户名、密码、邮箱）
- [ ] 提交注册
- [ ] 验证：注册成功，自动登录，获取 token
- [ ] 验证：token 保存到 localStorage

**API 验证：**
```bash
curl -X POST http://localhost:8081/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser_'$(date +%s)'",
    "password": "password123",
    "email": "test_'$(date +%s)'@example.com"
  }'
```

#### 1.2 初始化向导 - 场景选择
- [ ] 验证：注册成功后自动弹出初始化向导
- [ ] 验证：显示系统预置场景列表
- [ ] 验证：可以选择多个场景（如"我的大学"）
- [ ] 验证：可以自定义场景名称
- [ ] 点击"下一步"

**API 验证：**
```bash
# 获取系统预置场景
curl http://localhost:8081/api/preset-eras
```

#### 1.3 初始化向导 - 角色选择
- [ ] 验证：显示选中场景的角色列表
- [ ] 验证：可以选择角色
- [ ] 验证：可以自定义角色名称
- [ ] 点击"下一步"

**API 验证：**
```bash
# 获取场景的角色（需要场景ID）
curl http://localhost:8081/api/preset-characters/era/1
```

#### 1.4 初始化向导 - 主线剧情选择
- [ ] 验证：显示选中场景的主线剧情（如"我的大学"场景的"青春校园的序曲"）
- [ ] 验证：可以自定义主线剧情名称
- [ ] 点击"下一步"

**API 验证：**
```bash
# 获取场景的主线剧情（需要场景ID）
curl http://localhost:8081/api/system/main-stories/era/1
```

#### 1.5 初始化向导 - 剧本选择
- [ ] 验证：显示选中场景的剧本列表
- [ ] 验证：可以选择剧本
- [ ] 验证：可以自定义剧本标题
- [ ] 点击"完成"

**API 验证：**
```bash
# 获取场景的剧本（需要场景ID）
curl http://localhost:8081/api/system/scripts/era/1
```

#### 1.6 初始化完成验证
- [ ] 验证：显示友好的过渡效果（"正在同步您的数据..."）
- [ ] 验证：数据同步完成
- [ ] 验证：进入心域主界面
- [ ] **关键验证**：用户场景列表中**不包含**体验场景（大学时代、赛博都市、心域心理治疗诊所）
- [ ] 验证：用户场景列表只包含初始化时选择的场景

**API 验证：**
```bash
# 使用注册时获取的token
TOKEN="your-token-here"

# 获取用户的世界列表
curl -H "Authorization: Bearer $TOKEN" http://localhost:8081/api/worlds

# 获取用户的场景列表
curl -H "Authorization: Bearer $TOKEN" http://localhost:8081/api/eras

# 获取用户的角色列表
curl -H "Authorization: Bearer $TOKEN" http://localhost:8081/api/characters

# 获取用户的剧本列表
curl -H "Authorization: Bearer $TOKEN" http://localhost:8081/api/scripts
```

---

### 测试用例2: 数据获取验证

#### 2.1 验证初始化后的数据完整性
- [ ] 验证：可以获取用户的世界列表
- [ ] 验证：可以获取用户的场景列表
- [ ] 验证：可以获取用户的角色列表
- [ ] 验证：可以获取用户的剧本列表
- [ ] 验证：剧本与场景正确关联（通过 eraId）

#### 2.2 验证主线剧情数据
- [ ] 验证：场景包含主线剧情数据
- [ ] 验证：主线剧情的 systemEraId 与场景匹配
- [ ] 验证：主线剧情数据完整（name, description, firstMessage 等）

---

### 测试用例3: 场景列表显示逻辑

#### 3.1 登录用户场景列表
- [ ] 验证：登录用户只看到 userWorldScenes
- [ ] 验证：登录用户**不看到** WORLD_SCENES（体验场景）
- [ ] 验证：体验场景ID不在场景列表中：
  - `university_era`（大学时代）
  - `cyberpunk_city`（赛博都市）
  - `clinic`（心域心理治疗诊所）

#### 3.2 游客场景列表
- [ ] 退出登录或清除 token
- [ ] 验证：游客可以看到 WORLD_SCENES（体验场景）
- [ ] 验证：体验场景ID在场景列表中

---

### 测试用例4: API 端点测试

#### 4.1 认证相关 API
```bash
# 注册
curl -X POST http://localhost:8081/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"123456","email":"test@example.com"}'

# 登录
curl -X POST http://localhost:8081/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"123456"}'

# 获取当前用户（需要token）
curl -H "Authorization: Bearer $TOKEN" http://localhost:8081/api/auth/me
```

#### 4.2 系统预置数据 API（公开接口）
```bash
# 获取系统预置场景
curl http://localhost:8081/api/preset-eras

# 获取场景的角色
curl http://localhost:8081/api/preset-characters/era/1

# 获取场景的主线剧情
curl http://localhost:8081/api/system/main-stories/era/1

# 获取场景的剧本
curl http://localhost:8081/api/system/scripts/era/1
```

#### 4.3 用户数据 API（需要认证）
```bash
# 获取用户的世界列表
curl -H "Authorization: Bearer $TOKEN" http://localhost:8081/api/worlds

# 获取用户的场景列表
curl -H "Authorization: Bearer $TOKEN" http://localhost:8081/api/eras

# 获取用户的角色列表
curl -H "Authorization: Bearer $TOKEN" http://localhost:8081/api/characters

# 获取用户的剧本列表
curl -H "Authorization: Bearer $TOKEN" http://localhost:8081/api/scripts
```

---

## 自动化测试脚本

### 完整测试流程脚本

创建 `test_integration.sh` 脚本（见下方）

---

## 测试检查清单

### 功能检查
- [ ] 用户注册功能正常
- [ ] 初始化向导正常显示
- [ ] 场景选择功能正常
- [ ] 角色选择功能正常
- [ ] 主线剧情选择功能正常（特别是"我的大学"场景的"青春校园的序曲"）
- [ ] 剧本选择功能正常
- [ ] 初始化完成后数据同步正常
- [ ] 场景列表显示正确（不包含体验场景）

### 数据检查
- [ ] 注册后 token 正确保存
- [ ] 初始化后场景数据正确创建
- [ ] 初始化后角色数据正确创建
- [ ] 初始化后主线剧情数据正确创建
- [ ] 初始化后剧本数据正确创建
- [ ] 数据关联正确（剧本与场景、主线剧情与场景）

### UI/UX 检查
- [ ] 初始化向导步骤清晰
- [ ] 过渡效果友好（"正在同步您的数据..."）
- [ ] 错误提示友好
- [ ] 加载状态显示正确

### 性能检查
- [ ] API 响应时间合理（< 1秒）
- [ ] 页面加载流畅
- [ ] 数据同步不卡顿

---

## 常见问题排查

### 1. 初始化向导不显示
- 检查：注册后是否正确获取 token
- 检查：localStorage 中是否有 auth_token
- 检查：后端 `/api/auth/me` 接口是否正常

### 2. 主线剧情未显示
- 检查：后端 `/api/system/main-stories/era/{eraId}` 接口是否正常
- 检查：数据库中是否有对应场景的主线剧情数据
- 检查：systemEraId 是否匹配

### 3. 体验场景仍然显示
- 检查：前端场景列表构建逻辑
- 检查：userWorldScenes 是否正确加载
- 检查：getCurrentScenes 函数逻辑

### 4. 剧本未显示
- 检查：后端 `/api/system/scripts/era/{eraId}` 接口是否正常
- 检查：初始化时是否正确创建剧本
- 检查：剧本与场景的关联（eraId）

---

## 测试报告模板

### 测试环境
- 测试时间：YYYY-MM-DD HH:mm:ss
- 测试人员：
- 后端版本：
- 前端版本：

### 测试结果
- 测试用例1: ✅/❌
- 测试用例2: ✅/❌
- 测试用例3: ✅/❌
- 测试用例4: ✅/❌

### 发现的问题
1. 问题描述：
   - 复现步骤：
   - 预期结果：
   - 实际结果：
   - 严重程度：高/中/低

### 测试结论
- 通过/不通过
- 备注：




